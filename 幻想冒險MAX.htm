<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹»æƒ³å†’éšª</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-color: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #ff9800;
            --border-radius: 8px;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            
            /* Rarity Colors */
            --common: #b0b0b0;
            --uncommon: #4caf50;
            --rare: #2196f3;
            --epic: #9c27b0;
            --legendary: #ffd700;
            
            /* Buff Colors */
            --buff-angel: #4fc3f7;
            --buff-demon: #ef5350;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--panel-color);
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }

        /* Animations */
        @keyframes spawn-pop {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes damage-shake {
            0% { transform: translate(0, 0); filter: none; }
            20% { transform: translate(-10px, 0) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); }
            40% { transform: translate(10px, 0) rotate(5deg); }
            60% { transform: translate(-5px, 0); }
            80% { transform: translate(5px, 0); }
            100% { transform: translate(0, 0); filter: none; }
        }

        @keyframes attack-lunge {
            0% { transform: translateY(0) scale(1); }
            30% { transform: translateY(20px) scale(1.2); }
            100% { transform: translateY(0) scale(1); }
        }

        @keyframes screen-shake {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-5px, 5px); }
            50% { transform: translate(5px, -5px); }
            75% { transform: translate(-5px, -5px); }
            100% { transform: translate(0, 0); }
        }

        @keyframes float-up {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-30px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-60px) scale(1); opacity: 0; }
        }

        .anim-spawn { animation: spawn-pop 0.5s ease-out forwards; }
        .anim-damage { animation: damage-shake 0.4s ease-in-out; }
        .anim-lunge { animation: attack-lunge 0.3s ease-in-out; }
        .anim-screen-shake { animation: screen-shake 0.3s ease-in-out; }

        .floating-text {
            position: absolute;
            left: 50%;
            top: 40%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 1.5em;
            pointer-events: none;
            text-shadow: 2px 2px 0 #000;
            z-index: 100;
            animation: float-up 1s ease-out forwards;
        }

        header {
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            background: #222;
            padding: 10px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
        }

        .stat-item span {
            font-weight: bold;
            color: var(--accent-color);
        }
        
        #buff-display {
            grid-column: span 2;
            border-top: 1px solid #444;
            padding-top: 5px;
            margin-top: 5px;
            font-size: 0.85em;
            color: #aaa;
        }

        #event-display {
            min-height: 200px;
            background: #222;
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 1px solid #444;
            position: relative;
            overflow: hidden;
        }

        .monster-icon { font-size: 4em; margin-bottom: 10px; display: inline-block; }
        .monster-elite { filter: drop-shadow(0 0 10px #2196f3); }
        .monster-boss { filter: drop-shadow(0 0 15px #f44336); transform: scale(1.2); }

        .log-entry { margin: 5px 0; font-size: 0.95em; }
        .damage-text { color: #ff5252; font-weight: bold; }
        .crit-text { color: #ff0000; font-size: 1.2em; font-weight: bold; text-shadow: 0 0 5px #fff; }
        .heal-text { color: #69f0ae; }
        .gold-text { color: #ffd700; }
        .block-text { color: #2196f3; font-weight: bold; }
        .pierce-text { color: #ff9800; font-weight: bold; }
        .angel-text { color: var(--buff-angel); font-weight: bold; }
        .demon-text { color: var(--buff-demon); font-weight: bold; }

        #controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            padding: 12px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: 0.2s;
            background: #444;
            color: white;
        }

        button:hover { background: #555; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-primary { background: var(--accent-color); color: #000; }
        .btn-primary:hover { background: #ffb74d; }
        
        #inventory-section {
            background: #222;
            padding: 10px;
            border-radius: var(--border-radius);
        }

        .equipment-slots {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .equip-slot {
            flex: 1;
            background: #333;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.75em;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid #444;
        }

        .item-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .item {
            padding: 5px 10px;
            background: #333;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .item:hover { background: #444; }

        .rarity-common { color: var(--common); border-color: #555; }
        .rarity-uncommon { color: var(--uncommon); border-color: var(--uncommon); }
        .rarity-rare { color: var(--rare); border-color: var(--rare); }
        .rarity-epic { color: var(--epic); border-color: var(--epic); box-shadow: 0 0 5px var(--epic); }
        .rarity-legendary { color: var(--legendary); border-color: var(--legendary); box-shadow: 0 0 8px var(--legendary); background: linear-gradient(45deg, #333, #443300); animation: shine 2s infinite linear; }

        @keyframes shine {
            0% { border-color: var(--legendary); }
            50% { border-color: #fff; }
            100% { border-color: var(--legendary); }
        }

        .merchant-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            width: 100%;
        }
        .merchant-item {
            display: flex;
            flex-direction: column;
            background: #333;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #444;
        }
        .merchant-item:hover { background: #444; }
        .m-top { display: flex; justify-content: space-between; font-weight: bold; }
        .m-desc { font-size: 0.8em; color: #aaa; margin-top: 4px; }

        .hidden { display: none !important; }
        h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 5px;}
    </style>
</head>
<body>

<div id="game-container">
    <header>
        <div style="font-weight: bold; font-size: 1.2em;">âš”ï¸ å¹»æƒ³å†’éšª</div>
    </header>

    <div class="stats-grid">
        <div class="stat-item">ç”Ÿå‘½: <span id="hp-val">100</span> / <span id="max-hp-val">100</span></div>
        <div class="stat-item">æ”»æ“Š: <span id="atk-val">5</span></div>
        <div class="stat-item">é‡‘å¹£: <span id="gold-val">0</span></div>
        <div class="stat-item">æ·±åº¦: <span id="depth-val">0</span> å±¤</div>
        <div id="buff-display">ç‹€æ…‹: ç„¡</div>
    </div>

    <div id="event-display">
        <div id="event-icon" class="monster-icon">ğŸ²</div>
        <h3 id="event-title">æº–å‚™å†’éšª</h3>
        <div id="event-desc">æŒ‰ä¸‹æŒ‰éˆ•é–‹å§‹ä½ çš„æ—…ç¨‹...</div>
        <div id="merchant-area" class="hidden"></div>
    </div>

    <div id="controls">
        <button id="btn-main" class="btn-primary" onclick="Game.nextEvent()">é–‹å§‹å†’éšª</button>
        <button id="btn-sub" onclick="Game.handleSubAction()" disabled>...</button>
    </div>

    <div id="inventory-section">
        <h3>ğŸ’ èƒŒåŒ… <small>(é»æ“Šç‰©å“æŸ¥çœ‹/è£å‚™/å‡ºå”®)</small></h3>
        <div class="equipment-slots">
            <div class="equip-slot" id="slot-weapon" onclick="Game.unequip('weapon')">ç„¡æ­¦å™¨</div>
            <div class="equip-slot" id="slot-armor" onclick="Game.unequip('armor')">ç„¡é˜²å…·</div>
            <div class="equip-slot" id="slot-shield" onclick="Game.unequip('shield')">ç„¡ç›¾ç‰Œ</div>
        </div>
        <div class="item-list" id="backpack-list">
            </div>
    </div>
</div>

<script>
/**
 * éŠæˆ²æ•¸æ“šé…ç½®
 */
const CONFIG = {
    rarityProb: { common: 0.5, uncommon: 0.3, rare: 0.15, epic: 0.04, legendary: 0.01 },
    rarityDisplay: {
        common: { color: "rarity-common", label: "ä¸€èˆ¬" },
        uncommon: { color: "rarity-uncommon", label: "å„ªè³ª" },
        rare: { color: "rarity-rare", label: "ç¨€æœ‰" },
        epic: { color: "rarity-epic", label: "å²è©©" },
        legendary: { color: "rarity-legendary", label: "å‚³èªª" }
    },
    buffs: {
        angel_song: { id: 'angel_song', name: 'ğŸ‘¼ å¤©ä½¿çš„æ­Œé Œ', type: 'angel', desc: 'æ¯æ¬¡äº‹ä»¶æ¢å¾© 5 HP' },
        angel_protection: { id: 'angel_protection', name: 'ğŸ›¡ï¸ å¤©ä½¿çš„åŠ è­·', type: 'angel', desc: 'æ€ªç‰©å‚·å®³æ¸›å°‘ 30%' },
        angel_courage: { id: 'angel_courage', name: 'âš”ï¸ å¤©ä½¿çš„å‹‡æ°£', type: 'angel', desc: 'è‡´å‘½ä¸€æ“Šæ©Ÿç‡æå‡è‡³ 20%' },
        angel_wings: { id: 'angel_wings', name: 'ğŸ•Šï¸ å¤©ä½¿çš„ç¿…è†€', type: 'angel', desc: 'é€ƒè·‘æˆåŠŸç‡æå‡è‡³ 60%' },
        demon_wealth: { id: 'demon_wealth', name: 'ğŸ’° æƒ¡é­”çš„è²¡å¯Œ', type: 'demon', desc: 'æ”»æ“Šå¾—5é‡‘å¹£ï¼Œé€ƒè·‘å¤±æ•—æ‰£5é‡‘å¹£' },
        demon_destruction: { id: 'demon_destruction', name: 'ğŸ’€ æƒ¡é­”çš„ç ´å£', type: 'demon', desc: '10%æ©Ÿç‡ç§’æ®ºï¼Œè§¸ç™¼å¾Œæ‰£90%ç•¶å‰è¡€é‡' },
        demon_enhance: { id: 'demon_enhance', name: 'ğŸ”¥ æƒ¡é­”çš„å¼·åŒ–', type: 'demon', desc: 'é›™æ–¹è‡´å‘½ä¸€æ“Šæ©Ÿç‡è®Šç‚º 50%' },
        demon_wager: { id: 'demon_wager', name: 'ğŸ² æƒ¡é­”çš„è³­ç´„', type: 'demon', desc: 'é€ƒè·‘ç‡80%ï¼Œä½†é€ƒè·‘æ™‚1%æ©Ÿç‡æ­»äº¡' }
    },
    monsters: [
        { name: "å²èŠå§†", weight: 13.5, icon: "ğŸ¦ ", hp: 20, atk: 3, drop: "å²èŠå§†é»æ¶²", eliteDrop: "å²èŠå§†ç²¾è¯", bossDrop: "å²èŠå§†ç‹å† " },
        { name: "å“¥å¸ƒæ—", weight: 13.5, icon: "ğŸ‘º", hp: 35, atk: 5, drop: "ç ´å¸ƒ", eliteDrop: "å“¥å¸ƒæ—è€³ç’°", bossDrop: "å“¥å¸ƒæ—é‡‘ç‰™" },
        { name: "ç‹‚ç‹¼", weight: 13.5, icon: "ğŸº", hp: 50, atk: 8, drop: "ç‹¼çš®", eliteDrop: "ç‹¼ç‰™", bossDrop: "ç‹¼ç‹æŠ«é¢¨" },
        { name: "éª·é«å…µ", weight: 13.5, icon: "ğŸ’€", hp: 60, atk: 10, drop: "éª¨é ­", eliteDrop: "éˆé­‚ç¢ç‰‡", bossDrop: "æ­»éˆé ­éª¨" },
        { name: "åŠç¸äºº", weight: 13.5, icon: "ğŸ‘¹", hp: 90, atk: 12, drop: "æ–·åŠ", eliteDrop: "åŠç¸äººè­·ç¬¦", bossDrop: "æˆ°çˆ­è™Ÿè§’" },
        { name: "å¹½éˆ", weight: 13.5, icon: "ğŸ‘»", hp: 70, atk: 15, drop: "éˆè³ª", eliteDrop: "æ€¨å¿µé›†åˆé«”", bossDrop: "å¹½éˆæç‡ˆ" },
        { name: "çŸ³å·¨äºº", weight: 10, icon: "ğŸ—¿", hp: 150, atk: 20, drop: "çŸ³å¡Š", eliteDrop: "é­”åŠ›æ ¸å¿ƒ", bossDrop: "å¤§åœ°ä¹‹å¿ƒ" },
        { name: "é£Ÿäººå¦–", weight: 5, icon: "ğŸ§Ÿ", hp: 200, atk: 25, drop: "å·¨æ£’", eliteDrop: "é£Ÿäººå¦–ä¹‹è¡€", bossDrop: "é£Ÿäººå¦–åœ–é¨°" },
        { name: "é›™è¶³é£›é¾", weight: 3, icon: "ğŸ‰", hp: 300, atk: 35, drop: "é¾é±—", eliteDrop: "é¾ä¹‹æ·š", bossDrop: "é¾å¿ƒ" },
        { name: "é­”ç‹", weight: 1, icon: "ğŸ‘¿", hp: 500, atk: 50, drop: "é»‘æš—ç‰©è³ª", eliteDrop: "é­”ç‹å°è¨˜", bossDrop: "é­”ç¥ä¹‹çœ¼" }
    ],
    // æˆ°åˆ©å“è³‡æ–™åº«ï¼šè¨­å®šåƒ¹æ ¼ã€ç¨€æœ‰åº¦èˆ‡åœ–ç¤º
    lootData: {
        "å²èŠå§†é»æ¶²": { price: 10, rarity: "common", icon: "ğŸ’§" },
        "å²èŠå§†ç²¾è¯": { price: 50, rarity: "uncommon", icon: "âœ¨" },
        "å²èŠå§†ç‹å† ": { price: 200, rarity: "rare", icon: "ğŸ‘‘" },
        
        "ç ´å¸ƒ": { price: 15, rarity: "common", icon: "ğŸ§¶" },
        "å“¥å¸ƒæ—è€³ç’°": { price: 60, rarity: "uncommon", icon: "ğŸ’" },
        "å“¥å¸ƒæ—é‡‘ç‰™": { price: 250, rarity: "rare", icon: "ğŸ¦·" },
        
        "ç‹¼çš®": { price: 20, rarity: "common", icon: "ğŸ§µ" },
        "ç‹¼ç‰™": { price: 80, rarity: "uncommon", icon: "ğŸ¦´" },
        "ç‹¼ç‹æŠ«é¢¨": { price: 300, rarity: "rare", icon: "ğŸ§£" },
        
        "éª¨é ­": { price: 25, rarity: "common", icon: "ğŸ¦´" },
        "éˆé­‚ç¢ç‰‡": { price: 100, rarity: "uncommon", icon: "ğŸ‘»" },
        "æ­»éˆé ­éª¨": { price: 350, rarity: "rare", icon: "ğŸ’€" },
        
        "æ–·åŠ": { price: 30, rarity: "common", icon: "ğŸ—¡ï¸" },
        "åŠç¸äººè­·ç¬¦": { price: 120, rarity: "uncommon", icon: "ğŸ§¿" },
        "æˆ°çˆ­è™Ÿè§’": { price: 400, rarity: "rare", icon: "ğŸ“¯" },
        
        "éˆè³ª": { price: 35, rarity: "common", icon: "ğŸŒ«ï¸" },
        "æ€¨å¿µé›†åˆé«”": { price: 150, rarity: "uncommon", icon: "ğŸ‘¿" },
        "å¹½éˆæç‡ˆ": { price: 450, rarity: "rare", icon: "ğŸ®" },
        
        "çŸ³å¡Š": { price: 50, rarity: "common", icon: "ğŸª¨" },
        "é­”åŠ›æ ¸å¿ƒ": { price: 200, rarity: "rare", icon: "ğŸ”®" },
        "å¤§åœ°ä¹‹å¿ƒ": { price: 600, rarity: "epic", icon: "ğŸ’" },
        
        "å·¨æ£’": { price: 60, rarity: "common", icon: "ğŸªµ" },
        "é£Ÿäººå¦–ä¹‹è¡€": { price: 250, rarity: "rare", icon: "ğŸ©¸" },
        "é£Ÿäººå¦–åœ–é¨°": { price: 700, rarity: "epic", icon: "ğŸ—¿" },
        
        "é¾é±—": { price: 100, rarity: "uncommon", icon: "ğŸ›¡ï¸" },
        "é¾ä¹‹æ·š": { price: 400, rarity: "rare", icon: "ğŸ’§" },
        "é¾å¿ƒ": { price: 800, rarity: "epic", icon: "â¤ï¸" },
        
        "é»‘æš—ç‰©è³ª": { price: 200, rarity: "rare", icon: "âš«" },
        "é­”ç‹å°è¨˜": { price: 500, rarity: "epic", icon: "ğŸ”¯" },
        "é­”ç¥ä¹‹çœ¼": { price: 1000, rarity: "legendary", icon: "ğŸ‘ï¸" }
    },
    itemPool: [
        { name: "ç”Ÿé½åŒ•é¦–", type: "weapon", val: 3, rarity: "common", price: 15, icon: "ğŸ—¡ï¸" },
        { name: "æœ¨æ£’", type: "weapon", val: 4, rarity: "common", price: 20, icon: "ğŸªµ" },
        { name: "å¸ƒè¡£", type: "armor", val: 10, rarity: "common", price: 15, icon: "ğŸ‘•" },
        { name: "åœ“ç›¾", type: "shield", val: 1, rarity: "common", price: 25, icon: "ğŸ›¡ï¸" },
        { name: "æ²»ç™‚è—¥æ°´", type: "consumable", val: 30, rarity: "common", price: 25, icon: "ğŸ§ª", desc: "æ¢å¾©30é»ç”Ÿå‘½" },
        { name: "é¨å£«é•·æ§", type: "weapon", val: 12, rarity: "uncommon", price: 80, icon: "ğŸ”±" },
        { name: "é–å­ç”²", type: "armor", val: 40, rarity: "uncommon", price: 80, icon: "ğŸ›¡ï¸" },
        { name: "éµç›¾", type: "shield", val: 3, rarity: "uncommon", price: 90, icon: "ğŸ›¡ï¸" },
        { name: "å¼·åŠ›è—¥æ°´", type: "consumable", val: 80, rarity: "uncommon", price: 60, icon: "ğŸ·", desc: "æ¢å¾©80é»ç”Ÿå‘½" },
        { name: "ç§˜éŠ€åŠ", type: "weapon", val: 30, rarity: "rare", price: 250, icon: "âš”ï¸" },
        { name: "æ¿ç”²", type: "armor", val: 80, rarity: "rare", price: 250, icon: "ğŸ›¡ï¸" },
        { name: "é¨å£«ç›¾", type: "shield", val: 5, rarity: "rare", price: 300, icon: "ğŸ›¡ï¸" },
        { name: "ç²¾éˆè—¥åŠ‘", type: "consumable", val: 200, rarity: "rare", price: 150, icon: "ğŸ§‰", desc: "æ¢å¾©200é»ç”Ÿå‘½" },
        { name: "å± é¾åŠ", type: "weapon", val: 60, rarity: "epic", price: 800, icon: "ğŸ‰" },
        { name: "é¾é±—é§ç”²", type: "armor", val: 150, rarity: "epic", price: 800, icon: "ğŸ¥‹" },
        { name: "å¡”ç›¾", type: "shield", val: 7, rarity: "epic", price: 900, icon: "ğŸ§±" },
        { name: "è–åŠ Excalibur", type: "weapon", val: 150, rarity: "legendary", price: 3000, icon: "ğŸŒŸ" },
        { name: "ç¥ä¹‹å…‰è¼", type: "armor", val: 250, rarity: "legendary", price: 2000, icon: "ğŸŒ" },
        { name: "åŸƒç™¸æ–¯ä¹‹ç›¾", type: "shield", val: 10, rarity: "legendary", price: 2000, icon: "ğŸ”±" }
    ],
    phoenixFeather: {
        id: "phoenix_feather",
        name: "ä¸æ­»é³¥çš„ç¾½æ¯›",
        type: "revive",
        rarity: "legendary",
        icon: "ğŸª¶",
        price: 0,
        desc: "æ­»äº¡æ™‚ä»¥50%ç”Ÿå‘½å¾©æ´»ï¼Œç„¡æ³•å‡ºå”®"
    }
};

const Player = {
    hp: 100,
    maxHp: 100,
    baseAtk: 5,
    gold: 0,
    depth: 0,
    equipment: { weapon: null, armor: null, shield: null },
    backpack: [],
    buff: null 
};

const GameState = {
    phase: "idle",
    currentEnemy: null,
    merchantStock: [],
    log: []
};

const Game = {
    init() {
        this.updateUI();
    },

    triggerAnim(id, animClass) {
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove(animClass);
            void el.offsetWidth;
            el.classList.add(animClass);
        }
    },

    showFloatingText(text, color) {
        const display = document.getElementById('event-display');
        const div = document.createElement('div');
        div.className = 'floating-text';
        div.innerHTML = text;
        div.style.color = color;
        display.appendChild(div);
        setTimeout(() => div.remove(), 1000);
    },

    getAtk() {
        let atk = Player.baseAtk;
        if (Player.equipment.weapon) atk += Player.equipment.weapon.val;
        return atk;
    },

    recalcStats() {
        const oldMax = Player.maxHp;
        const hpPercent = Player.hp / oldMax;
        let bonusHp = Player.equipment.armor ? Player.equipment.armor.val : 0;
        let newMax = 100 + bonusHp;
        Player.maxHp = newMax;
        Player.hp = Math.floor(newMax * hpPercent);
        if (Player.hp === 0 && hpPercent > 0) Player.hp = 1;
        this.updateUI();
    },

    nextEvent() {
        if (Player.hp <= 0) {
            this.restart();
            return;
        }

        Player.depth++;
        this.log(`>>> é€²å…¥ç¬¬ ${Player.depth} å±¤æ¢ç´¢...`);
        
        if (Player.buff && Player.buff.id === 'angel_song') {
            if (Player.hp < Player.maxHp) {
                Player.hp = Math.min(Player.maxHp, Player.hp + 5);
                this.showFloatingText("+5 HP", "#69f0ae");
            }
        }

        const rand = Math.random();
        
        if (rand < 0.05) {
            this.triggerHeal();
        } else if (rand < 0.10) {
            this.triggerStatue();
        } else if (rand < 0.30) {
            this.triggerMerchant();
        } else if (rand < 0.40) {
            this.triggerChest();
        } else {
            this.triggerCombat();
        }
        
        this.updateUI();
    },

    triggerHeal() {
        const oldHp = Player.hp;
        Player.hp = Player.maxHp; 
        const healed = Player.hp - oldHp;
        
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ’– ä¼‘æ¯æ™‚åˆ»", "ä½ æ‰¾åˆ°ä¸€è™•å®‰å…¨çš„åœ°æ–¹ä¼‘æ¯ã€‚", `ç”Ÿå‘½å€¼ <span class='heal-text'>å®Œå…¨æ¢å¾©</span> (æ¢å¾©äº† ${healed} é»)ã€‚`, "ğŸ›Œ");
        if(healed > 0) this.showFloatingText(`+${healed} HP`, "#69f0ae");
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },

    triggerStatue() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ—¿ ç¥ˆç¦±è–åƒ", "ä½ ç™¼ç¾äº†ä¸€åº§å¤è€çš„è–åƒ...", "æ˜¯å¦è¦é€²è¡Œç¥ˆç¦±ï¼Ÿ", "ğŸ™");
        this.setButtons("ç¥ˆç¦±", "pray", "é›¢é–‹", "nextEvent", false);
    },

    pray() {
        const isAngel = Math.random() < 0.5;
        const type = isAngel ? 'angel' : 'demon';
        const icon = isAngel ? "ğŸ‘¼" : "ğŸ˜ˆ";
        const options = Object.values(CONFIG.buffs).filter(b => b.type === type);
        const selected = options[Math.floor(Math.random() * options.length)];
        
        Player.buff = selected;
        
        let title = isAngel ? "å¤©ä½¿è–åƒ" : "æƒ¡é­”è–åƒ";
        let style = isAngel ? "angel-text" : "demon-text";
        
        this.triggerAnim('event-icon', 'anim-spawn');
        let desc = `ä½ ç²å¾—äº† <span class='${style}'>${selected.name}</span> çš„æ•ˆæœã€‚<br><small>${selected.desc}</small>`;
        this.renderEvent(title, "ç¥ˆç¦±å¾—åˆ°äº†å›æ‡‰...", desc, icon);
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    triggerMerchant() {
        GameState.phase = "merchant";
        this.generateMerchantStock();
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ’° ç¥ç§˜å•†äºº", "ã€Œæˆ‘é€™è£¡æœ‰äº›å¥½æ±è¥¿ï¼Œçœ‹çœ‹å§ï¼Ÿã€", "é»æ“Šå•†å“å¯æŸ¥çœ‹è©³æƒ…èˆ‡è³¼è²·", "ğŸ‘³");
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        this.renderMerchantShop();
    },

    generateMerchantStock() {
        GameState.merchantStock = [];
        for(let i=0; i<4; i++) {
            GameState.merchantStock.push(this.generateRandomItem());
        }
    },

    getItemDesc(item) {
        if (item.desc) return item.desc;
        if (item.type === 'weapon') return `æ”»æ“ŠåŠ› +${item.val}`;
        if (item.type === 'armor') return `ç”Ÿå‘½ä¸Šé™ +${item.val}`;
        if (item.type === 'shield') return `æŠµæ“‹ ${item.val} æ¬¡æ”»æ“Š`;
        if (item.type === 'loot') return `æˆ°åˆ©å“ (å¯é«˜åƒ¹å‡ºå”®)`;
        return "æœªçŸ¥ç‰©å“";
    },

    renderMerchantShop() {
        const area = document.getElementById('merchant-area');
        area.innerHTML = "";
        area.classList.remove('hidden');
        
        let buyHtml = "<h4>è³¼è²·å•†å“</h4><div class='merchant-grid'>";
        GameState.merchantStock.forEach((item, idx) => {
            if (!item) return;
            const desc = this.getItemDesc(item);
            const rarityColor = CONFIG.rarityDisplay[item.rarity].color;
            buyHtml += `<div class="merchant-item ${rarityColor}" onclick="Game.buyItem(${idx})">
                <div class="m-top">
                    <span>${item.icon || 'ğŸ“¦'} ${item.name}</span>
                    <span class="gold-text">${item.price} G</span>
                </div>
                <div class="m-desc">${desc}</div>
            </div>`;
        });
        buyHtml += "</div>";
        buyHtml += "<h4>å‡ºå”®</h4><p style='font-size:0.8em; color:#888'>é»æ“Šä¸‹æ–¹èƒŒåŒ…ç‰©å“å³å¯å‡ºå”®ã€‚</p>";
        area.innerHTML = buyHtml;
    },

    buyItem(idx) {
        const item = GameState.merchantStock[idx];
        if (!item) return;
        if (Player.gold >= item.price) {
            Player.gold -= item.price;
            this.addToBackpack(item);
            GameState.merchantStock[idx] = null;
            this.showFloatingText("- " + item.price + " G", "yellow");
            this.log(`è³¼è²·äº† ${item.name}`);
            this.updateUI();
            this.renderMerchantShop();
        } else {
            alert("é‡‘å¹£ä¸è¶³ï¼");
        }
    },

    sellItem(index) {
        if (GameState.phase !== "merchant") return; 
        const item = Player.backpack[index];
        if (!item) return;
        if (item.type === 'revive') {
            alert("é€™ä»¶ç‰©å“å¤ªçè²´äº†ï¼Œç„¡æ³•å‡ºå”®ï¼");
            return;
        }
        let price = item.price;
        if (item.type === 'weapon' || item.type === 'armor' || item.type === 'shield' || item.type === 'consumable') {
            price = Math.floor(price * 0.8);
        }
        if(confirm(`ç¢ºå®šè¦ä»¥ ${price} G å‡ºå”® ${item.name} å—ï¼Ÿ`)) {
            Player.backpack.splice(index, 1);
            Player.gold += price;
            this.showFloatingText("+ " + price + " G", "yellow");
            this.log(`å‡ºå”® ${item.name} ç²å¾— ${price} G`);
            this.updateUI();
        }
    },

    triggerChest() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');

        if (Math.random() < 0.01) {
            const feather = {...CONFIG.phoenixFeather};
            this.addToBackpack(feather);
            this.renderEvent("ğŸ“¦ ç™¼ç¾å¯¶ç®±", "ä½ æ‰“é–‹äº†å¯¶ç®±...", "å¥‡è¹Ÿç™¼ç”Ÿäº†ï¼ä½ ç²å¾—äº† <span class='rarity-legendary'>ä¸æ­»é³¥çš„ç¾½æ¯›</span>ï¼", "ğŸª¶");
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            return;
        }

        const roll = Math.random();
        let title = "ğŸ“¦ ç™¼ç¾å¯¶ç®±";
        let desc = "";
        let icon = "ğŸ“¦";

        if (roll < 0.30) {
            const amount = Math.floor(Math.random() * 50) + 10 + (Player.depth * 2);
            Player.gold += amount;
            desc = `ç²å¾—äº† <span class='gold-text'>${amount} G</span>`;
            this.showFloatingText(`+${amount} G`, "#ffd700");
        } else if (roll < 0.60) {
            const item = this.generateSpecificItem(['consumable']);
            this.addToBackpack(item);
            desc = `ç²å¾—äº† <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`;
        } else if (roll < 0.80) {
            const item = this.generateSpecificItem(['weapon', 'armor', 'shield']);
            this.addToBackpack(item);
            desc = `ç²å¾—äº† <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`;
        } else if (roll < 0.90) {
            desc = "è£¡é¢ç©ºç©ºå¦‚ä¹Ÿ...";
        } else {
            const dmg = Math.floor(Player.maxHp * 0.15);
            Player.hp = Math.max(0, Player.hp - dmg);
            desc = `æ˜¯é™·é˜±ï¼å—åˆ°äº† <span class='damage-text'>${dmg}</span> é»å‚·å®³ã€‚`;
            this.triggerAnim('game-container', 'anim-screen-shake');
            this.showFloatingText(`-${dmg} HP`, "red");
            if(Player.hp === 0) { this.playerDie(); return; }
        }

        this.renderEvent(title, "ä½ æ‰“é–‹äº†å¯¶ç®±...", desc, icon);
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },

    getWeightedMonster() {
        const monsters = CONFIG.monsters;
        let totalWeight = 0;
        for (let m of monsters) totalWeight += m.weight;
        let randomVal = Math.random() * totalWeight;
        for (let m of monsters) {
            if (randomVal < m.weight) return m;
            randomVal -= m.weight;
        }
        return monsters[0];
    },

    triggerCombat() {
        GameState.phase = "combat";
        const baseMonster = this.getWeightedMonster();
        let tier = "normal";
        let rand = Math.random();

        if (Player.depth > 300) {
            if (rand < 0.5) tier = "elite"; else tier = "boss";
        } else if (Player.depth > 100) {
            if (rand < 0.1) tier = "boss"; else if (rand < 0.6) tier = "elite"; else tier = "normal";
        } else {
            if (rand < 0.01) tier = "boss"; else if (rand < 0.11) tier = "elite"; else tier = "normal";
        }

        let hpMul = 1, atkMul = 1;
        let namePrefix = "";
        if (tier === "elite") { hpMul = 2; atkMul = 1.5; namePrefix = "èè‹± "; }
        else if (tier === "boss") { hpMul = 3; atkMul = 2; namePrefix = "é¦–é ˜ "; }

        GameState.currentEnemy = {
            ...baseMonster,
            name: namePrefix + baseMonster.name,
            maxHp: Math.floor(baseMonster.hp * hpMul),
            hp: Math.floor(baseMonster.hp * hpMul),
            atk: Math.floor(baseMonster.atk * atkMul),
            tier: tier
        };

        let iconClass = "monster-icon";
        if(tier === "elite") iconClass += " monster-elite";
        if(tier === "boss") iconClass += " monster-boss";

        document.getElementById('event-icon').className = iconClass;
        this.triggerAnim('event-icon', 'anim-spawn');
        
        this.renderEvent(`âš”ï¸ é­é‡ ${GameState.currentEnemy.name}`, 
            `HP: ${GameState.currentEnemy.hp} | æ”»æ“Š: ${GameState.currentEnemy.atk}`, 
            "æº–å‚™æˆ°é¬¥ï¼", GameState.currentEnemy.icon);
        
        this.setButtons("æˆ°é¬¥", "combatRound", "é€ƒè·‘", "flee", false);
    },

    combatRound() {
        if (GameState.phase !== "combat") return;
        const enemy = GameState.currentEnemy;
        let logHtml = "";

        // 1. ç©å®¶æ”»æ“Š
        let pDmg = this.getAtk();
        let pCritRate = 0.05;
        
        if (Player.buff) {
            if (Player.buff.id === 'angel_courage') pCritRate = 0.2;
            if (Player.buff.id === 'demon_enhance') pCritRate = 0.5;
            if (Player.buff.id === 'demon_wealth') {
                Player.gold += 5;
                this.showFloatingText("+5 G", "gold");
                logHtml += `<span class='demon-text'>[æƒ¡é­”è²¡å¯Œ]</span> ç²å¾— 5 G<br>`;
            }
            if (Player.buff.id === 'demon_destruction') {
                if (Math.random() < 0.1) {
                    enemy.hp = 0;
                    let pain = Math.floor(Player.hp * 0.9);
                    Player.hp -= pain;
                    this.showFloatingText(`-${pain} HP`, "darkred");
                    logHtml += `<span class='demon-text'>[æƒ¡é­”ç ´å£]</span> è§¸ç™¼ç§’æ®ºï¼è‡ªèº«æ‰£é™¤ ${pain} HPã€‚<br>`;
                    this.combatWin(); 
                    this.updateUI();
                    return;
                }
            }
        }

        let pCrit = Math.random() < pCritRate;
        if (pCrit) pDmg *= 2;
        
        enemy.hp -= pDmg;
        
        this.triggerAnim('event-icon', 'anim-damage');
        this.showFloatingText(pDmg, pCrit ? "red" : "white");
        
        logHtml += `ä½ å° ${enemy.name} é€ æˆ ${pCrit ? "<span class='crit-text'>çˆ†æ“Š " : ""}${pDmg}${pCrit ? "</span>" : ""} é»å‚·å®³ã€‚<br>`;

        if (enemy.hp <= 0) {
            this.combatWin();
            return;
        }

        // 2. æ€ªç‰©æ”»æ“Š
        let mDmg = enemy.atk;
        let mCritRate = 0.1;
        if (Player.buff && Player.buff.id === 'demon_enhance') mCritRate = 0.5;
        if (Player.buff && Player.buff.id === 'angel_protection') mDmg = Math.floor(mDmg * 0.7);

        let mCrit = Math.random() < mCritRate;
        if (mCrit) mDmg *= 2;

        let applyDamage = true;
        let s = Player.equipment.shield;

        this.triggerAnim('event-icon', 'anim-lunge');

        if (s && s.val > 0) {
            if (mCrit && s.name !== "åŸƒç™¸æ–¯ä¹‹ç›¾") {
                logHtml += `<span class='pierce-text'>âš¡ è‡´å‘½ä¸€æ“Šè²«ç©¿äº†ç›¾ç‰Œï¼</span><br>`;
            } else {
                applyDamage = false;
                s.val--;
                this.showFloatingText("æ ¼æ“‹!", "#2196f3");
                logHtml += `<span class='block-text'>ğŸ›¡ï¸ ç›¾ç‰ŒæŠµæ“‹äº†æ”»æ“Šï¼</span> (å‰©é¤˜è€ä¹…: ${s.val})<br>`;
                if (s.val <= 0) {
                    logHtml += `<span class='damage-text'>ğŸ’” ä½ çš„ ${s.name} ç¢è£‚äº†ï¼</span><br>`;
                    Player.equipment.shield = null;
                    this.recalcStats(); 
                }
            }
        }

        if (applyDamage) {
            Player.hp -= mDmg;
            this.triggerAnim('game-container', 'anim-screen-shake');
            this.showFloatingText(`-${mDmg}`, "red");
            logHtml += `${enemy.name} æ”»æ“Šï¼é€ æˆ ${mCrit ? "<span class='crit-text'>è‡´å‘½ " : ""}${mDmg}${mCrit ? "</span>" : ""} é»å‚·å®³ã€‚`;
        }
        
        this.renderEvent(`âš”ï¸ æˆ°é¬¥ä¸­ - ${enemy.name}`, 
            `æ•µæ–¹ HP: ${Math.max(0, enemy.hp)}`, 
            logHtml, enemy.icon);

        if (Player.hp <= 0) {
            this.playerDie();
        } else {
            this.updateUI();
        }
    },

    combatWin() {
        const enemy = GameState.currentEnemy;
        GameState.phase = "event_end";
        let drops = [];
        let dropText = "";

        let gold = Math.floor(Math.random() * 20) + (Player.depth);
        if (enemy.tier === "elite") gold *= 2;
        if (enemy.tier === "boss") gold *= 5;
        Player.gold += gold;
        this.showFloatingText(`+${gold} G`, "#ffd700");
        dropText += `é‡‘å¹£ +${gold} <br>`;

        if (Math.random() < 0.7) {
            // ä½¿ç”¨æ–°çš„æˆ°åˆ©å“è³‡æ–™åº«ç”Ÿæˆæ‰è½
            if (CONFIG.lootData[enemy.drop]) {
                let loot = { ...CONFIG.lootData[enemy.drop], name: enemy.drop, type: "loot" };
                drops.push(loot);
            }
        }

        if (enemy.tier === "elite" || enemy.tier === "boss") {
            if (Math.random() < 0.3 && CONFIG.lootData[enemy.eliteDrop]) {
                let loot = { ...CONFIG.lootData[enemy.eliteDrop], name: enemy.eliteDrop, type: "loot" };
                drops.push(loot);
            }
        }
        if (enemy.tier === "boss") {
            if (Math.random() < 0.1 && CONFIG.lootData[enemy.bossDrop]) {
                let loot = { ...CONFIG.lootData[enemy.bossDrop], name: enemy.bossDrop, type: "loot" };
                drops.push(loot);
            }
        }

        // è£å‚™æ‰è½ç‡: 10%
        if (Math.random() < 0.1) {
            drops.push(this.generateRandomItem(enemy.tier));
        }

        drops.forEach(item => {
            this.addToBackpack(item);
            const colorClass = CONFIG.rarityDisplay[item.rarity].color;
            dropText += `ç²å¾— <span class='${colorClass}'>${item.name}</span><br>`;
        });

        this.renderEvent("ğŸ† æˆ°é¬¥å‹åˆ©", "ä½ æ“Šæ•—äº†æ•µäººï¼", dropText || "æ²’æœ‰æ‰è½ä»»ä½•ç‰©å“ã€‚", "ğŸ‰");
        document.getElementById('event-icon').className = "monster-icon"; 
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    flee() {
        let fleeRate = 0.5;
        if (Player.buff) {
            if (Player.buff.id === 'angel_wings') fleeRate = 0.6;
            if (Player.buff.id === 'demon_wager') {
                fleeRate = 0.8;
                if (Math.random() < 0.01) {
                    Player.hp = 0;
                    this.log("[æƒ¡é­”è³­ç´„] é€ƒè·‘æ™‚ä»£åƒ¹è§¸ç™¼ï¼Œæ­»äº¡ã€‚");
                    this.playerDie();
                    return;
                }
            }
        }

        if (Math.random() < fleeRate) {
            GameState.phase = "event_end";
            this.renderEvent("ğŸ’¨ é€ƒè·‘æˆåŠŸ", "ä½ æˆåŠŸç”©æ‰äº†æ€ªç‰©ã€‚", "", "ğŸƒ");
            document.getElementById('event-icon').className = "monster-icon";
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        } else {
            const enemy = GameState.currentEnemy;
            let mDmg = enemy.atk;
            let msg = "";
            let s = Player.equipment.shield;
            
            this.triggerAnim('event-icon', 'anim-lunge');

            if (s && s.val > 0) {
                s.val--;
                this.showFloatingText("æ ¼æ“‹!", "#2196f3");
                msg = `é€ƒè·‘å¤±æ•—ï¼ä½†<span class='block-text'>ç›¾ç‰ŒæŠµæ“‹äº†è¿½æ“Š</span>ï¼`;
                if (s.val <= 0) {
                    msg += `<br><span class='damage-text'>ğŸ’” ä½ çš„ ${s.name} ç¢è£‚äº†ï¼</span>`;
                    Player.equipment.shield = null;
                    this.recalcStats();
                }
            } else {
                Player.hp -= mDmg;
                this.triggerAnim('game-container', 'anim-screen-shake');
                this.showFloatingText(`-${mDmg}`, "red");
                msg = `é€ƒè·‘å¤±æ•—ï¼è¢« ${enemy.name} æ”»æ“Šé€ æˆ ${mDmg} å‚·å®³ã€‚`;
                
                if (Player.buff && Player.buff.id === 'demon_wealth') {
                    if (Player.gold >= 5) {
                        Player.gold -= 5;
                        this.showFloatingText("-5 G", "red");
                        msg += `<br><span class='demon-text'>[æƒ¡é­”è²¡å¯Œ]</span> æå¤± 5 G`;
                    }
                }
            }
            
            if (Player.hp <= 0) {
                this.playerDie();
            } else {
                this.renderEvent(`âš”ï¸ ${enemy.name}`, `æ•µæ–¹ HP: ${enemy.hp}`, msg, enemy.icon);
                this.updateUI();
            }
        }
    },

    playerDie() {
        const featherIdx = Player.backpack.findIndex(i => i.id === 'phoenix_feather');
        if (featherIdx !== -1) {
            Player.backpack.splice(featherIdx, 1);
            Player.hp = Math.floor(Player.maxHp * 0.5);
            this.renderEvent("ğŸ”¥ æµ´ç«é‡ç”Ÿ", "ä¸æ­»é³¥çš„ç¾½æ¯›ç™¼å‡ºè€€çœ¼å…‰èŠ’...", "ä½ å¾©æ´»äº†ï¼æ¢å¾© 50% ç”Ÿå‘½å€¼ã€‚", "ğŸ¦…");
            GameState.phase = "event_end";
            document.getElementById('event-icon').className = "monster-icon";
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            this.updateUI();
            return;
        }

        GameState.phase = "dead";
        Player.hp = 0;
        this.updateUI();
        this.renderEvent("â˜ ï¸ ä½ æ­»äº†", `å†’éšªçµæŸã€‚æœ€çµ‚æ·±åº¦: ${Player.depth}`, "æŒ‰ä¸‹é‡æ–°é–‹å§‹", "ğŸª¦");
        this.setButtons("é‡æ–°é–‹å§‹å†’éšª", "restart", "ç„¡", null, true);
    },

    restart() {
        Player.hp = 100;
        Player.maxHp = 100;
        Player.gold = 0;
        Player.depth = 0;
        Player.equipment = { weapon: null, armor: null, shield: null };
        Player.backpack = [];
        Player.buff = null;
        GameState.merchantStock = [];
        this.log("=== æ–°çš„å†’éšªé–‹å§‹ ===");
        this.nextEvent();
    },

    generateRandomItem(tierModifier = "normal") {
        const r = Math.random();
        let rarityKey = "common";
        let table = CONFIG.rarityProb;
        let acc = 0;
        for (let key in table) {
            acc += table[key];
            if (r <= acc) { rarityKey = key; break; }
        }

        if (tierModifier === "boss" && (rarityKey === "common" || rarityKey === "uncommon")) rarityKey = "rare";
        
        const pool = CONFIG.itemPool.filter(i => i.rarity === rarityKey);
        if (pool.length === 0) return this.generateRandomItem("normal");

        const template = pool[Math.floor(Math.random() * pool.length)];
        return { ...template };
    },

    generateSpecificItem(allowedTypes) {
        const r = Math.random();
        let rarityKey = "common";
        let table = CONFIG.rarityProb;
        let acc = 0;
        for (let key in table) {
            acc += table[key];
            if (r <= acc) { rarityKey = key; break; }
        }
        let pool = CONFIG.itemPool.filter(i => i.rarity === rarityKey && allowedTypes.includes(i.type));
        if (pool.length === 0) pool = CONFIG.itemPool.filter(i => allowedTypes.includes(i.type));
        const template = pool[Math.floor(Math.random() * pool.length)];
        return { ...template };
    },

    addToBackpack(item) {
        Player.backpack.push(item);
        this.updateUI();
    },

    handleItemClick(index) {
        if (GameState.phase === "merchant") {
            this.sellItem(index);
            return;
        }
        const item = Player.backpack[index];
        if (item.type === 'weapon' || item.type === 'armor' || item.type === 'shield') {
            if(confirm(`è¦è£å‚™ ${item.name} (${this.getItemDesc(item)}) å—ï¼Ÿ`)) this.equip(index);
        } else if (item.type === 'consumable') {
            if(confirm(`è¦ä½¿ç”¨ ${item.name} (${item.desc}) å—ï¼Ÿ`)) this.useItem(index);
        } else {
             alert(`${item.name}: ${item.desc || "å¯ä»¥ç”¨ä¾†æ›å–é‡‘å¹£"}`);
        }
    },

    equip(backpackIndex) {
        const item = Player.backpack[backpackIndex];
        const type = item.type;

        if (Player.equipment[type]) Player.backpack.push(Player.equipment[type]);
        Player.equipment[type] = item;
        Player.backpack.splice(backpackIndex, 1);
        
        this.recalcStats();
        this.updateUI();
        this.log(`è£å‚™äº† ${item.name}`);
    },

    unequip(type) {
        if (!Player.equipment[type]) return;
        Player.backpack.push(Player.equipment[type]);
        Player.equipment[type] = null;
        this.recalcStats();
        this.updateUI();
        this.log(`å¸ä¸‹äº† ${type === 'weapon' ? 'æ­¦å™¨' : type === 'armor' ? 'é˜²å…·' : 'ç›¾ç‰Œ'}`);
    },

    useItem(index) {
        const item = Player.backpack[index];
        if (item.name.includes("è—¥æ°´") || item.name.includes("è—¥åŠ‘")) {
            let heal = item.val;
            Player.hp = Math.min(Player.maxHp, Player.hp + heal);
            Player.backpack.splice(index, 1);
            this.showFloatingText(`+${heal} HP`, "#69f0ae");
            this.updateUI();
        }
    },

    log(msg) { console.log(msg); },

    renderEvent(title, subtitle, content, icon) {
        document.getElementById('event-title').innerText = title;
        document.getElementById('event-desc').innerHTML = `<p>${subtitle}</p><p>${content}</p>`;
        if(icon) document.getElementById('event-icon').innerText = icon;
        if(GameState.phase !== 'merchant') document.getElementById('merchant-area').classList.add('hidden');
    },

    setButtons(mainText, mainAction, subText, subAction, disableSub) {
        const b1 = document.getElementById('btn-main');
        const b2 = document.getElementById('btn-sub');
        b1.innerText = mainText;
        b1.onclick = () => Game[mainAction]();
        b2.innerText = subText;
        if (subAction) b2.onclick = () => Game[subAction]();
        b2.disabled = disableSub;
    },

    updateUI() {
        document.getElementById('hp-val').innerText = Player.hp;
        document.getElementById('max-hp-val').innerText = Player.maxHp;
        document.getElementById('atk-val').innerText = this.getAtk();
        document.getElementById('gold-val').innerText = Player.gold;
        document.getElementById('depth-val').innerText = Player.depth;
        
        const buffEl = document.getElementById('buff-display');
        if (Player.buff) {
            const style = Player.buff.type === 'angel' ? 'angel-text' : 'demon-text';
            buffEl.innerHTML = `ç‹€æ…‹: <span class="${style}">${Player.buff.name}</span>`;
        } else {
            buffEl.innerHTML = `ç‹€æ…‹: ç„¡`;
        }

        const w = Player.equipment.weapon;
        const a = Player.equipment.armor;
        const s = Player.equipment.shield;
        
        const wEl = document.getElementById('slot-weapon');
        wEl.innerHTML = w ? `<span class="${CONFIG.rarityDisplay[w.rarity].color}">${w.icon} ${w.name} (+${w.val})</span>` : "ç„¡æ­¦å™¨";
        wEl.className = `equip-slot ${w ? CONFIG.rarityDisplay[w.rarity].color : ''}`;

        const aEl = document.getElementById('slot-armor');
        aEl.innerHTML = a ? `<span class="${CONFIG.rarityDisplay[a.rarity].color}">${a.icon} ${a.name} (+${a.val})</span>` : "ç„¡é˜²å…·";
        aEl.className = `equip-slot ${a ? CONFIG.rarityDisplay[a.rarity].color : ''}`;
        
        const sEl = document.getElementById('slot-shield');
        sEl.innerHTML = s ? `<span class="${CONFIG.rarityDisplay[s.rarity].color}">${s.icon} ${s.name} (${s.val})</span>` : "ç„¡ç›¾ç‰Œ";
        sEl.className = `equip-slot ${s ? CONFIG.rarityDisplay[s.rarity].color : ''}`;

        const list = document.getElementById('backpack-list');
        list.innerHTML = "";
        Player.backpack.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = `item ${CONFIG.rarityDisplay[item.rarity].color}`;
            if (item.rarity === 'epic') div.classList.add('rare-epic');
            if (item.rarity === 'legendary') div.classList.add('rare-legendary');
            div.innerHTML = `${item.icon || 'ğŸ“¦'} ${item.name}`;
            div.onclick = () => this.handleItemClick(idx);
            list.appendChild(div);
        });
    }
};

Game.init();
</script>
</body>
</html>
