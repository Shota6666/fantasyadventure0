<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹»æƒ³å†’éšª / Fantasy Adventure</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-color: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #ff9800;
            --border-radius: 8px;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            
            /* Rarity Colors */
            --common: #b0b0b0;
            --uncommon: #4caf50;
            --rare: #2196f3;
            --epic: #9c27b0;
            --legendary: #ffd700;
            --mythic: #ff0055;
            --ultra: #00ffcc;
            
            /* Buff Colors */
            --buff-angel: #4fc3f7;
            --buff-demon: #ef5350;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 700px;
            background-color: var(--panel-color);
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }

        /* Header & Stats */
        header {
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .lang-select {
            background: #444; color: white; border: 1px solid #666; padding: 4px; border-radius: 4px; font-size: 0.8em;
        }

        .class-badge {
            font-size: 0.8em;
            background: #444;
            padding: 2px 8px;
            border-radius: 4px;
            color: var(--accent-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            background: #222;
            padding: 10px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
        }

        .stat-item span { font-weight: bold; color: var(--accent-color); }
        
        #buff-display {
            grid-column: span 2;
            border-top: 1px solid #444;
            padding-top: 5px;
            margin-top: 5px;
            font-size: 0.85em;
            color: #aaa;
            cursor: help;
            transition: 0.2s;
        }
        #buff-display:hover { background: #333; }

        /* Main Event Area */
        #event-display {
            min-height: 200px;
            background: #222;
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 1px solid #444;
            position: relative;
            overflow: hidden;
        }

        .monster-icon { font-size: 4em; margin-bottom: 10px; display: inline-block; transition: 0.3s; }
        
        /* Glow Effects */
        .glow-blue { filter: drop-shadow(0 0 10px #2196f3); }
        .glow-red { filter: drop-shadow(0 0 15px #f44336); transform: scale(1.1); }
        .glow-purple { filter: drop-shadow(0 0 20px #9c27b0); animation: true-form-pulse 2s infinite; transform: scale(1.3); }

        @keyframes true-form-pulse {
            0% { filter: drop-shadow(0 0 20px #9c27b0); }
            50% { filter: drop-shadow(0 0 40px #e040fb); }
            100% { filter: drop-shadow(0 0 20px #9c27b0); }
        }

        /* Animations */
        @keyframes spawn-pop { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes damage-shake { 0% { transform: translate(0, 0); filter: none; } 20% { transform: translate(-10px, 0) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } 40% { transform: translate(10px, 0) rotate(5deg); } 60% { transform: translate(-5px, 0); } 80% { transform: translate(5px, 0); } 100% { transform: translate(0, 0); filter: none; } }
        @keyframes attack-lunge { 0% { transform: translateY(0) scale(1); } 30% { transform: translateY(20px) scale(1.2); } 100% { transform: translateY(0) scale(1); } }
        @keyframes screen-shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-5px, 5px); } 50% { transform: translate(5px, -5px); } 75% { transform: translate(-5px, -5px); } 100% { transform: translate(0, 0); } }
        @keyframes float-up { 0% { transform: translateY(0) scale(1); opacity: 1; } 50% { transform: translateY(-30px) scale(1.2); opacity: 1; } 100% { transform: translateY(-60px) scale(1); opacity: 0; } }

        .anim-spawn { animation: spawn-pop 0.5s ease-out forwards; }
        .anim-damage { animation: damage-shake 0.4s ease-in-out; }
        .anim-lunge { animation: attack-lunge 0.3s ease-in-out; }
        .anim-screen-shake { animation: screen-shake 0.3s ease-in-out; }

        .floating-text {
            position: absolute; left: 50%; top: 40%; transform: translateX(-50%);
            font-weight: bold; font-size: 1.5em; pointer-events: none;
            text-shadow: 2px 2px 0 #000; z-index: 100;
            animation: float-up 1s ease-out forwards;
        }

        /* Text Styles */
        .damage-text { color: #ff5252; font-weight: bold; }
        .crit-text { color: #ff0000; font-size: 1.2em; font-weight: bold; text-shadow: 0 0 5px #fff; }
        .heal-text { color: #69f0ae; }
        .gold-text { color: #ffd700; }
        .block-text { color: #2196f3; font-weight: bold; }
        .pierce-text { color: #ff9800; font-weight: bold; }
        .angel-text { color: var(--buff-angel); font-weight: bold; }
        .demon-text { color: var(--buff-demon); font-weight: bold; }
        .mythic-text { color: var(--mythic); font-weight: bold; text-shadow: 0 0 5px #fff; }

        /* Controls */
        #controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 12px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; font-weight: bold; transition: 0.2s; background: #444; color: white; }
        button:hover { background: #555; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent-color); color: #000; }
        .btn-primary:hover { background: #ffb74d; }
        
        /* Inventory */
        #inventory-section { background: #222; padding: 10px; border-radius: var(--border-radius); }
        .equipment-slots { display: flex; gap: 5px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #444; }
        .equip-slot { flex: 1; background: #333; padding: 8px; border-radius: 4px; text-align: center; font-size: 0.75em; min-height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #444; }
        
        .inv-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .inv-col h4 { margin: 0 0 5px 0; font-size: 0.85em; color: #888; text-align: center; border-bottom: 1px solid #444; padding-bottom: 3px; }
        .item-list { display: flex; flex-direction: column; gap: 4px; max-height: 200px; overflow-y: auto; min-height: 50px; background: #2a2a2a; padding: 5px; border-radius: 4px; }
        
        .item { padding: 4px 8px; background: #333; border-radius: 3px; font-size: 0.8em; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; gap: 5px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .item:hover { background: #444; }

        /* Rarity */
        .rarity-common { color: var(--common); border-color: #555; }
        .rarity-uncommon { color: var(--uncommon); border-color: var(--uncommon); }
        .rarity-rare { color: var(--rare); border-color: var(--rare); }
        .rarity-epic { color: var(--epic); border-color: var(--epic); box-shadow: 0 0 5px var(--epic); }
        .rarity-legendary { color: var(--legendary); border-color: var(--legendary); box-shadow: 0 0 8px var(--legendary); background: linear-gradient(45deg, #333, #443300); animation: shine 2s infinite linear; }
        .rarity-mythic { color: var(--mythic); border-color: var(--mythic); box-shadow: 0 0 15px var(--mythic); background: #220011; animation: shine 1s infinite linear; }
        .rarity-ultra { color: var(--ultra); border-color: var(--ultra); box-shadow: 0 0 20px var(--ultra); background: #001122; animation: shine 0.5s infinite linear; }
        
        @keyframes shine { 0% { border-color: var(--legendary); } 50% { border-color: #fff; } 100% { border-color: var(--legendary); } }

        /* MERCHANT GRID FIX: 2x2 */
        .merchant-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 8px; 
            width: 100%; 
        }
        
        .merchant-item { display: flex; flex-direction: column; background: #333; padding: 10px; border-radius: 4px; cursor: pointer; border: 1px solid #444; }
        .merchant-item:hover { background: #444; }
        .m-top { display: flex; justify-content: space-between; font-weight: bold; }
        .m-desc { font-size: 0.8em; color: #aaa; margin-top: 4px; }

        /* Modals */
        #class-modal, #achieve-modal, #compendium-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #class-modal { display: flex; }

        .class-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; width: 100%; padding: 20px; }
        .class-card {
            background: #333; padding: 20px; border-radius: 8px; cursor: pointer;
            border: 2px solid #555; text-align: center; transition: 0.2s;
        }
        .class-card:hover { border-color: var(--accent-color); background: #444; transform: translateY(-5px); }
        .class-title { font-size: 1.2em; font-weight: bold; color: var(--accent-color); margin-bottom: 10px; }
        .class-desc { font-size: 0.9em; color: #ccc; }

        /* Achievements & Compendium */
        .achieve-list, .compendium-container { max-height: 70vh; overflow-y: auto; width: 90%; max-width: 600px; background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444; }
        .achieve-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; opacity: 0.5; }
        .achieve-item.unlocked { opacity: 1; background: #2a2a2a; }
        .achieve-info { display: flex; flex-direction: column; }
        .achieve-name { font-weight: bold; font-size: 1.1em; }
        .achieve-cond { font-size: 0.8em; color: #aaa; }
        .achieve-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }

        .compendium-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; padding-top: 10px; }
        .c-item { 
            background: #333; border: 1px solid #444; border-radius: 4px; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; cursor: help; min-height: 80px; position: relative;
        }
        .c-item.unlocked { background: #2d2d2d; }
        .c-item.unknown { background: #222; border-color: #333; opacity: 0.7; filter: grayscale(100%); }
        .c-item.secret-hidden { background: #000; border-color: #000; cursor: default; }
        
        .c-icon { font-size: 2em; margin-bottom: 5px; }
        .c-name { font-size: 0.75em; line-height: 1.2; word-break: break-all; }
        .c-item.unknown .c-name { color: #666; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="class-modal">
    <h2 style="color:white; margin-bottom: 30px;" data-key="title_choose_class">é¸æ“‡ä½ çš„è·æ¥­</h2>
    <div class="class-options">
        <div class="class-card" onclick="Game.selectClass('knight')">
            <div class="class-title" data-key="class_knight">ğŸ›¡ï¸ é¨å£«</div>
            <div class="class-desc" data-key="desc_knight">é–‹å±€è£å‚™<br>ã€Œé¨å£«é•·æ§ã€</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('merchant')">
            <div class="class-title" data-key="class_merchant">ğŸ’° å•†è²©</div>
            <div class="class-desc" data-key="desc_merchant">å‡ºå”®ç‰©å“åƒ¹æ ¼<br>æå‡ç‚º 1.2 å€</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('thief')">
            <div class="class-title" data-key="class_thief">ğŸ—¡ï¸ ç›œè³Š</div>
            <div class="class-desc" data-key="desc_thief">é–‹å•Ÿå¯¶ç®±æ™‚<br>ä¸æœƒé‡åˆ°é™·é˜±æˆ–ç©ºç®±</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('cultist')">
            <div class="class-title" data-key="class_cultist">ğŸ˜ˆ æƒ¡é­”ä¿¡å¾’</div>
            <div class="class-desc" data-key="desc_cultist">é–‹å±€è‡ªå¸¶<br>ä¸€å€‹æƒ¡é­”è©›å’’</div>
        </div>
    </div>
</div>

<div id="achieve-modal">
    <div style="width:90%; max-width:600px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2 style="color:white; margin:0;" data-key="btn_achievements">ğŸ† æˆå°±åˆ—è¡¨</h2>
        <button onclick="document.getElementById('achieve-modal').style.display='none'" style="background:#555;" data-key="btn_close">é—œé–‰</button>
    </div>
    <div id="achieve-stats" style="color:#aaa; margin-bottom:10px;"></div>
    <div class="achieve-list" id="achieve-list-content"></div>
</div>

<div id="compendium-modal">
    <div style="width:90%; max-width:600px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2 style="color:white; margin:0;" data-key="btn_compendium">ğŸ“– ç‰©å“åœ–é‘‘</h2>
        <button onclick="document.getElementById('compendium-modal').style.display='none'" style="background:#555;" data-key="btn_close">é—œé–‰</button>
    </div>
    <div id="compendium-stats" style="color:#aaa; margin-bottom:10px;"></div>
    <div class="compendium-container">
        <div class="compendium-grid" id="compendium-content"></div>
    </div>
</div>

<div id="game-container">
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <div style="font-weight: bold; font-size: 1.2em;">âš”ï¸ <span data-key="game_title">å¹»æƒ³å†’éšª</span></div>
            <button onclick="Game.showAchievements()" style="padding:4px 8px; font-size:0.8em;" data-key="btn_achievements">ğŸ† æˆå°±</button>
            <button onclick="Game.showCompendium()" style="padding:4px 8px; font-size:0.8em; background:#673ab7;" data-key="btn_compendium">ğŸ“– åœ–é‘‘</button>
        </div>
        <div style="display:flex; align-items:center; gap:5px;">
            <div id="class-badge" class="class-badge"></div>
            <select id="lang-select" class="lang-select" onchange="Game.setLang(this.value)">
                <option value="zh">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡</option>
                <option value="en">ğŸ‡ºğŸ‡¸ EN</option>
                <option value="ja">ğŸ‡¯ğŸ‡µ JP</option>
            </select>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-item"><span data-key="stat_hp">ç”Ÿå‘½</span>: <span id="hp-val">100</span> / <span id="max-hp-val">100</span></div>
        <div class="stat-item"><span data-key="stat_atk">æ”»æ“Š</span>: <span id="atk-val">5</span></div>
        <div class="stat-item"><span data-key="stat_gold">é‡‘å¹£</span>: <span id="gold-val">100</span></div>
        <div class="stat-item"><span data-key="stat_depth">æ·±åº¦</span>: <span id="depth-val">0</span> <span data-key="stat_floor">å±¤</span></div>
        <div id="buff-display" title="">ç‹€æ…‹: ç„¡</div>
    </div>

    <div id="event-display">
        <div id="event-icon" class="monster-icon">ğŸ²</div>
        <h3 id="event-title">...</h3>
        <div id="event-desc">...</div>
        <div id="merchant-area" class="hidden"></div>
    </div>

    <div id="controls">
        <button id="btn-main" class="btn-primary" onclick="Game.nextEvent()">...</button>
        <button id="btn-sub" onclick="Game.handleSubAction()" disabled>...</button>
    </div>

    <div id="inventory-section">
        <div class="equipment-slots">
            <div class="equip-slot" id="slot-weapon" onclick="Game.unequip('weapon')">...</div>
            <div class="equip-slot" id="slot-armor" onclick="Game.unequip('armor')">...</div>
            <div class="equip-slot" id="slot-shield" onclick="Game.unequip('shield')">...</div>
        </div>
        
        <div class="inv-container">
            <div class="inv-col">
                <h4 data-key="cat_equip">ğŸ“¦ è£å‚™</h4>
                <div class="item-list" id="inv-equip"></div>
            </div>
            <div class="inv-col">
                <h4 data-key="cat_consum">ğŸ§ª æ¶ˆè€—å“</h4>
                <div class="item-list" id="inv-consum"></div>
            </div>
            <div class="inv-col">
                <h4 data-key="cat_mat">ğŸ§© ç´ æ</h4>
                <div class="item-list" id="inv-mat"></div>
            </div>
        </div>
    </div>

    <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
        <button onclick="Game.manualRestart()" style="width: 100%; background: #d32f2f; opacity: 0.8;" data-key="btn_restart">ğŸ”„ é‡æ–°é–‹å§‹éŠæˆ²</button>
    </div>
</div>

<script>
// --- I18N SYSTEM ---
const TL = {
    zh: {
        game_title: "å¹»æƒ³å†’éšª", title_choose_class: "é¸æ“‡ä½ çš„è·æ¥­",
        class_knight: "ğŸ›¡ï¸ é¨å£«", desc_knight: "é–‹å±€è£å‚™<br>ã€Œé¨å£«é•·æ§ã€",
        class_merchant: "ğŸ’° å•†è²©", desc_merchant: "å‡ºå”®ç‰©å“åƒ¹æ ¼<br>æå‡ç‚º 1.2 å€",
        class_thief: "ğŸ—¡ï¸ ç›œè³Š", desc_thief: "é–‹å•Ÿå¯¶ç®±æ™‚<br>ä¸æœƒé‡åˆ°é™·é˜±æˆ–ç©ºç®±",
        class_cultist: "ğŸ˜ˆ æƒ¡é­”ä¿¡å¾’", desc_cultist: "é–‹å±€è‡ªå¸¶<br>ä¸€å€‹æƒ¡é­”è©›å’’",
        stat_hp: "ç”Ÿå‘½", stat_atk: "æ”»æ“Š", stat_gold: "é‡‘å¹£", stat_depth: "æ·±åº¦", stat_floor: "å±¤",
        buff_label: "ç‹€æ…‹", buff_none: "ç„¡", buff_click: "é»æ“ŠæŸ¥çœ‹è©³ç´°æ•ˆæœ",
        cat_equip: "ğŸ“¦ è£å‚™", cat_consum: "ğŸ§ª æ¶ˆè€—å“", cat_mat: "ğŸ§© ç´ æ",
        btn_achievements: "ğŸ† æˆå°±", btn_compendium: "ğŸ“– åœ–é‘‘", btn_close: "é—œé–‰", btn_restart: "ğŸ”„ é‡æ–°é–‹å§‹éŠæˆ²",
        btn_start: "é–‹å§‹å†’éšª", btn_continue: "ç¹¼çºŒ", btn_leave: "é›¢é–‹", btn_flee: "é€ƒè·‘", btn_fight: "æˆ°é¬¥",
        btn_buy: "è³¼è²·", btn_sell_all: "ä¸€éµå‡ºå”®ç´ æ", btn_open: "æ‰“é–‹", btn_pray: "ç¥ˆç¦±", btn_help: "å¹«åŠ©", btn_ignore: "ç„¡è¦–",
        btn_trade: "äº¤æ˜“", btn_accept: "æ¥å—æŒ‘æˆ°", btn_refuse: "æ‹’çµ•",
        // Events
        evt_prepare: "æº–å‚™å†’éšª", evt_prepare_desc: "è«‹å…ˆé¸æ“‡è·æ¥­...", evt_ready: "æº–å‚™å°±ç·’", evt_ready_desc: "ä½ çš„å†’éšªå³å°‡é–‹å§‹...",
        evt_load: "è®€å–æˆåŠŸ", evt_load_desc: "æ­¡è¿å›åˆ°ç¬¬ {0} å±¤", evt_die: "ä½ æ­»äº†", evt_die_desc: "å†’éšªçµæŸã€‚æœ€çµ‚æ·±åº¦: {0}",
        evt_win: "æˆ°é¬¥å‹åˆ©", evt_win_desc: "ä½ æ“Šæ•—äº†æ•µäººï¼", evt_flee_ok: "é€ƒè·‘æˆåŠŸ", evt_flee_ok_desc: "ä½ æˆåŠŸç”©æ‰äº†æ€ªç‰©ã€‚",
        evt_chest: "ç™¼ç¾å¯¶ç®±", evt_chest_open: "ä½ æ‰“é–‹äº†å¯¶ç®±...", evt_chest_trap: "æ˜¯é™·é˜±ï¼", evt_chest_empty: "è£¡é¢ç©ºç©ºå¦‚ä¹Ÿ...",
        evt_heal: "ä¼‘æ¯æ™‚åˆ»", evt_heal_desc: "ä½ æ‰¾åˆ°ä¸€è™•å®‰å…¨çš„åœ°æ–¹ä¼‘æ¯ã€‚", evt_full_heal: "ç”Ÿå‘½å€¼ <span class='heal-text'>å®Œå…¨æ¢å¾©</span>",
        evt_statue: "ç¥ˆç¦±è–åƒ", evt_statue_desc: "ä½ ç™¼ç¾äº†ä¸€åº§å¤è€çš„è–åƒ...",
        evt_merchant: "ç¥ç§˜å•†äºº", evt_merchant_desc: "ã€Œç´ æå¯æ˜¯å¾ˆå€¼éŒ¢çš„ï¼Œè¦è³£ä¸€äº›å—ï¼Ÿã€",
        evt_harpy: "é­é‡å“ˆæ¯”", evt_harpy_desc: "ä¸€éš»å“ˆæ¯”çªç„¶å¾ç©ºä¸­è¥²ä¾†ï¼",
        msg_equip: "è£å‚™äº† {0}", msg_unequip: "å¸ä¸‹äº† {0}", msg_sell: "å‡ºå”® {0} ç²å¾— {1} G", msg_buy: "è³¼è²·äº† {0}",
        msg_gain_gold: "ç²å¾—äº† <span class='gold-text'>{0} G</span>", msg_pain: "å—åˆ°äº† <span class='damage-text'>{0}</span> é»å‚·å®³",
        // Rarity
        rarity_common: "ä¸€èˆ¬", rarity_uncommon: "å„ªè³ª", rarity_rare: "ç¨€æœ‰", rarity_epic: "å²è©©",
        rarity_legendary: "å‚³èªª", rarity_mythic: "ç¥è©±", rarity_ultra: "æ¥µå‚³èªª",
        // Slots
        slot_weapon: "ç„¡æ­¦å™¨", slot_armor: "ç„¡é˜²å…·", slot_shield: "ç„¡ç›¾ç‰Œ",
        // Items & Monsters (Mapping keys to translations)
        "å²èŠå§†": "å²èŠå§†", "å“¥å¸ƒæ—": "å“¥å¸ƒæ—", "ç‹‚ç‹¼": "ç‹‚ç‹¼", "éª·é«å…µ": "éª·é«å…µ", "åŠç¸äºº": "åŠç¸äºº",
        "å¹½éˆ": "å¹½éˆ", "çŸ³å·¨äºº": "çŸ³å·¨äºº", "é£Ÿäººå¦–": "é£Ÿäººå¦–", "é›™è¶³é£›é¾": "é›™è¶³é£›é¾", "é­”ç‹": "é­”ç‹", "é­”ç‹çœŸèº«": "é­”ç‹çœŸèº«",
        "æ²»ç™‚è—¥æ°´": "æ²»ç™‚è—¥æ°´", "å¼·åŠ›è—¥æ°´": "å¼·åŠ›è—¥æ°´", "ç²¾éˆè—¥åŠ‘": "ç²¾éˆè—¥åŠ‘",
        "ç”Ÿé½åŒ•é¦–": "ç”Ÿé½åŒ•é¦–", "æœ¨æ£’": "æœ¨æ£’", "é¨å£«é•·æ§": "é¨å£«é•·æ§", "ç§˜éŠ€åŠ": "ç§˜éŠ€åŠ", "å± é¾åŠ": "å± é¾åŠ", "è–åŠ Excalibur": "è–åŠ Excalibur",
        "å¸ƒè¡£": "å¸ƒè¡£", "é–å­ç”²": "é–å­ç”²", "æ¿ç”²": "æ¿ç”²", "é¾é±—é§ç”²": "é¾é±—é§ç”²", "ç¥ä¹‹å…‰è¼": "ç¥ä¹‹å…‰è¼",
        "é¨å£«ç›¾": "é¨å£«ç›¾", "å¡”ç›¾": "å¡”ç›¾", "åŸƒç™¸æ–¯ä¹‹ç›¾": "åŸƒç™¸æ–¯ä¹‹ç›¾",
        "ä¸æ­»é³¥çš„ç¾½æ¯›": "ä¸æ­»é³¥çš„ç¾½æ¯›", "çœŸå¯¦ä¹‹å¿ƒ": "çœŸå¯¦ä¹‹å¿ƒ",
        // Loot
        "å²èŠå§†é»æ¶²": "å²èŠå§†é»æ¶²", "å²èŠå§†ç²¾è¯": "å²èŠå§†ç²¾è¯", "å²èŠå§†ç‹å† ": "å²èŠå§†ç‹å† ",
        "ç ´å¸ƒ": "ç ´å¸ƒ", "å“¥å¸ƒæ—è€³ç’°": "å“¥å¸ƒæ—è€³ç’°", "å“¥å¸ƒæ—é‡‘ç‰™": "å“¥å¸ƒæ—é‡‘ç‰™",
        "ç‹¼çš®": "ç‹¼çš®", "ç‹¼ç‰™": "ç‹¼ç‰™", "ç‹¼ç‹æŠ«é¢¨": "ç‹¼ç‹æŠ«é¢¨",
        "éª¨é ­": "éª¨é ­", "éˆé­‚ç¢ç‰‡": "éˆé­‚ç¢ç‰‡", "æ­»éˆé ­éª¨": "æ­»éˆé ­éª¨",
        "æ–·åŠ": "æ–·åŠ", "åŠç¸äººè­·ç¬¦": "åŠç¸äººè­·ç¬¦", "æˆ°çˆ­è™Ÿè§’": "æˆ°çˆ­è™Ÿè§’",
        "éˆè³ª": "éˆè³ª", "æ€¨å¿µé›†åˆé«”": "æ€¨å¿µé›†åˆé«”", "å¹½éˆæç‡ˆ": "å¹½éˆæç‡ˆ",
        "çŸ³å¡Š": "çŸ³å¡Š", "é­”åŠ›æ ¸å¿ƒ": "é­”åŠ›æ ¸å¿ƒ", "å¤§åœ°ä¹‹å¿ƒ": "å¤§åœ°ä¹‹å¿ƒ",
        "å·¨æ£’": "å·¨æ£’", "é£Ÿäººå¦–ä¹‹è¡€": "é£Ÿäººå¦–ä¹‹è¡€", "é£Ÿäººå¦–åœ–é¨°": "é£Ÿäººå¦–åœ–é¨°",
        "é¾é±—": "é¾é±—", "é¾ä¹‹æ·š": "é¾ä¹‹æ·š", "é¾å¿ƒ": "é¾å¿ƒ",
        "é»‘æš—ç‰©è³ª": "é»‘æš—ç‰©è³ª", "é­”ç‹å°è¨˜": "é­”ç‹å°è¨˜", "é­”ç¥ä¹‹çœ¼": "é­”ç¥ä¹‹çœ¼"
    },
    en: {
        game_title: "Fantasy Adventure", title_choose_class: "Choose Class",
        class_knight: "ğŸ›¡ï¸ Knight", desc_knight: "Starts with<br>'Knight Lance'",
        class_merchant: "ğŸ’° Merchant", desc_merchant: "Sell items for<br>1.2x Price",
        class_thief: "ğŸ—¡ï¸ Thief", desc_thief: "No traps/empty chests<br>when opening chests",
        class_cultist: "ğŸ˜ˆ Cultist", desc_cultist: "Starts with<br>a random Curse",
        stat_hp: "HP", stat_atk: "ATK", stat_gold: "Gold", stat_depth: "Depth", stat_floor: "F",
        buff_label: "Buff", buff_none: "None", buff_click: "Click for details",
        cat_equip: "ğŸ“¦ Equipment", cat_consum: "ğŸ§ª Potions", cat_mat: "ğŸ§© Materials",
        btn_achievements: "ğŸ† Trophies", btn_compendium: "ğŸ“– Book", btn_close: "Close", btn_restart: "ğŸ”„ Restart Game",
        btn_start: "Start Adventure", btn_continue: "Continue", btn_leave: "Leave", btn_flee: "Flee", btn_fight: "Fight",
        btn_buy: "Buy", btn_sell_all: "Sell All Mats", btn_open: "Open", btn_pray: "Pray", btn_help: "Help", btn_ignore: "Ignore",
        btn_trade: "Trade", btn_accept: "Accept", btn_refuse: "Refuse",
        // Events
        evt_prepare: "Prepare", evt_prepare_desc: "Choose your class first...", evt_ready: "Ready", evt_ready_desc: "Adventure begins...",
        evt_load: "Loaded", evt_load_desc: "Welcome back to Floor {0}", evt_die: "You Died", evt_die_desc: "Game Over. Depth: {0}",
        evt_win: "Victory", evt_win_desc: "Enemy defeated!", evt_flee_ok: "Escaped", evt_flee_ok_desc: "You ran away safely.",
        evt_chest: "Chest Found", evt_chest_open: "Opening chest...", evt_chest_trap: "It's a trap!", evt_chest_empty: "It's empty...",
        evt_heal: "Rest Site", evt_heal_desc: "Safe place to rest.", evt_full_heal: "HP <span class='heal-text'>Fully Restored</span>",
        evt_statue: "Ancient Statue", evt_statue_desc: "An ancient statue appears...",
        evt_merchant: "Merchant", evt_merchant_desc: "'Materials are valuable, selling any?'",
        evt_harpy: "Harpy Attack", evt_harpy_desc: "A Harpy swoops down!",
        msg_equip: "Equipped {0}", msg_unequip: "Unequipped {0}", msg_sell: "Sold {0} for {1} G", msg_buy: "Bought {0}",
        msg_gain_gold: "Gained <span class='gold-text'>{0} G</span>", msg_pain: "Took <span class='damage-text'>{0}</span> damage",
        // Rarity
        rarity_common: "Common", rarity_uncommon: "Uncommon", rarity_rare: "Rare", rarity_epic: "Epic",
        rarity_legendary: "Legendary", rarity_mythic: "Mythic", rarity_ultra: "Ultra",
        // Slots
        slot_weapon: "No Weapon", slot_armor: "No Armor", slot_shield: "No Shield",
        // Items & Monsters
        "å²èŠå§†": "Slime", "å“¥å¸ƒæ—": "Goblin", "ç‹‚ç‹¼": "Dire Wolf", "éª·é«å…µ": "Skeleton", "åŠç¸äºº": "Orc",
        "å¹½éˆ": "Ghost", "çŸ³å·¨äºº": "Golem", "é£Ÿäººå¦–": "Troll", "é›™è¶³é£›é¾": "Wyvern", "é­”ç‹": "Demon King", "é­”ç‹çœŸèº«": "True Demon King",
        "æ²»ç™‚è—¥æ°´": "Health Potion", "å¼·åŠ›è—¥æ°´": "Strong Potion", "ç²¾éˆè—¥åŠ‘": "Elixir",
        "ç”Ÿé½åŒ•é¦–": "Rusty Dagger", "æœ¨æ£’": "Club", "é¨å£«é•·æ§": "Knight Lance", "ç§˜éŠ€åŠ": "Mithril Sword", "å± é¾åŠ": "Dragon Slayer", "è–åŠ Excalibur": "Excalibur",
        "å¸ƒè¡£": "Cloth", "é–å­ç”²": "Chainmail", "æ¿ç”²": "Plate Armor", "é¾é±—é§ç”²": "Dragon Armor", "ç¥ä¹‹å…‰è¼": "Divine Armor",
        "é¨å£«ç›¾": "Knight Shield", "å¡”ç›¾": "Tower Shield", "åŸƒç™¸æ–¯ä¹‹ç›¾": "Aegis Shield",
        "ä¸æ­»é³¥çš„ç¾½æ¯›": "Phoenix Feather", "çœŸå¯¦ä¹‹å¿ƒ": "True Heart",
        // Loot
        "å²èŠå§†é»æ¶²": "Slime Gel", "å²èŠå§†ç²¾è¯": "Slime Essence", "å²èŠå§†ç‹å† ": "Slime Crown",
        "ç ´å¸ƒ": "Rag", "å“¥å¸ƒæ—è€³ç’°": "Goblin Ring", "å“¥å¸ƒæ—é‡‘ç‰™": "Golden Tooth",
        "ç‹¼çš®": "Wolf Pelt", "ç‹¼ç‰™": "Wolf Fang", "ç‹¼ç‹æŠ«é¢¨": "Wolf Cape",
        "éª¨é ­": "Bone", "éˆé­‚ç¢ç‰‡": "Soul Shard", "æ­»éˆé ­éª¨": "Necro Skull",
        "æ–·åŠ": "Broken Sword", "åŠç¸äººè­·ç¬¦": "Orc Amulet", "æˆ°çˆ­è™Ÿè§’": "War Horn",
        "éˆè³ª": "Ectoplasm", "æ€¨å¿µé›†åˆé«”": "Grudge Mass", "å¹½éˆæç‡ˆ": "Ghost Lantern",
        "çŸ³å¡Š": "Stone", "é­”åŠ›æ ¸å¿ƒ": "Mana Core", "å¤§åœ°ä¹‹å¿ƒ": "Earth Heart",
        "å·¨æ£’": "Big Club", "é£Ÿäººå¦–ä¹‹è¡€": "Troll Blood", "é£Ÿäººå¦–åœ–é¨°": "Troll Totem",
        "é¾é±—": "Dragon Scale", "é¾ä¹‹æ·š": "Dragon Tear", "é¾å¿ƒ": "Dragon Heart",
        "é»‘æš—ç‰©è³ª": "Dark Matter", "é­”ç‹å°è¨˜": "Demon Mark", "é­”ç¥ä¹‹çœ¼": "Demon Eye"
    },
    ja: {
        game_title: "å¹»æƒ³å†’é™º", title_choose_class: "è·æ¥­ã‚’é¸æŠ",
        class_knight: "ğŸ›¡ï¸ é¨å£«", desc_knight: "åˆæœŸè£…å‚™<br>ã€Œé¨å£«ã®æ§ã€",
        class_merchant: "ğŸ’° å•†äºº", desc_merchant: "ã‚¢ã‚¤ãƒ†ãƒ å£²å´ä¾¡æ ¼<br>1.2å€",
        class_thief: "ğŸ—¡ï¸ ç›—è³Š", desc_thief: "å®ç®±ã®ç½ ã‚„<br>ç©ºç®±ã‚’å›é¿",
        class_cultist: "ğŸ˜ˆ ç‹‚ä¿¡è€…", desc_cultist: "ãƒ©ãƒ³ãƒ€ãƒ ãªå‘ªã„ã‚’<br>æ‰€æŒã—ã¦é–‹å§‹",
        stat_hp: "HP", stat_atk: "æ”»æ’ƒ", stat_gold: "G", stat_depth: "æ·±åº¦", stat_floor: "å±¤",
        buff_label: "çŠ¶æ…‹", buff_none: "ãªã—", buff_click: "ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°",
        cat_equip: "ğŸ“¦ è£…å‚™", cat_consum: "ğŸ§ª é“å…·", cat_mat: "ğŸ§© ç´ æ",
        btn_achievements: "ğŸ† å®Ÿç¸¾", btn_compendium: "ğŸ“– å›³é‘‘", btn_close: "é–‰ã˜ã‚‹", btn_restart: "ğŸ”„ æœ€åˆã‹ã‚‰",
        btn_start: "å†’é™ºé–‹å§‹", btn_continue: "æ¬¡ã¸", btn_leave: "ç«‹ã¡å»ã‚‹", btn_flee: "é€ƒã’ã‚‹", btn_fight: "æˆ¦ã†",
        btn_buy: "è³¼å…¥", btn_sell_all: "ç´ æå…¨å£²å´", btn_open: "é–‹ã‘ã‚‹", btn_pray: "ç¥ˆã‚‹", btn_help: "åŠ©ã‘ã‚‹", btn_ignore: "ç„¡è¦–",
        btn_trade: "å–å¼•", btn_accept: "å—ã‘ã‚‹", btn_refuse: "æ–­ã‚‹",
        // Events
        evt_prepare: "å†’é™ºæº–å‚™", evt_prepare_desc: "è·æ¥­ã‚’é¸ã‚“ã§ãã ã•ã„...", evt_ready: "æº–å‚™å®Œäº†", evt_ready_desc: "å†’é™ºãŒå§‹ã¾ã‚Šã¾ã™...",
        evt_load: "ãƒ­ãƒ¼ãƒ‰å®Œäº†", evt_load_desc: "åœ°ä¸‹ {0} å±¤ã¸ã‚ˆã†ã“ã", evt_die: "æ­»äº¡", evt_die_desc: "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã€‚åˆ°é”æ·±åº¦: {0}",
        evt_win: "å‹åˆ©", evt_win_desc: "æ•µã‚’å€’ã—ãŸï¼", evt_flee_ok: "é€ƒèµ°æˆåŠŸ", evt_flee_ok_desc: "ç„¡äº‹ã«é€ƒã’åˆ‡ã£ãŸã€‚",
        evt_chest: "å®ç®±ç™ºè¦‹", evt_chest_open: "å®ç®±ã‚’é–‹ã‘ãŸ...", evt_chest_trap: "ç½ ã ï¼", evt_chest_empty: "ç©ºã£ã½ã ã£ãŸ...",
        evt_heal: "ä¼‘æ†©æ‰€", evt_heal_desc: "å®‰å…¨ãªå ´æ‰€ã‚’è¦‹ã¤ã‘ãŸã€‚", evt_full_heal: "HPãŒ <span class='heal-text'>å…¨å›å¾©</span> ã—ãŸ",
        evt_statue: "å¤ã®çŸ³åƒ", evt_statue_desc: "å¤ã³ãŸçŸ³åƒã‚’è¦‹ã¤ã‘ãŸ...",
        evt_merchant: "è¬ã®å•†äºº", evt_merchant_desc: "ã€Œç´ æã¯é«˜ãè²·ã†ã‚ˆã€å£²ã‚‰ãªã„ã‹ï¼Ÿã€",
        evt_harpy: "ãƒãƒ¼ãƒ”ãƒ¼è¥²æ¥", evt_harpy_desc: "ãƒãƒ¼ãƒ”ãƒ¼ãŒç©ºã‹ã‚‰è¥²ã£ã¦ããŸï¼",
        msg_equip: "{0} ã‚’è£…å‚™ã—ãŸ", msg_unequip: "{0} ã‚’å¤–ã—ãŸ", msg_sell: "{0} ã‚’ {1} G ã§å£²å´", msg_buy: "{0} ã‚’è³¼å…¥",
        msg_gain_gold: "<span class='gold-text'>{0} G</span> ã‚’æ‰‹ã«å…¥ã‚ŒãŸ", msg_pain: "<span class='damage-text'>{0}</span> ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸ",
        // Rarity
        rarity_common: "ä¸€èˆ¬", rarity_uncommon: "é«˜ç´š", rarity_rare: "å¸Œå°‘", rarity_epic: "å²è©©",
        rarity_legendary: "ä¼èª¬", rarity_mythic: "ç¥è©±", rarity_ultra: "æ¥µä¼èª¬",
        // Slots
        slot_weapon: "æ­¦å™¨ãªã—", slot_armor: "é˜²å…·ãªã—", slot_shield: "ç›¾ãªã—",
        // Items & Monsters
        "å²èŠå§†": "ã‚¹ãƒ©ã‚¤ãƒ ", "å“¥å¸ƒæ—": "ã‚´ãƒ–ãƒªãƒ³", "ç‹‚ç‹¼": "ãƒ€ã‚¤ã‚¢ã‚¦ãƒ«ãƒ•", "éª·é«å…µ": "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", "åŠç¸äºº": "ã‚ªãƒ¼ã‚¯",
        "å¹½éˆ": "ã‚´ãƒ¼ã‚¹ãƒˆ", "çŸ³å·¨äºº": "ã‚´ãƒ¼ãƒ¬ãƒ ", "é£Ÿäººå¦–": "ãƒˆãƒ­ãƒ¼ãƒ«", "é›™è¶³é£›é¾": "ãƒ¯ã‚¤ãƒãƒ¼ãƒ³", "é­”ç‹": "é­”ç‹", "é­”ç‹çœŸèº«": "çœŸã®é­”ç‹",
        "æ²»ç™‚è—¥æ°´": "å›å¾©è–¬", "å¼·åŠ›è—¥æ°´": "å¼·åŠ›å›å¾©è–¬", "ç²¾éˆè—¥åŠ‘": "ã‚¨ãƒªã‚¯ã‚µãƒ¼",
        "ç”Ÿé½åŒ•é¦–": "éŒ†ã³ãŸçŸ­å‰£", "æœ¨æ£’": "æ£æ£’", "é¨å£«é•·æ§": "é¨å£«ã®æ§", "ç§˜éŠ€åŠ": "ãƒŸã‚¹ãƒªãƒ«å‰£", "å± é¾åŠ": "ãƒ‰ãƒ©ã‚´ãƒ³ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼", "è–åŠ Excalibur": "è–å‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼",
        "å¸ƒè¡£": "å¸ƒã®æœ", "é–å­ç”²": "ãƒã‚§ãƒ¼ãƒ³ãƒ¡ã‚¤ãƒ«", "æ¿ç”²": "ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¢ãƒ¼ãƒãƒ¼", "é¾é±—é§ç”²": "ç«œé±—ã®é§", "ç¥ä¹‹å…‰è¼": "ç¥ã®è¼ã",
        "é¨å£«ç›¾": "é¨å£«ã®ç›¾", "å¡”ç›¾": "ã‚¿ãƒ¯ãƒ¼ã‚·ãƒ¼ãƒ«ãƒ‰", "åŸƒç™¸æ–¯ä¹‹ç›¾": "ã‚¤ãƒ¼ã‚¸ã‚¹ã®ç›¾",
        "ä¸æ­»é³¥çš„ç¾½æ¯›": "ä¸æ­»é³¥ã®ç¾½æ ¹", "çœŸå¯¦ä¹‹å¿ƒ": "çœŸå®Ÿã®å¿ƒ",
        // Loot
        "å²èŠå§†é»æ¶²": "ã‚¹ãƒ©ã‚¤ãƒ ã®ç²˜æ¶²", "å²èŠå§†ç²¾è¯": "ã‚¹ãƒ©ã‚¤ãƒ ã®ç²¾è¯", "å²èŠå§†ç‹å† ": "ã‚¹ãƒ©ã‚¤ãƒ ã®ç‹å† ",
        "ç ´å¸ƒ": "ãƒœãƒ­å¸ƒ", "å“¥å¸ƒæ—è€³ç’°": "ã‚´ãƒ–ãƒªãƒ³ã®æŒ‡è¼ª", "å“¥å¸ƒæ—é‡‘ç‰™": "ã‚´ãƒ–ãƒªãƒ³ã®é‡‘æ­¯",
        "ç‹¼çš®": "ç‹¼ã®çš®", "ç‹¼ç‰™": "ç‹¼ã®ç‰™", "ç‹¼ç‹æŠ«é¢¨": "ç‹¼ç‹ã®ãƒãƒ³ãƒˆ",
        "éª¨é ­": "éª¨", "éˆé­‚ç¢ç‰‡": "é­‚ã®æ¬ ç‰‡", "æ­»éˆé ­éª¨": "æ­»éœŠã®é ­éª¨",
        "æ–·åŠ": "æŠ˜ã‚ŒãŸå‰£", "åŠç¸äººè­·ç¬¦": "ã‚ªãƒ¼ã‚¯ã®ã‚¢ãƒŸãƒ¥ãƒ¬ãƒƒãƒˆ", "æˆ°çˆ­è™Ÿè§’": "æˆ¦äº‰ã®è§’ç¬›",
        "éˆè³ª": "ã‚¨ã‚¯ãƒˆãƒ—ãƒ©ã‚ºãƒ ", "æ€¨å¿µé›†åˆé«”": "æ€¨å¿µã®é›†åˆä½“", "å¹½éˆæç‡ˆ": "å¹½éœŠã®ãƒ©ãƒ³ã‚¿ãƒ³",
        "çŸ³å¡Š": "çŸ³ã“ã‚", "é­”åŠ›æ ¸å¿ƒ": "ãƒãƒŠã®æ ¸", "å¤§åœ°ä¹‹å¿ƒ": "å¤§åœ°ã®å¿ƒ",
        "å·¨æ£’": "å·¨å¤§ãªæ£æ£’", "é£Ÿäººå¦–ä¹‹è¡€": "ãƒˆãƒ­ãƒ¼ãƒ«ã®è¡€", "é£Ÿäººå¦–åœ–é¨°": "ãƒˆãƒ­ãƒ¼ãƒ«ã®ãƒˆãƒ¼ãƒ†ãƒ ",
        "é¾é±—": "ç«œã®é±—", "é¾ä¹‹æ·š": "ç«œã®æ¶™", "é¾å¿ƒ": "ç«œã®å¿ƒè‡“",
        "é»‘æš—ç‰©è³ª": "ãƒ€ãƒ¼ã‚¯ãƒã‚¿ãƒ¼", "é­”ç‹å°è¨˜": "é­”ç‹ã®å°", "é­”ç¥ä¹‹çœ¼": "é­”ç¥ã®ç³"
    }
};

const CONFIG = {
    rarityProb: { common: 0.5, uncommon: 0.3, rare: 0.15, epic: 0.04, legendary: 0.01 },
    rarityDisplay: {
        common: { color: "rarity-common", key: "rarity_common", val: 1 },
        uncommon: { color: "rarity-uncommon", key: "rarity_uncommon", val: 2 },
        rare: { color: "rarity-rare", key: "rarity_rare", val: 3 },
        epic: { color: "rarity-epic", key: "rarity_epic", val: 4 },
        legendary: { color: "rarity-legendary", key: "rarity_legendary", val: 5 },
        mythic: { color: "rarity-mythic", key: "rarity_mythic", val: 6 },
        ultra: { color: "rarity-ultra", key: "rarity_ultra", val: 7 }
    },
    buffs: {
        angel_song: { id: 'angel_song', name: 'ğŸ‘¼ å¤©ä½¿çš„æ­Œé Œ', type: 'angel', desc: 'æ¯æ¬¡äº‹ä»¶æ¢å¾© 5 HP' },
        angel_protection: { id: 'angel_protection', name: 'ğŸ›¡ï¸ å¤©ä½¿çš„åŠ è­·', type: 'angel', desc: 'æ€ªç‰©é€ æˆçš„å‚·å®³æ¸›å°‘ 30%' },
        angel_courage: { id: 'angel_courage', name: 'âš”ï¸ å¤©ä½¿çš„å‹‡æ°£', type: 'angel', desc: 'è‡´å‘½ä¸€æ“Šæ©Ÿç‡æå‡è‡³ 20%' },
        angel_wings: { id: 'angel_wings', name: 'ğŸ•Šï¸ å¤©ä½¿çš„ç¿…è†€', type: 'angel', desc: 'é€ƒè·‘æˆåŠŸç‡æå‡è‡³ 60%' },
        demon_wealth: { id: 'demon_wealth', name: 'ğŸ’° æƒ¡é­”çš„è²¡å¯Œ', type: 'demon', desc: 'æ”»æ“Šå¾—5é‡‘å¹£ï¼Œä½†é€ƒè·‘å¤±æ•—è¢«æ”»æ“Šæ™‚æ‰£5é‡‘å¹£' },
        demon_destruction: { id: 'demon_destruction', name: 'ğŸ’€ æƒ¡é­”çš„ç ´å£', type: 'demon', desc: '10%æ©Ÿç‡ç§’æ®ºæ€ªç‰©ï¼Œè§¸ç™¼å¾Œæ‰£é™¤ç•¶å‰è¡€é‡90%' },
        demon_enhance: { id: 'demon_enhance', name: 'ğŸ”¥ æƒ¡é­”çš„å¼·åŒ–', type: 'demon', desc: 'é›™æ–¹è‡´å‘½ä¸€æ“Šæ©Ÿç‡è®Šç‚º 50%' },
        demon_wager: { id: 'demon_wager', name: 'ğŸ² æƒ¡é­”çš„è³­ç´„', type: 'demon', desc: 'é€ƒè·‘ç‡80%ï¼Œä½†æ¯æ¬¡é€ƒè·‘æœ‰1%æ©Ÿç‡ç›´æ¥æ­»äº¡' }
    },
    monsters: [
        { name: "å²èŠå§†", weight: 13.5, baseGold: 1, icon: "ğŸ¦ ", hp: 20, atk: 3, drop: "å²èŠå§†é»æ¶²", eliteDrop: "å²èŠå§†ç²¾è¯", bossDrop: "å²èŠå§†ç‹å† " },
        { name: "å“¥å¸ƒæ—", weight: 13.5, baseGold: 2, icon: "ğŸ‘º", hp: 35, atk: 5, drop: "ç ´å¸ƒ", eliteDrop: "å“¥å¸ƒæ—è€³ç’°", bossDrop: "å“¥å¸ƒæ—é‡‘ç‰™" },
        { name: "ç‹‚ç‹¼", weight: 13.5, baseGold: 3, icon: "ğŸº", hp: 50, atk: 8, drop: "ç‹¼çš®", eliteDrop: "ç‹¼ç‰™", bossDrop: "ç‹¼ç‹æŠ«é¢¨" },
        { name: "éª·é«å…µ", weight: 13.5, baseGold: 4, icon: "ğŸ’€", hp: 60, atk: 10, drop: "éª¨é ­", eliteDrop: "éˆé­‚ç¢ç‰‡", bossDrop: "æ­»éˆé ­éª¨" },
        { name: "åŠç¸äºº", weight: 13.5, baseGold: 8, icon: "ğŸ‘¹", hp: 90, atk: 12, drop: "æ–·åŠ", eliteDrop: "åŠç¸äººè­·ç¬¦", bossDrop: "æˆ°çˆ­è™Ÿè§’" },
        { name: "å¹½éˆ", weight: 13.5, baseGold: 10, icon: "ğŸ‘»", hp: 70, atk: 15, drop: "éˆè³ª", eliteDrop: "æ€¨å¿µé›†åˆé«”", bossDrop: "å¹½éˆæç‡ˆ" },
        { name: "çŸ³å·¨äºº", weight: 10, baseGold: 15, icon: "ğŸ—¿", hp: 150, atk: 20, drop: "çŸ³å¡Š", eliteDrop: "é­”åŠ›æ ¸å¿ƒ", bossDrop: "å¤§åœ°ä¹‹å¿ƒ" },
        { name: "é£Ÿäººå¦–", weight: 5, baseGold: 25, icon: "ğŸ§Ÿ", hp: 200, atk: 25, drop: "å·¨æ£’", eliteDrop: "é£Ÿäººå¦–ä¹‹è¡€", bossDrop: "é£Ÿäººå¦–åœ–é¨°" },
        { name: "é›™è¶³é£›é¾", weight: 3, baseGold: 40, icon: "ğŸ‰", hp: 300, atk: 35, drop: "é¾é±—", eliteDrop: "é¾ä¹‹æ·š", bossDrop: "é¾å¿ƒ" },
        { name: "é­”ç‹", weight: 1, baseGold: 50, icon: "ğŸ‘¿", hp: 500, atk: 50, drop: "é»‘æš—ç‰©è³ª", eliteDrop: "é­”ç‹å°è¨˜", bossDrop: "é­”ç¥ä¹‹çœ¼" }
    ],
    lootData: {
        "å²èŠå§†é»æ¶²": { price: 10, rarity: "common", icon: "ğŸ’§" },
        "å²èŠå§†ç²¾è¯": { price: 50, rarity: "uncommon", icon: "âœ¨" },
        "å²èŠå§†ç‹å† ": { price: 200, rarity: "rare", icon: "ğŸ‘‘" },
        "ç ´å¸ƒ": { price: 15, rarity: "common", icon: "ğŸ§¶" },
        "å“¥å¸ƒæ—è€³ç’°": { price: 60, rarity: "uncommon", icon: "ğŸ’" },
        "å“¥å¸ƒæ—é‡‘ç‰™": { price: 250, rarity: "rare", icon: "ğŸ¦·" },
        "ç‹¼çš®": { price: 20, rarity: "common", icon: "ğŸ§µ" },
        "ç‹¼ç‰™": { price: 80, rarity: "uncommon", icon: "ğŸ¦´" },
        "ç‹¼ç‹æŠ«é¢¨": { price: 300, rarity: "rare", icon: "ğŸ§£" },
        "éª¨é ­": { price: 25, rarity: "common", icon: "ğŸ¦´" },
        "éˆé­‚ç¢ç‰‡": { price: 100, rarity: "uncommon", icon: "ğŸ‘»" },
        "æ­»éˆé ­éª¨": { price: 350, rarity: "rare", icon: "ğŸ’€" },
        "æ–·åŠ": { price: 30, rarity: "common", icon: "ğŸ—¡ï¸" },
        "åŠç¸äººè­·ç¬¦": { price: 120, rarity: "uncommon", icon: "ğŸ§¿" },
        "æˆ°çˆ­è™Ÿè§’": { price: 400, rarity: "rare", icon: "ğŸ“¯" },
        "éˆè³ª": { price: 35, rarity: "common", icon: "ğŸŒ«ï¸" },
        "æ€¨å¿µé›†åˆé«”": { price: 150, rarity: "uncommon", icon: "ğŸ‘¿" },
        "å¹½éˆæç‡ˆ": { price: 450, rarity: "rare", icon: "ğŸ®" },
        "çŸ³å¡Š": { price: 50, rarity: "common", icon: "ğŸª¨" },
        "é­”åŠ›æ ¸å¿ƒ": { price: 200, rarity: "rare", icon: "ğŸ”®" },
        "å¤§åœ°ä¹‹å¿ƒ": { price: 600, rarity: "epic", icon: "ğŸ’" },
        "å·¨æ£’": { price: 60, rarity: "common", icon: "ğŸªµ" },
        "é£Ÿäººå¦–ä¹‹è¡€": { price: 250, rarity: "rare", icon: "ğŸ©¸" },
        "é£Ÿäººå¦–åœ–é¨°": { price: 700, rarity: "epic", icon: "ğŸ—¿" },
        "é¾é±—": { price: 100, rarity: "uncommon", icon: "ğŸ›¡ï¸" },
        "é¾ä¹‹æ·š": { price: 400, rarity: "rare", icon: "ğŸ’§" },
        "é¾å¿ƒ": { price: 800, rarity: "epic", icon: "â¤ï¸" },
        "é»‘æš—ç‰©è³ª": { price: 200, rarity: "rare", icon: "âš«" },
        "é­”ç‹å°è¨˜": { price: 500, rarity: "epic", icon: "ğŸ”¯" },
        "é­”ç¥ä¹‹çœ¼": { price: 1000, rarity: "legendary", icon: "ğŸ‘ï¸" },
        "çœŸå¯¦ä¹‹å¿ƒ": { price: 5000, rarity: "mythic", icon: "ğŸ’–" }
    },
    itemPool: [
        { name: "ç”Ÿé½åŒ•é¦–", type: "weapon", val: 3, rarity: "common", price: 15, icon: "ğŸ—¡ï¸" },
        { name: "æœ¨æ£’", type: "weapon", val: 4, rarity: "common", price: 20, icon: "ğŸªµ" },
        { name: "å¸ƒè¡£", type: "armor", val: 10, rarity: "common", price: 15, icon: "ğŸ‘•" },
        { name: "æ²»ç™‚è—¥æ°´", type: "consumable", val: 30, rarity: "common", price: 25, icon: "ğŸ§ª", desc: "æ¢å¾©30é»ç”Ÿå‘½" },
        { name: "é¨å£«é•·æ§", type: "weapon", val: 12, rarity: "uncommon", price: 80, icon: "ğŸ”±" },
        { name: "é–å­ç”²", type: "armor", val: 40, rarity: "uncommon", price: 80, icon: "ğŸ›¡ï¸" },
        { name: "å¼·åŠ›è—¥æ°´", type: "consumable", val: 80, rarity: "uncommon", price: 60, icon: "ğŸ·", desc: "æ¢å¾©80é»ç”Ÿå‘½" },
        { name: "ç§˜éŠ€åŠ", type: "weapon", val: 30, rarity: "rare", price: 250, icon: "âš”ï¸" },
        { name: "æ¿ç”²", type: "armor", val: 100, rarity: "rare", price: 250, icon: "ğŸ›¡ï¸" },
        { name: "é¨å£«ç›¾", type: "shield", val: 2, rarity: "rare", price: 300, icon: "ğŸ›¡ï¸" },
        { name: "ç²¾éˆè—¥åŠ‘", type: "consumable", val: 200, rarity: "rare", price: 150, icon: "ğŸ§‰", desc: "æ¢å¾©200é»ç”Ÿå‘½" },
        { name: "å± é¾åŠ", type: "weapon", val: 60, rarity: "epic", price: 800, icon: "ğŸ‰" },
        { name: "é¾é±—é§ç”²", type: "armor", val: 250, rarity: "epic", price: 800, icon: "ğŸ¥‹" },
        { name: "å¡”ç›¾", type: "shield", val: 5, rarity: "epic", price: 500, icon: "ğŸ§±" },
        { name: "è–åŠ Excalibur", type: "weapon", val: 150, rarity: "legendary", price: 2500, icon: "ğŸŒŸ" },
        { name: "ç¥ä¹‹å…‰è¼", type: "armor", val: 400, rarity: "legendary", price: 2000, icon: "ğŸŒ" },
        { name: "åŸƒç™¸æ–¯ä¹‹ç›¾", type: "shield", val: 10, rarity: "legendary", price: 900, icon: "ğŸ”±" }
    ],
    phoenixFeather: {
        id: "phoenix_feather",
        name: "ä¸æ­»é³¥çš„ç¾½æ¯›",
        type: "revive",
        rarity: "legendary",
        icon: "ğŸª¶",
        price: 0,
        desc: "æ­»äº¡æ™‚ä»¥50%ç”Ÿå‘½å¾©æ´»ï¼Œç„¡æ³•å‡ºå”®"
    },
    achievements: [
        { id: "abyss_50", name: "æ·±æ·µè¸å…¥è€…", cond: "é€šéç¬¬ 50 å±¤", rarity: "common", check: (p) => p.depth >= 50 },
        { id: "abyss_100", name: "ä¸å±ˆæ¢ç´¢è€…", cond: "é€šéç¬¬ 100 å±¤", rarity: "rare", check: (p) => p.depth >= 100 },
        { id: "abyss_500", name: "æ·±æ·µç‹è€…", cond: "é€šéç¬¬ 500 å±¤", rarity: "epic", check: (p) => p.depth >= 500 },
        { id: "abyss_1000", name: "æ°¸å¤œæ¼«éŠè€…", cond: "é€šéç¬¬ 1000 å±¤", rarity: "legendary", check: (p) => p.depth >= 1000 },
        { id: "hero_kill", name: "å‹‡è€…?", cond: "åœ¨ 1000 å±¤æ“Šæ•—æ·±å±¤é¦–é ˜é­”ç‹", rarity: "legendary", check: (p) => p.kill1000Boss },
        { id: "collector", name: "æ”¶è—å®¶", cond: "æ”¶é›† 20 ç¨®ä¸åŒç‰©å“", rarity: "common", check: (p) => p.history.items.size >= 20 },
        { id: "researcher", name: "æ€ªç‰©ç ”ç©¶å“¡", cond: "å–å¾—æ‰€æœ‰ä¸€èˆ¬èˆ‡èè‹±æ‰è½ç‰©(é™¤çœŸå¯¦ä¹‹å¿ƒ)", rarity: "epic", check: (p) => Game.checkDrops('researcher') },
        { id: "prospector", name: "æ€ªç‰©æ¢å‹˜è€…", cond: "å–å¾—æ‰€æœ‰ä¸€èˆ¬ã€èè‹±ã€é¦–é ˜æ‰è½ç‰©(é™¤çœŸå¯¦ä¹‹å¿ƒ)", rarity: "legendary", check: (p) => Game.checkDrops('prospector') },
        { id: "phoenix", name: "ä¸æ­»é³¥çš„é¸ä¸­", cond: "å–å¾—ã€Œä¸æ­»é³¥çš„ç¾½æ¯›ã€", rarity: "legendary", check: (p) => p.history.items.has("ä¸æ­»é³¥çš„ç¾½æ¯›") },
        // Hidden
        { id: "rest", name: "ä¼‘æ¯?", cond: "å–å¾—æ‰€æœ‰æ™®é€šåˆ°å‚³èªªçš„æˆå°±", rarity: "mythic", hidden: true, check: (p) => Game.checkTierComplete(['common','rare','epic','legendary']) },
        { id: "hero_true", name: "å‹‡è€…", cond: "ç²å¾—çœŸå¯¦ä¹‹å¿ƒ", rarity: "mythic", hidden: true, check: (p) => p.history.items.has("çœŸå¯¦ä¹‹å¿ƒ") },
        { id: "answer", name: "ç­”æ¡ˆ", cond: "ç²å¾—æ‰€æœ‰ç‰©å“", rarity: "mythic", hidden: true, check: (p) => Game.checkAllItems() },
        { id: "true_rest", name: "ç™¼è‡ªå¿ƒéˆçš„ä¼‘æ¯", cond: "ç²å¾—æ‰€æœ‰æˆå°±", rarity: "ultra", hidden: true, check: (p) => Game.checkAllAchievements() }
    ]
};

const Player = {
    hp: 100,
    maxHp: 100,
    baseAtk: 5,
    gold: 100,
    depth: 0,
    class: null,
    equipment: { weapon: null, armor: null, shield: null },
    inventory: { 
        equipment: [], 
        consumable: [ 
            { name: "æ²»ç™‚è—¥æ°´", type: "consumable", val: 30, rarity: "common", price: 25, icon: "ğŸ§ª", desc: "æ¢å¾©30é»ç”Ÿå‘½" }
        ], 
        material: [] 
    },
    buff: null,
    achievements: new Set(),
    history: { items: new Set() },
    kill1000Boss: false
};

const GameState = {
    phase: "select_class",
    currentEnemy: null,
    merchantStock: [],
    log: [],
    isLoading: false,
    lang: "zh"
};

const Game = {
    init() {
        if (localStorage.getItem('fantasy_adventure_save')) {
            this.loadGame();
        } else {
            this.updateUI();
        }
        this.setLang(GameState.lang);
    },

    setLang(lang) {
        GameState.lang = lang;
        document.getElementById('lang-select').value = lang;
        
        // Update Static Elements
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if(TL[lang][key]) el.innerHTML = TL[lang][key];
        });

        // Update Dynamic Elements
        this.updateUI();
        
        // Refresh Event Text if not in combat
        if (GameState.phase === "select_class") return;
        
        // If merchant, re-render shop text
        if (GameState.phase === "merchant") {
            this.renderEvent(this.t('evt_merchant'), this.t('evt_merchant_desc'), "", "ğŸ‘³");
            this.renderMerchantShop();
            this.setButtons(this.t('btn_leave'), "nextEvent", "ç„¡", null, true);
        }
    },

    t(key, ...args) {
        const dict = TL[GameState.lang] || TL.zh;
        let str = dict[key] || key; // Fallback to key if not found
        
        // Handle parameters {0}, {1}...
        if (args.length > 0) {
            args.forEach((arg, index) => {
                str = str.replace(`{${index}}`, arg);
            });
        }
        return str;
    },

    // --- Save & Load System ---
    saveGame() {
        if (Player.hp <= 0) {
            localStorage.removeItem('fantasy_adventure_save');
            return;
        }
        if (!Player.class) return;

        try {
            const saveData = {
                player: {
                    ...Player,
                    achievements: Array.from(Player.achievements),
                    history: {
                        items: Array.from(Player.history.items)
                    }
                },
                gameState: GameState,
                timestamp: new Date().toLocaleString()
            };
            localStorage.setItem('fantasy_adventure_save', JSON.stringify(saveData));
        } catch (e) {
            console.error("Auto-save failed", e);
        }
    },

    loadGame() {
        const json = localStorage.getItem('fantasy_adventure_save');
        if (!json) return;

        GameState.isLoading = true;

        try {
            const data = JSON.parse(json);
            Object.assign(Player, data.player);
            Player.achievements = new Set(data.player.achievements);
            Player.history.items = new Set(data.player.history.items);
            Object.assign(GameState, data.gameState);

            this.updateUI();
            
            document.getElementById('class-modal').style.display = 'none';

            // Restore badge
            const badgeMap = { 'knight': 'class_knight', 'merchant': 'class_merchant', 'thief': 'class_thief', 'cultist': 'class_cultist' };
            document.getElementById('class-badge').innerHTML = this.t(badgeMap[Player.class]) || "";

            if (GameState.phase === 'combat' && GameState.currentEnemy) {
                const enemy = GameState.currentEnemy;
                this.renderEvent(`âš”ï¸ ${this.t(enemy.name.replace(/^(èè‹± |æ·±æ·µ |é¦–é ˜ )+/g, ""))}`, 
                    `${this.t('stat_hp')}: ${enemy.hp} | ${this.t('stat_atk')}: ${enemy.atk}`, 
                    this.t('evt_ready_desc'), enemy.icon);
                
                let iconClass = "monster-icon";
                if(enemy.tier === "elite") iconClass += " monster-elite glow-blue";
                if(enemy.tier === "boss") iconClass += " monster-boss glow-red";
                if(enemy.isTrueForm) iconClass = "monster-icon monster-true-form glow-purple";
                document.getElementById('event-icon').className = iconClass;
                
                this.setButtons(this.t('btn_fight'), "combatRound", this.t('btn_flee'), "flee", false);
            } 
            else if (GameState.phase === 'merchant') {
                this.triggerAnim('event-icon', 'anim-spawn');
                this.renderEvent(this.t('evt_merchant'), this.t('evt_merchant_desc'), "", "ğŸ‘³");
                this.setButtons(this.t('btn_leave'), "nextEvent", "ç„¡", null, true);
                this.renderMerchantShop();
            }
            else {
                GameState.phase = "event_end";
                this.renderEvent(this.t('evt_load'), this.t('evt_load_desc', Player.depth), "", "ğŸ’¾");
                document.getElementById('event-icon').className = "monster-icon";
                document.getElementById('merchant-area').classList.add('hidden');
                this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
            }

        } catch (e) {
            console.error(e);
            localStorage.removeItem('fantasy_adventure_save');
        } finally {
            GameState.isLoading = false;
        }
    },

    manualRestart() {
        if (confirm("Reset Game?")) {
            localStorage.removeItem('fantasy_adventure_save');
            location.reload();
        }
    },

    // --- Compendium ---
    getAllItems() {
        const items = [];
        items.push(...CONFIG.itemPool);
        for (let [name, data] of Object.entries(CONFIG.lootData)) {
            items.push({ ...data, name: name, type: 'material' });
        }
        items.push(CONFIG.phoenixFeather);
        return items.sort((a, b) => {
            const rA = CONFIG.rarityDisplay[a.rarity].val;
            const rB = CONFIG.rarityDisplay[b.rarity].val;
            if (rA !== rB) return rA - rB;
            return a.name.localeCompare(b.name);
        });
    },

    showCompendium() {
        const modal = document.getElementById('compendium-modal');
        const list = document.getElementById('compendium-content');
        const stats = document.getElementById('compendium-stats');
        list.innerHTML = "";
        modal.style.display = 'flex';

        const allItems = this.getAllItems();
        const unlockedCount = allItems.filter(i => Player.history.items.has(i.name)).length;
        
        stats.innerText = `Progress: ${unlockedCount} / ${allItems.length}`;

        allItems.forEach(item => {
            const unlocked = Player.history.items.has(item.name);
            const div = document.createElement('div');
            
            if (!unlocked && item.name === "çœŸå¯¦ä¹‹å¿ƒ") {
                div.className = 'c-item secret-hidden';
                div.title = "?????";
            } 
            else if (unlocked) {
                div.className = `c-item unlocked ${CONFIG.rarityDisplay[item.rarity].color}`;
                div.title = this.t(item.name) + `\n(${item.price}G)`;
                div.innerHTML = `
                    <div class="c-icon">${item.icon || 'ğŸ“¦'}</div>
                    <div class="c-name">${this.t(item.name)}</div>
                `;
            } 
            else {
                div.className = 'c-item unknown';
                div.title = "???";
                div.innerHTML = `
                    <div class="c-icon">â“</div>
                    <div class="c-name">???</div>
                `;
            }
            list.appendChild(div);
        });
    },

    // --- Achievements ---
    checkAchievements() {
        let newUnlock = false;
        CONFIG.achievements.forEach(ach => {
            if (!Player.achievements.has(ach.id)) {
                if (ach.check(Player)) {
                    Player.achievements.add(ach.id);
                    this.showFloatingText(`ğŸ† ${ach.name}`, CONFIG.rarityDisplay[ach.rarity].color === 'rarity-ultra' ? '#00ffcc' : 'gold');
                    newUnlock = true;
                }
            }
        });
        if (newUnlock) this.checkAchievements();
    },

    checkDrops(type) {
        let needed = [];
        CONFIG.monsters.forEach(m => {
            needed.push(m.drop);
            needed.push(m.eliteDrop);
            if (type === 'prospector') needed.push(m.bossDrop);
        });
        return needed.every(item => Player.history.items.has(item));
    },

    checkAllItems() {
        let allItems = [];
        CONFIG.itemPool.forEach(i => allItems.push(i.name));
        Object.keys(CONFIG.lootData).forEach(k => allItems.push(k));
        allItems.push(CONFIG.phoenixFeather.name);
        return allItems.every(i => Player.history.items.has(i));
    },

    checkTierComplete(tiers) {
        const targets = CONFIG.achievements.filter(a => tiers.includes(a.rarity) && !a.hidden);
        return targets.every(a => Player.achievements.has(a.id));
    },

    checkAllAchievements() {
        const others = CONFIG.achievements.filter(a => a.id !== 'true_rest');
        return others.every(a => Player.achievements.has(a.id));
    },

    showAchievements() {
        const modal = document.getElementById('achieve-modal');
        const list = document.getElementById('achieve-list-content');
        const stats = document.getElementById('achieve-stats');
        list.innerHTML = "";
        modal.style.display = 'flex';

        let visibleTotal = CONFIG.achievements.filter(a => !a.hidden || Player.achievements.has(a.id)).length;
        let unlockedCount = Player.achievements.size;
        
        stats.innerText = `Progress: ${unlockedCount} / ${visibleTotal}`;

        CONFIG.achievements.forEach(ach => {
            if (ach.hidden && !Player.achievements.has(ach.id)) return;

            const unlocked = Player.achievements.has(ach.id);
            const div = document.createElement('div');
            div.className = `achieve-item ${unlocked ? 'unlocked' : ''}`;
            
            let colorClass = CONFIG.rarityDisplay[ach.rarity].color;
            let rarityName = this.t(CONFIG.rarityDisplay[ach.rarity].key);

            div.innerHTML = `
                <div class="achieve-info">
                    <div class="achieve-name" style="${unlocked ? 'color:white' : ''}">${ach.name}</div>
                    <div class="achieve-cond">${ach.cond}</div>
                </div>
                <div class="achieve-badge ${colorClass}">${rarityName}</div>
            `;
            list.appendChild(div);
        });
    },

    // --- Core ---
    selectClass(classType) {
        Player.class = classType;
        document.getElementById('class-modal').style.display = 'none';
        
        if (classType === 'knight') {
            const lance = { name: "é¨å£«é•·æ§", type: "weapon", val: 12, rarity: "uncommon", price: 80, icon: "ğŸ”±" };
            this.addItemToInventory(lance, false); 
            this.equip(0, 'equipment'); 
        } else if (classType === 'cultist') {
            const demonBuffs = Object.values(CONFIG.buffs).filter(b => b.type === 'demon');
            Player.buff = demonBuffs[Math.floor(Math.random() * demonBuffs.length)];
            this.updateUI();
        } else {
            this.updateUI();
        }

        const badgeMap = { 'knight': 'class_knight', 'merchant': 'class_merchant', 'thief': 'class_thief', 'cultist': 'class_cultist' };
        document.getElementById('class-badge').innerHTML = this.t(badgeMap[classType]);

        this.renderEvent(this.t('evt_ready'), this.t('evt_ready_desc'), "", "âœ¨");
    },

    triggerAnim(id, animClass) {
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove(animClass);
            void el.offsetWidth;
            el.classList.add(animClass);
        }
    },

    showFloatingText(text, color) {
        const display = document.getElementById('event-display');
        const div = document.createElement('div');
        div.className = 'floating-text';
        div.innerHTML = text;
        div.style.color = color;
        display.appendChild(div);
        setTimeout(() => div.remove(), 1000);
    },

    getAtk() {
        let atk = Player.baseAtk;
        if (Player.equipment.weapon) atk += Player.equipment.weapon.val;
        return atk;
    },

    recalcStats() {
        const currentRatio = Player.maxHp > 0 ? Player.hp / Player.maxHp : 1; 
        let bonusHp = Player.equipment.armor ? Player.equipment.armor.val : 0;
        const newMaxHp = 100 + bonusHp; 
        Player.maxHp = newMaxHp;
        let newHp = Math.round(currentRatio * Player.maxHp);
        Player.hp = Math.min(newHp, Player.maxHp);
        if (Player.hp < 0) Player.hp = 0;
        this.updateStatsUI();
    },

    nextEvent() {
        if (Player.hp <= 0) {
            this.restart();
            return;
        }

        Player.depth++;
        this.checkAchievements();
        
        if (Player.buff && Player.buff.id === 'angel_song') {
            if (Player.hp < Player.maxHp) {
                Player.hp = Math.min(Player.maxHp, Player.hp + 5);
                this.showFloatingText("+5 HP", "#69f0ae");
            }
        }

        if (Player.depth >= 1000 && (Player.depth - 1000) % 500 === 0) {
            this.triggerCombat(true, true); 
            this.updateUI();
            return;
        }

        if (Player.depth === 500) {
            this.triggerCombat(true, false); 
            this.updateUI();
            return;
        }
        
        if (Player.depth > 200 && Math.random() < 0.01) {
            this.triggerHarpy();
            this.updateUI();
            return;
        }

        const rand = Math.random();
        
        if (rand < 0.05) {
            this.triggerHeal();
        } else if (rand < 0.10) {
            this.triggerStatue();
        } else if (rand < 0.13) {
            this.triggerClassEvent();
        } else if (rand < 0.30) {
            this.triggerMerchant();
        } else if (rand < 0.40) {
            this.triggerChest();
        } else {
            this.triggerCombat(false, false);
        }
        
        this.updateUI();
    },

    triggerClassEvent() {
        GameState.phase = "event_end";
        if (Player.class === 'knight') this.handleKnightEvent();
        else if (Player.class === 'merchant') this.handleMerchantEvent();
        else if (Player.class === 'thief') this.handleThiefEvent();
        else if (Player.class === 'cultist') this.handleCultistEvent();
    },

    handleKnightEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent(this.t('evt_prepare'), "Found survivors...", this.t('btn_help') + "?", "ğŸ›¡ï¸");
        this.setButtons(this.t('btn_help') + " (60%)", "resolveKnightHelp", this.t('btn_ignore'), "nextEvent", false);
    },

    resolveKnightHelp() {
        if (Math.random() < 0.6) {
            Player.gold += 100;
            this.showFloatingText("+100 G", "gold");
            this.renderEvent(this.t('evt_win'), "", this.t('msg_gain_gold', 100), "ğŸ‰");
        } else {
            let dmg = Math.floor(Player.hp * 0.5);
            Player.hp -= dmg;
            this.showFloatingText(`-${dmg} HP`, "red");
            this.renderEvent("Failed", "", this.t('msg_pain', dmg), "ğŸ©¸");
            if (Player.hp <= 0) { this.playerDie("Rescue Mission"); return; }
        }
        this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    handleMerchantEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent(this.t('evt_merchant'), "Shady deal...", this.t('btn_trade') + " (66 G)?", "ğŸ•µï¸");
        this.setButtons(this.t('btn_trade'), "resolveMerchantTrade", this.t('btn_leave'), "nextEvent", false);
    },

    resolveMerchantTrade() {
        if (Player.gold < 66) { alert("Gold!"); return; }
        Player.gold -= 66;
        this.showFloatingText("-66 G", "gold");

        if (Math.random() < 0.1) {
            this.renderEvent("Scammed!", "", "", "ğŸ’¨");
        } else {
            let item;
            if (Math.random() < 0.01) {
                const legends = CONFIG.itemPool.filter(i => i.rarity === 'legendary' || i.rarity === 'epic');
                item = { ...legends[Math.floor(Math.random() * legends.length)] };
            } else {
                item = this.generateSpecificItem(['weapon', 'armor', 'shield', 'consumable']);
            }
            this.addItemToInventory(item);
            this.renderEvent("Deal!", "", this.t('msg_gain_gold', item.name), "ğŸ");
        }
        this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    handleThiefEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("Golden Chest", "Glowing chest...", this.t('btn_open') + "?", "âœ¨");
        this.setButtons(this.t('btn_open'), "resolveThiefChest", this.t('btn_leave'), "nextEvent", false);
    },

    resolveThiefChest() {
        if (Math.random() < 0.05) {
            const artifacts = CONFIG.itemPool.filter(i => i.rarity === 'legendary' && ['è–åŠ Excalibur', 'ç¥ä¹‹å…‰è¼', 'åŸƒç™¸æ–¯ä¹‹ç›¾'].includes(i.name));
            if (artifacts.length > 0) {
                const item = { ...artifacts[Math.floor(Math.random() * artifacts.length)] };
                this.addItemToInventory(item);
                this.renderEvent("Artifact!", "", item.name, "ğŸ‘‘");
            } else {
                const item = this.generateRandomItem();
                this.addItemToInventory(item);
                this.renderEvent(this.t('evt_chest_open'), "", item.name, "ğŸ“¦");
            }
        } else {
            let dmg = Math.floor(Player.hp * 0.5);
            Player.hp -= dmg;
            this.showFloatingText(`-${dmg} HP`, "red");
            this.renderEvent(this.t('evt_chest_trap'), "", this.t('msg_pain', dmg), "ğŸ’£");
            if (Player.hp <= 0) { this.playerDie("Trap"); return; }
        }
        this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    handleCultistEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("Demon Game", "High or Low?", this.t('btn_accept') + "?", "ğŸ˜ˆ");
        this.setButtons(this.t('btn_accept'), "resolveCultistGame", this.t('btn_refuse'), "nextEvent", false);
    },

    resolveCultistGame() {
        const pRoll = Math.floor(Math.random() * 6) + 1;
        const dRoll = Math.floor(Math.random() * 6) + 1;
        
        let resultHtml = `You: ${pRoll}, Demon: ${dRoll}<br>`;

        if (pRoll > dRoll) {
            let rarity = 'rare';
            let r = Math.random();
            if (r < 0.1) rarity = 'legendary';
            else if (r < 0.3) rarity = 'epic';
            
            let pool = CONFIG.itemPool.filter(i => i.rarity === rarity && ['weapon', 'armor', 'shield'].includes(i.type));
            if (pool.length === 0) pool = CONFIG.itemPool.filter(i => i.rarity === 'rare');
            
            const item = { ...pool[Math.floor(Math.random() * pool.length)] };
            this.addItemToInventory(item);
            
            this.renderEvent(this.t('evt_win'), resultHtml, item.name, "ğŸ‰");
        } else {
            Player.hp = Math.floor(Player.maxHp * 0.01) || 1;
            this.showFloatingText("HP -> 1%", "darkred");
            this.renderEvent("Lost...", resultHtml, "HP -> 1%", "ğŸ’€");
        }
        this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    triggerHarpy() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        
        let outcome = Math.random();

        if (outcome < 0.2) {
            Player.gold += 500;
            this.showFloatingText("+500 G", "#ffd700");
            this.renderEvent(this.t('evt_harpy'), this.t('evt_harpy_desc'), this.t('msg_gain_gold', 500), "ğŸ¦…");
        } else {
            const type = Math.floor(Math.random() * 4);
            let desc = "";
            if (type === 0) { Player.inventory.equipment = []; desc = "Equipment stolen"; }
            else if (type === 1) { Player.inventory.consumable = []; desc = "Potions stolen"; }
            else if (type === 2) { Player.inventory.material = []; desc = "Materials stolen"; }
            else { Player.gold = 0; desc = "Gold stolen"; }
            this.renderEvent(this.t('evt_harpy'), this.t('evt_harpy_desc'), desc, "ğŸ¦…");
        }
        this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
    },

    triggerHeal() {
        const oldHp = Player.hp;
        Player.hp = Player.maxHp; 
        const healed = Player.hp - oldHp;
        
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent(this.t('evt_heal'), this.t('evt_heal_desc'), this.t('evt_full_heal'), "ğŸ›Œ");
        if(healed > 0) this.showFloatingText(`+${healed} HP`, "#69f0ae");
        this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
    },

    triggerStatue() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent(this.t('evt_statue'), this.t('evt_statue_desc'), this.t('btn_pray') + "?", "ğŸ™");
        this.setButtons(this.t('btn_pray'), "pray", this.t('btn_leave'), "nextEvent", false);
    },

    pray() {
        if (!CONFIG.buffs) return; 
        
        const isAngel = Math.random() < 0.5;
        const type = isAngel ? 'angel' : 'demon';
        const icon = isAngel ? "ğŸ‘¼" : "ğŸ˜ˆ";
        const options = Object.values(CONFIG.buffs).filter(b => b.type === type);
        
        if (options.length === 0) return;

        const selected = options[Math.floor(Math.random() * options.length)];
        Player.buff = selected;
        
        let title = isAngel ? "Angel" : "Demon";
        let style = isAngel ? "angel-text" : "demon-text";
        
        this.triggerAnim('event-icon', 'anim-spawn');
        let desc = `<span class='${style}'>${selected.name}</span>`;
        this.renderEvent(title, "...", desc, icon);
        this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    triggerMerchant() {
        GameState.phase = "merchant";
        this.generateMerchantStock();
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent(this.t('evt_merchant'), this.t('evt_merchant_desc'), "", "ğŸ‘³");
        this.setButtons(this.t('btn_leave'), "nextEvent", "ç„¡", null, true);
        this.renderMerchantShop();
    },

    generateMerchantStock() {
        GameState.merchantStock = [];
        for(let i=0; i<4; i++) {
            GameState.merchantStock.push(this.generateRandomItem());
        }
    },

    getItemDesc(item) {
        if (item.desc) return item.desc; // Consumables (can be added to translations if needed)
        let valText = "";
        if (item.type === 'weapon') valText = `ATK +${item.val}`;
        if (item.type === 'armor') valText = `HP +${item.val}`;
        if (item.type === 'shield') valText = `Block ${item.val}`;
        return valText;
    },

    renderMerchantShop() {
        const area = document.getElementById('merchant-area');
        area.innerHTML = "";
        area.classList.remove('hidden');
        
        let buyHtml = `<h4 data-key='btn_buy'>${this.t('btn_buy')}</h4><div class='merchant-grid'>`;
        GameState.merchantStock.forEach((item, idx) => {
            if (!item) return;
            const desc = this.getItemDesc(item);
            const rarityColor = CONFIG.rarityDisplay[item.rarity].color;
            buyHtml += `<div class="merchant-item ${rarityColor}" onclick="Game.buyItem(${idx})">
                <div class="m-top">
                    <span>${item.icon || 'ğŸ“¦'} ${this.t(item.name)}</span>
                    <span class="gold-text">${item.price} G</span>
                </div>
                <div class="m-desc">${desc}</div>
            </div>`;
        });
        buyHtml += "</div>";
        
        buyHtml += `<div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
            <h4 data-key='btn_sell_all'>Sell</h4>
            <button onclick="Game.sellAllMaterials()" style="padding:5px 10px; font-size:0.8em; background:#d32f2f;">${this.t('btn_sell_all')}</button>
        </div>`;
        
        area.innerHTML = buyHtml;
    },

    buyItem(idx) {
        const item = GameState.merchantStock[idx];
        if (!item) return;
        if (Player.gold >= item.price) {
            Player.gold -= item.price;
            this.addItemToInventory(item);
            GameState.merchantStock[idx] = null;
            this.showFloatingText(`- ${item.price} G`, "yellow");
            this.updateUI();
            this.renderMerchantShop();
        } else {
            alert("No Gold!");
        }
    },

    sellAllMaterials() {
        if (GameState.phase !== "merchant") return;
        if (Player.inventory.material.length === 0) return;
        
        let total = 0;
        let keptItems = [];
        Player.inventory.material.forEach(item => {
            if (item.type === 'revive') {
                keptItems.push(item);
            } else {
                let price = item.price; 
                if (Player.class === 'merchant') price = Math.floor(price * 1.2);
                total += price;
            }
        });
        
        Player.inventory.material = keptItems;
        Player.gold += total;
        this.showFloatingText(`+ ${total} G`, "yellow");
        this.updateUI();
    },

    sellItem(index, category) {
        if (GameState.phase !== "merchant") return; 
        
        const item = Player.inventory[category][index];
        if (!item) return;
        if (item.type === 'revive') {
            alert("Cannot sell!");
            return;
        }

        let price = item.price;
        if (['weapon', 'armor', 'shield', 'consumable'].includes(item.type)) {
            price = Math.floor(price * 0.8);
        }
        
        if (Player.class === 'merchant') {
            price = Math.floor(price * 1.2);
        }
        
        if(confirm(`Sell ${this.t(item.name)} for ${price} G?`)) {
            Player.inventory[category].splice(index, 1);
            Player.gold += price;
            this.showFloatingText(`+ ${price} G`, "yellow");
            this.updateUI();
        }
    },

    triggerChest() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');

        if (Math.random() < 0.01) {
            const feather = {...CONFIG.phoenixFeather};
            this.addItemToInventory(feather);
            this.renderEvent(this.t('evt_chest'), this.t('evt_chest_open'), `<span class='rarity-legendary'>${this.t(feather.name)}</span>`, "ğŸª¶");
            this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
            return;
        }

        const roll = Math.random();
        let isThief = Player.class === 'thief';
        let safeRoll = isThief ? roll * 0.8 : roll; 

        if (safeRoll < 0.30) {
            const amount = Math.floor(Math.random() * 50) + 10 + (Player.depth * 2);
            Player.gold += amount;
            this.showFloatingText(`+${amount} G`, "#ffd700");
            this.renderEvent(this.t('evt_chest'), this.t('evt_chest_open'), this.t('msg_gain_gold', amount), "ğŸ“¦");
        } else if (safeRoll < 0.60) {
            const item = this.generateSpecificItem(['consumable']);
            this.addItemToInventory(item);
            this.renderEvent(this.t('evt_chest'), this.t('evt_chest_open'), this.t(item.name), "ğŸ“¦");
        } else if (safeRoll < 0.80) {
            const item = this.generateSpecificItem(['weapon', 'armor', 'shield']);
            this.addItemToInventory(item);
            this.renderEvent(this.t('evt_chest'), this.t('evt_chest_open'), this.t(item.name), "ğŸ“¦");
        } else if (safeRoll < 0.90) {
            this.renderEvent(this.t('evt_chest'), this.t('evt_chest_open'), this.t('evt_chest_empty'), "ğŸ“¦");
        } else {
            const dmg = Math.floor(Player.maxHp * 0.15);
            Player.hp = Math.max(0, Player.hp - dmg);
            this.triggerAnim('game-container', 'anim-screen-shake');
            this.showFloatingText(`-${dmg} HP`, "red");
            this.renderEvent(this.t('evt_chest'), this.t('evt_chest_trap'), this.t('msg_pain', dmg), "ğŸ’£");
            if(Player.hp === 0) { this.playerDie("Chest Trap"); return; }
        }
        this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
    },

    getWeightedMonster() {
        let activeMonsters = [];
        if (Player.depth < 50) {
            let weakWeight = 99 / 4; 
            let strongWeight = 1 / 6; 
            CONFIG.monsters.forEach((m, idx) => {
                let tempM = {...m};
                tempM.weight = (idx < 4) ? weakWeight : strongWeight;
                activeMonsters.push(tempM);
            });
        } else {
            activeMonsters = CONFIG.monsters;
        }

        let totalWeight = 0;
        for (let m of activeMonsters) totalWeight += m.weight;
        let randomVal = Math.random() * totalWeight;
        for (let m of activeMonsters) {
            if (randomVal < m.weight) return m;
            randomVal -= m.weight;
        }
        return activeMonsters[0];
    },

    triggerCombat(isForcedBoss, checkTrueForm) {
        GameState.phase = "combat";
        
        let baseMonster;
        let tier = "normal";
        let canFlee = true;

        if (isForcedBoss) {
            baseMonster = CONFIG.monsters[9]; 
            tier = "boss";
            canFlee = false;
        } else {
            baseMonster = this.getWeightedMonster();
            let rand = Math.random();
            if (Player.depth > 300) {
                if (rand < 0.5) tier = "elite"; else tier = "boss";
            } else if (Player.depth > 100) {
                if (rand < 0.1) tier = "boss"; else if (rand < 0.6) tier = "elite"; else tier = "normal";
            } else {
                if (rand < 0.01) tier = "boss"; else if (rand < 0.11) tier = "elite"; else tier = "normal";
            }
        }

        let hpMul = 1, atkMul = 1;
        
        if (Player.depth > 500) { hpMul *= 1.5; }
        if (tier === "elite") { hpMul *= 2; atkMul *= 1.5; }
        else if (tier === "boss") { hpMul *= 3; atkMul *= 2; }

        let enemy = {
            ...baseMonster,
            name: baseMonster.name, // Keep base name for ID
            maxHp: Math.floor(baseMonster.hp * hpMul),
            hp: Math.floor(baseMonster.hp * hpMul),
            atk: Math.floor(baseMonster.atk * atkMul),
            tier: tier
        };

        if (checkTrueForm) {
            const hasSword = Player.equipment.weapon && Player.equipment.weapon.name === "è–åŠ Excalibur";
            const hasArmor = Player.equipment.armor && Player.equipment.armor.name === "ç¥ä¹‹å…‰è¼";
            
            if (hasSword && hasArmor) {
                enemy.name = "é­”ç‹çœŸèº«";
                enemy.maxHp = 4000;
                enemy.hp = 4000;
                enemy.atk = 200;
                enemy.isTrueForm = true;
            }
        }

        GameState.currentEnemy = enemy;

        let iconClass = "monster-icon";
        if(tier === "elite") iconClass += " monster-elite glow-blue";
        if(tier === "boss") iconClass += " monster-boss glow-red";
        if(enemy.isTrueForm) iconClass = "monster-icon monster-true-form glow-purple";

        document.getElementById('event-icon').className = iconClass;
        this.triggerAnim('event-icon', 'anim-spawn');
        
        let prefix = "";
        if (tier === "elite") prefix = "Elite ";
        if (tier === "boss") prefix = "Boss ";
        
        this.renderEvent(`âš”ï¸ ${prefix}${this.t(enemy.name)}`, 
            `${this.t('stat_hp')}: ${enemy.hp} | ${this.t('stat_atk')}: ${enemy.atk}`, 
            this.t('evt_ready_desc'), enemy.icon);
        
        this.setButtons(this.t('btn_fight'), "combatRound", this.t('btn_flee'), "flee", !canFlee);
    },

    combatRound() {
        if (GameState.phase !== "combat") return;
        const enemy = GameState.currentEnemy;
        let logHtml = "";

        let pDmg = this.getAtk();
        let pCritRate = 0.05;
        
        if (Player.buff) {
            if (Player.buff.id === 'angel_courage') pCritRate = 0.2;
            if (Player.buff.id === 'demon_enhance') pCritRate = 0.5;
            if (Player.buff.id === 'demon_wealth') {
                Player.gold += 5;
                this.showFloatingText("+5 G", "gold");
                // Simplified log for translation ease
                logHtml += `[Buff] +5 G<br>`;
            }
            if (Player.buff.id === 'demon_destruction') {
                if (Math.random() < 0.1) {
                    enemy.hp = 0;
                    let pain = Math.floor(Player.hp * 0.9);
                    Player.hp -= pain;
                    this.showFloatingText(`-${pain} HP`, "darkred");
                    logHtml += `[Buff] Kill! -${pain} HP<br>`;
                    this.combatWin(); 
                    this.updateUI();
                    return;
                }
            }
        }

        let pCrit = Math.random() < pCritRate;
        if (pCrit) pDmg *= 2;
        
        enemy.hp -= pDmg;
        
        this.triggerAnim('event-icon', 'anim-damage');
        this.showFloatingText(pDmg, pCrit ? "red" : "white");
        
        logHtml += `You hit ${this.t(enemy.name)} for ${pCrit ? "CRIT " : ""}${pDmg}.<br>`;

        if (enemy.hp <= 0) {
            this.combatWin();
            return;
        }

        let mDmg = enemy.atk;
        let mCritRate = 0.1;
        if (Player.buff && Player.buff.id === 'demon_enhance') mCritRate = 0.5;
        if (Player.buff && Player.buff.id === 'angel_protection') mDmg = Math.floor(mDmg * 0.7);

        let mCrit = Math.random() < mCritRate;
        if (mCrit) mDmg *= 2;

        let applyDamage = true;
        let s = Player.equipment.shield;

        this.triggerAnim('event-icon', 'anim-lunge');

        if (s && s.val > 0) {
            s.val--; 
            let isPierced = (mCrit && s.name !== "åŸƒç™¸æ–¯ä¹‹ç›¾");
            
            if (isPierced) {
                logHtml += `<span class='pierce-text'>Pierce! Shield ignored.</span><br>`;
            } else {
                applyDamage = false;
                this.showFloatingText("Block!", "#2196f3");
                logHtml += `<span class='block-text'>Blocked!</span> (${s.val} left)<br>`;
            }

            if (s.val <= 0) {
                logHtml += `<span class='damage-text'>Shield Broken!</span><br>`;
                Player.equipment.shield = null;
                this.recalcStats(); 
            }
        }

        if (applyDamage) {
            Player.hp -= mDmg;
            this.triggerAnim('game-container', 'anim-screen-shake');
            this.showFloatingText(`-${mDmg}`, "red");
            logHtml += `Enemy hit you for ${mCrit ? "CRIT " : ""}${mDmg}.`;
        }
        
        this.renderEvent(`âš”ï¸ ${this.t(enemy.name)}`, 
            `${this.t('stat_hp')}: ${Math.max(0, enemy.hp)}`, 
            logHtml, enemy.icon);

        if (Player.hp <= 0) {
            this.playerDie(enemy.name);
        } else {
            this.updateUI();
        }
    },

    combatWin() {
        const enemy = GameState.currentEnemy;
        GameState.phase = "event_end";
        
        if(Player.depth === 1000 && enemy.tier === 'boss') {
            Player.kill1000Boss = true;
        }

        let drops = [];
        let dropText = "";

        let gold = enemy.baseGold;
        if (enemy.tier === "elite") gold *= 2;
        if (enemy.tier === "boss") gold *= 5;
        
        Player.gold += gold;
        this.showFloatingText(`+${gold} G`, "#ffd700");
        dropText += `+ ${gold} G<br>`;

        if (enemy.isTrueForm) {
            if (CONFIG.lootData["çœŸå¯¦ä¹‹å¿ƒ"]) {
                let loot = { ...CONFIG.lootData["çœŸå¯¦ä¹‹å¿ƒ"], name: "çœŸå¯¦ä¹‹å¿ƒ", type: "loot" };
                drops.push(loot);
            }
        } else {
            if (Math.random() < 0.7 && CONFIG.lootData[enemy.drop]) {
                drops.push({ ...CONFIG.lootData[enemy.drop], name: enemy.drop, type: "loot" });
            }
            if ((enemy.tier === "elite" || enemy.tier === "boss") && Math.random() < 0.3 && CONFIG.lootData[enemy.eliteDrop]) {
                drops.push({ ...CONFIG.lootData[enemy.eliteDrop], name: enemy.eliteDrop, type: "loot" });
            }
            if (enemy.tier === "boss" && Math.random() < 0.1 && CONFIG.lootData[enemy.bossDrop]) {
                drops.push({ ...CONFIG.lootData[enemy.bossDrop], name: enemy.bossDrop, type: "loot" });
            }
        }

        if (Math.random() < 0.1) {
            drops.push(this.generateRandomItem(enemy.tier));
        }

        drops.forEach(item => {
            this.addItemToInventory(item);
            let colorClass = item.rarity ? CONFIG.rarityDisplay[item.rarity].color : "";
            if(item.rarity === 'mythic') colorClass = 'rarity-mythic';
            dropText += `<span class='${colorClass}'>${this.t(item.name)}</span><br>`;
        });

        this.renderEvent(this.t('evt_win'), this.t('evt_win_desc'), dropText || "Empty.", "ğŸ‰");
        document.getElementById('event-icon').className = "monster-icon"; 
        
        this.checkAchievements();
        this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    flee() {
        let fleeRate = 0.5;
        if (Player.buff) {
            if (Player.buff.id === 'angel_wings') fleeRate = 0.6;
            if (Player.buff.id === 'demon_wager') {
                fleeRate = 0.8;
                if (Math.random() < 0.01) {
                    Player.hp = 0;
                    this.playerDie("Demon Wager");
                    return;
                }
            }
        }

        if (Math.random() < fleeRate) {
            GameState.phase = "event_end";
            this.renderEvent(this.t('evt_flee_ok'), this.t('evt_flee_ok_desc'), "", "ğŸƒ");
            document.getElementById('event-icon').className = "monster-icon";
            this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
        } else {
            const enemy = GameState.currentEnemy;
            let mDmg = enemy.atk;
            let msg = "";
            let s = Player.equipment.shield;
            
            this.triggerAnim('event-icon', 'anim-lunge');

            if (s && s.val > 0) {
                s.val--;
                this.showFloatingText("Block!", "#2196f3");
                msg = `Failed! Shield Blocked.`;
                if (s.val <= 0) {
                    msg += `<br>Shield Broken!`;
                    Player.equipment.shield = null;
                    this.recalcStats();
                }
            } else {
                Player.hp -= mDmg;
                this.triggerAnim('game-container', 'anim-screen-shake');
                this.showFloatingText(`-${mDmg}`, "red");
                msg = `Failed! Took ${mDmg} dmg.`;
                
                if (Player.buff && Player.buff.id === 'demon_wealth') {
                    if (Player.gold >= 5) {
                        Player.gold -= 5;
                        this.showFloatingText("-5 G", "red");
                    }
                }
            }
            
            if (Player.hp <= 0) {
                this.playerDie("Flee Failed");
            } else {
                this.renderEvent(`âš”ï¸ ${this.t(enemy.name)}`, `${this.t('stat_hp')}: ${enemy.hp}`, msg, enemy.icon);
                this.updateUI();
            }
        }
    },

    playerDie(reason) {
        const featherIdx = Player.inventory.material.findIndex(i => i.id === 'phoenix_feather');
        if (featherIdx !== -1) {
            Player.inventory.material.splice(featherIdx, 1);
            Player.hp = Math.floor(Player.maxHp * 0.5);
            
            if (GameState.phase === 'combat' && GameState.currentEnemy) {
                this.renderEvent(`âš”ï¸ Revived`, `Enemy HP: ${GameState.currentEnemy.hp}`, "Phoenix Feather Used!", GameState.currentEnemy.icon);
                this.setButtons(this.t('btn_fight'), "combatRound", this.t('btn_flee'), "flee", false);
            } else {
                this.renderEvent("Revived", "Phoenix Feather Used!", "HP 50%", "ğŸ¦…");
                GameState.phase = "event_end";
                this.setButtons(this.t('btn_continue'), "nextEvent", "ç„¡", null, true);
            }
            
            this.updateUI();
            return;
        }

        GameState.phase = "dead";
        Player.hp = 0;
        this.updateUI();
        localStorage.removeItem('fantasy_adventure_save');
        this.renderEvent(this.t('evt_die'), this.t('evt_die_desc', Player.depth), reason, "ğŸª¦");
        this.setButtons(this.t('btn_restart'), "restart", "ç„¡", null, true);
    },

    restart() {
        location.reload();
    },

    generateRandomItem(tierModifier = "normal") {
        const r = Math.random();
        let rarityKey = "common";
        let table = CONFIG.rarityProb;
        let acc = 0;
        for (let key in table) {
            acc += table[key];
            if (r <= acc) { rarityKey = key; break; }
        }

        if (tierModifier === "boss" && (rarityKey === "common" || rarityKey === "uncommon")) rarityKey = "rare";
        
        const pool = CONFIG.itemPool.filter(i => i.rarity === rarityKey);
        if (pool.length === 0) return this.generateRandomItem("normal");

        const template = pool[Math.floor(Math.random() * pool.length)];
        return Object.assign({}, template);
    },

    generateSpecificItem(allowedTypes) {
        const r = Math.random();
        let rarityKey = "common";
        let table = CONFIG.rarityProb;
        let acc = 0;
        for (let key in table) {
            acc += table[key];
            if (r <= acc) { rarityKey = key; break; }
        }
        let pool = CONFIG.itemPool.filter(i => i.rarity === rarityKey && allowedTypes.includes(i.type));
        if (pool.length === 0) pool = CONFIG.itemPool.filter(i => allowedTypes.includes(i.type));
        const template = pool[Math.floor(Math.random() * pool.length)];
        return Object.assign({}, template);
    },

    addItemToInventory(item, render = true) {
        Player.history.items.add(item.name);

        if (['weapon', 'armor', 'shield'].includes(item.type)) {
            Player.inventory.equipment.push(item);
        } else if (item.type === 'consumable') {
            Player.inventory.consumable.push(item);
        } else {
            Player.inventory.material.push(item);
        }
        if (render) this.updateUI();
    },

    handleItemClick(index, category) {
        // Fix: Dead player cannot use items
        if (Player.hp <= 0 || GameState.phase === 'dead') return;

        if (GameState.phase === "merchant") {
            this.sellItem(index, category);
            return;
        }
        const item = Player.inventory[category][index];
        if (['weapon', 'armor', 'shield'].includes(item.type)) {
            if(confirm(`Equip ${this.t(item.name)}?`)) this.equip(index, category);
        } else if (item.type === 'consumable') {
            if(confirm(`Use ${this.t(item.name)}?`)) this.useItem(index, category);
        } else {
             alert(`${this.t(item.name)}`);
        }
    },

    equip(index, category) {
        const item = Player.inventory[category][index];
        const type = item.type;

        if (!['weapon', 'armor', 'shield'].includes(type)) return;

        if (Player.equipment[type]) this.addItemToInventory(Player.equipment[type], false);
        
        Player.equipment[type] = item;
        Player.inventory[category].splice(index, 1);
        
        this.recalcStats();
        this.updateUI();    
    },

    unequip(type) {
        if (!Player.equipment[type]) return;
        const item = Player.equipment[type];
        
        this.addItemToInventory(item, false); 
        Player.equipment[type] = null;
        
        this.recalcStats();
        this.updateUI();
    },

    useItem(index, category) {
        const item = Player.inventory[category][index];
        // Checks logic by Chinese name (ID)
        if (item.name.includes("è—¥æ°´") || item.name.includes("è—¥åŠ‘")) {
            let heal = item.val;
            Player.hp = Math.min(Player.maxHp, Player.hp + heal);
            Player.inventory[category].splice(index, 1);
            this.showFloatingText(`+${heal} HP`, "#69f0ae");
            this.updateUI();
        }
    },

    log(msg) { console.log(msg); },

    renderEvent(title, subtitle, content, icon) {
        document.getElementById('event-title').innerHTML = title;
        document.getElementById('event-desc').innerHTML = `<p>${subtitle}</p><p>${content}</p>`;
        if(icon) document.getElementById('event-icon').innerText = icon;
        if(GameState.phase !== 'merchant') document.getElementById('merchant-area').classList.add('hidden');
    },

    setButtons(mainText, mainAction, subText, subAction, disableSub) {
        const b1 = document.getElementById('btn-main');
        const b2 = document.getElementById('btn-sub');
        b1.innerText = mainText;
        b1.onclick = () => Game[mainAction]();
        b2.innerText = subText;
        if (subAction) b2.onclick = () => Game[subAction]();
        b2.disabled = disableSub;
    },

    updateUI() {
        this.updateStatsUI();

        const w = Player.equipment.weapon;
        const a = Player.equipment.armor;
        const s = Player.equipment.shield;
        
        const wEl = document.getElementById('slot-weapon');
        wEl.innerHTML = w ? `<span class="${CONFIG.rarityDisplay[w.rarity].color}">${w.icon} ${this.t(w.name)} (+${w.val})</span>` : this.t('slot_weapon');
        wEl.className = `equip-slot ${w ? CONFIG.rarityDisplay[w.rarity].color : ''}`;

        const aEl = document.getElementById('slot-armor');
        aEl.innerHTML = a ? `<span class="${CONFIG.rarityDisplay[a.rarity].color}">${a.icon} ${this.t(a.name)} (+${a.val})</span>` : this.t('slot_armor');
        aEl.className = `equip-slot ${a ? CONFIG.rarityDisplay[a.rarity].color : ''}`;
        
        const sEl = document.getElementById('slot-shield');
        sEl.innerHTML = s ? `<span class="${CONFIG.rarityDisplay[s.rarity].color}">${s.icon} ${this.t(s.name)} (${s.val})</span>` : this.t('slot_shield');
        sEl.className = `equip-slot ${s ? CONFIG.rarityDisplay[s.rarity].color : ''}`;

        this.renderInvList('inv-equip', Player.inventory.equipment, 'equipment');
        this.renderInvList('inv-consum', Player.inventory.consumable, 'consumable');
        this.renderInvList('inv-mat', Player.inventory.material, 'material');

        if (!GameState.isLoading && Player.hp > 0 && Player.class) {
            this.saveGame();
        }
    },

    updateStatsUI() {
        document.getElementById('hp-val').innerText = Player.hp;
        document.getElementById('max-hp-val').innerText = Player.maxHp;
        document.getElementById('atk-val').innerText = this.getAtk();
        document.getElementById('gold-val').innerText = Player.gold;
        document.getElementById('depth-val').innerText = Player.depth;
        
        const buffEl = document.getElementById('buff-display');
        if (Player.buff) {
            const style = Player.buff.type === 'angel' ? 'angel-text' : 'demon-text';
            buffEl.innerHTML = `${this.t('buff_label')}: <span class="${style}">${Player.buff.name}</span> <span style="font-size:0.8em; cursor:pointer;">(${this.t('buff_click')})</span>`;
            buffEl.onclick = () => alert(`${Player.buff.name}\n\n${Player.buff.desc}`);
        } else {
            buffEl.innerHTML = `${this.t('buff_label')}: ${this.t('buff_none')}`;
            buffEl.onclick = null;
        }
    },

    renderInvList(id, items, category) {
        const list = document.getElementById(id);
        list.innerHTML = "";
        items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = `item ${CONFIG.rarityDisplay[item.rarity].color}`;
            if (item.rarity === 'epic') div.classList.add('rare-epic');
            if (item.rarity === 'legendary') div.classList.add('rare-legendary');
            if (item.rarity === 'mythic') div.classList.add('rarity-mythic');
            div.innerHTML = `${item.icon || 'ğŸ“¦'} ${this.t(item.name)}`;
            div.onclick = () => this.handleItemClick(idx, category);
            list.appendChild(div);
        });
    }
};

Game.init();
</script>
</body>
</html>
