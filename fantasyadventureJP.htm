<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹»æƒ³ã®å†’é™ºv1.1</title>
    <style>
        :root {
            /* å¤‰æ•°è¨­å®š */
            --bg-color: #1a1a1a;
            --panel-color: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #ff9800;
            --border-radius: 8px;
            --font-main: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            
            /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚«ãƒ©ãƒ¼ */
            --common: #b0b0b0;
            --uncommon: #4caf50;
            --rare: #2196f3;
            --epic: #9c27b0;
            --legendary: #ffd700;
            --mythic: #ff0055;
            --ultra: #00ffcc;
            
            /* ãƒãƒ•ã‚«ãƒ©ãƒ¼ */
            --buff-angel: #4fc3f7;
            --buff-demon: #ef5350;
        }

        /* ç…‰ç„ãƒ¢ãƒ¼ãƒ‰ã®å¤‰æ•°ä¸Šæ›¸ã */
        body.inferno-mode {
            --bg-color: #050000;
            --panel-color: #1a0505;
            --text-color: #ffcccc;
            --accent-color: #ff3333;
            background-image: repeating-linear-gradient(
                45deg,
                #050000,
                #050000 10px,
                #110000 10px,
                #110000 20px
            );
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 1s, color 1s;
        }

        #game-container {
            width: 100%;
            max-width: 700px;
            background-color: var(--panel-color);
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            transition: background-color 1s, box-shadow 1s;
        }
        
        /* ç…‰ç„ãƒ¢ãƒ¼ãƒ‰ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        body.inferno-mode #game-container {
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.2);
            border: 1px solid #330000;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ & ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        header {
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .class-badge {
            font-size: 0.8em;
            background: #444;
            padding: 2px 8px;
            border-radius: 4px;
            color: var(--accent-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            background: #222;
            padding: 10px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
        }
        
        body.inferno-mode .stats-grid {
            background: #220000;
            border: 1px solid #550000;
        }

        .stat-item span { font-weight: bold; color: var(--accent-color); }
        
        #buff-display {
            grid-column: span 2;
            border-top: 1px solid #444;
            padding-top: 5px;
            margin-top: 5px;
            font-size: 0.85em;
            color: #aaa;
            cursor: help;
            transition: 0.2s;
        }
        #buff-display:hover { background: #333; }

        /* ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚¨ãƒªã‚¢ */
        #event-display {
            min-height: 200px;
            background: #222;
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 1px solid #444;
            position: relative;
            overflow: hidden;
        }
        
        body.inferno-mode #event-display {
            background: #110000;
            border-color: #660000;
        }

        .monster-icon { font-size: 4em; margin-bottom: 10px; display: inline-block; transition: 0.3s; }
        
        /* ç™ºå…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .glow-blue { filter: drop-shadow(0 0 10px #2196f3); }
        .glow-red { filter: drop-shadow(0 0 15px #f44336); transform: scale(1.1); }
        .glow-purple { filter: drop-shadow(0 0 20px #9c27b0); animation: true-form-pulse 2s infinite; transform: scale(1.3); }
        
        /* ç…‰ç„å›ºæœ‰ã®ç™ºå…‰ */
        .glow-inferno { filter: drop-shadow(0 0 15px #ff0000); animation: inferno-pulse 1s infinite alternate; }
        .glow-void { filter: drop-shadow(0 0 15px #000000) drop-shadow(0 0 5px #ff00ff); animation: glitch-anim 2s infinite; }

        @keyframes true-form-pulse {
            0% { filter: drop-shadow(0 0 20px #9c27b0); }
            50% { filter: drop-shadow(0 0 40px #e040fb); }
            100% { filter: drop-shadow(0 0 20px #9c27b0); }
        }
        
        @keyframes inferno-pulse {
            from { filter: drop-shadow(0 0 10px #ff0000); }
            to { filter: drop-shadow(0 0 25px #ff3300); }
        }

        @keyframes glitch-anim {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        @keyframes lilith-pulse {
            0% { filter: drop-shadow(0 0 2px rgba(255, 192, 203, 0.5)); }
            50% { filter: drop-shadow(0 0 15px rgba(255, 20, 147, 0.9)); }
            100% { filter: drop-shadow(0 0 2px rgba(255, 192, 203, 0.5)); }
        }
        .lilith-glow {
            animation: lilith-pulse 3s infinite ease-in-out;
        }
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes spawn-pop { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes damage-shake { 0% { transform: translate(0, 0); filter: none; } 20% { transform: translate(-10px, 0) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } 40% { transform: translate(10px, 0) rotate(5deg); } 60% { transform: translate(-5px, 0); } 80% { transform: translate(5px, 0); } 100% { transform: translate(0, 0); filter: none; } }
        @keyframes attack-lunge { 0% { transform: translateY(0) scale(1); } 30% { transform: translateY(20px) scale(1.2); } 100% { transform: translateY(0) scale(1); } }
        @keyframes screen-shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-5px, 5px); } 50% { transform: translate(5px, -5px); } 75% { transform: translate(-5px, -5px); } 100% { transform: translate(0, 0); } }
        @keyframes float-up { 0% { transform: translateY(0) scale(1); opacity: 1; } 50% { transform: translateY(-30px) scale(1.2); opacity: 1; } 100% { transform: translateY(-60px) scale(1); opacity: 0; } }

        .anim-spawn { animation: spawn-pop 0.5s ease-out forwards; }
        .anim-damage { animation: damage-shake 0.4s ease-in-out; }
        .anim-lunge { animation: attack-lunge 0.3s ease-in-out; }
        .anim-screen-shake { animation: screen-shake 0.3s ease-in-out; }

        .floating-text {
            position: absolute; left: 50%; top: 40%; transform: translateX(-50%);
            font-weight: bold; font-size: 1.5em; pointer-events: none;
            text-shadow: 2px 2px 0 #000; z-index: 100;
            animation: float-up 1s ease-out forwards;
        }

        /* ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .damage-text { color: #ff5252; font-weight: bold; }
        .crit-text { color: #ff0000; font-size: 1.2em; font-weight: bold; text-shadow: 0 0 5px #fff; }
        .heal-text { color: #69f0ae; }
        .gold-text { color: #ffd700; }
        .block-text { color: #2196f3; font-weight: bold; }
        .pierce-text { color: #ff9800; font-weight: bold; }
        .angel-text { color: var(--buff-angel); font-weight: bold; }
        .demon-text { color: var(--buff-demon); font-weight: bold; }
        .mythic-text { color: var(--mythic); font-weight: bold; text-shadow: 0 0 5px #fff; }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        #controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 12px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; font-weight: bold; transition: 0.2s; background: #444; color: white; }
        button:hover { background: #555; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent-color); color: #000; }
        .btn-primary:hover { background: #ffb74d; }
        
        /* ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª */
        #inventory-section { background: #222; padding: 10px; border-radius: var(--border-radius); }
        body.inferno-mode #inventory-section { background: #220000; }

        .equipment-slots { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #444; }
        .equip-row { display: flex; gap: 5px; }
        .equip-slot { flex: 1; background: #333; padding: 8px; border-radius: 4px; text-align: center; font-size: 0.75em; min-height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #444; }
        body.inferno-mode .equip-slot { background: #331111; border-color: #550000; }
        
        .inv-container { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        .inv-col h4 { margin: 0 0 5px 0; font-size: 0.85em; color: #888; text-align: center; border-bottom: 1px solid #444; padding-bottom: 3px; }
        .item-list { display: flex; flex-direction: column; gap: 4px; max-height: 200px; overflow-y: auto; min-height: 50px; background: #2a2a2a; padding: 5px; border-radius: 4px; }
        body.inferno-mode .item-list { background: #1a0505; }
        
        .item { padding: 4px 8px; background: #333; border-radius: 3px; font-size: 0.8em; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; gap: 5px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        body.inferno-mode .item { background: #331111; }
        .item:hover { background: #444; }

        /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£ */
        .rarity-common { color: var(--common); border-color: #555; }
        .rarity-uncommon { color: var(--uncommon); border-color: var(--uncommon); }
        .rarity-rare { color: var(--rare); border-color: var(--rare); }
        .rarity-epic { color: var(--epic); border-color: var(--epic); box-shadow: 0 0 5px var(--epic); }
        .rarity-legendary { color: var(--legendary); border-color: var(--legendary); box-shadow: 0 0 8px var(--legendary); background: linear-gradient(45deg, #333, #443300); animation: shine 2s infinite linear; }
        .rarity-mythic { color: var(--mythic); border-color: var(--mythic); box-shadow: 0 0 15px var(--mythic); background: #220011; animation: shine 1s infinite linear; }
        .rarity-ultra { color: var(--ultra); border-color: var(--ultra); box-shadow: 0 0 20px var(--ultra); background: #001122; animation: shine 0.5s infinite linear; }
        
        @keyframes shine { 0% { border-color: var(--legendary); } 50% { border-color: #fff; } 100% { border-color: var(--legendary); } }

        /* å•†äºº & ã‚¯ãƒ©ãƒ•ãƒˆ */
        .merchant-grid, .craft-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
        .merchant-item, .craft-item { display: flex; flex-direction: column; background: #333; padding: 10px; border-radius: 4px; cursor: pointer; border: 1px solid #444; }
        .merchant-item:hover, .craft-item:hover { background: #444; }
        .m-top { display: flex; justify-content: space-between; font-weight: bold; }
        .m-desc { font-size: 0.8em; color: #aaa; margin-top: 4px; }

        /* ã‚¯ãƒ©ãƒ•ãƒˆãƒ†ãƒ¼ãƒ–ãƒ« */
        #crafting-area { width: 100%; max-height: 300px; overflow-y: auto; }
        .craft-req { color: #888; font-size: 0.85em; margin-top: 3px; }
        .craft-req.ok { color: #4caf50; }
        .craft-req.no { color: #f44336; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #class-modal, #achieve-modal, #compendium-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        /* JSã§display flexã‚’åˆ‡ã‚Šæ›¿ãˆ */

        .class-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; width: 100%; padding: 20px; max-height: 90vh; overflow-y: auto; }
        .class-card {
            background: #333; padding: 20px; border-radius: 8px; cursor: pointer;
            border: 2px solid #555; text-align: center; transition: 0.2s;
        }
        .class-card:hover { border-color: var(--accent-color); background: #444; transform: translateY(-5px); }
        .class-title { font-size: 1.2em; font-weight: bold; color: var(--accent-color); margin-bottom: 10px; }
        .class-desc { font-size: 0.9em; color: #ccc; }

        /* å®Ÿç¸¾ & å›³é‘‘ */
        .achieve-list, .compendium-container { max-height: 70vh; overflow-y: auto; width: 90%; max-width: 600px; background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444; }
        .achieve-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; opacity: 0.5; }
        .achieve-item.unlocked { opacity: 1; background: #2a2a2a; }
        .achieve-info { display: flex; flex-direction: column; }
        .achieve-name { font-weight: bold; font-size: 1.1em; }
        .achieve-cond { font-size: 0.8em; color: #aaa; }
        .achieve-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }

        .compendium-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn { background: #333; border: 1px solid #555; padding: 5px 15px; cursor: pointer; color: #888; }
        .tab-btn.active { background: #555; color: white; border-color: var(--accent-color); }

        .compendium-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; padding-top: 10px; }
        .c-item { 
            background: #333; border: 1px solid #444; border-radius: 4px; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; cursor: help; min-height: 80px; position: relative;
        }
        .c-item.unlocked { background: #2d2d2d; }
        .c-item.unknown { background: #222; border-color: #333; opacity: 0.7; filter: grayscale(100%); }
        .c-item.secret-hidden { background: #000; border-color: #000; cursor: default; }
        
        .c-icon { font-size: 2em; margin-bottom: 5px; }
        .c-name { font-size: 0.75em; line-height: 1.2; word-break: break-all; }
        .c-item.unknown .c-name { color: #666; }

        .hidden { display: none !important; }

        /* --- é­…é­”ãƒªãƒªã‚¹ CSS Art --- */
        .demon-wrapper {
            --skin-color: #ffcdd8;
            --hair-color: #3d2b3d;
            --shadow-color: rgba(0,0,0,0.1);
            width: 100px; 
            height: 100px;
            position: relative; 
            margin: 0 auto;
            overflow: visible;
            pointer-events: none;
        }

        .demon-container * {
            position: absolute;
            box-sizing: border-box;
        }

        .demon-container {
            position: absolute;
            width: 300px;
            height: 350px;
            left: 50%;
            top: 50%;
            margin-left: -150px;
            margin-top: -175px;
            transform: scale(0.25); 
            transform-origin: center center;
            top: 60%; 
        }

        /* --- 1. ãƒ„ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ« --- */
        .twin-tail { width: 35px; height: 170px; background: var(--hair-color); top: 120px; z-index: 0; border-radius: 20px; }
        .twin-tail.left { left: 45px; transform-origin: top right; transform: rotate(20deg); }
        .twin-tail.right { right: 45px; transform-origin: top left; transform: rotate(-20deg); }

        /* --- 2. å°»å°¾ --- */
        .tail { width: 120px; height: 100px; top: 220px; left: 150px; z-index: 2; }
        .tail-curve { width: 80px; height: 80px; border-radius: 50%; border: 8px solid transparent; border-bottom-color: var(--hair-color); border-right-color: var(--hair-color); transform: rotate(45deg); }
        .tail-tip { width: 25px; height: 25px; background: var(--hair-color); bottom: -5px; right: -15px; transform: rotate(45deg); border-radius: 3px; }

        /* --- 3. ä½“ --- */
        .body-shape { width: 90px; height: 100px; background: var(--hair-color); top: 200px; left: 105px; border-radius: 50% 50% 40% 40% / 60% 60% 30% 30%; z-index: 5; }
        .collar { width: 40px; height: 20px; background: #fff; top: 0px; left: 25px; border-radius: 0 0 50% 50%; }

        /* --- 4. æ‰‹ --- */
        .hands { top: 215px; left: 105px; width: 90px; height: 30px; z-index: 6; }
        .hand { width: 30px; height: 30px; background: var(--skin-color); border-radius: 50%; top: 0; box-shadow: 0 2px 5px var(--shadow-color); }
        .hand.left { left: -15px; }
        .hand.right { right: -15px; }

        /* --- 5. é ­éƒ¨ --- */
        .head { width: 180px; height: 170px; background: var(--skin-color); border-radius: 50% 50% 45% 45% / 55% 55% 45% 45%; top: 50px; left: 60px; z-index: 10; box-shadow: 0 5px 15px var(--shadow-color); }
        .hair-bangs { width: 190px; height: 80px; background: var(--hair-color); top: -10px; left: -5px; border-radius: 50% 50% 20% 20% / 70% 70% 30% 30%; z-index: 11; }
        .hair-side { width: 50px; height: 100px; background: var(--hair-color); top: 50px; z-index: 9; }
        .hair-side.left { left: -10px; border-radius: 50% 0 0 50%; transform: rotate(5deg); }
        .hair-side.right { right: -10px; border-radius: 0 50% 50% 0; transform: rotate(-5deg); }
        .horn { width: 35px; height: 55px; background: var(--hair-color); top: -35px; z-index: 8; }
        .horn.left { left: 30px; border-radius: 100% 0 0 0; transform: rotate(-15deg); }
        .horn.right { right: 30px; border-radius: 0 100% 0 0; transform: rotate(15deg); }
    </style>
</head>
<body>

<div id="rebirth-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:400; flex-direction:column; align-items:center; justify-content:center;">
    <div style="background:#111; padding:30px; border-radius:8px; width:90%; max-width:500px; text-align:center; border: 2px solid #00ffcc; box-shadow: 0 0 30px rgba(0, 255, 204, 0.2);">
        <div style="font-size:3em; margin-bottom:10px;">â³</div>
        <h2 style="color:#00ffcc; margin:0 0 10px 0;">è¼ªå»»ã®é¸æŠ</h2>
        <p style="color:#ccc; margin-bottom:20px; line-height:1.6;">
            æ™‚ã¯é¡ã‚Šã€å…¨ã¦ã¯ç„¡ã«å¸°ã™ã€‚<br>
            æ¬¡ã®è¼ªå»»ã¸æŒã¡è¾¼ã‚ã‚‹ã®ã¯ <span style="color:#fff; font-weight:bold;">1ã¤ã®ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼</span> ã®ã¿ã€‚<br>
            <span style="font-size:0.8em; color:#888;">(ãã®ä»–ã®è£…å‚™ã€é“å…·ã€é‡‘è²¨ã€èƒ½åŠ›å€¤ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™)</span>
        </p>
        
        <div id="rebirth-list" style="max-height:300px; overflow-y:auto; display:grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap:10px; padding:10px; background:#222; border-radius:4px; margin-bottom:20px;">
            </div>

        <button onclick="Game.executeRebirth(null)" style="background:#d32f2f; width:100%; padding:15px; border:1px solid #555;">ä½•ã‚‚æŒãŸãšã«é–‹å§‹ã™ã‚‹</button>
        <button onclick="document.getElementById('rebirth-modal').style.display='none'" style="background:#555; width:100%; margin-top:10px; padding:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<div id="class-modal"> 
    <h2 style="color:white; margin-bottom: 30px;">ã‚¯ãƒ©ã‚¹ã‚’é¸æŠ</h2> <div class="class-options">
        <div class="class-card" onclick="Game.selectClass('knight')">
            <div class="class-title">ğŸ›¡ï¸ é¨å£«</div>
            <div class="class-desc">åˆæœŸè£…å‚™ã€Œé¨å£«ã®é•·æ§ã€<br>ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãŒã€Œæ¸¾èº«ã®ä¸€æ’ƒã€ã«å¼·åŒ– (3å€ãƒ€ãƒ¡ãƒ¼ã‚¸)</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('merchant')">
            <div class="class-title">ğŸ’° å•†äºº</div>
            <div class="class-desc">å£²å´ä¾¡æ ¼ 1.2 å€<br>å•†åº—ã§6ã¤ã®å•†å“ã‚’è³¼å…¥å¯èƒ½</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('thief')">
            <div class="class-title">ğŸ—¡ï¸ ç›—è³Š</div>
            <div class="class-desc">å®ç®±ã‚’é–‹ã‘ã‚‹éš›<br>ç½ ã‚„ç©ºç®±ã«é­é‡ã—ãªã„</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('cultist')">
            <div class="class-title">ğŸ˜ˆ æ‚ªé­”ä¿¡å¾’</div>
            <div class="class-desc">é–‹å§‹æ™‚ã«<br>æ‚ªé­”ã®å‘ªã„ã‚’1ã¤æ‰€æŒ</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('scarecrow')">
            <div class="class-title">ğŸŒ¾ ã‚«ã‚«ã‚·</div>
            <div class="class-desc">ãƒãƒ¼ãƒ”ãƒ¼é­é‡æ™‚<br>å¿…ãšè¿½ã„æ‰•ã†</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('ape')">
            <div class="class-title">ğŸ¦ é¡äººçŒ¿</div>
            <div class="class-desc">è»¢å€’ã‚¤ãƒ™ãƒ³ãƒˆæ™‚<br>å¿…ãšå²©å£ã‚’æ´ã‚€</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('challenger')">
            <div class="class-title">ğŸ§— æŒ‘æˆ¦è€…</div>
            <div class="class-desc">ç‰¹æ®Šã‚¹ã‚­ãƒ«ãªã—<br>åˆæœŸã‚¢ã‚¤ãƒ†ãƒ ã€Œå¼·åŠ›ãªãƒãƒ¼ã‚·ãƒ§ãƒ³ã€æ‰€æŒ</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('dragonslayer')">
            <div class="class-title">ğŸ‰ ãƒ‰ãƒ©ã‚´ãƒ³ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>
            <div class="class-desc">åˆæœŸè£…å‚™ã€Œå± ç«œåˆ€ã€ã¨ã€Œç«œé±—ã®é§ã€</div>
        </div>
    </div>
</div>

<div id="achieve-modal">
    <div style="width:90%; max-width:600px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2 style="color:white; margin:0;">ğŸ† å®Ÿç¸¾ãƒªã‚¹ãƒˆ</h2>
        <button onclick="document.getElementById('achieve-modal').style.display='none'" style="background:#555;">é–‰ã˜ã‚‹</button>
    </div>
    <div id="achieve-stats" style="color:#aaa; margin-bottom:10px;"></div>
    <div class="achieve-list" id="achieve-list-content"></div>
</div>

<div id="compendium-modal">
    <div style="width:90%; max-width:600px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2 style="color:white; margin:0;">ğŸ“– ã‚¢ã‚¤ãƒ†ãƒ å›³é‘‘</h2>
        <button onclick="document.getElementById('compendium-modal').style.display='none'" style="background:#555;">é–‰ã˜ã‚‹</button>
    </div>
    <div class="compendium-tabs">
        <button class="tab-btn active" onclick="Game.switchCompendiumTab('items')">ä¸€èˆ¬ã‚¢ã‚¤ãƒ†ãƒ </button>
        <button class="tab-btn" onclick="Game.switchCompendiumTab('accessories')">ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼</button>
        <button class="tab-btn" onclick="Game.switchCompendiumTab('inferno')">ç…‰ç„ãƒ»ç¥è©±</button>
    </div>
    <div id="compendium-stats" style="color:#aaa; margin-bottom:10px;"></div>
    <div class="compendium-container">
        <div class="compendium-grid" id="compendium-content"></div>
    </div>
</div>

<div id="credits-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:200; flex-direction:column; align-items:center; justify-content:center;">
    <div style="width:90%; max-width:400px; background:#222; padding:30px; border-radius:8px; border:1px solid #444; text-align:center; box-shadow: 0 0 20px rgba(0,0,0,0.8);">
        <h2 style="color:white; margin:0 0 15px 0;">ğŸ‘¨â€ğŸ’» ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</h2>
        <p style="color:#ccc; margin-bottom:25px; line-height: 1.5;">
            ã€Šãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ã€‹ã‚’éŠã‚“ã§ã„ãŸã ãæ„Ÿè¬ã—ã¾ã™ï¼<br>æœ€æ–°æƒ…å ±ã¯SNSã§ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
        </p>
        <div style="display:flex; flex-direction:column; gap:15px;">
            <a href="https://www.threads.net/@kanda_shota_art?igshid=NTc4MTIwNjQ2YQ==" target="_blank" style="text-decoration:none;">
                <button style="width:100%; padding:15px; background:#111; color:#fff; border:1px solid #333; font-size:1em; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <span>â—‰</span> Threads (@kanda_shota_art)
                </button>
            </a>
            <a href="https://x.com/shota_at_?s=21" target="_blank" style="text-decoration:none;">
                <button style="width:100%; padding:15px; background:#000; color:#fff; border:1px solid #333; font-size:1em; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <span>ğ•</span> Twitter (X)
                </button>
            </a>
            <a href="https://www.buymeacoffee.com/maker.shota" target="_blank" style="text-decoration:none;">
                <button style="width:100%; padding:15px; background:#FFDD00; color:#000; border:none; font-size:1em; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <span>âš”ï¸</span> é–‹ç™ºã‚’æ”¯æ´ã™ã‚‹
                </button>
            </a>
        </div>
        <button onclick="document.getElementById('credits-modal').style.display='none'" style="margin-top:25px; background:#555; width: 100%;">é–‰ã˜ã‚‹</button>
    </div>
</div>
    
<div id="portable-crafting-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:350; flex-direction:column; align-items:center; justify-content:center;">
    <div style="background:#2d2d2d; padding:20px; border-radius:8px; width:95%; max-width:500px; max-height:80vh; display:flex; flex-direction:column; border: 2px solid #aaa; box-shadow: 0 0 20px rgba(255,255,255,0.15);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
            <h3 style="color:#e0e0e0; margin:0;">ğŸ§° æºå¸¯ç”¨ä½œæ¥­å°</h3>
            <button onclick="document.getElementById('portable-crafting-modal').style.display='none'" style="background:#555; padding:5px 15px;">é–‰ã˜ã‚‹</button>
        </div>
        <div style="margin-bottom:10px; color:#888; font-size:0.9em; text-align:center;">(æºå¸¯ãƒ¢ãƒ¼ãƒ‰ï¼šä¸€èˆ¬ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã®ã¿ä½œæˆå¯èƒ½)</div>
        <div id="portable-craft-content" style="flex:1; overflow-y:auto;"></div>
    </div>
</div>

<div id="inventory-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:300; flex-direction:column; align-items:center; justify-content:center;">
    <div style="width:90%; max-width:600px; max-height:80vh; background:#222; border:1px solid #444; border-radius:8px; display:flex; flex-direction:column; padding:20px; box-shadow:0 0 30px rgba(0,0,0,0.5);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
            <h3 id="inv-modal-title" style="margin:0; color:#e0e0e0;">ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</h3>
            <button onclick="document.getElementById('inventory-modal').style.display='none'" style="background:#555; padding:5px 15px;">é–‰ã˜ã‚‹</button>
        </div>
        <div id="inv-modal-content" style="flex:1; overflow-y:auto; display:grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap:10px; padding-right:5px;">
            </div>
    </div>
</div>

<div id="sell-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:310; flex-direction:column; align-items:center; justify-content:center;">
    <div style="background:#2d2d2d; padding:20px; border-radius:8px; width:80%; max-width:400px; text-align:center; border: 1px solid #ff9800; box-shadow: 0 0 20px rgba(255, 152, 0, 0.2);">
        <h3 style="color:#ff9800; margin-top:0;">ğŸ’° å£²å´ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</h3>
        <p style="color:#aaa; font-size:0.9em; margin-bottom:20px;">(ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã®ç´ æã®ã¿å£²å´ã—ã¾ã™ã€‚ä¿è­·/ç¥è©±ã‚¢ã‚¤ãƒ†ãƒ ã¯å«ã¾ã‚Œã¾ã›ã‚“)</p>
        
        <div id="sell-options-grid" style="display:flex; flex-direction:column; gap:10px; max-height:60vh; overflow-y:auto;">
            </div>

        <button onclick="document.getElementById('sell-modal').style.display='none'" style="margin-top:20px; background:#555; width:100%;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<div id="game-container">


<header>
        <div style="display:flex; align-items:center; gap:10px;">
            <div style="font-weight: bold; font-size: 1.2em;">âš”ï¸ å¹»æƒ³ã®å†’é™º</div>
            <button onclick="Game.showAchievements()" style="padding:4px 8px; font-size:0.8em;">ğŸ† å®Ÿç¸¾</button>
            <button onclick="Game.showCompendium()" style="padding:4px 8px; font-size:0.8em; background:#673ab7;">ğŸ“– å›³é‘‘</button>
<button onclick="Game.showCredits()" style="padding:4px 8px; font-size:0.8em; background:#ff5722; color:white; margin-left:5px;">ğŸ‘¨â€ğŸ’» ä½œè€…</button>
        </div>
        <div id="class-badge" class="class-badge"></div>
    </header>

    <div class="stats-grid">
        <div class="stat-item">HP: <span id="hp-val">100</span> / <span id="max-hp-val">100</span></div>
        <div class="stat-item">æ”»æ’ƒåŠ›: <span id="atk-val">5</span></div>
        <div class="stat-item">ä¼šå¿ƒç‡: <span id="crit-val">5</span>%</div> <div class="stat-item">æ‰€æŒé‡‘: <span id="gold-val">100</span></div>
        <div class="stat-item">æ·±åº¦: <span id="depth-val">0</span> å±¤</div>
        <div id="buff-display" title="ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’ç¢ºèª">çŠ¶æ…‹: ãªã—</div>
    </div>

    <div id="event-display">
        <div id="event-icon" class="monster-icon">ğŸ²</div>
        <h3 id="event-title">å†’é™ºã®æº–å‚™</h3>
        <div id="event-desc">ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„...</div>
        <div id="merchant-area" class="hidden"></div>
        <div id="crafting-area" class="hidden"></div>
    </div>

    <div id="controls">
        <button id="btn-main" class="btn-primary" onclick="Game.nextEvent()">å†’é™ºé–‹å§‹</button>
        <button id="btn-sub" onclick="Game.handleSubAction()" disabled>...</button>
    </div>

    <div id="inventory-section">
        <div class="equipment-slots">
            <div class="equip-row">
                <div class="equip-slot" id="slot-weapon" onclick="Game.unequip('weapon')">æ­¦å™¨ãªã—</div>
                <div class="equip-slot" id="slot-armor" onclick="Game.unequip('armor')">é˜²å…·ãªã—</div>
                <div class="equip-slot" id="slot-shield" onclick="Game.unequip('shield')">ç›¾ãªã—</div>
            </div>
            <div class="equip-row">
                <div class="equip-slot" id="slot-acc1" onclick="Game.unequipAccessory(0)">è£…é£¾å“ 1</div>
                <div class="equip-slot" id="slot-acc2" onclick="Game.unequipAccessory(1)">è£…é£¾å“ 2</div>
                <div class="equip-slot" id="slot-acc3" onclick="Game.unequipAccessory(2)">è£…é£¾å“ 3</div>
            </div>
        </div>
        
<div class="inv-container">
            <div class="inv-col">
                <h4 style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ“¦ è£…å‚™</span>
                    <button onclick="Game.openInventoryModal('equipment')" style="padding:2px 6px; font-size:0.8em; background:#444;">ğŸ”</button>
                </h4>
                <div class="item-list" id="inv-equip"></div>
            </div>
            <div class="inv-col">
                <h4 style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ’ è£…é£¾</span>
                    <button onclick="Game.openInventoryModal('accessory')" style="padding:2px 6px; font-size:0.8em; background:#444;">ğŸ”</button>
                </h4>
                <div class="item-list" id="inv-acc"></div>
            </div>
            <div class="inv-col">
                <h4 style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ§ª æ¶ˆè€—</span>
                    <button onclick="Game.openInventoryModal('consumable')" style="padding:2px 6px; font-size:0.8em; background:#444;">ğŸ”</button>
                </h4>
                <div class="item-list" id="inv-consum"></div>
            </div>
            <div class="inv-col">
                <h4 style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ§© ç´ æ</span>
                    <button onclick="Game.openInventoryModal('material')" style="padding:2px 6px; font-size:0.8em; background:#444;">ğŸ”</button>
                </h4>
                <div class="item-list" id="inv-mat"></div>
            </div>
        </div>

    <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
        <button onclick="Game.manualRestart()" style="width: 100%; background: #d32f2f; opacity: 0.8;">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
    </div>
</div>
<script>
const LILITH_HTML = `
<div class="demon-wrapper">
    <div class="demon-container">
        <div class="twin-tail left"></div>
        <div class="twin-tail right"></div>
        <div class="tail"><div class="tail-curve"><div class="tail-tip"></div></div></div>
        <div class="body-shape"><div class="collar"></div></div>
        <div class="hands"><div class="hand left"></div><div class="hand right"></div></div>
        <div class="head">
            <div class="horn left"></div><div class="horn right"></div>
            <div class="hair-bangs"></div>
            <div class="hair-side left"></div><div class="hair-side right"></div>
        </div>
    </div>
</div>`;
const CONFIG = {
    rarityProb: { common: 0.5, uncommon: 0.3, rare: 0.15, epic: 0.04, legendary: 0.01 },
    rarityDisplay: {
        common: { color: "rarity-common", label: "ä¸€èˆ¬", val: 1 },
        uncommon: { color: "rarity-uncommon", label: "è‰¯è³ª", val: 2 },
        rare: { color: "rarity-rare", label: "ãƒ¬ã‚¢", val: 3 },
        epic: { color: "rarity-epic", label: "ã‚¨ãƒ”ãƒƒã‚¯", val: 4 },
        legendary: { color: "rarity-legendary", label: "ä¼èª¬", val: 5 },
        mythic: { color: "rarity-mythic", label: "ç¥è©±", val: 6 },
        ultra: { color: "rarity-ultra", label: "æ¥µãƒ»ä¼èª¬", val: 7 }
    },
   infernoMonsters: [
        { name: "ã‚·ãƒ£ãƒ‰ã‚¦ã‚¹ãƒ©ã‚¤ãƒ ", weight: 20, baseGold: 50, icon: "ğŸŒ‘", hp: 1000, atk: 150, drop: "æš—å½±ã®ã‚²ãƒ«" },
        { name: "ãƒ´ã‚©ã‚¤ãƒ‰ã‚¢ã‚¤", weight: 20, baseGold: 60, icon: "ğŸ‘ï¸", hp: 2400, atk: 360, drop: "è™šç©ºã®å¡µ" },
        { name: "ãƒã‚°ãƒã‚´ãƒ¼ãƒ¬ãƒ ", weight: 15, baseGold: 100, icon: "ğŸŒ‹", hp: 6000, atk: 400, drop: "æº¶å²©ã®æ ¸", tier: "normal" },
        { name: "ãƒŠã‚¤ãƒˆãƒ¡ã‚¢ãƒ›ãƒ¼ã‚¹", weight: 15, baseGold: 120, icon: "ğŸ¦„", hp: 5000, atk: 600, drop: "æ‚ªå¤¢ã®è§’", tier: "normal" },
        { name: "å •è½ã—ãŸé¨å£«", weight: 10, baseGold: 300, icon: "ğŸ¤º", hp: 10000, atk: 800, drop: "æœ½ã¡ãŸé§", tier: "elite" },
        { name: "ã‚«ã‚ªã‚¹ãƒ»ãƒ†ãƒ³ã‚¿ã‚¯ãƒ«", weight: 10, baseGold: 350, icon: "ğŸ¦‘", hp: 9000, atk: 900, drop: "æ··æ²Œã®ç¥çµŒ", tier: "elite" },
        { name: "ãƒ–ãƒ©ãƒƒãƒ‰ä¼¯çˆµ", weight: 4, baseGold: 800, icon: "ğŸ§›", hp: 24000, atk: 1200, drop: "é®®è¡€ã®ã‚¨ãƒƒã‚»ãƒ³ã‚¹", tier: "boss" },
        { name: "ãƒªãƒƒãƒã‚­ãƒ³ã‚°", weight: 4, baseGold: 900, icon: "ğŸ’€", hp: 20000, atk: 1400, drop: "å‘½åŒ£ã®æ¬ ç‰‡", tier: "boss" },
        { name: "ã‚¢ãƒ“ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³", weight: 2, baseGold: 2000, icon: "ğŸ²", hp: 60000, atk: 2000, drop: "é­”ç«œã®é€†é±—", tier: "boss" },
        { name: "æ—§æ”¯é…è€…", weight: 0.1, baseGold: 9999, icon: "ğŸ™", hp: 99999, atk: 9999, drop: "åçŠ¶ã—ãŒãŸãã‚‚ã®", tier: "boss", isOldOne: true }
    ],
    // ç…‰ç„ç¥è©±è£…å‚™
    infernoItems: [
        { id: "w_ragnarok", name: "ãƒ©ã‚°ãƒŠãƒ­ã‚¯", type: "weapon", val: 2000, rarity: "mythic", price: 10000, icon: "â˜„ï¸", desc: "[çœŸå®Ÿãƒ€ãƒ¡ãƒ¼ã‚¸] 5%ã®ç¢ºç‡ã§ä¸€æ’ƒå¿…æ®º (æ”¯é…è€…ã¨ç¥ã«ã¯ç„¡åŠ¹)" },
        { id: "acc_red_cloth", name: "èµ¤ã„å¸ƒ", type: "accessory", rarity: "mythic", price: 5000, icon: "ğŸ§£", desc: "[ãƒã‚¿ãƒ‰ãƒ¼ãƒ«] ä¼šå¿ƒç‡ +10%ã€ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã®çªé€²ã‚’ç„¡åŠ¹åŒ–" },
        { id: "w_minotaur", name: "ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã®æˆ¦æ–§", type: "weapon", val: 3000, rarity: "mythic", price: 8000, icon: "ğŸª“", desc: "[å—œè¡€æˆé•·] æ•µæ’ƒç ´æ™‚ 1%ã®ç¢ºç‡ã§åŸºç¤ä¼šå¿ƒç‡ãŒæ°¸ä¹…ã« 3% ä¸Šæ˜‡" },
        { id: "w_soulreaver", name: "ã‚½ã‚¦ãƒ«ãƒªãƒ¼ãƒãƒ¼", type: "weapon", val: 1500, rarity: "mythic", price: 8000, icon: "â˜ ï¸", desc: "[å¸è¡€] ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸ã® 10% ã‚’HPã¨ã—ã¦å¸å" },
        { id: "a_voidwalker", name: "ãƒ´ã‚©ã‚¤ãƒ‰ã‚¦ã‚©ãƒ¼ã‚«ãƒ¼", type: "armor", val: 3000, rarity: "mythic", price: 9000, icon: "ğŸ‘»", desc: "[çµ¶å¯¾å›é¿] æ•µã®æ”»æ’ƒã‚’ 10% ã®ç¢ºç‡ã§å›é¿" },
        { 
            id: "acc_wheel", 
            name: "é‹å‘½ã®è¼ª", 
            type: "accessory", 
            rarity: "mythic", 
            price: 12000, 
            icon: "ğŸ¡", 
            desc: "[ä¼šå¿ƒçªç ´] ä¼šå¿ƒç‡ã‚’0ã«ã™ã‚‹ä»£ã‚ã‚Šã€20%ã”ã¨ã«ãƒ€ãƒ¡ãƒ¼ã‚¸å€ç‡+1.0å€" 
        },
        { id: "acc_chaos", name: "ã‚«ã‚ªã‚¹ã‚­ãƒ¥ãƒ¼ãƒ–", type: "accessory", rarity: "mythic", price: 15000, icon: "ğŸ²", desc: "[ãƒ©ãƒ³ãƒ€ãƒ å€ç‡] æ”»æ’ƒå€ç‡ãŒ 0.5~3.0å€ ã®é–“ã§å¤‰å‹•" },
        { id: "c_harpy_blood", name: "ãƒãƒ¼ãƒ”ãƒ¼ã®è¡€", type: "consumable", val: 500, rarity: "mythic", price: 500, icon: "ğŸ·", desc: "HPã‚’ 500 å›å¾©" },
        { id: "c_pure_blood", name: "æµ„åŒ–ã®è¡€", type: "consumable", val: 99999, rarity: "mythic", price: 2000, icon: "âœ¨", desc: "HPã‚’å®Œå…¨å›å¾©" },
        { id: "w_doom", name: "ç ´æ»…ã®å¤§å‰£", type: "weapon", val: 3000, rarity: "mythic", price: 20000, icon: "ğŸ—¡ï¸", desc: "ç´”ç²‹ã‹ã¤æ¥µè‡´ã®ç ´å£ŠåŠ› (æ”»æ’ƒåŠ› 3000)" },

        { 
            id: "s_demon_wall", 
            name: "é­”ç¥ã®å£", 
            type: "shield", 
            val: 10, 
            rarity: "mythic", 
            price: 25000, 
            icon: "ğŸ›¡ï¸", 
            desc: "[çµ¶å¯¾é˜²å¾¡] åœ°ç„ã®é»’æ›œçŸ³ã§ä½œã‚‰ã‚ŒãŸå·¨ç›¾ã€‚æ”»æ’ƒã‚’10å›é˜²ã" 
        },
        { id: "a_apocalypse", name: "çµ‚æœ«ã®é§", type: "armor", val: 1000, rarity: "mythic", price: 20000, icon: "ğŸ›¡ï¸", desc: "[ç”Ÿå‘½è²ªé£Ÿ] æ”»æ’ƒæ™‚ 1%ã®ç¢ºç‡ã§åŸºç¤HPãŒæ°¸ä¹…ã« 100 å¢—åŠ " },

        { 
            id: "acc_transcendence", 
            name: "è¶…è¶Šã®ã‚­ãƒ¥ãƒ¼ãƒ–", 
            type: "accessory", 
            rarity: "mythic", 
            price: 30000, 
            icon: "ğŸ§Š", 
            desc: "[é™ç•Œè¶…è¶Š] æ¯ã‚¿ãƒ¼ãƒ³ 1.0~5.0å€ ã®æ”»æ’ƒå€ç‡ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é©ç”¨ (ã‚«ã‚ªã‚¹ã¨é‡è¤‡å¯)" 
        },
        { 
            id: "w_void_breaker", 
            name: "ãƒ´ã‚©ã‚¤ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼", 
            type: "weapon", 
            val: 2000, 
            rarity: "mythic", 
            price: 30000, 
            icon: "ğŸŒŒ", 
            desc: "[é­‚ã®è²ªé£Ÿ] æ•µæ’ƒç ´æ™‚ 10%ã®ç¢ºç‡ã§åŸºç¤æ”»æ’ƒåŠ›ãŒæ°¸ä¹…ã« 100 å¢—åŠ " 
        },
        { 
            id: "w_primordial", 
            name: "åŸåˆã®å‰£", 
            type: "weapon", 
            val: 111111, 
            rarity: "ultra", 
            price: 99999, 
            icon: "âš”ï¸", 
            desc: "[åŸåˆã®åŠ›] æ”»æ’ƒåŠ›1.5å€ã€‚ç¥ã®ä»£è¡Œè€…ã®ã€è–æ½”ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€‘ã‚’ç„¡è¦– (ãƒ€ãƒ¡ãƒ¼ã‚¸ä¸Šé™ç„¡åŠ¹)" 
        },
        // ç…‰ç„ç‚‰ã®å·»ç‰©
        { 
            id: "c_inferno_scroll", 
            name: "ç…‰ç„ç‚‰ã®å·»ç‰©", 
            type: "consumable", 
            rarity: "mythic", 
            price: 5000, 
            icon: "ğŸ“œ", 
            desc: "ã„ã¤ã§ã‚‚ç…‰ç„ã®ç‚‰ã‚’å¬å–šã§ãã‚‹ (æ¶ˆè€—å“)" 
        }
    
    ],
    // --- ä¸ƒã¤ã®å¤§ç½ªã‚¢ã‚¤ãƒ†ãƒ  ---
   sinItems: [
    { id: "acc_pride", name: "å‚²æ…¢ã®ç³", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ¦", desc: "[å‚²æ…¢] æ”»æ’ƒåŠ› +100%ã€è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ +50%" },
    { id: "acc_envy", name: "å«‰å¦¬ã®é­”ç®±", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ¦Š", desc: "[å«‰å¦¬] æ”»æ’ƒæ™‚ 10%ã®ç¢ºç‡ã§HPã‚’å®Œå…¨å›å¾©" },
    { id: "acc_wrath", name: "æš´æ€’ã®ãƒŠãƒƒã‚¯ãƒ«", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ˜¡", desc: "[æš´æ€’] æ”»æ’ƒåŠ› +1000ã€æ”»æ’ƒæ™‚ 10%ã®ç¢ºç‡ã§2å›æ”»æ’ƒ" },
    { id: "acc_sloth", name: "çœ ã‚Šã®æŒ‡è¼ª", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ’¤", desc: "[æ€ æƒ°] é€ƒèµ°å¤±æ•—æ™‚ã®è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ 50% è»½æ¸›" },
    { id: "acc_greed", name: "é»„é‡‘ã®è–åƒ", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ·", desc: "[å¼·æ¬²] æ•µæ’ƒç ´æ™‚ã®ç²å¾—ã‚´ãƒ¼ãƒ«ãƒ‰ +100%" },
    { id: "acc_gluttony", name: "æš´é£Ÿã®ç‰™", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ²", desc: "[æš´é£Ÿ] æ”»æ’ƒã”ã¨ã«æœ€å¤§HPã® 10% ã‚’å›å¾©" },
    { id: "acc_lust", name: "é­…é­”ã®é¦™æ°´", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ‘™", desc: "[è‰²æ¬²] æˆ¦é—˜ã®æœ€åˆã®æ”»æ’ƒãŒå¿…ãšã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã«ãªã‚‹" },
    { id: "m_crown_sin", name: "åŸç½ªã®ç‹å† ", type: "material", rarity: "ultra", price: 99999, icon: "ğŸ‘‘", desc: "[ç©¶æ¥µ] ä¸ƒã¤ã®å¤§ç½ªã‚’é›†ã‚ã—è¨¼ã€‚çœŸã®ç¥ã‚’å¬å–šã§ãã‚‹ã€‚" }
],

specialItems: {
        chocolate: { name: "é­”åŠ›ã®ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ", type: "material", rarity: "epic", icon: "ğŸ«", desc: "é­”åŠ›ã‚’å¸¯ã³ãŸãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã€‚é£Ÿã¹ã‚‹ã“ã¨ã¯ã§ããªã„ã€‚" },
        note: { name: "ãƒ¡ãƒ¢", type: "material", rarity: "mythic", icon: "ğŸ“„", desc: "ã‚µã‚­ãƒ¥ãƒã‚¹ã®çœŸåãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã€‚(é‡è¦ã‚¢ã‚¤ãƒ†ãƒ )" },
        holy_sword: { name: "ç¥è–ãªå…‰å‰£", type: "weapon", val: 1000, rarity: "mythic", price: 0, icon: "âš”ï¸", desc: "ãƒªãƒªã‚¹ã‹ã‚‰è´ˆã‚‰ã‚ŒãŸç¥å™¨ã€‚" },

        hourglass: { 
        name: "è¼ªå»»ã®ç ‚æ™‚è¨ˆ", 
        type: "consumable", 
        rarity: "ultra", 
        icon: "â³", 
        desc: "ä½¿ç”¨ã™ã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚’åˆæœŸçŠ¶æ…‹(ãƒ¬ãƒ™ãƒ«/é‡‘è²¨/ã‚¢ã‚¤ãƒ†ãƒ æ¶ˆå¤±)ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãŒã€ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã‚’1ã¤ç¶™æ‰¿ã§ãã‚‹ã€‚", 
        price: 0 
    },
},

forgeItems: [
        { 
            id: "acc_shadow", name: "ã‚·ãƒ£ãƒ‰ã‚¦ãƒ€ãƒŸãƒ¼", type: "accessory", rarity: "mythic", price: 20000, icon: "ğŸ‘¤", 
            desc: "[æµä½“å›é¿] 10%ã®ç¢ºç‡ã§ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ç„¡åŠ¹åŒ–ã—åæ’ƒ (é˜²å¾¡åŠ›ã®10%)",
            recipe: { mat: "æš—å½±ã®ã‚²ãƒ«", count: 10 }
        },
        { 
            id: "shield_void", name: "è™šç©ºã®é¡", type: "shield", 
            val: 2, 
            rarity: "mythic", price: 20000, icon: "ğŸª", 
            desc: "[è¦–ç·šå±ˆæŠ˜] ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚’é˜²ãã€‚70%ã®ç¢ºç‡ã§è€ä¹…æ¶ˆè²»ãªã—ã€50%ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’åå°„",
            recipe: { mat: "è™šç©ºã®å¡µ", count: 10 }
        },
        { 
            id: "armor_magma", name: "åœ°æ ¸ã®ç‚‰å¿ƒé§", type: "armor", val: 2000, rarity: "mythic", price: 20000, icon: "ğŸŒ‹", 
            desc: "[éç†±åå¿œ] è¢«ãƒ€ãƒ¡-20%ã€‚ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã€æ•µå‘³æ–¹åŒæ–¹ãŒHP5%æ¸›å°‘ (è‡ªèº«Max, æ•µCurrent)",
            recipe: { mat: "æº¶å²©ã®æ ¸", count: 10 }
        },
        { 
            id: "w_nightmare", name: "ãƒŠã‚¤ãƒˆãƒ¡ã‚¢ãƒ©ãƒ³ã‚¹", type: "weapon", val: 1500, rarity: "mythic", price: 20000, icon: "ğŸ¦„", 
            desc: "[ææ€–ã®çªæ’ƒ] 1ã‚¿ãƒ¼ãƒ³ç›®ã®æ”»æ’ƒåŠ›+100%ã€‚å€’ã—ãã‚Œãªã„å ´åˆã€æ¬¡ã‚¿ãƒ¼ãƒ³æ°—çµ¶",
            recipe: { mat: "æ‚ªå¤¢ã®è§’", count: 10 }
        },
        { 
            id: "acc_dead", name: "äº¡è€…ã®ãƒãƒƒã‚¯ãƒ¬ã‚¹", type: "accessory", rarity: "mythic", price: 20000, icon: "ğŸ’€", 
            desc: "[äº¡è€…ã®æ€¨å¿µ] æ­»äº¡æ™‚ã€éœŠä½“ã¨ãªã‚Š3ã‚¿ãƒ¼ãƒ³å¾©æ´» (æ”»æ’ƒ2å€)ã€‚æ’ƒç ´ã§è˜‡ç”Ÿ",
            recipe: { mat: "æœ½ã¡ãŸé§", count: 10 }
        },
        { 
            id: "w_chaos", name: "æ­£æ°—åº¦ã‚¦ã‚£ãƒƒãƒ—", type: "weapon", val: 0, rarity: "mythic", price: 20000, icon: "ğŸ¦‘", 
            desc: "[æ€è€ƒæ±šæŸ“] æ”»æ’ƒåŠ› 500~5000ã€‚10%ã®ç¢ºç‡ã§æ•µã‚’æ··ä¹±ã•ã›ã‚‹",
            recipe: { mat: "æ··æ²Œã®ç¥çµŒ", count: 10 }
        },
        { 
            id: "acc_blood", name: "è¡€ã®å¥‘ç´„æ›¸", type: "accessory", rarity: "mythic", price: 20000, icon: "ğŸ“œ", 
            desc: "[é®®è¡€è»¢åŒ–] MaxHPåŠæ¸›ã€æ¸›å°‘åˆ†ã‚’æ”»æ’ƒåŠ›ã«åŠ ç®—ã€‚ãƒãƒ¼ã‚·ãƒ§ãƒ³ä½¿ç”¨ä¸å¯",
            recipe: { mat: "é®®è¡€ã®ã‚¨ãƒƒã‚»ãƒ³ã‚¹", count: 10 }
        },
        { 
            id: "acc_phylactery", name: "æ°¸ç”Ÿã®è­·ç¬¦", type: "accessory", rarity: "mythic", price: 20000, icon: "âš±ï¸", 
            desc: "[å‘½åŒ£è²¯è”µ] æ’ƒç ´ã§é­‚ã‚’ä¿å­˜ (Max 200)ã€‚è‡´æ­»æ™‚ã€50é­‚æ¶ˆè²»ã—ã¦HP50%ã§å¾©æ´»",
            recipe: { mat: "å‘½åŒ£ã®æ¬ ç‰‡", count: 10 }
        },
        { 
            id: "armor_dragon", name: "é€†é±—ã®ç«œè£…", type: "armor", val: 4000, rarity: "mythic", price: 20000, icon: "ğŸ‰", 
            desc: "[ç«œã®æ€’ã‚Š] è¢«ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«æ™‚ã€10%ã®ç¢ºç‡ã§æ–¬æ®º (ç¥ã®ä»£è¡Œè€…ã«ã¯ç„¡åŠ¹)",
            recipe: { mat: "é­”ç«œã®é€†é±—", count: 10 }
        },
        
        { 
            id: "w_oldone", name: "æ»…ä¸–ã®æ§", type: "weapon", val: 5000, rarity: "mythic", price: 50000, icon: "ğŸ”±", 
            desc: "[æ”¯é…è€…] 50%ã®ç¢ºç‡ã§æ•µã‚’æ”¯é… (DoT 20, ãƒ‰ãƒ­ãƒƒãƒ—ç‡100%)",
            recipe: { mat: "åçŠ¶ã—ãŒãŸãã‚‚ã®", count: 5 }
        }
    ],


    sinBuffs: {
        sloth_curse: { id: 'sloth_curse', name: 'ğŸ’¤ æ€ æƒ°ã®å‘ªã„', type: 'debuff', desc: 'æ”»æ’ƒä¸å¯ã€é€ƒã’ã‚‹ã®ã¿ (æ®‹ã‚Š10æˆ¦)' },
        greed_shackle: { id: 'greed_shackle', name: 'â›“ï¸ é»„é‡‘ã®æ·', type: 'debuff', desc: 'æ•æ·ä½ä¸‹ã€è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ 20% å¢—åŠ  (æ‚ªé­”å•†äººã§ã®è§£é™¤ãŒå¿…è¦)' },
        lust_charm: { id: 'lust_charm', name: 'ğŸ’‹ é­…äº†ã®é¦™ã‚Š', type: 'debuff', desc: 'ã‚¤ãƒ™ãƒ³ãƒˆé­é‡ã”ã¨ã«æœ€å¤§HPã®10%ã‚’å¤±ã†' }
    },
    sinMonsters: [
        { name: "é¡åƒ", icon: "ğŸ‘¤", hp: 1, atk: 1, drop: "", tier: "boss" }, // æ•°å€¤å‹•çš„ç”Ÿæˆ
        { name: "ãƒãƒ¼ã‚µãƒ¼ã‚«ãƒ¼", icon: "â›“ï¸", hp: 40000, atk: 1000, drop: "", tier: "boss" },
        { name: "é»„é‡‘ã®å·¨åƒ", icon: "ğŸ—½", hp: 1, atk: 1000, drop: "", tier: "boss" } // HPå‹•çš„ç”Ÿæˆ
    ],
    // ---------------------------
   accessories: {
        // --- ã‚¹ãƒ©ã‚¤ãƒ ã‚·ãƒªãƒ¼ã‚º ---
        acc_slime_1: { id: 'acc_slime_1', name: "ã‚²ãƒ«çŠ¶ã®æŒ‡è¼ª", type: 'accessory', rarity: 'common', price: 100, icon: "âšª", desc: "å½¹ã«ç«‹ãŸãªã„", recipe: {mat: "ã‚¹ãƒ©ã‚¤ãƒ ã®ç²˜æ¶²", count: 10} },
        acc_slime_2: { id: 'acc_slime_2', name: "ã‚¨ãƒƒã‚»ãƒ³ã‚¹ã®ãŠå®ˆã‚Š", type: 'accessory', rarity: 'rare', price: 500, icon: "ğŸ”µ", desc: "ã‚¤ãƒ™ãƒ³ãƒˆæ¯ã«HP2å›å¾©", recipe: {mat: "ã‚¹ãƒ©ã‚¤ãƒ ã®ã‚¨ãƒƒã‚»ãƒ³ã‚¹", count: 10} },
        acc_slime_3: { id: 'acc_slime_3', name: "ç²˜æ¶²ã®ç‹å† ", type: 'accessory', rarity: 'epic', price: 2000, icon: "ğŸŸ ", desc: "ã‚¤ãƒ™ãƒ³ãƒˆæ¯ã«HP10å›å¾©", recipe: {mat: "ã‚¹ãƒ©ã‚¤ãƒ ã®ç‹å† ", count: 5} },
        
        // --- ã‚´ãƒ–ãƒªãƒ³ã‚·ãƒªãƒ¼ã‚º ---
        acc_gob_1: { id: 'acc_gob_1', name: "ãƒœãƒ­å¸ƒã®ãƒªãƒ¥ãƒƒã‚¯", type: 'accessory', rarity: 'common', price: 150, icon: "âšª", desc: "é‡‘è²¨ç²å¾—é‡ +5% (å•†äººã¯é™¤ã)", recipe: {mat: "ãƒœãƒ­å¸ƒ", count: 10} },
        acc_gob_2: { id: 'acc_gob_2', name: "é‡‘ã®è€³é£¾ã‚Š", type: 'accessory', rarity: 'rare', price: 600, icon: "ğŸ”µ", desc: "é‡‘è²¨ç²å¾—é‡ +10% (å•†äººã¯é™¤ã)", recipe: {mat: "ã‚´ãƒ–ãƒªãƒ³ã®è€³é£¾ã‚Š", count: 10} },
        acc_gob_3: { id: 'acc_gob_3', name: "å¼·æ¬²ã®é‡‘æ­¯", type: 'accessory', rarity: 'epic', price: 2500, icon: "ğŸŸ ", desc: "é‡‘è²¨ç²å¾—é‡ +20% (å•†äººã¯é™¤ã)", recipe: {mat: "ã‚´ãƒ–ãƒªãƒ³ã®é‡‘æ­¯", count: 5} },
        
        // --- ç‹‚ç‹¼ã‚·ãƒªãƒ¼ã‚º ---
        acc_wolf_1: { id: 'acc_wolf_1', name: "ç‹¼çš®ã®æ‰‹è¢‹", type: 'accessory', rarity: 'common', price: 200, icon: "âšª", desc: "ä¼šå¿ƒç‡ +1%", recipe: {mat: "ç‹¼ã®çš®", count: 10} },
        acc_wolf_2: { id: 'acc_wolf_2', name: "ç‹¼ç‰™ã®é¦–é£¾ã‚Š", type: 'accessory', rarity: 'rare', price: 800, icon: "ğŸ”µ", desc: "ä¼šå¿ƒç‡ +3%", recipe: {mat: "ç‹¼ã®ç‰™", count: 10} },
        acc_wolf_3: { id: 'acc_wolf_3', name: "è¡€æœˆã®ãƒãƒ³ãƒˆ", type: 'accessory', rarity: 'epic', price: 3000, icon: "ğŸŸ ", desc: "ä¼šå¿ƒç‡ +8%", recipe: {mat: "ç‹¼ç‹ã®ãƒãƒ³ãƒˆ", count: 5} },
        
        // --- ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚·ãƒªãƒ¼ã‚º ---
        acc_skel_1: { id: 'acc_skel_1', name: "éª¨ã®æŒ‡è¼ª", type: 'accessory', rarity: 'common', price: 250, icon: "âšª", desc: "è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ 5% è»½æ¸› (ä¼šå¿ƒé™¤ã)", recipe: {mat: "éª¨", count: 10} },
        acc_skel_2: { id: 'acc_skel_2', name: "é­‚ã®å™¨", type: 'accessory', rarity: 'rare', price: 1000, icon: "ğŸ”µ", desc: "è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ 10% è»½æ¸› (ä¼šå¿ƒé™¤ã)", recipe: {mat: "é­‚ã®æ¬ ç‰‡", count: 10} },
        acc_skel_3: { id: 'acc_skel_3', name: "æ­»éœŠã®è­·ç¬¦", type: 'accessory', rarity: 'epic', price: 3500, icon: "ğŸŸ ", desc: "è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ 15% è»½æ¸› (ä¼šå¿ƒå«ã‚€)", recipe: {mat: "æ­»éœŠã®é ­è“‹éª¨", count: 5} },
        
        // --- ã‚ªãƒ¼ã‚¯ã‚·ãƒªãƒ¼ã‚º ---
        acc_orc_1: { id: 'acc_orc_1', name: "æŠ˜ã‚ŒãŸå‰£ã®é£¾ã‚Š", type: 'accessory', rarity: 'common', price: 300, icon: "âšª", desc: "ãƒãƒ¼ãƒ”ãƒ¼æ’ƒé€€ç‡ +10%", recipe: {mat: "æŠ˜ã‚ŒãŸå‰£", count: 10} },
        acc_orc_2: { id: 'acc_orc_2', name: "è›®æ—ã®è­·ç¬¦", type: 'accessory', rarity: 'rare', price: 1200, icon: "ğŸ”µ", desc: "ãƒãƒ¼ãƒ”ãƒ¼æ’ƒé€€ç‡ +30%", recipe: {mat: "ã‚ªãƒ¼ã‚¯ã®è­·ç¬¦", count: 10} },
        acc_orc_3: { id: 'acc_orc_3', name: "å¨ä¿¡ã®è§’ç¬›", type: 'accessory', rarity: 'epic', price: 4000, icon: "ğŸŸ ", desc: "ãƒãƒ¼ãƒ”ãƒ¼ã‚’å¿…ãšæ’ƒé€€", recipe: {mat: "æˆ¦äº‰ã®è§’ç¬›", count: 5} },
        
        // --- å¹½éœŠã‚·ãƒªãƒ¼ã‚º ---
        acc_ghost_1: { id: 'acc_ghost_1', name: "éœŠè³ªã®ãƒãƒ³ãƒˆ", type: 'accessory', rarity: 'common', price: 350, icon: "âšª", desc: "é€ƒèµ°æˆåŠŸç‡ +2%", recipe: {mat: "ã‚¨ã‚¯ãƒˆãƒ—ãƒ©ã‚ºãƒ ", count: 10} },
        acc_ghost_2: { id: 'acc_ghost_2', name: "æ€¨å¿µã®æ•°ç ", type: 'accessory', rarity: 'rare', price: 1500, icon: "ğŸ”µ", desc: "é€ƒèµ°æˆåŠŸç‡ +5%", recipe: {mat: "æ€¨å¿µã®é›†åˆä½“", count: 10} },
        acc_ghost_3: { id: 'acc_ghost_3', name: "å†¥ç•Œã®ãƒ©ãƒ³ã‚¿ãƒ³", type: 'accessory', rarity: 'epic', price: 4500, icon: "ğŸŸ ", desc: "é€ƒèµ°æˆåŠŸç‡ +10%", recipe: {mat: "å¹½éœŠã®ãƒ©ãƒ³ã‚¿ãƒ³", count: 5} },
        
        // --- ã‚´ãƒ¼ãƒ¬ãƒ ã‚·ãƒªãƒ¼ã‚º ---
        acc_golem_1: { id: 'acc_golem_1', name: "çŸ³å¡Šã®ãƒãƒƒã‚¸", type: 'accessory', rarity: 'common', price: 500, icon: "âšª", desc: "æœ€å¤§HP +30", recipe: {mat: "çŸ³å¡Š", count: 10} },
        acc_golem_2: { id: 'acc_golem_2', name: "é­”å°ã‚³ã‚¢", type: 'accessory', rarity: 'rare', price: 2000, icon: "ğŸ”µ", desc: "æœ€å¤§HP +100", recipe: {mat: "é­”åŠ›ã‚³ã‚¢", count: 10} },
        acc_golem_3: { id: 'acc_golem_3', name: "ç£çŸ³ã®å¿ƒ", type: 'accessory', rarity: 'epic', price: 6000, icon: "ğŸŸ ", desc: "æœ€å¤§HP +200", recipe: {mat: "å¤§åœ°ã®å¿ƒ", count: 5} },
        
        // --- ãƒˆãƒ­ãƒ¼ãƒ«ã‚·ãƒªãƒ¼ã‚º ---
        acc_troll_1: { id: 'acc_troll_1', name: "æ£æ£’ã®ãŠå®ˆã‚Š", type: 'accessory', rarity: 'common', price: 600, icon: "âšª", desc: "æ”»æ’ƒåŠ› +10", recipe: {mat: "å·¨å¤§ãªæ£æ£’", count: 10} },
        acc_troll_2: { id: 'acc_troll_2', name: "é®®è¡€ã®ç“¶", type: 'accessory', rarity: 'rare', price: 2500, icon: "ğŸ”µ", desc: "æ”»æ’ƒåŠ› +20", recipe: {mat: "ãƒˆãƒ­ãƒ¼ãƒ«ã®è¡€", count: 10} },
        acc_troll_3: { id: 'acc_troll_3', name: "å¤ã®ãƒˆãƒ¼ãƒ†ãƒ ", type: 'accessory', rarity: 'epic', price: 7000, icon: "ğŸŸ ", desc: "æ”»æ’ƒåŠ› +35", recipe: {mat: "ãƒˆãƒ­ãƒ¼ãƒ«ã®ãƒˆãƒ¼ãƒ†ãƒ ", count: 5} },
        
        // --- ãƒ¯ã‚¤ãƒãƒ¼ãƒ³ã‚·ãƒªãƒ¼ã‚º ---
        acc_wyv_1: { id: 'acc_wyv_1', name: "ç«œã®é±—", type: 'accessory', rarity: 'common', price: 1000, icon: "âšª", desc: "ãƒœã‚¹ã¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ +5%", recipe: {mat: "ç«œã®é±—", count: 10} },
        acc_wyv_2: { id: 'acc_wyv_2', name: "ç«œæ¶™ã®ãƒšãƒ³ãƒ€ãƒ³ãƒˆ", type: 'accessory', rarity: 'rare', price: 4000, icon: "ğŸ”µ", desc: "ãƒœã‚¹ã¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ +8%", recipe: {mat: "ç«œã®æ¶™", count: 10} },
        acc_wyv_3: { id: 'acc_wyv_3', name: "çœŸç«œã®å¿ƒè‡“", type: 'accessory', rarity: 'epic', price: 8000, icon: "ğŸŸ ", desc: "ãƒœã‚¹ã¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ +20%", recipe: {mat: "ç«œã®å¿ƒè‡“", count: 5} },
        
        // --- é­”ç‹ã‚·ãƒªãƒ¼ã‚º ---
        acc_demon_1: { id: 'acc_demon_1', name: "é—‡ã®æ¬ ç‰‡", type: 'accessory', rarity: 'rare', price: 2000, icon: "âšª", desc: "æ”»+10 HP+10 ä¼šå¿ƒ+2%", recipe: {mat: "ãƒ€ãƒ¼ã‚¯ãƒã‚¿ãƒ¼", count: 10} },
        acc_demon_2: { id: 'acc_demon_2', name: "é­”å›ã®è¨˜ç« ", type: 'accessory', rarity: 'epic', price: 5000, icon: "ğŸ”µ", desc: "æ”»+20 HP+20 ä¼šå¿ƒ+5%", recipe: {mat: "é­”ç‹ã®å°", count: 10} },
        acc_demon_3: { id: 'acc_demon_3', name: "æ··æ²Œã®é­”çœ¼", type: 'accessory', rarity: 'legendary', price: 10000, icon: "ğŸŸ ", desc: "æ”»+40 HP+40 ä¼šå¿ƒ+20%", recipe: {mat: "é­”ç¥ã®çœ¼", count: 5} }
    },
    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æ›´æ–° (ãƒ‘ãƒãƒ³ã‚³ã¨ãƒ•ãƒƒã‚¯çµ±åˆ)
    lootData: {
        "ã‚¹ãƒ©ã‚¤ãƒ ã®ç²˜æ¶²": { price: 10, rarity: "common", icon: "ğŸ’§" },
        "ã‚¹ãƒ©ã‚¤ãƒ ã®ã‚¨ãƒƒã‚»ãƒ³ã‚¹": { price: 50, rarity: "uncommon", icon: "âœ¨" },
        "ã‚¹ãƒ©ã‚¤ãƒ ã®ç‹å† ": { price: 200, rarity: "rare", icon: "ğŸ‘‘" },
        "ãƒœãƒ­å¸ƒ": { price: 15, rarity: "common", icon: "ğŸ§¶" },
        "ã‚´ãƒ–ãƒªãƒ³ã®è€³é£¾ã‚Š": { price: 60, rarity: "uncommon", icon: "ğŸ’" },
        "ã‚´ãƒ–ãƒªãƒ³ã®é‡‘æ­¯": { price: 250, rarity: "rare", icon: "ğŸ¦·" },
        "ç‹¼ã®çš®": { price: 20, rarity: "common", icon: "ğŸ§µ" },
        "ç‹¼ã®ç‰™": { price: 80, rarity: "uncommon", icon: "ğŸ¦´" },
        "ç‹¼ç‹ã®ãƒãƒ³ãƒˆ": { price: 300, rarity: "rare", icon: "ğŸ§£" },
        "éª¨": { price: 25, rarity: "common", icon: "ğŸ¦´" },
        "é­‚ã®æ¬ ç‰‡": { price: 100, rarity: "uncommon", icon: "ğŸ‘»" },
        "æ­»éœŠã®é ­è“‹éª¨": { price: 350, rarity: "rare", icon: "ğŸ’€" },
        "æŠ˜ã‚ŒãŸå‰£": { price: 30, rarity: "common", icon: "ğŸ—¡ï¸" },
        "ã‚ªãƒ¼ã‚¯ã®è­·ç¬¦": { price: 120, rarity: "uncommon", icon: "ğŸ§¿" },
        "æˆ¦äº‰ã®è§’ç¬›": { price: 400, rarity: "rare", icon: "ğŸ“¯" },
        "ã‚¨ã‚¯ãƒˆãƒ—ãƒ©ã‚ºãƒ ": { price: 35, rarity: "common", icon: "ğŸŒ«ï¸" },
        "æ€¨å¿µã®é›†åˆä½“": { price: 150, rarity: "uncommon", icon: "ğŸ‘¿" },
        "å¹½éœŠã®ãƒ©ãƒ³ã‚¿ãƒ³": { price: 450, rarity: "rare", icon: "ğŸ®" },
        "çŸ³å¡Š": { price: 50, rarity: "common", icon: "ğŸª¨" },
        "é­”åŠ›ã‚³ã‚¢": { price: 200, rarity: "rare", icon: "ğŸ”®" },
        "å¤§åœ°ã®å¿ƒ": { price: 600, rarity: "epic", icon: "ğŸ’" },
        "å·¨å¤§ãªæ£æ£’": { price: 60, rarity: "common", icon: "ğŸªµ" },
        "ãƒˆãƒ­ãƒ¼ãƒ«ã®è¡€": { price: 250, rarity: "rare", icon: "ğŸ©¸" },
        "ãƒˆãƒ­ãƒ¼ãƒ«ã®ãƒˆãƒ¼ãƒ†ãƒ ": { price: 700, rarity: "epic", icon: "ğŸ—¿" },
        "ç«œã®é±—": { price: 100, rarity: "uncommon", icon: "ğŸ›¡ï¸" },
        "ç«œã®æ¶™": { price: 400, rarity: "rare", icon: "ğŸ’§" },
        "ç«œã®å¿ƒè‡“": { price: 800, rarity: "epic", icon: "â¤ï¸" },
        "ãƒ€ãƒ¼ã‚¯ãƒã‚¿ãƒ¼": { price: 200, rarity: "rare", icon: "âš«" },
        "é­”ç‹ã®å°": { price: 500, rarity: "epic", icon: "ğŸ”¯" },
        "é­”ç¥ã®çœ¼": { price: 1000, rarity: "legendary", icon: "ğŸ‘ï¸" },
        "çœŸå®Ÿã®å¿ƒ": { price: 5000, rarity: "mythic", icon: "ğŸ’–" },
        // ç…‰ç„ç´ æ
        "æš—å½±ã®ã‚²ãƒ«": { price: 1000, rarity: "mythic", icon: "âš«" },
        "è™šç©ºã®å¡µ": { price: 1200, rarity: "mythic", icon: "ğŸŒ«ï¸" },
        "æº¶å²©ã®æ ¸": { price: 1500, rarity: "mythic", icon: "ğŸ”¥" },
        "æ‚ªå¤¢ã®è§’": { price: 1800, rarity: "mythic", icon: "ğŸ¦„" },
        "æœ½ã¡ãŸé§": { price: 3000, rarity: "mythic", icon: "ğŸ›¡ï¸" },
        "æ··æ²Œã®ç¥çµŒ": { price: 3500, rarity: "mythic", icon: "ğŸ§ " },
        "é®®è¡€ã®ã‚¨ãƒƒã‚»ãƒ³ã‚¹": { price: 5000, rarity: "mythic", icon: "ğŸ©¸" },
        "å‘½åŒ£ã®æ¬ ç‰‡": { price: 6000, rarity: "mythic", icon: "ğŸ’€" },
        "é­”ç«œã®é€†é±—": { price: 10000, rarity: "mythic", icon: "ğŸ²" },
        "åçŠ¶ã—ãŒãŸãã‚‚ã®": { price: 50000, rarity: "ultra", icon: "ğŸ™" },
        // æ–°ã‚¢ã‚¤ãƒ†ãƒ 
        "ãƒ‘ãƒãƒ³ã‚³": { price: 0, rarity: "rare", icon: "ğŸªƒ", desc: "ãƒãƒ¼ãƒ”ãƒ¼é­é‡æ™‚ã€å¿…ãšæ’ƒé€€ã§ãã‚‹ã€‚ä½¿ç”¨å¾Œæ¶ˆæ»…ã€‚å£²å´ä¸å¯" },
        "ãƒ•ãƒƒã‚¯": { price: 0, rarity: "rare", icon: "ğŸª", desc: "è»¢å€’æ™‚ã€1å›ã ã‘å›é¿ã—ã¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’å…¥æ‰‹ã§ãã‚‹ã€‚ä½¿ç”¨å¾Œæ¶ˆæ»…ã€‚å£²å´ä¸å¯" }
    },
    buffs: {
        angel_song: { id: 'angel_song', name: 'ğŸ‘¼ å¤©ä½¿ã®æ­Œ', type: 'angel', desc: 'ã‚¤ãƒ™ãƒ³ãƒˆæ¯ã« HP 5 å›å¾©' },
        angel_protection: { id: 'angel_protection', name: 'ğŸ›¡ï¸ å¤©ä½¿ã®åŠ è­·', type: 'angel', desc: 'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‹ã‚‰ã®è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ 30% è»½æ¸›' },
        angel_courage: { id: 'angel_courage', name: 'âš”ï¸ å¤©ä½¿ã®å‹‡æ°—', type: 'angel', desc: 'ä¼šå¿ƒç‡ãŒ 20% ã«ä¸Šæ˜‡' },
        angel_wings: { id: 'angel_wings', name: 'ğŸ•Šï¸ å¤©ä½¿ã®ç¿¼', type: 'angel', desc: 'é€ƒèµ°æˆåŠŸç‡ãŒ 60% ã«ä¸Šæ˜‡' },
        demon_wealth: { id: 'demon_wealth', name: 'ğŸ’° æ‚ªé­”ã®å¯Œ', type: 'demon', desc: 'æ”»æ’ƒæ™‚ 5G ç²å¾—ã€é€ƒèµ°å¤±æ•—æ™‚ 5G æ²¡å' },
        demon_destruction: { id: 'demon_destruction', name: 'ğŸ’€ æ‚ªé­”ã®ç ´å£Š', type: 'demon', desc: '10%ã®ç¢ºç‡ã§æ•µã‚’å³æ­»ã€ç™ºå‹•æ™‚HP90%æ¸›å°‘' },
        demon_enhance: { id: 'demon_enhance', name: 'ğŸ”¥ æ‚ªé­”ã®å¼·åŒ–', type: 'demon', desc: 'æ•µå‘³æ–¹åŒæ–¹ã®ä¼šå¿ƒç‡ãŒ 50% ã«ãªã‚‹' },
        demon_wager: { id: 'demon_wager', name: 'ğŸ² æ‚ªé­”ã®è³­ã‘', type: 'demon', desc: 'é€ƒèµ°ç‡80%ã€ãŸã ã—é€ƒèµ°æ™‚1%ã®ç¢ºç‡ã§å³æ­»' }
    },
    monsters: [
        { name: "ã‚¹ãƒ©ã‚¤ãƒ ", weight: 13.5, baseGold: 1, icon: "ğŸ¦ ", hp: 20, atk: 3, drop: "ã‚¹ãƒ©ã‚¤ãƒ ã®ç²˜æ¶²", eliteDrop: "ã‚¹ãƒ©ã‚¤ãƒ ã®ã‚¨ãƒƒã‚»ãƒ³ã‚¹", bossDrop: "ã‚¹ãƒ©ã‚¤ãƒ ã®ç‹å† " },
        { name: "ã‚´ãƒ–ãƒªãƒ³", weight: 13.5, baseGold: 2, icon: "ğŸ‘º", hp: 35, atk: 5, drop: "ãƒœãƒ­å¸ƒ", eliteDrop: "ã‚´ãƒ–ãƒªãƒ³ã®è€³é£¾ã‚Š", bossDrop: "ã‚´ãƒ–ãƒªãƒ³ã®é‡‘æ­¯" },
        { name: "ç‹‚ç‹¼", weight: 13.5, baseGold: 3, icon: "ğŸº", hp: 50, atk: 8, drop: "ç‹¼ã®çš®", eliteDrop: "ç‹¼ã®ç‰™", bossDrop: "ç‹¼ç‹ã®ãƒãƒ³ãƒˆ" },
        { name: "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", weight: 13.5, baseGold: 4, icon: "ğŸ’€", hp: 60, atk: 10, drop: "éª¨", eliteDrop: "é­‚ã®æ¬ ç‰‡", bossDrop: "æ­»éœŠã®é ­è“‹éª¨" },
        { name: "ã‚ªãƒ¼ã‚¯", weight: 13.5, baseGold: 8, icon: "ğŸ‘¹", hp: 90, atk: 12, drop: "æŠ˜ã‚ŒãŸå‰£", eliteDrop: "ã‚ªãƒ¼ã‚¯ã®è­·ç¬¦", bossDrop: "æˆ¦äº‰ã®è§’ç¬›" },
        { name: "ã‚´ãƒ¼ã‚¹ãƒˆ", weight: 13.5, baseGold: 10, icon: "ğŸ‘»", hp: 70, atk: 15, drop: "ã‚¨ã‚¯ãƒˆãƒ—ãƒ©ã‚ºãƒ ", eliteDrop: "æ€¨å¿µã®é›†åˆä½“", bossDrop: "å¹½éœŠã®ãƒ©ãƒ³ã‚¿ãƒ³" },
        { name: "ã‚´ãƒ¼ãƒ¬ãƒ ", weight: 9, baseGold: 15, icon: "ğŸ—¿", hp: 150, atk: 20, drop: "çŸ³å¡Š", eliteDrop: "é­”åŠ›ã‚³ã‚¢", bossDrop: "å¤§åœ°ã®å¿ƒ" },
        
        { name: "ãƒˆãƒ­ãƒ¼ãƒ«", weight: 4, baseGold: 25, icon: "ğŸ§Ÿ", hp: 200, atk: 25, drop: "å·¨å¤§ãªæ£æ£’", eliteDrop: "ãƒˆãƒ­ãƒ¼ãƒ«ã®è¡€", bossDrop: "ãƒˆãƒ­ãƒ¼ãƒ«ã®ãƒˆãƒ¼ãƒ†ãƒ " },
        
        { name: "ãƒ¯ã‚¤ãƒãƒ¼ãƒ³", weight: 4, baseGold: 40, icon: "ğŸ‰", hp: 300, atk: 35, drop: "ç«œã®é±—", eliteDrop: "ç«œã®æ¶™", bossDrop: "ç«œã®å¿ƒè‡“" },
        
        { name: "é­”ç‹", weight: 2, baseGold: 50, icon: "ğŸ‘¿", hp: 500, atk: 50, drop: "ãƒ€ãƒ¼ã‚¯ãƒã‚¿ãƒ¼", eliteDrop: "é­”ç‹ã®å°", bossDrop: "é­”ç¥ã®çœ¼" }
    ],
    itemPool: [
        { name: "éŒ†ã³ãŸãƒ€ã‚¬ãƒ¼", type: "weapon", val: 3, rarity: "common", price: 15, icon: "ğŸ—¡ï¸" },
        { name: "æœ¨ã®æ£’", type: "weapon", val: 4, rarity: "common", price: 20, icon: "ğŸªµ" },
        { name: "å¸ƒã®æœ", type: "armor", val: 10, rarity: "common", price: 15, icon: "ğŸ‘•" },
        { name: "å›å¾©ãƒãƒ¼ã‚·ãƒ§ãƒ³", type: "consumable", val: 30, rarity: "common", price: 25, icon: "ğŸ§ª", desc: "HPã‚’30å›å¾©" },
        { name: "é¨å£«ã®é•·æ§", type: "weapon", val: 12, rarity: "uncommon", price: 80, icon: "ğŸ”±" },
        { name: "ãƒã‚§ãƒ¼ãƒ³ãƒ¡ã‚¤ãƒ«", type: "armor", val: 40, rarity: "uncommon", price: 80, icon: "ğŸ›¡ï¸" },
        { name: "å¼·åŠ›ãªãƒãƒ¼ã‚·ãƒ§ãƒ³", type: "consumable", val: 80, rarity: "uncommon", price: 60, icon: "ğŸ·", desc: "HPã‚’80å›å¾©" },
        { name: "ãƒŸã‚¹ãƒªãƒ«ã®å‰£", type: "weapon", val: 30, rarity: "rare", price: 250, icon: "âš”ï¸" },
        { name: "ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¢ãƒ¼ãƒãƒ¼", type: "armor", val: 100, rarity: "rare", price: 250, icon: "ğŸ›¡ï¸" },
        { name: "é¨å£«ã®ç›¾", type: "shield", val: 2, rarity: "rare", price: 300, icon: "ğŸ›¡ï¸" },
        { name: "ã‚¨ãƒªã‚¯ã‚µãƒ¼", type: "consumable", val: 200, rarity: "rare", price: 150, icon: "ğŸ§‰", desc: "HPã‚’200å›å¾©" },
        { name: "å± ç«œå‰£", type: "weapon", val: 60, rarity: "epic", price: 800, icon: "ğŸ‰" },
        { name: "ç«œé±—ã®é§", type: "armor", val: 250, rarity: "epic", price: 800, icon: "ğŸ¥‹" },
        { name: "ã‚¿ãƒ¯ãƒ¼ã‚·ãƒ¼ãƒ«ãƒ‰", type: "shield", val: 5, rarity: "epic", price: 500, icon: "ğŸ§±" },
        { name: "è–å‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼", type: "weapon", val: 150, rarity: "legendary", price: 2500, icon: "ğŸŒŸ" },
        { name: "ç¥ã®è¼ã", type: "armor", val: 400, rarity: "legendary", price: 2000, icon: "ğŸŒ" },
        { name: "ã‚¤ãƒ¼ã‚¸ã‚¹ã®ç›¾", type: "shield", val: 8, rarity: "legendary", price: 900, icon: "ğŸ”±" },
{ name: "æºå¸¯ç”¨ä½œæ¥­å°", type: "consumable", rarity: "rare", price: 1500, icon: "ğŸ§°", desc: "ã©ã“ã§ã‚‚è£½ä½œã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã‘ã‚‹ (æ¶ˆè€—å“)" }
    ],
    phoenixFeather: {
        id: "phoenix_feather",
        name: "ä¸æ­»é³¥ã®ç¾½æ ¹",
        type: "revive",
        rarity: "legendary",
        icon: "ğŸª¶",
        price: 0,
        desc: "æ­»äº¡æ™‚ã€HP50%ã§å¾©æ´»ã™ã‚‹ã€‚å£²å´ä¸å¯"
    },
    bible: {
        id: "inferno_bible",
        name: "ç…‰ç„ã®è–æ›¸",
        type: "special",
        rarity: "mythic",
        icon: "ğŸ“•",
        desc: "ç…‰ç„ã¸ã®æ‰‰ã‚’é–‹ã",
        recipe: {mat: "çœŸå®Ÿã®å¿ƒ", count: 2}
    },
achievements: [
        // --- ğŸŒŒ æ·±æ·µæ¢ç´¢ (é€²åº¦) ---
        { id: "abyss_50", name: "æ·±æ·µã®å‘¼ã³å£°", cond: "åˆã‚ã¦å±é™ºãªé ˜åŸŸã«è¸ã¿å…¥ã‚‹ (50å±¤åˆ°é”)", rarity: "common", check: (p) => p.depth >= 50 },
        { id: "abyss_100", name: "ç™¾å±¤ã®è©¦ç·´", cond: "ç”Ÿå­˜ã®è³‡æ ¼ã‚’è¨¼æ˜ã™ã‚‹ (100å±¤åˆ°é”)", rarity: "rare", check: (p) => p.depth >= 100 },
        { id: "abyss_500", name: "å¸¸å¤œã®æ—…äºº", cond: "é—‡ã¨å­¤ç‹¬ã«æ…£ã‚Œã‚‹ (500å±¤åˆ°é”)", rarity: "epic", check: (p) => p.depth >= 500 },
        { id: "abyss_1000", name: "åƒå±¤ã®åŸ·å¿µ", cond: "å‡¡äººã«ã¯åˆ°é”å›°é›£ãªå¢ƒåœ° (1000å±¤åˆ°é”)", rarity: "legendary", check: (p) => p.depth >= 1000 },
        { id: "abyss_10000", name: "æ·±æ·µã®æœã¦", cond: "çµ‚ã‚ã‚Šã®ãªã„ä¼èª¬ã®ç›®æ’ƒè€… (10000å±¤åˆ°é”)", rarity: "ultra", check: (p) => p.depth >= 10000, hidden: true },
        
        // --- âš”ï¸ æˆ¦é—˜ã¨åé›† (åŸºç¤) ---
        { id: "hero_kill", name: "å½ã‚Šã®çµ‚ç„‰", cond: "è¡¨å±¤ä¸–ç•Œã®é­”ç‹ã‚’æ’ƒç ´ã™ã‚‹ (1000å±¤ãƒœã‚¹)", rarity: "legendary", check: (p) => p.kill1000Boss },
        { id: "phoenix", name: "æ¶…æ§ƒã®æ®‹ã‚Šç«", cond: "ã€Œä¸æ­»é³¥ã®ç¾½æ ¹ã€ã‚’å…¥æ‰‹ã™ã‚‹", rarity: "legendary", check: (p) => p.history.items.has("ä¸æ­»é³¥ã®ç¾½æ ¹") },
        { id: "collector", name: "æº€è¼‰ã®ãƒªãƒ¥ãƒƒã‚¯", cond: "20ç¨®é¡ã®ç•°ãªã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’åé›†", rarity: "common", check: (p) => Game.getCollectedItemsCount() >= 20 },
        { id: "researcher", name: "é­”ç‰©å­¦è€…", cond: "å…¨ã¦ã®ä¸€èˆ¬ãƒ»ã‚¨ãƒªãƒ¼ãƒˆãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚’å…¥æ‰‹", rarity: "epic", check: (p) => Game.checkDrops('researcher') },
        { id: "prospector", name: "ä¸‡ç‰©ã®è¦³å¯Ÿè€…", cond: "è¡¨å±¤ä¸–ç•Œã®å…¨ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚’å…¥æ‰‹ (ãƒœã‚¹å«ã‚€)", rarity: "legendary", check: (p) => Game.checkDrops('prospector') },
        { id: "hero_true", name: "çœŸå®Ÿã®å‹‡æ°—", cond: "ã€ŒçœŸå®Ÿã®å¿ƒã€ã‚’å…¥æ‰‹ã—ã€ä¸–ç•Œã®çœŸå®Ÿã‚’çŸ¥ã‚‹", rarity: "mythic", hidden: true, check: (p) => p.history.items.has("çœŸå®Ÿã®å¿ƒ") },

        // --- ğŸ”¥ ç…‰ç„ã¨ç¥è©± (ä¸Šç´š) ---
        { id: "inferno_enter", name: "åœ°ç„ã®è¾ºå¢ƒ", cond: "ç…‰ç„ã®è–æ›¸ã‚’ä½¿ã„ã€ç…‰ç„ä¸–ç•Œã¸å •ã¡ã‚‹", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.inInferno },
        { id: "mythic_smith", name: "é»’æ›œçŸ³ã®éšéŸ³", cond: "ã€Œç…‰ç„ã®ç‚‰ã€ã§ç¥è©±è£…å‚™ã‚’è£½ä½œã™ã‚‹", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has('ã‚·ãƒ£ãƒ‰ã‚¦ãƒ€ãƒŸãƒ¼') || p.history.items.has('è™šç©ºã®é¡') || p.history.items.has('åœ°æ ¸ã®ç‚‰å¿ƒé§') || p.history.items.has('ãƒŠã‚¤ãƒˆãƒ¡ã‚¢ãƒ©ãƒ³ã‚¹') || p.history.items.has('äº¡è€…ã®ãƒãƒƒã‚¯ãƒ¬ã‚¹') || p.history.items.has('æ­£æ°—åº¦ã‚¦ã‚£ãƒƒãƒ—') || p.history.items.has('è¡€ã®å¥‘ç´„æ›¸') || p.history.items.has('æ°¸ç”Ÿã®è­·ç¬¦') || p.history.items.has('é€†é±—ã®ç«œè£…') || p.history.items.has('æ»…ä¸–ã®æ§') },
        { id: "old_one_end", name: "åçŠ¶ã—ãŒãŸãææ€–", cond: "ç…‰ç„æ·±éƒ¨ã®ã€Œæ—§æ”¯é…è€…ã€ã‚’æ’ƒç ´ã™ã‚‹", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("åçŠ¶ã—ãŒãŸãã‚‚ã®") },
        { id: "minotaur_rage", name: "ãƒã‚¿ãƒ‰ãƒ¼ãƒ«ã®æ „å…‰", cond: "ã€Œèµ¤ã„å¸ƒã€ã¨ã€ŒãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã®æˆ¦æ–§ã€ã‚’åŒæ™‚ã«æ‰€æŒ", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("èµ¤ã„å¸ƒ") && p.history.items.has("ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã®æˆ¦æ–§") },
        
        // --- ğŸ˜ˆ ä¸ƒã¤ã®å¤§ç½ª (æŒ‘æˆ¦) ---
        { id: "sin_pride", name: "å‚²æ…¢ã‚’å¾ã™", cond: "ã€Œå‚²æ…¢ã®ç³ã€ã‚’å…¥æ‰‹", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("å‚²æ…¢ã®ç³") },
        { id: "sin_envy", name: "å«‰å¦¬ã‚’å¾ã™", cond: "ã€Œå«‰å¦¬ã®é­”ç®±ã€ã‚’å…¥æ‰‹", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("å«‰å¦¬ã®é­”ç®±") },
        { id: "sin_wrath", name: "æš´æ€’ã‚’å¾ã™", cond: "ã€Œæš´æ€’ã®ãƒŠãƒƒã‚¯ãƒ«ã€ã‚’å…¥æ‰‹", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("æš´æ€’ã®ãƒŠãƒƒã‚¯ãƒ«") },
        { id: "sin_sloth", name: "æ€ æƒ°ã‚’å¾ã™", cond: "ã€Œçœ ã‚Šã®æŒ‡è¼ªã€ã‚’å…¥æ‰‹", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("çœ ã‚Šã®æŒ‡è¼ª") },
        { id: "sin_greed", name: "å¼·æ¬²ã‚’å¾ã™", cond: "ã€Œé»„é‡‘ã®è–åƒã€ã‚’å…¥æ‰‹", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("é»„é‡‘ã®è–åƒ") },
        { id: "sin_gluttony", name: "æš´é£Ÿã‚’å¾ã™", cond: "ã€Œæš´é£Ÿã®ç‰™ã€ã‚’å…¥æ‰‹", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("æš´é£Ÿã®ç‰™") },
        { id: "sin_lust", name: "è‰²æ¬²ã‚’å¾ã™", cond: "ã€Œé­…é­”ã®é¦™æ°´ã€ã‚’å…¥æ‰‹", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("é­…é­”ã®é¦™æ°´") },
        
        // --- ğŸ”’ éš ã—ã¨ç©¶æ¥µ (ä¼èª¬) ---
        { id: "max_train", name: "ç™»å³°é€ æ¥µ", cond: "ç²¾éœŠã¨ã‚¹ãƒ©ã‚¤ãƒ é•·è€ã®å¼·åŒ–ã‚’æœ€å¤§ã¾ã§è¡Œã† (å„5å›)", rarity: "mythic", hidden: true, check: (p) => p.fairyEnhanceCount >= 5 && p.elderEnhanceCount >= 5 },
        { id: "sin_crown", name: "åŸç½ªã®èƒŒè² ã„æ‰‹", cond: "ä¸ƒã¤ã®å¤§ç½ªã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã‚’é›†ã‚ã€ã€ŒåŸç½ªã®ç‹å† ã€ã‚’å…¥æ‰‹", rarity: "ultra", hidden: true, category: "inferno", check: (p) => p.history.items.has("åŸç½ªã®ç‹å† ") },
        { id: "god_killer", name: "é‹å‘½ã¸ã®åé€†", cond: "ç¥ã®ä»£è¡Œè€…ã‚’æ’ƒç ´ã—ã€ã€Œè¼ªå»»ã®ç ‚æ™‚è¨ˆã€ã‚’å…¥æ‰‹", rarity: "ultra", hidden: true, check: (p) => p.history.items.has("è¼ªå»»ã®ç ‚æ™‚è¨ˆ") },
        { id: "rebirth_used", name: "è¼ªå»»ã®èµ·ç‚¹", cond: "ç ‚æ™‚è¨ˆã‚’ä½¿ã„æ™‚ç©ºã‚’è¶…ãˆã€è¨˜æ†¶ã‚’ä¿æŒã™ã‚‹", rarity: "ultra", hidden: true, check: (p) => p.history.items.has("è¼ªå»»å¾Œã®è¨˜æ†¶") },
        { id: "hero_all_items", name: "å…¨çŸ¥ã®å¢ƒåœ°", cond: "å›³é‘‘ã®å…¨ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å…¥æ‰‹ã™ã‚‹", rarity: "ultra", hidden: true, check: (p) => Game.checkAllItems() },
        
        // --- ğŸ’— ãƒªãƒªã‚¹ã®çµ† (ã‚¹ãƒˆãƒ¼ãƒªãƒ¼) ---
        { id: "lilith_note", name: "å°‘å¥³ã®ç§˜å¯†", cond: "æ¥ãšã‹ã—ãŒã‚Šå±‹ã®ã‚µã‚­ãƒ¥ãƒã‚¹ã‹ã‚‰ã€Œãƒ¡ãƒ¢ã€ã‚’å—ã‘å–ã‚‹", rarity: "epic", hidden: true, check: (p) => p.history.items.has("ãƒ¡ãƒ¢") },
        { id: "lilith_sword", name: "å®ˆè­·ã®æ±ºæ„", cond: "ãƒ¡ãƒ¢ã‚’æŒã£ã¦ç…‰ç„ã«å…¥ã‚Šã€ã€Œç¥è–ãªå…‰å‰£ã€ã‚’å…¥æ‰‹", rarity: "epic", hidden: true, check: (p) => p.history.items.has("ç¥è–ãªå…‰å‰£") },
        { id: "lilith_pass", name: "å„ªã—ã•ã®é€šè¡Œè¨¼", cond: "ãƒ¡ãƒ¢ã‚’è¦‹ã›ã¦è‰²æ¬²ã®è©¦ç·´ã‚’é€šéã—ã€ã€Œã‚µã‚­ãƒ¥ãƒã‚¹ã®æƒ³ã„ã€ã‚’å…¥æ‰‹", rarity: "epic", hidden: true, check: (p) => p.history.items.has("ã‚µã‚­ãƒ¥ãƒã‚¹ã®æƒ³ã„") },
        { id: "lilith_bless", name: "ç¨®æ—ã‚’è¶…ãˆãŸçµ†", cond: "ç¥ã®ä»£è¡Œè€…ã¨ã®æ±ºæˆ¦æ™‚ã€ãƒªãƒªã‚¹ãŒåŠ©å¤ªåˆ€ã™ã‚‹", rarity: "mythic", hidden: true, check: (p) => p.lilithBlessing && !p.lilithSacrificed },
        { id: "lilith_sacrifice", name: "æ•£ã‚Šã‚†ãæ¡œè‰²", cond: "ã‚ãªãŸã‚’å®ˆã‚‹ãŸã‚ã€ãƒªãƒªã‚¹ãŒç¥æˆ¦ã§çŠ ç‰²ã«ãªã‚‹ (Bad End)", rarity: "mythic", hidden: true, check: (p) => p.lilithSacrificed && Player.history.items.has("è¼ªå»»ã®ç ‚æ™‚è¨ˆ") }, 
        { id: "lilith_love", name: "æ°¸é ã®èª“ã„", cond: "ç¥ã®ä»£è¡Œè€…ã«å‹åˆ©ã—ã€ãƒªãƒªã‚¹ãŒç”Ÿå­˜ã™ã‚‹ (True End)", rarity: "ultra", hidden: true, check: (p) => p.lilithBlessing && Player.history.items.has("è¼ªå»»ã®ç ‚æ™‚è¨ˆ") },
    ]
};
const Player = {
    hp: 100,
    maxHp: 100,
    baseMaxHp: 100,
    baseAtk: 5,
    gold: 100,
    depth: 0,
    class: null,

    permanentCritBonus: 0,
    lilithBlessing: false,      // ç¥ç¦ã‚’ç²å¾—ã—ãŸã‹ (ç”Ÿå­˜è¨¼æ˜/ç´”æ„›ã‚¨ãƒ³ãƒ‰ç”¨)
    lilithSacrificed: false,    // ãƒªãƒªã‚¹ãŒçŠ ç‰²ã«ãªã£ãŸã‹ (é‡è¤‡é˜²æ­¢/å‹åˆ©ã‚¨ãƒ³ãƒ‰ç”¨)
    lastInspirationTurns: 0,    // æœ€å¾Œã®é¼“èˆã®æ®‹ã‚Šã‚¿ãƒ¼ãƒ³
    chaosRoll: 1,
    transcendenceRoll: 1,       // è¶…è¶Šã‚­ãƒ¥ãƒ¼ãƒ–ã®å€ç‡
    fairyEnhanceCount: 0,       // ç²¾éœŠã®å¼·åŒ–å›æ•° (è¡¨å±¤)
    elderEnhanceCount: 0,       // é•·è€ã®å¼·åŒ–å›æ•° (ç…‰ç„)
    permanentHpBonus: 0,        // æ°¸ä¹…HPãƒœãƒ¼ãƒŠã‚¹
    equipment: { weapon: null, armor: null, shield: null, accessories: [null, null, null] },
    inventory: { 
        equipment: [], 
        consumable: [
            { name: "å›å¾©ãƒãƒ¼ã‚·ãƒ§ãƒ³", type: "consumable", val: 30, rarity: "common", price: 25, icon: "ğŸ§ª", desc: "HPã‚’30å›å¾©" }
        ], 
        material: [],
        accessory: []
    },
    buff: null,
    debuff: null,
    achievements: new Set(),
    history: { items: new Set() },
    kill1000Boss: false,
    inInferno: false,
    
    // å¤‰æ•°ã¯ã“ã“ã§å®šç¾©ã—ãªã„ã¨èª­ã¿è¾¼ã‚ãªã„
    souls: 0,             
    ghostTurns: 0,        
    bloodContractAtk: 0,  

    // ä¸ƒã¤ã®å¤§ç½ªçŠ¶æ…‹è¿½è·¡
    sinState: {
        slothCount: 0,     // æ€ æƒ°ã®å‘ªã„æ®‹ã‚Šå›æ•°
        wrathRevive: 0,    // ãƒãƒ¼ã‚µãƒ¼ã‚«ãƒ¼å¾©æ´»å›æ•°
        lustActive: false, // é­…äº†çŠ¶æ…‹ã‹
        greedActive: false // é»„é‡‘ã®æ·çŠ¶æ…‹ã‹
    },
    succubusStage: 0 // 0=åˆå¯¾é¢, 1=çŸ¥ã‚Šåˆã„, 2=ç…§ã‚Œ, 3=å®Œäº†
};

const GameState = {
    phase: "select_class",
    forgeUsed: false,     // ç‚‰ã‚’ä½¿ç”¨ã—ãŸã‹
    merchantRefreshed: false,
    combatTurn: 0,        // æˆ¦é—˜ã‚¿ãƒ¼ãƒ³æ•°
    enemyDominated: false, // æ—§æ”¯é…è€…åŠ¹æœ
    currentEnemy: null,
    merchantStock: [],
    craftingCount: 0,
    log: [],
    isLoading: false,
    compendiumTab: 'items',
    currentSinType: null // ç¾åœ¨ã®å¤§ç½ªã‚¿ã‚¤ãƒ—ï¼ˆè£…å‚™ãƒ­ãƒƒã‚¯ç”¨ï¼‰
};

const Game = {
    init() {
        if (localStorage.getItem('fantasy_adventure_save_v2')) {
            this.loadGame();
        } else {
            // æ–°è¦ã‚²ãƒ¼ãƒ æ™‚ã¯ã‚¯ãƒ©ã‚¹é¸æŠã‚’è¡¨ç¤º
            document.getElementById('class-modal').style.display = 'flex';
            this.updateUI();
        }
    },

    saveGame() {
        if (Player.hp <= 0) {
            localStorage.removeItem('fantasy_adventure_save_v2');
            return;
        }
        if (!Player.class) return;

        try {
            const saveData = {
                player: {
                    ...Player,
                    achievements: Array.from(Player.achievements),
                    history: { items: Array.from(Player.history.items) }
                },
                gameState: GameState,
                timestamp: new Date().toLocaleString()
            };
            localStorage.setItem('fantasy_adventure_save_v2', JSON.stringify(saveData));
        } catch (e) {
            console.error("Auto-save failed", e);
        }
    },

    loadGame() {
        const json = localStorage.getItem('fantasy_adventure_save_v2');
        if (!json) return;

        GameState.isLoading = true;

        try {
            const data = JSON.parse(json);

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸
            Object.assign(Player, data.player);
            // äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
            if(!Player.equipment.accessories) Player.equipment.accessories = [null, null, null];
            if(!Player.inventory.accessory) Player.inventory.accessory = [];
            if(Player.inInferno === undefined) Player.inInferno = false;
            
            if(!Player.sinState) Player.sinState = { slothCount: 0, wrathRevive: 0, lustActive: false, greedActive: false };
            if (typeof Player.lilithBlessing === 'undefined') Player.lilithBlessing = false;
            if (typeof Player.lilithSacrificed === 'undefined') Player.lilithSacrificed = false;

            Player.achievements = new Set(data.player.achievements);
            Player.history.items = new Set(data.player.history.items);

            Object.assign(GameState, data.gameState);

            if (GameState.merchantRefreshed === undefined) GameState.merchantRefreshed = false;

            // ç…‰ç„ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«é©ç”¨
            if (!Player.sinState) Player.sinState = {};
            if (typeof Player.sinState.slothCount !== 'number') Player.sinState.slothCount = 0;
            if (typeof Player.sinState.wrathRevive !== 'number') Player.sinState.wrathRevive = 0;

            if (Player.inInferno) {
                document.body.classList.add('inferno-mode');
            } else {
                document.body.classList.remove('inferno-mode');
            }

            this.updateUI();
            
            document.getElementById('class-modal').style.display = 'none';
            const badgeMap = { 
                'knight': 'ğŸ›¡ï¸ é¨å£«', 'merchant': 'ğŸ’° å•†äºº', 'thief': 'ğŸ—¡ï¸ ç›—è³Š', 
                'cultist': 'ğŸ˜ˆ æ‚ªé­”ä¿¡å¾’', 'scarecrow': 'ğŸŒ¾ ã‚«ã‚«ã‚·', 'ape': 'ğŸ¦ é¡äººçŒ¿',
                'challenger': 'ğŸ§— æŒ‘æˆ¦è€…', 'dragonslayer': 'ğŸ‰ ãƒ‰ãƒ©ã‚´ãƒ³ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼'
            };
            document.getElementById('class-badge').innerText = badgeMap[Player.class] || "";

            this.restoreScreenState();
            this.showFloatingText("ãƒ­ãƒ¼ãƒ‰å®Œäº†", "#2196f3");

        } catch (e) {
            console.error(e);
            alert("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã¾ã™ã€‚æ–°è¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚");
            localStorage.removeItem('fantasy_adventure_save_v2');
            document.getElementById('class-modal').style.display = 'flex';
        } finally {
            GameState.isLoading = false;
        }
    },

    restoreScreenState() {
        if (GameState.phase === 'combat' && GameState.currentEnemy) {
            const enemy = GameState.currentEnemy;
            let iconClass = "monster-icon";
            if(enemy.tier === "elite") iconClass += " monster-elite glow-blue";
            if(enemy.tier === "boss") iconClass += " monster-boss glow-red";
            if(enemy.isTrueForm) iconClass = "monster-icon monster-true-form glow-purple";
            if(Player.inInferno) iconClass += " glow-inferno";

            this.renderEvent(`âš”ï¸ é­é‡ ${enemy.name} (å¾©å¸°)`, 
                `HP: ${enemy.hp} | æ”»æ’ƒ: ${enemy.atk}`, 
                "æˆ¦é—˜å†é–‹ï¼", enemy.icon);
            document.getElementById('event-icon').className = iconClass;
            
            const canFlee = !enemy.isSin && !enemy.isOldOne && enemy.tier !== 'boss' && !enemy.isGod;
            this.setButtons("æˆ¦é—˜", "combatRound", "é€ƒã’ã‚‹", "flee", !canFlee);
        } 
        else if (GameState.phase === 'sin_event') {
            const sin = GameState.currentSinType;
            if (sin) {
                this.log(`>>> ä¸ƒã¤ã®å¤§ç½ªã‚¤ãƒ™ãƒ³ãƒˆå¾©å¸°: ${sin}`);
                switch(sin) {
                    case 'pride': this.handlePrideEvent(); break;
                    case 'envy': this.handleEnvyEvent(); break;
                    case 'wrath': this.handleWrathEvent(); break;
                    case 'sloth': this.handleSlothEvent(); break;
                    case 'greed': this.handleGreedEvent(); break;
                    case 'gluttony': this.handleGluttonyEvent(); break;
                    case 'lust': this.handleLustEvent(); break;
                    default: this.nextEvent();
                }
            } else {
                this.nextEvent();
            }
        }
        else if (GameState.phase === 'merchant' || GameState.phase === 'demon_merchant') {
            this.triggerAnim('event-icon', 'anim-spawn');
            const title = GameState.phase === 'merchant' ? "ğŸ’° è¬ã®å•†äºº" : "ğŸ˜ˆ æ‚ªé­”ã®å•†äºº";
            this.renderEvent(title, "ãŠã‹ãˆã‚Šãªã•ã„ã€‚å–å¼•ã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ", "å•†å“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’ç¢ºèªãƒ»è³¼å…¥", "ğŸ‘³");
            this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
            this.renderMerchantShop();
        }
        else if (GameState.phase === 'crafting') {
            this.triggerAnim('event-icon', 'anim-spawn');
            this.renderEvent("ğŸ”¨ è£½ä½œå°", "æ”¾æ£„ã•ã‚ŒãŸè£½ä½œå°ãŒã‚ã‚Šã¾ã™ã€‚", `æ®‹ã‚Šè£½ä½œå›æ•°: ${2 - GameState.craftingCount}`, "âš’ï¸");
            this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
            this.renderCraftingUI();
        }
        else {
            GameState.phase = "event_end";
            this.renderEvent("ğŸ“‚ ãƒ­ãƒ¼ãƒ‰æˆåŠŸ", `ç¬¬ ${Player.depth} å±¤ã¸ã‚ˆã†ã“ã`, "ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å†’é™ºã‚’å†é–‹ã—ã¦ãã ã•ã„ã€‚", "ğŸ’¾");
            document.getElementById('event-icon').className = "monster-icon";
            document.getElementById('merchant-area').classList.add('hidden');
            document.getElementById('crafting-area').classList.add('hidden');
            this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
        }
    },

    manualRestart() {
        if (confirm("âš  æœ¬å½“ã«æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ\n\nç¾åœ¨ã®é€²è¡ŒçŠ¶æ³ã¯å‰Šé™¤ã•ã‚Œã€å¾©å…ƒã§ãã¾ã›ã‚“ï¼")) {
            localStorage.removeItem('fantasy_adventure_save_v2');
            location.reload();
        }
    },

    // --- å›³é‘‘ (Compendium) ---
    switchCompendiumTab(tab) {
        GameState.compendiumTab = tab;
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(b => b.classList.remove('active'));
        if(tab === 'items') btns[0].classList.add('active');
        else if(tab === 'accessories') btns[1].classList.add('active');
        else btns[2].classList.add('active');
        this.showCompendium(true);
    },

    showCredits() {
        document.getElementById('credits-modal').style.display = 'flex';
    },

    getAllItems(tab) {
        let items = [];
        if (tab === 'items') {
            items.push(...CONFIG.itemPool);
            for (let [name, data] of Object.entries(CONFIG.lootData)) {
                if(data.rarity !== 'mythic' && data.rarity !== 'ultra') items.push({ ...data, name: name, type: 'material' });
            }
            items.push(CONFIG.phoenixFeather);
            items.push(CONFIG.bible);
            items.push(CONFIG.specialItems.chocolate);
        } else if (tab === 'accessories') {
            items.push(...Object.values(CONFIG.accessories));
        } else if (tab === 'inferno') {
            items.push(...CONFIG.infernoItems);
            items.push(...CONFIG.sinItems);
            items.push(...CONFIG.forgeItems);
            items.push(CONFIG.specialItems.hourglass);
            items.push(CONFIG.specialItems.holy_sword);
            items.push(CONFIG.specialItems.note);
            // ä»®æƒ³å®Ÿç¸¾ã‚¢ã‚¤ãƒ†ãƒ 
            items.push({ name: "ã‚µã‚­ãƒ¥ãƒã‚¹ã®æƒ³ã„", type: "special", rarity: "epic", icon: "â¤ï¸", desc: "ã‚µã‚­ãƒ¥ãƒã‚¹ãŒé€šã—ã¦ãã‚ŒãŸè¨¼ (å®Ÿç¸¾ç”¨)" });
            items.push({ name: "è¼ªå»»å¾Œã®è¨˜æ†¶", type: "special", rarity: "ultra", icon: "ğŸ§ ", desc: "æ™‚é–“ã‚’é¡ã£ãŸå¾Œã«æ®‹ã‚‹è¨˜æ†¶ (å®Ÿç¸¾ç”¨)" });

            for (let [name, data] of Object.entries(CONFIG.lootData)) {
                if(data.rarity === 'mythic' || data.rarity === 'ultra') items.push({ ...data, name: name, type: 'material' });
            }
        }
        return items.sort((a, b) => {
            const rA = CONFIG.rarityDisplay[a.rarity].val;
            const rB = CONFIG.rarityDisplay[b.rarity].val;
            if (rA !== rB) return rA - rB;
            return a.name.localeCompare(b.name);
        });
    },

    showCompendium(isSwitch = false) {
        const modal = document.getElementById('compendium-modal');
        if(!isSwitch) modal.style.display = 'flex';
        
        const list = document.getElementById('compendium-content');
        const stats = document.getElementById('compendium-stats');
        list.innerHTML = "";

        const allItems = this.getAllItems(GameState.compendiumTab).filter(i => i.name !== "ã‚µã‚­ãƒ¥ãƒã‚¹ã®æƒ³ã„" && i.name !== "è¼ªå»»å¾Œã®è¨˜æ†¶");
        const unlockedCount = allItems.filter(i => Player.history.items.has(i.name)).length;
        
        stats.innerText = `åé›†ç‡: ${unlockedCount} / ${allItems.length}`;

        allItems.forEach(item => {
            const unlocked = Player.history.items.has(item.name);
            const div = document.createElement('div');
            
            if (!unlocked && (item.name === "çœŸå®Ÿã®å¿ƒ" || item.rarity === "ultra" || item.rarity === "mythic")) {
                div.className = 'c-item secret-hidden';
                div.title = "?????";
            } 
            else if (unlocked) {
                div.className = `c-item unlocked ${CONFIG.rarityDisplay[item.rarity].color}`;
                if(item.rarity === 'mythic') div.className += ' rarity-mythic';
                if(item.rarity === 'ultra') div.className += ' rarity-ultra';
                
                let tooltip = this.getItemDesc(item);
                if(item.type === 'accessory' && item.recipe) {
                    tooltip += `\n[ãƒ¬ã‚·ãƒ”: ${item.recipe.mat} x${item.recipe.count}]`;
                } else {
                    tooltip += `\n(ä¾¡å€¤: ${item.price || 0}G)`;
                }
                div.title = tooltip;
                div.style.cursor = 'pointer';
                div.onclick = () => alert(`ã€${item.name}ã€‘\n\n${tooltip}`);

                div.innerHTML = `<div class="c-icon">${item.icon || 'ğŸ“¦'}</div><div class="c-name">${item.name}</div>`;
            } 
            else {
                div.className = 'c-item unknown';
                div.title = "æœªç²å¾—";
                div.innerHTML = `<div class="c-icon">â“</div><div class="c-name">???</div>`;
            }
            list.appendChild(div);
        });
    },

    // --- ä¸ƒã¤ã®å¤§ç½ªã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚¸ãƒƒã‚¯ ---
    triggerSinEvent() {
        const sins = ['pride', 'envy', 'wrath', 'sloth', 'greed', 'gluttony', 'lust'];
        const sin = sins[Math.floor(Math.random() * sins.length)];
        
        GameState.phase = "sin_event";
        GameState.currentSinType = sin;
        this.log(`>>> ä¸ƒã¤ã®å¤§ç½ªã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ: ${sin}`);

        switch(sin) {
            case 'pride': this.handlePrideEvent(); break;
            case 'envy': this.handleEnvyEvent(); break;
            case 'wrath': this.handleWrathEvent(); break;
            case 'sloth': this.handleSlothEvent(); break;
            case 'greed': this.handleGreedEvent(); break;
            case 'gluttony': this.handleGluttonyEvent(); break;
            case 'lust': this.handleLustEvent(); break;
        }
    },

    // äº¡è€…ã®å½«åƒã‚¤ãƒ™ãƒ³ãƒˆ
    triggerDeadStatue() {
        GameState.phase = "event_end";
        this.renderEvent("ğŸ—¿ äº¡è€…ã®å½«åƒ", "ç¥è–ã‹ã¤ç ´æ»…çš„ãªæ°—é…ã‚’æ”¾ã¤å½«åƒã€‚", "ãã‚Œã¯ç‹å† ã‚’å¾…ã£ã¦ã„ã‚‹ã‚ˆã†ã ã€‚", "ğŸ—½");
        
        const hasCrown = Player.inventory.material.some(i => i.name === "åŸç½ªã®ç‹å† ");
        if (hasCrown) {
            this.setButtons("ç‹å† ã‚’æ§ã’ã‚‹", "triggerGodAgent", "ç«‹ã¡å»ã‚‹", "nextEvent", false);
        } else {
            this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
        }
    },

    // æœ€çµ‚ãƒœã‚¹ (ç¥ã®ä»£è¡Œè€…) ãƒˆãƒªã‚¬ãƒ¼
    triggerGodAgent() {
        // 1. ç‹å† ã‚’å‰Šé™¤
        const idx = Player.inventory.material.findIndex(i => i.name === "åŸç½ªã®ç‹å† ");
        if(idx > -1) {
            Player.inventory.material.splice(idx, 1);
            this.updateUI(); 
        }

        // 2. ãƒœã‚¹è¨­å®š
        const enemy = {
            name: "ç†¾å¤©ä½¿ãƒ»ç¥ã®ä»£è¡Œè€…", 
            icon: "âšœï¸", 
            hp: 666666, 
            maxHp: 666666,
            atk: 6666, 
            tier: "boss", 
            isGod: true
        };
        
        // 3. æˆ¦é—˜é–‹å§‹ (é€ƒèµ°ä¸å¯)
        this.triggerCombatWithEnemy(enemy, false);
        this.showFloatingText("âš ï¸ è­¦å‘Šï¼šç¥è‡¨ âš ï¸", "red");
    },

    // 1. å‚²æ…¢
    handlePrideEvent() {
        this.renderEvent("ğŸ¦ å‚²æ…¢ã®é–€", "ã€Œé˜²å‚™ã‚’æ¨ã¦å»ã‚‹è€…ã“ãã€çœŸã®å¼·è€…ãªã‚Šã€‚ã€", "è‡ªåˆ†ã¨ç“œäºŒã¤ã®é»„é‡‘ã®é¡åƒãŒç«‹ã£ã¦ã„ã‚‹ã€‚\n(é˜²å…·ã‚’å¤–ã—ã¦æˆ¦é—˜ã€é€ƒèµ°ä¸å¯)", "ğŸª");
        this.setButtons("æŒ‘æˆ¦ã™ã‚‹", "resolvePrideFight", "æ‹’å¦ã™ã‚‹ (ç«‹ã¡å»ã‚‹)", "nextEvent", false);
    },
    resolvePrideFight() {
        // å¼·åˆ¶çš„ã«é˜²å…·ã‚’å¤–ã™ (ãƒãƒ¼ãƒˆé˜²æ­¢)
        if (Player.equipment.armor) {
            this.addItemToInventory(Player.equipment.armor, false);
            Player.equipment.armor = null;
        }
        if (Player.equipment.shield) {
            this.addItemToInventory(Player.equipment.shield, false);
            Player.equipment.shield = null;
        }
        
        this.recalcStats();
        this.updateUI();
        
        const pAtk = this.getAtk();

        // æ”»æ’ƒåŠ›: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®50%, HP: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ”»æ’ƒåŠ›ã®4å€
        const mirrorAtk = Math.max(1, Math.floor(pAtk * 0.5)); 
        const mirrorHp = Math.min(333333, pAtk * 4);

        const enemy = {
            name: "å‚²æ…¢ã®é¡åƒ", icon: "ğŸ‘¤",
            hp: mirrorHp, 
            maxHp: mirrorHp,
            atk: mirrorAtk, 
            tier: "boss", isSin: true, sinType: 'pride'
        };
        this.triggerCombatWithEnemy(enemy, false); 
    },

    // 2. å«‰å¦¬
    handleEnvyEvent() {
        this.renderEvent("ğŸ¦Š å«‰å¦¬ã®é­”ç²¾", "ã€Œç¶ºéº—ã ã­...å¼·ã„ã­...äº¤æ›ã—ã¦ã‚ˆ...ã€", "é­”ç²¾ãŒã‚ãªãŸã®è£…å‚™ã‚’æ¬²ã—ãã†ã«è¦‹ã¦ã„ã‚‹ã€‚", "ğŸ‘º");
        this.setButtons("äº¤æ›ã™ã‚‹ (ãƒ¬ã‚¢è£…å‚™2ã¤æ¶ˆå¤±)", "resolveEnvyTrade", "æ‹’å¦", "nextEvent", false);
    },

    forceRemoveItem(targetItem) {
        if (Player.equipment.weapon === targetItem) { Player.equipment.weapon = null; this.recalcStats(); return; }
        if (Player.equipment.armor === targetItem) { Player.equipment.armor = null; this.recalcStats(); return; }
        if (Player.equipment.shield === targetItem) { Player.equipment.shield = null; this.recalcStats(); return; }
        
        for (let i = 0; i < 3; i++) {
            if (Player.equipment.accessories[i] === targetItem) {
                Player.equipment.accessories[i] = null;
                this.recalcStats();
                return;
            }
        }
        this.removeItemFromInventory(targetItem);
    },

    resolveEnvyTrade() {
        // 1. å…¨ã‚¢ã‚¤ãƒ†ãƒ åé›†
        let allCandidates = [];
        allCandidates.push(...Player.inventory.equipment);
        allCandidates.push(...Player.inventory.accessory);
        if (Player.equipment.weapon) allCandidates.push(Player.equipment.weapon);
        if (Player.equipment.armor) allCandidates.push(Player.equipment.armor);
        if (Player.equipment.shield) allCandidates.push(Player.equipment.shield);
        Player.equipment.accessories.forEach(acc => {
            if (acc) allCandidates.push(acc);
        });

        // 2. ã‚½ãƒ¼ãƒˆ (ãƒ¬ã‚¢åº¦é«˜ -> ä½)
        allCandidates.sort((a, b) => CONFIG.rarityDisplay[b.rarity].val - CONFIG.rarityDisplay[a.rarity].val);
        
        if (allCandidates.length < 2) {
            this.renderEvent("ğŸ¦Š å«‰å¦¬ã®å˜²ç¬‘", "ã€Œã¾ã¨ã‚‚ãªè£…å‚™ã‚’2ã¤ã‚‚æŒã£ã¦ãªã„ã˜ã‚ƒãªã„ã‹ï¼å¤±ã›ã‚ï¼ã€", "é­”ç²¾ã¯ã‚ãªãŸã‚’ç„¡è¦–ã—ãŸã€‚", "ğŸ’¨");
            this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
            return;
        }

        // 3. æœ€ã‚‚ä¾¡å€¤ã®ã‚ã‚‹2ã¤ã‚’æ²¡å
        const removed1 = allCandidates[0];
        const removed2 = allCandidates[1];

        this.forceRemoveItem(removed1);
        this.forceRemoveItem(removed2);

        // 4. å ±é…¬
        const reward = CONFIG.sinItems.find(i => i.id === 'acc_envy');
        this.addItemToInventory({...reward});
        this.updateUI();

        this.renderEvent("ğŸ¦Š å–å¼•æˆç«‹", 
            `å«‰å¦¬ã®é­”ç²¾ã¯ <span style="color:red">${removed1.name}</span> ã¨ <span style="color:red">${removed2.name}</span> ã‚’å¥ªã„å»ã£ãŸ...`, 
            `äº¤æ›ã« <span class="rarity-mythic">${reward.name}</span> ã‚’å…¥æ‰‹ã—ãŸï¼`, "ğŸ");
        this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
    },

    // 3. æš´æ€’
    handleWrathEvent() {
        this.renderEvent("ğŸ˜¡ æš´æ€’ã®æª»", "ãƒãƒ¼ã‚µãƒ¼ã‚«ãƒ¼ãŒå’†å“®ã—ã¦ã„ã‚‹ã€‚ã€Œè§£æ”¾ã—ã‚ï¼æ­»ã¬ã¾ã§æ®ºã—åˆãŠã†ï¼ã€", "çµ‚ã‚ã‚Šã®ãªã„æ­»é—˜ã€‚æ•µã¯å¾©æ´»ã™ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚", "â›“ï¸");
        this.setButtons("è§£æ”¾ã—ã¦æˆ¦ã†", "resolveWrathFight", "ç„¡è¦–ã™ã‚‹ (-50 HP)", "resolveWrathIgnore", false);
    },
    resolveWrathFight() {
        Player.sinState.wrathRevive = 0;
        const enemy = { ...CONFIG.sinMonsters[1], isSin: true, sinType: 'wrath' }; 
        this.triggerCombatWithEnemy(enemy, false);
    },
    resolveWrathIgnore() {
        Player.hp = Math.max(1, Player.hp - 50);
        this.renderEvent("ğŸ˜¡ æ€’ã‚Šã®å¨åœ§", "èƒŒå¾Œã«å¼·çƒˆãªæ®ºæ°—ã‚’æ„Ÿã˜ãŸ...", "HP -50", "ğŸ¤•");
        this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
    },

    // 4. æ€ æƒ°
    handleSlothEvent() {
        this.renderEvent("ğŸ» å®‰æ¯ã®æ²¼åœ°", "ç¼ãŒé‡ã„...åœ°é¢ã«ã¯ãµã‹ãµã‹ã®ãƒ™ãƒƒãƒ‰ãŒ...", "ã€Œå†’é™ºãªã‚“ã¦ç–²ã‚Œã‚‹ã ã‘...ä¼‘ã‚‚ã†ã‚ˆ...ã€", "ğŸ’¤");
        this.setButtons("ä¸€çœ ã‚Šã™ã‚‹ (å…¨å¿«+å‘ªã„)", "resolveSlothSleep", "å¼·è¡Œçªç ´ (-30% HP)", "resolveSlothPass", false);
    },
    resolveSlothSleep() {
        Player.hp = Player.maxHp;
        Player.debuff = CONFIG.sinBuffs.sloth_curse;
        Player.sinState.slothCount = 10;
        this.renderEvent("ğŸ’¤ ã¾ã©ã‚ã¿ã®å¾Œ", "ä½“åŠ›ã¯å…¨å¿«ã—ãŸãŒã€ä½“ãŒé‰›ã®ã‚ˆã†ã«é‡ã„ã€‚", "çŠ¶æ…‹ç•°å¸¸ï¼šæ€ æƒ°ã®å‘ªã„ (10æˆ¦é—˜ç¶™ç¶š)", "ğŸ›Œ");
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
    },
    resolveSlothPass() {
        const dmg = Math.floor(Player.hp * 0.3);
        Player.hp = Math.floor(Player.hp * 0.7);
        Player.gold += 2000;
        this.renderEvent("ğŸ» æ„å¿—åŠ›", "çœ æ°—ã«æ‰“ã¡å‹ã¡ã€é“ç«¯ã§è²¡å¸ƒã‚’è¦‹ã¤ã‘ãŸã€‚", `HP -${dmg}, 2000 G ç²å¾—`, "ğŸ’ª");
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
    },

    // 5. å¼·æ¬²
    handleGreedEvent() {
        this.renderEvent("ğŸ· é»„é‡‘ã®ç‰åº§", "ã‚¹ãƒ©ã‚¤ãƒ ã®ç‰åº§ãŒå®çŸ³ã§åŸ‹ã‚å°½ãã•ã‚Œã¦ã„ã‚‹ã€‚", "ã€ŒæŒã£ã¦ã„ã‘ã€ãã®é‡ã¿ã«è€ãˆã‚‰ã‚Œã‚‹ãªã‚‰ãª...ã€", "ğŸ‘‘");
        this.setButtons("å¤§é‡ã«å–ã‚‹ (5ä¸‡G+å‘ªã„)", "resolveGreedTake", "å…¨ã¦å¥ªã† (BOSSæˆ¦)", "resolveGreedFight", false);
    },
    resolveGreedTake() {
        Player.gold += 50000;
        Player.sinState.greedActive = true;
        Player.debuff = CONFIG.sinBuffs.greed_shackle;
        this.renderEvent("ğŸ· å¼·æ¬²ã®ä»£å„Ÿ", "50,000 G ã‚’æ‰‹ã«å…¥ã‚ŒãŸãŒã€ä½“ãŒé‡ããªã£ãŸã€‚", "çŠ¶æ…‹ç•°å¸¸ï¼šé»„é‡‘ã®æ· (è¢«ãƒ€ãƒ¡+20%)", "ğŸ’°");
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
    },
    resolveGreedFight() {
        const hp = Math.min(333333, Math.max(1000, Player.gold)); 
        const enemy = { 
            ...CONFIG.sinMonsters[2], 
            hp: hp, maxHp: hp, 
            isSin: true, sinType: 'greed' 
        };
        this.triggerCombatWithEnemy(enemy, false);
    },

    // 6. æš´é£Ÿ
    handleGluttonyEvent() {
        this.renderEvent("ğŸ² æœ€å¾Œã®æ™©é¤", "ãƒ†ãƒ¼ãƒ–ãƒ«ã«è…æ•—ã—ãŸã€ã—ã‹ã—é­…åŠ›çš„ãªæ–™ç†ãŒä¸¦ã‚“ã§ã„ã‚‹ã€‚", "çŒ›çƒˆãªé£¢é¤“æ„Ÿã€‚å…¨ã¦ã‚’è²ªã‚Šé£Ÿã„ãŸã„ã€‚", "ğŸ–");
        this.setButtons("æš´é£Ÿã™ã‚‹ (æ¶ˆè€—å“å…¨ãƒ­ã‚¹ãƒˆ)", "resolveGluttonyEat", "è£…å‚™ã‚’æ§ã’ã‚‹ (80%ã§æˆåŠŸ)", "resolveGluttonySacrifice", false);
    },
    resolveGluttonyEat() {
        Player.permanentHpBonus = (Player.permanentHpBonus || 0) + 50;
        Player.maxHp += 50; 
        Player.hp = Player.maxHp;
        
        if (Player.inventory.consumable.length > 0) {
            Player.inventory.consumable = [];
            this.renderEvent("ğŸ² æš´é£²æš´é£Ÿ", "ãƒªãƒ¥ãƒƒã‚¯ã®ä¸­ã®ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¾ã§é£Ÿã¹å°½ãã—ãŸï¼", "MaxHP +50ï¼Œæ¶ˆè€—å“æ¶ˆå¤±ã€‚", "ğŸ˜‹");
        } else {
            Player.hp = Math.floor(Player.maxHp * 0.5);
            this.renderEvent("ğŸ² é£¢é¤“ã®æ¥µã¿", "é£Ÿã¹ã‚‹ã‚‚ã®ãŒãªãã€è‡ªåˆ†ã®è…•ã‚’é½§ã£ãŸ...", "MaxHP +50ï¼Œç¾åœ¨HPåŠæ¸›ã€‚", "ğŸ©¸");
        }
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
    },
    resolveGluttonySacrifice() {
        if (Math.random() < 0.8) {
             let allEq = [...Player.inventory.equipment];
             if (allEq.length > 0) {
                 const ate = allEq[Math.floor(Math.random() * allEq.length)];
                 this.removeItemFromInventory(ate);
                 const reward = CONFIG.sinItems.find(i => i.id === 'acc_gluttony');
                 this.addItemToInventory({...reward});
                 this.renderEvent("ğŸ² æš´é£Ÿã®è¤’ç¾", `ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ ${ate.name} ã‚’é£²ã¿è¾¼ã¿ã€å®ç‰©ã‚’åãå‡ºã—ãŸã€‚`, `ç²å¾— <span class='rarity-mythic'>${reward.name}</span>`, "ğŸ");
             } else {
                 this.renderEvent("ğŸ² ç„¡åå¿œ", "æ§ã’ã‚‹è£…å‚™ã‚’æŒã£ã¦ã„ãªã„ã€‚", "", "ğŸ•¸ï¸");
             }
        } else {
            this.renderEvent("ğŸ² æš´é£Ÿã®æ€’ã‚Š", "ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä¾›ç‰©ã«æº€è¶³ã—ãªã‹ã£ãŸã€‚", "ä½•ã‚‚èµ·ããªã‹ã£ãŸã€‚", "ğŸ’¨");
        }
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
    },

    // 7. è‰²æ¬²
    handleLustEvent() {
        this.renderEvent("ğŸ‘™ ã‚µã‚­ãƒ¥ãƒã‚¹ã®å–å¼•", "ã€ŒåŠ›ãŒæ¬²ã—ã„ï¼Ÿ ã‚ãªãŸã®ç²¾æ°—ã‚’å°‘ã—åˆ†ã‘ã¦ãã‚Œã‚Œã°...ã€", "ç²¾æ°—ã‚’æ§ã’ã¦åŠ›ã‚’å¾—ã‚‹ã‹ã€èª˜æƒ‘ã‚’æ‹’çµ¶ã™ã‚‹ã‹ã€‚", "ğŸ’‹");
        
        const hasNote = Player.inventory.material.some(i => i.name === "ãƒ¡ãƒ¢");
        if (hasNote) {
             this.setButtons("ãƒ¡ãƒ¢ã‚’è¦‹ã›ã‚‹", "resolveLustNote", "ç²¾æ°—ã‚’æ§ã’ã‚‹", "resolveLustAccept", false);
        } else {
             this.setButtons("ç²¾æ°—ã‚’æ§ã’ã‚‹ (MaxHPæ¸›å°‘)", "resolveLustAccept", "æ‹’å¦ã™ã‚‹ (-50 HP)", "resolveLustDeny", false);
        }
    },
    resolveLustNote() {
        Player.history.items.add("ã‚µã‚­ãƒ¥ãƒã‚¹ã®æƒ³ã„"); 
        this.checkAchievements();
        
        const perfume = CONFIG.sinItems.find(i => i.id === 'acc_lust');
        this.addItemToInventory({...perfume});
        this.renderEvent("ğŸ‘™ ãƒªãƒªã‚¹ã®é€šè¡Œè¨¼", "ã€Œã‚ã‚‰ã€ã‚ãªãŸ...ãã‚Œã‚’æŒã£ã¦ã„ã‚‹ãªã‚‰é€šã‚Šãªã•ã„ã€‚ã€", `ç²å¾— <span class='rarity-mythic'>${perfume.name}</span>`, "ğŸ«");
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
    },
    resolveLustAccept() {
        Player.sinState.lustActive = true;
        Player.debuff = CONFIG.sinBuffs.lust_charm;
        const reward = CONFIG.sinItems.find(i => i.id === 'acc_lust');
        this.addItemToInventory({...reward});
        this.renderEvent("ğŸ‘™ è‡´å‘½çš„ãªå¿«æ¥½", "ä½“ãŒç©ºã£ã½ã«ãªã£ãŸæ„Ÿè¦š...ã ãŒè¬ã®é¦™æ°´ã‚’æ‰‹ã«å…¥ã‚ŒãŸã€‚", `ç²å¾— <span class='rarity-mythic'>${reward.name}</span>ï¼Œæ°¸ä¹…ãƒ‡ãƒãƒ•ä»˜ä¸ã€‚`, "ğŸ’„");
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
    },
    resolveLustDeny() {
        Player.hp = Math.max(1, Player.hp - 50);
        this.renderEvent("ğŸ‘™ ã‚µã‚­ãƒ¥ãƒã‚¹ã®ç¾æ¥", "ã€Œå¯æ„›ããªã„äººï¼ã€", "HP -50", "ğŸ’¢");
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
    },

    removeItemFromInventory(item) {
        ['equipment', 'accessory', 'consumable', 'material'].forEach(cat => {
            const idx = Player.inventory[cat].indexOf(item);
            if(idx > -1) Player.inventory[cat].splice(idx, 1);
        });
    },

    // ç¶šãã¯ãƒ‘ãƒ¼ãƒˆ4ã¸...
// è£œåŠ©ï¼šç‰¹å®šã®æˆ¦é—˜ã‚’ãƒˆãƒªã‚¬ãƒ¼
    triggerCombatWithEnemy(enemyData, canFlee) {
        GameState.phase = "combat";
        GameState.combatTurn = 0;
        GameState.enemyDominated = false;

        // ç…‰ç„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼çŠ¶æ…‹åˆæœŸåŒ–
        enemyData.undyingTriggered = false; // å •è½ã—ãŸé¨å£«ï¼šä¸æ­»ç™ºå‹•æ¸ˆã¿ã‹
        enemyData.rageStack = 0;            // æ—§æ”¯é…è€…ï¼šç²¾ç¥å´©å£Šã‚¹ã‚¿ãƒƒã‚¯

        // ãƒªãƒªã‚¹åŠ©å¤ªåˆ€åˆ¤å®š
        if (enemyData.isGod && Player.inventory.material.some(i => i.name === "ãƒ¡ãƒ¢") && !Player.lilithBlessing && !Player.lilithSacrificed) {
            Player.lilithBlessing = true;
            Player.maxHp += 10000;
            Player.hp = Player.maxHp;
            
            this.showFloatingText("ğŸ’— ãƒªãƒªã‚¹å‚æˆ¦!", "#ff69b4");
            setTimeout(() => {
                alert("ğŸ’— ãƒªãƒªã‚¹ãŒç¾ã‚ŒãŸï¼\n\nã€Œä»Šå›ã ã‘ã¯ä»˜ãåˆã£ã¦ã‚ã’ã‚‹ã€‚ã€\n\n(çŠ¶æ…‹ç²å¾—ï¼šãƒªãƒªã‚¹ã®ç¥ç¦ã€HP +10000)");
                this.checkAchievements();
            }, 100);
        }

        // åŸç½ªã®ç‹å† å¼·åŒ–ãƒ­ã‚¸ãƒƒã‚¯
        const hasCrown = Player.inventory.material.some(i => i.name === "åŸç½ªã®ç‹å† ");
        if (hasCrown && !enemyData.isGod && !enemyData.isTrueForm && !enemyData.name.includes("åŸåˆ") && !enemyData.isSin && !enemyData.isGardenBoss) { 
            enemyData.name = "åŸåˆ " + enemyData.name;
            enemyData.hp *= 2;
            enemyData.atk *= 2;
            enemyData.maxHp = enemyData.hp; 
            this.showFloatingText("ä¸–ç•ŒãŒå´©å£Šã—ã¦ã„ã...", "#ff0000");
        }
        
        enemyData.maxHp = enemyData.maxHp || enemyData.hp;
        GameState.currentEnemy = enemyData;
        
        let iconClass = "monster-icon glow-inferno";
        if (enemyData.tier === 'boss') iconClass += " monster-boss glow-red";
        if (enemyData.isGod) iconClass = "monster-icon glow-void"; 
        
        if (Player.lilithBlessing) document.body.style.boxShadow = "inset 0 0 50px #ff69b4";

        document.getElementById('event-icon').className = iconClass;
        this.triggerAnim('event-icon', 'anim-spawn');

        this.renderEvent(`âš”ï¸ ${enemyData.name}`, 
            `HP: ${enemyData.hp} | æ”»æ’ƒ: ${enemyData.atk}`, 
            "ç‰¹æ®Šæˆ¦é—˜é–‹å§‹ï¼", enemyData.icon);

        const iconEl = document.getElementById('event-icon');
        iconEl.onclick = () => Game.inspectEnemy(); 
        iconEl.style.cursor = "help"; 
        
        // é€ƒèµ°ãƒ­ã‚¸ãƒƒã‚¯ï¼šç‰¹å®šã®ç…‰ç„ãƒœã‚¹ã‚’é™¤å¤–
        const escapableBosses = ['ãƒ–ãƒ©ãƒƒãƒ‰ä¼¯çˆµ', 'ãƒªãƒƒãƒã‚­ãƒ³ã‚°', 'ã‚¢ãƒ“ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³'];
        const isEscapable = escapableBosses.some(name => enemyData.name.includes(name));

        // å¼·åˆ¶é€ƒèµ°ç¦æ­¢åˆ¤å®šï¼š
        // ç¥ã€ä¸ƒã¤ã®å¤§ç½ªã€æ—§æ”¯é…è€…ã€ã¾ãŸã¯é€ƒèµ°ä¸å¯ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œãªã„ãƒœã‚¹
        const forceNoFlee = (
            enemyData.isGod || 
            enemyData.isSin || 
            enemyData.isOldOne || 
            (enemyData.tier === 'boss' && !isEscapable)
        ) && !enemyData.isGardenBoss;

        this.setButtons("æˆ¦é—˜", "combatRound", "é€ƒã’ã‚‹", "flee", forceNoFlee);

        // æ€ æƒ°ã®å‘ªã„ãƒ­ã‚¸ãƒƒã‚¯
        if (Player.debuff && Player.debuff.id === 'sloth_curse') {
            const btnMain = document.getElementById('btn-main'); 
            const btnSub = document.getElementById('btn-sub');   
            btnMain.disabled = true;
            btnMain.innerText = "ğŸ’¤ æ€ æƒ° (æ”»æ’ƒä¸å¯)";
            btnMain.style.opacity = "0.6";
            btnMain.style.cursor = "not-allowed";
            btnSub.disabled = false;
            btnSub.innerText = "é€ƒã’ã‚‹";
        } else {
            document.getElementById('btn-main').disabled = false;
            document.getElementById('btn-main').style.opacity = "1";
            document.getElementById('btn-main').style.cursor = "pointer";
        }
    },

    checkSinCollection() {
        const required = ['acc_pride', 'acc_envy', 'acc_wrath', 'acc_sloth', 'acc_greed', 'acc_gluttony', 'acc_lust'];
        const hasAll = required.every(id => {
            const itemDef = CONFIG.sinItems.find(i => i.id === id);
            return Player.history.items.has(itemDef.name);
        });
        if (hasAll && !Player.history.items.has("åŸç½ªã®ç‹å† ")) {
            const crown = CONFIG.sinItems.find(i => i.id === 'm_crown_sin');
            this.addItemToInventory({...crown});
            this.checkAchievements(); // ç½ªæ·±ãäººå®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
            alert("ğŸ‘‘ ã€åŸç½ªã®ç‹å† ã€‘ é™è‡¨ï¼\n\nä¸ƒã¤ã®å¤§ç½ªã‚’é›†ã‚ã€çœŸã®ç¥ã«æŒ‘ã‚€è³‡æ ¼ã‚’å¾—ã¾ã—ãŸã€‚");
        }
    },

    // --- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®— (Stats Calculation) ---
    getAtk() {
        if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_chaos') {
            let dmg = Math.floor(Math.random() * 4501) + 500; // 500 ~ 5000
            // è¡€ã®å¥‘ç´„åŠ ç®—
            dmg += Player.bloodContractAtk;
            // å‚²æ…¢åŠ ç®—
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_pride')) dmg = Math.floor(dmg * 1.5);
            return dmg;
        }

        let atk = Player.baseAtk;
        if (Player.equipment.weapon) atk += Player.equipment.weapon.val;
        
        // è¡€ã®å¥‘ç´„åŠ ç®—
        atk += Player.bloodContractAtk;

        Player.equipment.accessories.forEach(acc => {
            if(!acc) return;
            if(acc.id.includes('troll')) {
                if(acc.id === 'acc_troll_1') atk += 10;
                if(acc.id === 'acc_troll_2') atk += 20;
                if(acc.id === 'acc_troll_3') atk += 35;
            }
            if(acc.id.includes('demon')) {
                if(acc.id === 'acc_demon_1') atk += 10;
                if(acc.id === 'acc_demon_2') atk += 20;
                if(acc.id === 'acc_demon_3') atk += 40;
            }
            if(acc.id === 'acc_chaos') {
                atk = Math.floor(atk * Player.chaosRoll);
            }
            // è¶…è¶Šã‚­ãƒ¥ãƒ¼ãƒ–å€ç‡
            if(acc.id === 'acc_transcendence') {
                atk = Math.floor(atk * Player.transcendenceRoll);
            }

            if(acc.id === 'acc_wrath') atk += 1000;
            // å‚²æ…¢ã®ç³ï¼šæ”»æ’ƒåŠ› +50% (èª¬æ˜æ–‡ã®+100%ã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹å ´åˆã¯ã“ã“ã‚’ * 2.0 ã«)
            // å…ƒã‚³ãƒ¼ãƒ‰ã¯ * 2.0 ãªã®ã§ã“ã“ã‚‚åˆã‚ã›ã¾ã™
            if(acc.id === 'acc_pride') atk = Math.floor(atk * 2.0);
        });

        // äº¡è€…ã®ãƒãƒƒã‚¯ãƒ¬ã‚¹ (éœŠä½“æ™‚æ”»æ’ƒ2å€)
        if (Player.ghostTurns > 0) atk *= 2;

        // ãƒŠã‚¤ãƒˆãƒ¡ã‚¢ãƒ©ãƒ³ã‚¹ (åˆæ‰‹å€åŒ–)
        if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_nightmare' && GameState.combatTurn === 1) {
            atk *= 2;
        }
        // åŸåˆã®å‰£ï¼šç·æ”»æ’ƒåŠ›1.5å€
        if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_primordial') {
            atk = Math.floor(atk * 1.5);
        }
        return atk;
    },

    getCritRate(returnRaw = false) {
        // åŸºç¤ 5% + æ°¸ä¹…ãƒœãƒ¼ãƒŠã‚¹
        let rate = 0.05 + (Player.permanentCritBonus || 0);

        // ãƒãƒ•åŠ ç®—
        if (Player.buff) {
            if (Player.buff.id === 'angel_courage') rate += 0.20;
            if (Player.buff.id === 'demon_enhance') rate = 0.50;  // å›ºå®šå€¤
        }

        // ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼åŠ ç®—
        Player.equipment.accessories.forEach(acc => {
            if(!acc) return;
            if(acc.id === 'acc_wolf_1') rate += 0.01;
            if(acc.id === 'acc_wolf_2') rate += 0.03;
            if(acc.id === 'acc_wolf_3') rate += 0.08;
            if(acc.id === 'acc_demon_1') rate += 0.02;
            if(acc.id === 'acc_demon_2') rate += 0.05;
            if(acc.id === 'acc_demon_3') rate += 0.20;
            
            // èµ¤ã„å¸ƒ
            if(acc.id === 'acc_red_cloth') rate += 0.10; 

            // é‹å‘½ã®è¼ª (Rawè¦æ±‚ã§ãªã‘ã‚Œã°0ã«ãªã‚Šãƒ€ãƒ¡ãƒ¼ã‚¸è»¢æ›)
            if(acc.id === 'acc_wheel' && !returnRaw) rate = 0; 
        });
        
        let percent = Math.round(rate * 100);
        return percent > 100 ? 100 : percent;
    },

    recalcStats() {
        const currentRatio = Player.maxHp > 0 ? Player.hp / Player.maxHp : 1; 
        let bonusHp = Player.equipment.armor ? Player.equipment.armor.val : 0;
        
        Player.equipment.accessories.forEach(acc => {
            if(!acc) return;
            if(acc.id.includes('golem')) {
                if(acc.id === 'acc_golem_1') bonusHp += 30;
                if(acc.id === 'acc_golem_2') bonusHp += 100;
                if(acc.id === 'acc_golem_3') bonusHp += 200;
            }
            if(acc.id.includes('demon')) {
                if(acc.id === 'acc_demon_1') bonusHp += 10;
                if(acc.id === 'acc_demon_2') bonusHp += 20;
                if(acc.id === 'acc_demon_3') bonusHp += 40;
            }
        });
        
        // åŸºç¤å€¤ + è£…å‚™ + æ°¸ä¹…ãƒœãƒ¼ãƒŠã‚¹ + ãƒªãƒªã‚¹
        let newMaxHp = Player.baseMaxHp + bonusHp + (Player.permanentHpBonus || 0);
        
        if (Player.lilithBlessing || Player.lilithSacrificed) {
            newMaxHp += 10000;
        }

        if (Player.lastInspirationTurns > 0) {
            newMaxHp += 6666;
        }
        
        // è¡€ã®å¥‘ç´„æ›¸ (MaxHPåŠæ¸› -> AtkåŠ ç®—)
        Player.bloodContractAtk = 0;
        if (Player.equipment.accessories.some(a => a && a.id === 'acc_blood')) {
            let removedHp = Math.floor(newMaxHp * 0.5);
            newMaxHp -= removedHp;
            Player.bloodContractAtk = removedHp;
        }

        Player.maxHp = newMaxHp;
        
        // HPå‰²åˆç¶­æŒ
        let newHp = Math.round(currentRatio * Player.maxHp);
        Player.hp = Math.min(newHp, Player.maxHp);
        if (Player.hp <= 0 && Player.ghostTurns === 0) Player.hp = 0; 
        
        this.updateStatsUI();
    },

   // --- ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ (Core Logic) ---
    nextEvent() {
        if (Player.hp <= 0) {
            this.restart();
            return;
        }

        // ã‚«ã‚ªã‚¹ã‚­ãƒ¥ãƒ¼ãƒ–åˆ¤å®š
        if (Player.equipment.accessories.some(a => a && a.id === 'acc_chaos')) {
            Player.chaosRoll = (Math.random() * 2.5 + 0.5).toFixed(2); // 0.5 - 3.0
            this.showFloatingText(`ğŸ² ã‚«ã‚ªã‚¹: x${Player.chaosRoll}`, "#ff00ff");
        } else {
            Player.chaosRoll = 1;
        }

        // è¶…è¶Šã‚­ãƒ¥ãƒ¼ãƒ–åˆ¤å®š
        if (Player.equipment.accessories.some(a => a && a.id === 'acc_transcendence')) {
            Player.transcendenceRoll = (Math.random() * 4.0 + 1.0).toFixed(2);
            setTimeout(() => Game.showFloatingText(`ğŸ§Š è¶…è¶Š: x${Player.transcendenceRoll}`, "#00ffff"), 300);
        } else {
            Player.transcendenceRoll = 1;
        }

        // è‰²æ¬²ãƒ€ãƒ¡ãƒ¼ã‚¸
        if (Player.sinState.lustActive) {
            const drain = Math.floor(Player.maxHp * 0.10);
            Player.hp = Math.max(1, Player.hp - drain);
            this.showFloatingText(`é­…äº† -${drain} HP`, "#ff00ff");
        }

        Player.depth++;
        this.checkAchievements();
        this.checkSinCollection();
        
        // ç…‰ç„ã¸ã®æ‰‰
        if (!Player.inInferno && Player.history.items.has("ç…‰ç„ã®è–æ›¸")) {
            this.triggerInfernoGate();
            return;
        }

        // ç…‰ç„ä¸–ç•Œ
        if (Player.inInferno) {
            if (Player.depth === 1) {
                const hasNote = Player.inventory.material.some(i => i.name === "ãƒ¡ãƒ¢");
                const hasSword = Player.inventory.equipment.some(i => i.name === "ç¥è–ãªå…‰å‰£") || Player.equipment.weapon?.name === "ç¥è–ãªå…‰å‰£";
                
                if (hasNote && !hasSword) {
                    GameState.phase = "event_end";
                    const sword = {...CONFIG.specialItems.holy_sword};
                    this.addItemToInventory(sword);
                    this.renderEvent("âš”ï¸ ãƒªãƒªã‚¹ã®è´ˆã‚Šç‰©", "ã€Œã“ã‚Œã‚’æŒã£ã¦ã¦ã€‚ã“ã“ã§ç”ŸãæŠœããŸã‚ã«ã€‚ã€", `ãƒ¡ãƒ¢ã‚’æŒã£ã¦ã„ãŸãŸã‚ã€<span class='rarity-mythic'>${sword.name}</span> ã‚’ç²å¾—ï¼`, "ğŸ");
                    this.setButtons("æ¬¡ã¸", "processInfernoEvent", "ãªã—", null, true); 
                    return;
                }
            }
            this.log(`>>> ğŸ”¥ [ç…‰ç„] ç¬¬ ${Player.depth} å±¤`);
            this.processInfernoEvent();
            return;
        }

        // æ—§ä¸–ç•Œ
        this.log(`>>> ç¬¬ ${Player.depth} å±¤æ¢ç´¢ä¸­...`);
        this.processNormalEvent();
    },

    processNormalEvent() {
        // è‡ªç„¶å›å¾©
        let regen = 0;
        if (Player.buff && Player.buff.id === 'angel_song') regen += 5;
        Player.equipment.accessories.forEach(acc => {
            if(!acc) return;
            if(acc.id === 'acc_slime_2') regen += 2;
            if(acc.id === 'acc_slime_3') regen += 10;
        });
        if (regen > 0 && Player.hp < Player.maxHp) {
            Player.hp = Math.min(Player.maxHp, Player.hp + regen);
            this.showFloatingText(`+${regen} HP`, "#69f0ae");
        }

        if (Math.random() < 0.01) {
            this.triggerFairyEvent();
            this.updateUI();
            return;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ„ãƒªãƒ¼
        if (Player.depth >= 1000 && (Player.depth - 1000) % 500 === 0) {
            this.triggerCombat(true, true); 
            this.updateUI();
            return;
        }
        if (Player.depth === 500) {
            this.triggerCombat(true, false); 
            this.updateUI();
            return;
        }
        if (Player.depth === 501) alert("è­¦å‘Šï¼šæ·±å±¤é ˜åŸŸã«çªå…¥ã—ã¾ã—ãŸï¼");

        if (Player.depth > 100 && Math.random() < 0.005) {
            this.triggerTrip();
            this.updateUI();
            return;
        }

        if (Math.random() < 0.005) {
            this.triggerSuccubusEvent();
            this.updateUI();
            return;
        }

        if (Player.depth > 200 && Math.random() < 0.005) {
            this.triggerHarpy();
            this.updateUI();
            return;
        }

        const rand = Math.random();
        if (rand < 0.03) this.triggerCraftingTable();
        else if (rand < 0.08) this.triggerHeal();
        else if (rand < 0.13) this.triggerStatue();
        else if (rand < 0.16) this.triggerClassEvent();
        else if (rand < 0.33) this.triggerMerchant();
        else if (rand < 0.43) this.triggerChest();
        else this.triggerCombat(false, false);
        
        this.updateUI();
    },

   processInfernoEvent() {
        // é™å¯‚ã®åº­åœ’ (0.05% - æœ€å„ªå…ˆ)
        if (Math.random() < 0.0005) {
            this.triggerGardenEvent();
            return;
        }

        // 10å±¤ç¢ºå®šã‚¹ãƒ©ã‚¤ãƒ é•·è€
        if (Player.depth === 10) {
            this.log(">>> 10å±¤ç¢ºå®š: ã‚¹ãƒ©ã‚¤ãƒ é•·è€");
            this.triggerSlimeElderEvent();
            return;
        }

        const rand = Math.random();
        // 1% ã‚¹ãƒ©ã‚¤ãƒ é•·è€
        if (Math.random() < 0.01) { 
            this.triggerSlimeElderEvent(); 
            return; 
        }

        if (Math.random() < 0.005) { 
            this.triggerInfernoHarpy(); 
            return; 
        }

        const hasCrown = Player.inventory.material.some(i => i.name === "åŸç½ªã®ç‹å† ");
        if (hasCrown && Math.random() < 0.05) {
             this.triggerDeadStatue(); 
             return; 
        }
        
        // 1. ä¸ƒã¤ã®å¤§ç½ª (1%)
        if (rand < 0.01) { this.triggerSinEvent(); return; }

        // 2. ç…‰ç„ã®ç‚‰ (5%) -> 0.06
        if (rand < 0.06) { this.triggerInfernoForge(); return; }

        // 3. ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã®è¿·å®® (3%) -> 0.09
        if (rand < 0.09) { this.triggerMinotaurMaze(); return; }

        // 4. æ‚ªé­”å•†äºº (10%) -> 0.19
        if (rand < 0.19) { this.triggerDemonMerchant(); } 
        // 5. è™šç©ºã®è£‚ã‘ç›® (10%) -> 0.29
        else if (rand < 0.29) { this.triggerVoidRift(); } 
        // 6. é®®è¡€ã®ç¥­å£‡ (10%) -> 0.39
        else if (rand < 0.39) { this.triggerBloodAltar(); }
        // 7. ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ä¹±å…¥ (3%) -> 0.42
        else if (rand < 0.42) { this.triggerMinotaur(); }
        // 8. ç…‰ç„æˆ¦é—˜ (ãã®ä»–)
        else { this.triggerInfernoCombat(); }
        
        this.updateUI();
    },

    showLilith() {
        const iconEl = document.getElementById('event-icon');
        iconEl.innerHTML = LILITH_HTML;
        iconEl.className = 'lilith-glow'; 
        iconEl.style.overflow = 'visible'; 
    },

    // é­…é­”ãƒªãƒªã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
    triggerSuccubusEvent() {
        GameState.phase = "event_end";
        
        const hasChocolate = Player.inventory.material.some(i => i.name === "é­”åŠ›ã®ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ");
        const stage = Player.succubusStage;

        // Stage A (0): åˆå¯¾é¢
        if (stage === 0) {
            this.renderEvent("?? å€’ã‚Œã¦ã„ã‚‹å°‘å¥³", "é“ç«¯ã§å°‘å¥³ãŒå€’ã‚Œã¦ã„ã‚‹...", "é¡”è‰²ãŒæ‚ªã„ã‚ˆã†ã ã€‚", null);
            this.showLilith();
            
            if (hasChocolate) {
                this.setButtons("èµ·ã“ã™ (ãƒãƒ§ã‚³ã‚’ã‚ã’ã‚‹)", "resolveSuccubusA_Give", "ç„¡è¦–ã™ã‚‹", "nextEvent", false);
            } else {
                this.setButtons("èµ·ã“ã™ (-20HP)", "resolveSuccubusA_Wake", "ç„¡è¦–ã™ã‚‹", "nextEvent", false);
            }
        }
        // Stage B (1): çŸ¥ã‚Šåˆã„
        else if (stage === 1) {
            this.renderEvent("ğŸ‘© å†ä¼š", "ã‚µã‚­ãƒ¥ãƒã‚¹ã¯å‰å›ã®æ•‘åŠ©ã«æ„Ÿè¬ã—ã¦ã„ã‚‹ã€‚", "å…ƒæ°—ã«ãªã£ãŸã‚ˆã†ã ã€‚", null);
            this.showLilith();

            if (hasChocolate) {
                this.setButtons("ãƒãƒ§ã‚³ã‚’ã‚ã’ã‚‹", "resolveSuccubusB_Give", "ãŠç¤¼ã¯ã„ã„ã¨è¨€ã†", "resolveSuccubusHeal", false);
            } else {
                this.setButtons("ãŠç¤¼ã¯ã„ã„ã¨è¨€ã†", "resolveSuccubusHeal", "ãªã—", null, true);
            }
        }
        // Stage C (2): ç…§ã‚Œ
        else if (stage === 2) {
            this.renderEvent("ğŸ˜³ ç…§ã‚Œã‚‹ã‚µã‚­ãƒ¥ãƒã‚¹", "ã‚ãªãŸã‚’è¦‹ã¦é ¬ã‚’èµ¤ã‚‰ã‚ã¦ã„ã‚‹ã€‚", "ä½•ã‹è¨€ã„ãŸãã†ã ...", null);
            this.showLilith();

            if (hasChocolate) {
                this.setButtons("ãƒãƒ§ã‚³ã‚’ã‚ã’ã‚‹", "resolveSuccubusC_Give", "ãŠå–‹ã‚Šã™ã‚‹", "resolveSuccubusHeal", false); 
            } else {
                this.setButtons("ãŠå–‹ã‚Šã™ã‚‹", "resolveSuccubusHeal", "ãªã—", null, true);
            }
        }
        // Stage 3: å®Œäº† (å›å¾©)
        else {
            this.renderEvent("â¤ï¸ ã‚µã‚­ãƒ¥ãƒã‚¹ãƒ»ãƒªãƒªã‚¹", "ã€Œå†’é™ºã€ãŠç–²ã‚Œæ§˜ã€‚ç™’ã—ã¦ã‚ã’ã‚‹ã€‚ã€", "HP å®Œå…¨å›å¾©ã€‚", null);
            this.showLilith();
            Player.hp = Player.maxHp;
            this.setButtons("ã‚ã‚ŠãŒã¨ã†", "nextEvent", "ãªã—", null, true);
        }
    },

    // ã‚¹ãƒ©ã‚¤ãƒ é•·è€ã‚¤ãƒ™ãƒ³ãƒˆ (ç…‰ç„)
    triggerSlimeElderEvent() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        
        if (Player.elderEnhanceCount >= 5) {
            const feather = {...CONFIG.phoenixFeather};
            this.addItemToInventory(feather);
            this.renderEvent("ğŸ‘‘ ã‚¹ãƒ©ã‚¤ãƒ é•·è€", "é•·è€ã¯é©šã„ãŸã‚ˆã†ã«ã‚ãªãŸã‚’è¦‹ã¦ã„ã‚‹ã€‚", "ã€ŒãŠä¸»ã€ä¸æ€è­°ãªè¼ãã‚’æ”¾ã£ã¦ãŠã‚‹ãª...ã“ã®ç¾½æ ¹ã‚’ã‚„ã‚ã†ã€‚ã€<br>ç²å¾— <span class='rarity-legendary'>ä¸æ­»é³¥ã®ç¾½æ ¹</span>", "ğŸ‘´");
            this.setButtons("æ„Ÿè¬ã™ã‚‹", "nextEvent", "ãªã—", null, true);
            return;
        }

        this.renderEvent("ğŸ‘‘ ã‚¹ãƒ©ã‚¤ãƒ é•·è€", "ç‹å† ã‚’è¢«ã£ãŸå·¨å¤§ãªã‚¹ãƒ©ã‚¤ãƒ ãŒé“ã‚’å¡ã„ã§ã„ã‚‹ã€‚", `ã€Œè‹¥è€…ã‚ˆã€å…¨è²¡ç”£ (${Player.gold} G) ã‚’æ¨ã¦ã‚‹è¦šæ‚ŸãŒã‚ã‚‹ãªã‚‰ã€ç…‰ç„ã®ç”Ÿãæ–¹ã‚’æˆã‘ã‚ˆã†ã€‚ã€<br>(ç¾åœ¨ã®å¼·åŒ–: ${Player.elderEnhanceCount}/5)`, "ğŸ‘´");
        
        if (Player.gold <= 0) {
            this.setButtons("ä¸€æ–‡ç„¡ã—ã§ã™...", "nextEvent", "ãªã—", null, true);
        } else {
            this.setButtons("å…¨è²¡ç”£ã‚’æ§ã’ã‚‹ (HP+600/æ”»+600)", "resolveElderEnhance", "æ‹’å¦", "nextEvent", false);
        }
    },

    resolveElderEnhance() {
        if (Player.elderEnhanceCount >= 5) {
            alert("ç…‰ç„ã®åŠ›ãŒé™ç•Œã«é”ã—ã¾ã—ãŸï¼");
            this.nextEvent();
            return;
        }

        Player.gold = 0;
        Player.elderEnhanceCount++;
        
        Player.baseMaxHp += 600;
        Player.maxHp += 600;
        Player.hp += 600;
        Player.baseAtk += 600;
        
        this.showFloatingText("ç…‰ç„ã®åŠ›ãŒè¦šé†’!", "#ff0000");
        this.renderEvent("ğŸ‘‘ é•·è€ã®ä¼æ‰¿", "é‡‘è²¨ã¯é•·è€ã«é£²ã¿è¾¼ã¾ã‚Œã€ç´”ç²‹ãªåŠ›ã«å¤‰ã‚ã£ãŸï¼", `æœ€å¤§HP +600 / åŸºç¤æ”»æ’ƒ +600<br>(å¼·åŒ–æ¸ˆã¿ ${Player.elderEnhanceCount}/5 å›)`, "ğŸ’ª");
        this.setButtons("æ„Ÿè¬ã™ã‚‹", "nextEvent", "ãªã—", null, true);
        this.updateUI();
        this.checkAchievements(); 
    },
    
    resolveSuccubusA_Wake() {
        Player.hp = Math.max(1, Player.hp - 20);
        this.renderEvent("ğŸ˜µ ç²¾æ°—å¸å", "èµ·ã“ãã†ã¨ã—ãŸãŒã€ä½“åŠ›ãŒå¸ã„å–ã‚‰ã‚ŒãŸ...", "HP -20", null);
        this.showLilith();
        this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },
    resolveSuccubusA_Give() {
        this.removeSpecificItem("é­”åŠ›ã®ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ");
        Player.succubusStage = 1;
        this.renderEvent("ğŸ« å…ƒæ°—å›å¾©", "ãƒãƒ§ã‚³ã‚’é£Ÿã¹ã‚‹ã¨ã€å½¼å¥³ã®é¡”è‰²ãŒè‰¯ããªã£ãŸã€‚", "è¨€è‘‰ã¯ãªã‹ã£ãŸãŒã€æ„Ÿè¬ã®çœ¼å·®ã—ã‚’æ®‹ã—ã¦å»ã£ã¦ã„ã£ãŸã€‚", null);
        this.showLilith();
        this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },
    resolveSuccubusB_Give() {
        this.removeSpecificItem("é­”åŠ›ã®ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ");
        Player.succubusStage = 2;
        Player.hp = Player.maxHp;
        this.renderEvent("ğŸ« å–œã¶ã‚µã‚­ãƒ¥ãƒã‚¹", "å½¼å¥³ã¯å¬‰ã—ãã†ã«ãƒãƒ§ã‚³ã‚’å—ã‘å–ã£ãŸï¼", "ãŠç¤¼ã«HPã‚’å…¨å›å¾©ã—ã¦ãã‚ŒãŸã€‚", null);
        this.showLilith();
        this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },
    resolveSuccubusC_Give() {
        this.removeSpecificItem("é­”åŠ›ã®ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ");
        Player.succubusStage = 3;
        Player.hp = Math.max(1, Player.hp - 10);
        this.addItemToInventory({...CONFIG.specialItems.note});
        this.renderEvent("ğŸ¥° ã‚µã‚­ãƒ¥ãƒã‚¹ã®çœŸå", "å½¼å¥³ã¯æ¥ãšã‹ã—ãã†ã«ã‚ãªãŸã‚’æŠ±ãã—ã‚ (HP -10)ã€ãƒ¡ãƒ¢ã‚’æ‰‹æ¸¡ã—ãŸã€‚", "ã€ãƒ¡ãƒ¢ã€‘ã‚’ç²å¾—ã€‚", null);
        this.showLilith();
        this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },
    resolveSuccubusHeal() {
        Player.hp = Player.maxHp;
        this.renderEvent("âœ¨ ã‚µã‚­ãƒ¥ãƒã‚¹ã®æ©è¿”ã—", "ã€Œã“ã‚ŒãŒãŠç¤¼ã‚ˆã€‚ã€", "HP å®Œå…¨å›å¾©ã€‚", null);
        this.showLilith();
        this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },

    removeSpecificItem(name) {
        const idx = Player.inventory.material.findIndex(i => i.name === name);
        if(idx > -1) Player.inventory.material.splice(idx, 1);
    },

    triggerFairyEvent() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        
        if (Player.fairyEnhanceCount >= 5) {
            Player.hp = Player.maxHp;
            this.renderEvent("ğŸ§š ç²¾éœŠã®ç¥ç¦", "ç²¾éœŠã¯å¾®ç¬‘ã‚“ã§ã„ã‚‹ã€‚", "ã€Œã‚ãªãŸã®é­‚ã¯ååˆ†ã«å¼·ã„ã‚ã€‚ã€<br>(HPå®Œå…¨å›å¾©)", "âœ¨");
            this.setButtons("ã‚ã‚ŠãŒã¨ã†", "nextEvent", "ãªã—", null, true);
            return;
        }

        this.renderEvent("ğŸ§š æ¹–ã®ç²¾éœŠ", "å…‰ã‚Šè¼ãç²¾éœŠãŒç¾ã‚ŒãŸã€‚", `ã€Œå…¨ã¦ã®å¯Œ (${Player.gold} G) ã‚’æ§ã’ã‚Œã°ã€ã‚ãªãŸã®æœ¬è³ªã‚’å¼·åŒ–ã—ã¾ã—ã‚‡ã†ã€‚ã€<br>(ç¾åœ¨ã®å¼·åŒ–: ${Player.fairyEnhanceCount}/5)`, "ğŸ’§");
        
        if (Player.gold <= 0) {
            this.setButtons("ãŠé‡‘ãŒãªã„...", "nextEvent", "ãªã—", null, true);
        } else {
            this.setButtons("é‡‘è²¨ã‚’æ§ã’ã‚‹ (HP+100/æ”»+100)", "resolveFairyEnhance", "æ‹’å¦", "nextEvent", false);
        }
    },

    resolveFairyEnhance() {
        if (Player.fairyEnhanceCount >= 5) {
            alert("é­‚ã®å¼·åŒ–ã¯é™ç•Œã§ã™ï¼");
            this.nextEvent();
            return;
        }

        Player.gold = 0; 
        Player.fairyEnhanceCount++;
        
        Player.baseMaxHp += 100; 
        Player.maxHp += 100;     
        Player.hp += 100;        
        Player.baseAtk += 100;
        
        this.showFloatingText("åŸºç¤èƒ½åŠ›å¤§å¹…ä¸Šæ˜‡!", "#00ffcc");
        this.renderEvent("ğŸ§š ç²¾éœŠã®é­”æ³•", "é‡‘è²¨ãŒå…‰ã®ç²‰ã¨ãªã£ã¦ä½“ã«æº¶ã‘è¾¼ã‚“ã ã€‚", `æœ€å¤§HP +100 / åŸºç¤æ”»æ’ƒ +100<br>(å¼·åŒ–æ¸ˆã¿ ${Player.fairyEnhanceCount}/5 å›)`, "âœ¨");
        this.setButtons("ã‚ã‚ŠãŒã¨ã†", "nextEvent", "ãªã—", null, true);
        this.updateUI();
        this.checkAchievements();
    },

    // --- é€šå¸¸ã‚¤ãƒ™ãƒ³ãƒˆ ---
    triggerTrip() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-damage');
        const hookIndex = Player.inventory.material.findIndex(i => i.name === 'ãƒ•ãƒƒã‚¯');
        let useHook = false;
        if (hookIndex !== -1) {
            Player.inventory.material.splice(hookIndex, 1);
            useHook = true;
        }
        const isApe = Player.class === 'ape';
        const isGoodOutcome = useHook || isApe || (Math.random() < 0.3);

        if (isGoodOutcome) {
            const item = this.generateSpecificItem(['weapon', 'armor', 'shield']);
            this.addItemToInventory(item);
            let msg = "";
            if (useHook) msg = `è»¢å€’ã—ãŸãŒã€<span class='rarity-rare'>ãƒ•ãƒƒã‚¯</span>ãŒå²©å£ã‚’æ‰ãˆãŸï¼(ãƒ•ãƒƒã‚¯ç ´æ)<br>å²©å£ã§ <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span> ã‚’ç™ºè¦‹ï¼`;
            else if (isApe) msg = `è»¢å€’ã—ãŸãŒã€<span class='block-text'>é¡äººçŒ¿ã®æ•æ·æ€§</span>ã§å²©å£ã‚’æ´ã‚“ã ï¼<br>å¶ç„¶ã«ã‚‚ <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span> ã‚’ç™ºè¦‹ï¼`;
            else msg = `è»¢å€’ã—ãŸãŒã€é–“ä¸€é«ªã§å²©å£ã‚’æ´ã‚“ã ï¼<br>å¶ç„¶ã«ã‚‚ <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span> ã‚’ç™ºè¦‹ï¼`;
            this.renderEvent("ğŸ’« ç½ã„è»¢ã˜ã¦", "è»¢ã‚“ã§ã—ã¾ã£ãŸãŒ...", msg, "ğŸª");
        } else {
            let lostItemName = null;
            const equippedTypes = [];
            if (Player.equipment.weapon) equippedTypes.push('weapon');
            if (Player.equipment.armor) equippedTypes.push('armor');
            if (Player.equipment.shield) equippedTypes.push('shield');

            if (equippedTypes.length > 0) {
                const lostType = equippedTypes[Math.floor(Math.random() * equippedTypes.length)];
                const item = Player.equipment[lostType];
                lostItemName = item.name;
                Player.equipment[lostType] = null;
                this.recalcStats();
                this.renderEvent("ğŸ’« è»¢å€’ï¼", "åœ°é¢ãŒå´©ã‚Œã€æ´¾æ‰‹ã«è»¢ã‚“ã ...", `ä¸é‹ã«ã‚‚ <span class='damage-text'>${lostItemName}</span> ã‚’è½ã¨ã—ã¦ã—ã¾ã£ãŸï¼`, "ğŸ¦¶");
            } else {
                const dmg = 10;
                Player.hp = Math.max(1, Player.hp - dmg);
                this.renderEvent("ğŸ’« è»¢å€’ï¼", "åœ°é¢ãŒå´©ã‚Œã€æ´¾æ‰‹ã«è»¢ã‚“ã ...", `è£…å‚™ã¯ç„¡äº‹ã ãŒã€ä½“ã‚’å¼·ãæ‰“ã£ãŸ (HP -${dmg})ã€‚`, "ğŸ¦¶");
            }
        }
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
    },

    // ... (ç…‰ç„ã‚¤ãƒ™ãƒ³ãƒˆ) ...

    triggerInfernoForge() {
        GameState.phase = "forge";
        GameState.forgeUsed = false;
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ”¥ ç…‰ç„ã®ç‚‰", "ç…®ãˆãŸãã‚‹ãƒã‚°ãƒã®ä¸­ã«é»’æ›œçŸ³ã®é‡‘åºŠãŒã‚ã‚‹ã€‚", "ã“ã“ã§ã¯ä¸€åº¦ã ã‘ç¥è©±è£…å‚™ã‚’é›é€ ã§ãã‚‹ã€‚", "ğŸŒ‹");
        this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
        this.renderForgeUI();
    },

    renderForgeUI() {
        const area = document.getElementById('crafting-area');
        area.innerHTML = "";
        area.classList.remove('hidden');

        if (GameState.forgeUsed) {
            this.renderEvent("ğŸ”¥ æ¶ˆãˆãŸç‚‰ç«", "ç‚‰ã®ç«ã¯æ¶ˆãˆã€ãŸã ã®ãƒã‚°ãƒã«æˆ»ã£ãŸã€‚", "ã“ã‚Œä»¥ä¸Šé›é€ ã¯ã§ããªã„ã€‚", "ğŸŒ«ï¸");
            return;
        }

        let html = "<h4>ğŸ”¥ ç…‰ç„é›é€  (1å›é™å®š)</h4><div class='craft-grid'>";
        
        CONFIG.forgeItems.forEach(item => {
            const recipe = item.recipe;
            const ownedItems = Player.inventory.material.filter(m => m.name === recipe.mat);
            const owned = ownedItems.length;
            const canCraft = owned >= recipe.count;
            const statusClass = canCraft ? 'ok' : 'no';

            html += `<div class="craft-item" onclick="Game.craftForgeItem('${item.id}')">
                <div class="m-top">
                    <span>${item.icon} ${item.name}</span>
                </div>
                <div class="craft-req ${statusClass}">
                    éœ€: ${recipe.mat} (${owned}/${recipe.count})
                </div>
            </div>`;
        });
        html += "</div>";
        area.innerHTML = html;
    },

    craftForgeItem(itemId) {
        if (GameState.phase !== "forge" || GameState.forgeUsed) return;

        const itemTemplate = CONFIG.forgeItems.find(i => i.id === itemId);
        if (!itemTemplate) return;

        const recipe = itemTemplate.recipe;
        const owned = Player.inventory.material.filter(m => m.name === recipe.mat).length;

        if (owned < recipe.count) {
            alert("ç´ æãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
            return;
        }

        // ç´ ææ¶ˆè²»
        let toRemove = recipe.count;
        const newMats = [];
        for (let m of Player.inventory.material) {
            if (m.name === recipe.mat && toRemove > 0) {
                toRemove--;
            } else {
                newMats.push(m);
            }
        }
        Player.inventory.material = newMats;

        // è£…å‚™ä»˜ä¸
        this.addItemToInventory(Object.assign({}, itemTemplate));
        GameState.forgeUsed = true;
        
        this.showFloatingText("é›é€ æˆåŠŸ!", "#ff3300");
        this.renderForgeUI(); 
        this.updateUI();
        this.checkAchievements();
    },

    triggerInfernoGate() {
        Player.inInferno = true;
        Player.depth = 0; 
        document.body.classList.add('inferno-mode');
        GameState.phase = "event_end";
        this.triggerAnim('game-container', 'anim-screen-shake');
        this.renderEvent("ğŸ”¥ ç…‰ç„ã®é–€é–‹æ”¾", "è–æ›¸ãŒç‡ƒãˆå°½ãã€ä¸–ç•ŒãŒå´©å£Šã—ã¦å†æ§‹ç¯‰ã•ã‚Œã‚‹...", "ç…‰ç„ã¸å •ã¡ãŸã€‚æ—§ä¸–ç•Œã®ãƒ«ãƒ¼ãƒ«ã¯ã‚‚ã¯ã‚„é€šç”¨ã—ãªã„ã€‚", "â›©ï¸");
        const idx = Player.inventory.material.findIndex(i => i.name === "ç…‰ç„ã®è–æ›¸");
        if(idx > -1) Player.inventory.material.splice(idx, 1);
        this.setButtons("ææ€–ã«ç«‹ã¡å‘ã‹ã†", "nextEvent", "ãªã—", null, true);
        this.checkAchievements(); 
    },
    triggerVoidRift() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸŒŒ è™šç©ºã®è£‚ã‘ç›®", "ç©ºé–“ãŒè£‚ã‘ã€å±é™ºãªç´«è‰²ã®è£‚ã‘ç›®ãŒç¾ã‚ŒãŸã€‚", "ãƒã‚¤ãƒªã‚¹ã‚¯ãƒ»ãƒã‚¤ãƒªã‚¿ãƒ¼ãƒ³ï¼š50%ã§ç¥è©±ã®å®ã€50%ã§è‡´å‘½å‚·ã€‚", "ğŸŒ€");
        this.setButtons("è§¦ã‚Œã‚‹ (50%ã§è² å‚·)", "resolveVoidRift", "ç«‹ã¡å»ã‚‹", "nextEvent", false);
    },

    resolveVoidRift() {
        if (Math.random() < 0.5) {
            // --- æˆåŠŸ ---
            const roll = Math.random(); 

            if (roll < 0.01) { 
                // 1%ï¼šãƒ´ã‚©ã‚¤ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼
                const sword = CONFIG.infernoItems.find(i => i.id === 'w_void_breaker');
                this.addItemToInventory({...sword});
                this.renderEvent("ğŸŒŒ è™šç©ºã®å¥‡è·¡", "è£‚ã‘ç›®ã®å¥¥ã«ç ´æ»…ã®å…‰ã‚’è¦‹ãŸ...", `é‹æ°—çˆ†ç™ºï¼ <span class='rarity-mythic'>${sword.name}</span> ã‚’ç²å¾—`, "ğŸŒŒ");
            } 
            else if (roll < 0.50) { 
                // 49%ï¼šå¤§é‡ã‚´ãƒ¼ãƒ«ãƒ‰
                const gold = 5000 + Player.depth * 10;
                Player.gold += gold;
                this.renderEvent("ğŸŒŒ è™šç©ºã®å¯Œ", "å¤§é‡ã®ç…‰ç„é‡‘è²¨ãŒæ¹§ãå‡ºã—ãŸï¼", `ç²å¾— <span class='gold-text'>${gold} G</span>`, "ğŸ’°");
            } 
            else { 
                // 50%ï¼šç¥è©±ç´ æ
                const mats = Object.entries(CONFIG.lootData)
                    .filter(([k, v]) => v.rarity === 'mythic')
                    .map(([k, v]) => ({...v, name: k, type: 'material'}));
                
                const mat = mats[Math.floor(Math.random() * mats.length)];
                this.addItemToInventory(mat);
                this.renderEvent("ğŸŒŒ è™šç©ºã®è´ˆã‚Šç‰©", "è™šç©ºãŒå¼·åŠ›ãªæ°—é…ã‚’æ”¾ã¤ç‰©è³ªã‚’åãå‡ºã—ãŸã€‚", `ç²å¾— <span class='rarity-mythic'>${mat.name}</span>`, "ğŸ’");
            }
        } else {
            // --- å¤±æ•— ---
            // 50% MaxHP çœŸå®Ÿãƒ€ãƒ¡ãƒ¼ã‚¸
            const dmg = Math.floor(Player.maxHp * 0.5);
            
            if (Player.hp <= dmg) {
                Player.hp = 0;
                this.checkDeath("è™šç©ºã«é£²ã¿è¾¼ã¾ã‚ŒãŸ");
                return;
            } else {
                Player.hp -= dmg;
                this.showFloatingText(`-${dmg} HP (çœŸå®Ÿãƒ€ãƒ¡ãƒ¼ã‚¸)`, "#ff00ff");
                this.renderEvent("ğŸŒŒ è™šç©ºã®åæ’ƒ", "è™šç©ºãŒã‚ãªãŸã®é­‚ã‚’å¼•ãè£‚ã“ã†ã¨ã—ãŸï¼", `<span class='damage-text'>${dmg} (50% MaxHP)</span> ã®çœŸå®Ÿãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚`, "ğŸ’€");
            }
        }
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },
    triggerBloodAltar() {
        GameState.phase = "event_end";
        this.renderEvent("ğŸ©¸ é®®è¡€ã®ç¥­å£‡", "ã€Œè¡€ã«ã¯è¡€ã‚’ã€ç­‰ä¾¡äº¤æ›ã ã€‚ã€", `ç¾åœ¨HPã®50% (${Math.floor(Player.hp * 0.5)}) ã‚’æ§ã’ã€ç…‰ç„ã®ç¥å™¨ã‚’å¾—ã‚‹ã‹ï¼Ÿ(æˆåŠŸç‡ 20%)`, "ğŸ§›");
        this.setButtons("ç”Ÿå‘½ã‚’æ§ã’ã‚‹", "resolveBloodAltar", "ç«‹ã¡å»ã‚‹", "nextEvent", false);
    },

    resolveBloodAltar() {
        const cost = Math.floor(Player.hp * 0.5);
        Player.hp -= cost;
        this.showFloatingText(`-${cost} HP`, "red");
        
        // æˆåŠŸç‡ 20%
        if (Math.random() < 0.20) {
            if (Math.random() < 0.05) {
                const cube = CONFIG.infernoItems.find(i => i.id === 'acc_transcendence');
                this.addItemToInventory({...cube});
                this.renderEvent("ğŸ©¸ ç¥­å£‡ã®å¥‡è·¡", "è¡€æ¶²ãŒæ²¸é¨°ã—ã€ä¸å¯æ€è­°ãªå½¢çŠ¶ã«å‡å›ºã—ãŸï¼", `ç²å¾— <span class='rarity-mythic'>${cube.name}</span>`, "ğŸ§Š");
            } else {
                const poolIds = ['w_ragnarok', 'w_soulreaver', 'a_voidwalker', 'acc_wheel', 'acc_chaos'];
                const targetId = poolIds[Math.floor(Math.random() * poolIds.length)];
                const item = CONFIG.infernoItems.find(i => i.id === targetId);
                
                const newItem = Object.assign({}, item);
                this.addItemToInventory(newItem);
                this.renderEvent("ğŸ©¸ ç¥­å£‡ã®å¿œç­”", "è¡€éœ§ã®ä¸­ã«ç¥å™¨ãŒæµ®ã‹ã³ä¸ŠãŒã£ãŸ...", `ç²å¾— <span class='rarity-mythic'>${newItem.name}</span>`, "ğŸ");
            }
        } else {
            this.renderEvent("ğŸ©¸ ç¥­å£‡ã®æ²ˆé»™", "è¡€ã¯å¹²ä¸ŠãŒã‚Šã€ä½•ã‚‚èµ·ããªã‹ã£ãŸã€‚", "çŠ ç‰²ã¯ç„¡é§„ã«ãªã£ãŸ...", "ğŸ•¸ï¸");
        }
        
        if (Player.hp <= 0) { this.checkDeath("çŒ®ç¥­ã«ã‚ˆã‚‹æ­»"); return; }
        
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },
    triggerMinotaur() {
        GameState.phase = "event_end";
        const hasRedCloth = Player.equipment.accessories.some(a => a && a.id === 'acc_red_cloth');

        if (hasRedCloth) {
            this.triggerAnim('event-icon', 'anim-lunge');
            this.renderEvent("ğŸ® ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã®çªé€²ï¼", "ç‹‚ã£ãŸãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ãŒçªã£è¾¼ã‚“ã§ããŸï¼", "ã—ã‹ã—ã‚ãªãŸã¯<span class='rarity-mythic'>èµ¤ã„å¸ƒ</span>ã‚’ç¿»ã—ã€è¯éº—ã«å›é¿ã—ãŸï¼(ãƒ€ãƒ¡ãƒ¼ã‚¸ç„¡åŠ¹)", "ğŸ§£");
            this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
            return;
        }
        const equippedAccs = Player.equipment.accessories.map((a, i) => ({item: a, idx: i})).filter(x => x.item !== null);
        if (equippedAccs.length > 0) {
            const target = equippedAccs[Math.floor(Math.random() * equippedAccs.length)];
            Player.equipment.accessories[target.idx] = null;
            this.recalcStats();
            this.renderEvent("ğŸ® ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã®çªé€²ï¼", "ç‹‚ã£ãŸãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã«å¹ãé£›ã°ã•ã‚ŒãŸï¼", `ã‚ãªãŸã® <span class='damage-text'>${target.item.name}</span> ãŒå¼¾ãé£›ã°ã•ã‚Œå¤±ã‚ã‚ŒãŸï¼`, "ğŸ’¨");
        } else {
            const dmg = 300;
            Player.hp -= dmg;
            this.renderEvent("ğŸ® ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã®çªé€²ï¼", "ç‹‚ã£ãŸãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã«å¹ãé£›ã°ã•ã‚ŒãŸï¼", `è½ã¨ã™é£¾ã‚ŠãŒãªãã€${dmg} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`, "ğŸ¤•");
        }
        if (Player.hp <= 0) { this.checkDeath("ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã«è½¢ã‹ã‚ŒãŸ"); return; }
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },

    triggerMinotaurMaze() {
        GameState.phase = "event_end";
        this.renderEvent("ğŸ•¸ï¸ ä¸æ°—å‘³ãªè¿·å®®", "è¡€ã®åŒ‚ã„ãŒæ¼‚ã†è¿·å®®ã«è¿·ã„è¾¼ã‚“ã ...", "å‡ºå£ã‚’è¦‹ã¤ã‘ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚", "ğŸ§±");
        this.setButtons("è¿·å®®ã‚’æ¢ç´¢", "resolveMinotaurMaze", "ãªã—", null, true);
    },

    resolveMinotaurMaze() {
        const rand = Math.random();
        
        // çµæœ 1: èµ¤ã„å¸ƒ (20%)
        if (rand < 0.20) {
            const item = CONFIG.infernoItems.find(i => i.id === 'acc_red_cloth');
            this.addItemToInventory({...item});
            this.renderEvent("ğŸ§£ è¿·å®®ã®ç‰‡éš…", "ç‰‡éš…ã«é®®ã‚„ã‹ãªå¸ƒã‚’è¦‹ã¤ã‘ãŸã€‚", `ç²å¾— <span class="rarity-mythic">${item.name}</span>ï¼`, "ğŸ§£");
        }
        // çµæœ 2: æˆ¦æ–§ (20%)
        else if (rand < 0.40) {
            const item = CONFIG.infernoItems.find(i => i.id === 'w_minotaur');
            this.addItemToInventory({...item});
            this.renderEvent("ğŸª“ è¿·å®®ã®éºç”£", "å£éš›ã«å·¨å¤§ãªæ–§ãŒç«‹ã¦ã‹ã‘ã‚‰ã‚Œã¦ã„ãŸã€‚", `ç²å¾— <span class="rarity-mythic">${item.name}</span>ï¼`, "ğŸª“");
        }
        // çµæœ 3: ä½•ã‚‚ãªã— (30%)
        else if (rand < 0.70) {
            this.renderEvent("ğŸ§± è¿·å®®ã®å‡ºå£", "è¿·å®®ã‚’å½·å¾¨ã„ç¶šã‘ãŸ...", "ä½•ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸãŒã€ç„¡äº‹ã«å‡ºå£ã¸è¾¿ã‚Šç€ã„ãŸã€‚", "ğŸ’¨");
        }
        // çµæœ 4: çªé€² (30%)
        else {
            this.triggerMinotaur();
            return; 
        }
        
        this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },

    triggerDemonMerchant() {
        GameState.phase = "demon_merchant";
        GameState.merchantRefreshed = false;
        this.generateDemonStock();
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ˜ˆ æ‚ªé­”ã®å•†äºº", "ã€Œä¿—ä¸–ã®é€šè²¨ãªã©ç´™åˆ‡ã‚ŒåŒç„¶...ç…‰ç„é‡‘è²¨ãªã‚‰å—ã‘å–ã‚ã†ã€‚ã€", "ç¥è©±è£…å‚™ã®è²©å£²", "ğŸ§›");
        this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
        this.renderMerchantShop();
    },
    generateDemonStock() {
        GameState.merchantStock = [];
        const normalPool = ['w_doom', 'a_apocalypse', 'c_harpy_blood', 'c_pure_blood'];
        let slots = 4;

        // 3% ç…‰ç„ç‚‰ã®å·»ç‰©
        if (Math.random() < 0.03) { 
            const scroll = CONFIG.infernoItems.find(i => i.id === 'c_inferno_scroll');
            if (scroll) {
                GameState.merchantStock.push(Object.assign({}, scroll));
                slots--; 
            }
        }
        // 1% ä¸æ­»é³¥ã®ç¾½æ ¹
        if (Math.random() < 0.01) { 
            let feather = Object.assign({}, CONFIG.phoenixFeather);
            feather.price = 20000; 
            feather.desc = "æ­»äº¡æ™‚HP50%ã§å¾©æ´» (è³¼å…¥å“)"; 
            GameState.merchantStock.push(feather);
            slots--; 
        }
        // 10% é­”ç¥ã®å£
        if (slots > 0 && Math.random() < 0.1) { 
            const wall = CONFIG.infernoItems.find(i => i.id === 's_demon_wall');
            if (wall) {
                GameState.merchantStock.push(Object.assign({}, wall));
                slots--; 
            }
        }

        for(let i=0; i < slots; i++) {
            const targetId = normalPool[Math.floor(Math.random() * normalPool.length)];
            const item = CONFIG.infernoItems.find(i => i.id === targetId);
            if(item) {
                GameState.merchantStock.push(Object.assign({}, item));
            }
        }
    },

    triggerGardenEvent() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸŒ¸ é™å¯‚ã®åº­åœ’", "ç…‰ç„ã«ä¼¼ã¤ã‹ã‚ã—ããªã„æµ„åœŸ...", "åº­åœ’ã®ä¸­å¤®ã«å¼·å¤§ãªæ°—ã‚’æ”¾ã¤é­‚ãŒã„ã‚‹ã€‚<br>(è¿‘ã¥ãã¨æ¥µã‚ã¦å±é™ºãªæˆ¦é—˜ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹)", "ğŸ‘»");
        this.setButtons("è¿‘ã¥ã", "resolveGardenFight", "ç«‹ã¡å»ã‚‹", "nextEvent", false);
    },

    resolveGardenFight() {
        const enemy = {
            name: "å‹‡è€…ã®æ®‹é­‚",
            icon: "ğŸ‘»",
            hp: 333333,
            maxHp: 333333,
            atk: 111111,
            tier: "boss",
            isGardenBoss: true
        };
        // é€ƒèµ°å¯èƒ½(true)
        this.triggerCombatWithEnemy(enemy, true); 
        this.showFloatingText("å¼·è€…...", "#fff");
    },

    triggerInfernoCombat() {
        GameState.phase = "combat";
        let monsterPool = CONFIG.infernoMonsters;
        let totalW = monsterPool.reduce((a, b) => a + b.weight, 0);
        let r = Math.random() * totalW;
        let enemyTemplate = monsterPool[0];
        for(let m of monsterPool) {
            if (r < m.weight) { enemyTemplate = m; break; }
            r -= m.weight;
        }

        // åˆå¿ƒè€…ä¿è­· (1-30å±¤)
        let statModifier = 1.0;
        let namePrefix = "";
        
        if (Player.depth <= 30) {
            statModifier = 0.3; // 70% å¼±ä½“åŒ–
            namePrefix = "(è¡°å¼±) ";
        }

        let enemy = {
            ...enemyTemplate,
            name: namePrefix + enemyTemplate.name,
            maxHp: Math.floor(enemyTemplate.hp * statModifier),
            hp: Math.floor(enemyTemplate.hp * statModifier),
            atk: Math.floor(enemyTemplate.atk * statModifier),
            tier: enemyTemplate.tier || "normal",
            isOldOne: enemyTemplate.isOldOne || false
        };

        if (Player.depth <= 30) {
            this.showFloatingText("åˆå¿ƒè€…ä¿è­·: æ•µå¼±ä½“åŒ– 70%", "#4caf50");
        }

        this.triggerCombatWithEnemy(enemy, true);
    },
// --- æˆ¦é—˜ãƒ­ã‚¸ãƒƒã‚¯ (Combat Logic) ---
    combatRound() {
        if (GameState.phase !== "combat") return;
        GameState.combatTurn++; 
        const enemy = GameState.currentEnemy;
        let logHtml = "";

        // æœ€å¾Œã®é¼“èˆãƒã‚§ãƒƒã‚¯
        const hasInspiration = Player.lastInspirationTurns > 0;
        if (hasInspiration) {
            logHtml += `<span style='color:#ff69b4'>ğŸ’— æœ€å¾Œã®é¼“èˆï¼šç¥ã®æ¨©èƒ½ã‚’ç„¡åŠ¹åŒ– (æ®‹ã‚Š ${Player.lastInspirationTurns} ã‚¿ãƒ¼ãƒ³)</span><br>`;
        }

        // --- ç’°å¢ƒãƒ»ãƒ‘ãƒƒã‚·ãƒ–ã‚¹ã‚­ãƒ« ---
        
        // 1. ãƒã‚°ãƒã‚´ãƒ¼ãƒ¬ãƒ  - éç†±ã‚ªãƒ¼ãƒ©
        if (enemy.name.includes("ãƒã‚°ãƒã‚´ãƒ¼ãƒ¬ãƒ ")) {
            const burn = Math.floor(Player.maxHp * 0.05);
            Player.hp -= burn;
            logHtml += `<span style='color:orange'>ğŸŒ‹ ã€éç†±ã‚ªãƒ¼ãƒ©ã€‘ ç©ºæ°—ãŒè‚ºã‚’ç„¼ãï¼(HP -${burn})</span><br>`;
        }

        // 2. æ—§æ”¯é…è€… - ç²¾ç¥å´©å£Š
        if (enemy.isOldOne) {
            enemy.rageStack = (enemy.rageStack || 0) + 1;
            const madnessDmg = 50 * enemy.rageStack;
            Player.hp -= madnessDmg;
            logHtml += `<span style='color:purple'>ğŸ™ ã€ç²¾ç¥å´©å£Šã€‘ è„³å†…ã®å›ããŒå¤§ãããªã£ã¦ã„ã... (HP -${madnessDmg})</span><br>`;
        }

        // 3. å¯©åˆ¤ã®çœ¼ (ç¥ã®ä»£è¡Œè€…)
        if (enemy.isGod && GameState.combatTurn % 3 === 0 && !hasInspiration) {
            Player.hp = 1;
            logHtml += "<span style='color:red; font-weight:bold; font-size:1.2em;'>ğŸ‘ï¸ ã€å¯©åˆ¤ã®çœ¼ã€‘ å¤©ç½°è¦¿é¢ï¼ HPãŒ 1 ã«ãªã‚‹ï¼</span><br>";
            this.triggerAnim('game-container', 'anim-screen-shake');
        }

        if (Player.hp <= 0) { this.checkDeath(enemy.name); return; }

        // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ç•°å¸¸ ---
        // ã‚«ã‚ªã‚¹ãƒ»ãƒ†ãƒ³ã‚¿ã‚¯ãƒ« - æ€è€ƒæ±šæŸ“
        if (Player.isConfused) {
            Player.isConfused = false; 
            logHtml += "<span style='color:violet'>ğŸ§  ã€æ€è€ƒæ±šæŸ“ã€‘ æ··ä¹±ã—ã¦å‹•ã‘ãªã„ï¼</span><br>";
            this.renderEvent(`âš”ï¸ æˆ¦é—˜ - ${enemy.name}`, `HP: ${enemy.hp}`, logHtml, enemy.icon);
            this.enemyAttackPhase(enemy, logHtml);
            if (Player.lastInspirationTurns > 0) Player.lastInspirationTurns--;
            return;
        }

        // ãƒŠã‚¤ãƒˆãƒ¡ã‚¢ãƒ©ãƒ³ã‚¹ - æ°—çµ¶
        if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_nightmare' && GameState.combatTurn === 2) {
             logHtml += "<span style='color:purple'>ğŸ¦„ æ‚ªå¤¢ã®åå‹•ï¼ çªæ’ƒã®åå‹•ã§1ã‚¿ãƒ¼ãƒ³å‹•ã‘ãªã„ï¼</span><br>";
             this.renderEvent(`âš”ï¸ æˆ¦é—˜ - ${enemy.name}`, `HP: ${enemy.hp}`, logHtml, enemy.icon);
             this.enemyAttackPhase(enemy, logHtml);
             if (Player.lastInspirationTurns > 0) Player.lastInspirationTurns--;
             return;
        }

        // åœ°æ ¸ã®ç‚‰å¿ƒé§ (åŒæ–¹ãƒ€ãƒ¡ãƒ¼ã‚¸)
        if (Player.equipment.armor && Player.equipment.armor.id === 'armor_magma') {
            let selfBurn = Math.floor(Player.maxHp * 0.05);
            let enemyBurn = Math.floor(enemy.hp * 0.05);
            Player.hp = Math.max(1, Player.hp - selfBurn); 
            enemy.hp -= enemyBurn;
            logHtml += `<span style='color:orange'>ğŸŒ‹ éç†±åå¿œï¼šæ•µå‘³æ–¹ã‚’ç„¼ã (è‡ª-${selfBurn}, æ•µ-${enemyBurn})</span><br>`;
        }
        
        // æ”¯é…è€… (DoT)
        if (GameState.enemyDominated) {
            enemy.hp -= 20;
            logHtml += `<span style='color:purple'>ğŸ™ æ”¯é…è€…æµ¸é£Ÿï¼šæ•µ HP -20</span><br>`;
        }

        if (enemy.hp <= 0) { this.combatWin(); return; }

        // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ”»æ’ƒãƒ•ã‚§ãƒ¼ã‚º ---
        
        let skipPlayerTurn = false;
        if (Player.debuff && Player.debuff.id === 'sloth_curse' && enemy.hp === enemy.maxHp) { 
            skipPlayerTurn = true;
            logHtml += "<span style='color:grey'>ğŸ’¤ æ€ æƒ°ã®ãŸã‚è¡Œå‹•ã§ããªã„...</span><br>";
        }

        if (!skipPlayerTurn) {
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_envy') && Math.random() < 0.10) {
                 Player.hp = Player.maxHp;
                 logHtml += `<span style='color:#4caf50;'>ğŸ¦Š å«‰å¦¬ç™ºå‹•ï¼šHPå®Œå…¨å›å¾©ï¼</span><br>`;
            }
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_gluttony')) {
                const healAmt = Math.floor(Player.maxHp * 0.10);
                Player.hp = Math.min(Player.maxHp, Player.hp + healAmt);
            }
            if (Player.buff && Player.buff.id === 'demon_destruction') {
                if (Math.random() < 0.1 && !enemy.isGod && !enemy.isOldOne) { 
                    enemy.hp = 0;
                    Player.hp -= Math.floor(Player.hp * 0.9);
                    logHtml += `<span style='color:red;'>ğŸ’€ æ‚ªé­”ã®ç ´å£Šï¼å³æ­»ç™ºå‹•ï¼</span><br>`;
                    this.combatWin();
                    return;
                }
            }

            let pDmg = this.getAtk();
            let rawCrit = this.getCritRate(); 
            
            // ç¥ã®å¨åœ§
            if (enemy.isGod && !hasInspiration) {
                rawCrit = 0; 
                logHtml += "<span style='color:gray'>âš ï¸ ã€å¨åœ§ã€‘ ä¼šå¿ƒãŒå°ã˜ã‚‰ã‚ŒãŸã€‚</span><br>";
            }
            
            // é­…é­”ã®é¦™æ°´
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_lust') && GameState.combatTurn === 1) rawCrit = 100;

            let isCrit = Math.random() * 100 < rawCrit;
            
            // é‹å‘½ã®è¼ª
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_wheel')) {
                let trueRate = this.getCritRate(true);
                let multiplier = 1 + (trueRate / 20); 
                pDmg = Math.floor(pDmg * multiplier);
            } else if (isCrit) {
                pDmg *= (Player.class === 'knight') ? 3 : 2;
            }

            if (Player.equipment.accessories.some(a => a && a.id === 'acc_wrath') && Math.random() < 0.1) {
                pDmg *= 2;
                logHtml += "<span style='color:#d32f2f;'>ğŸ˜¡ æš´æ€’é€£æ’ƒï¼</span><br>";
            }

            // --- æ•µã®é˜²å¾¡ã‚¹ã‚­ãƒ« ---

            // 1. ã‚·ãƒ£ãƒ‰ã‚¦ã‚¹ãƒ©ã‚¤ãƒ  - æµä½“å›é¿
            if (enemy.name.includes("ã‚·ãƒ£ãƒ‰ã‚¦ã‚¹ãƒ©ã‚¤ãƒ ") && Math.random() < 0.15) {
                pDmg = 0;
                let counter = Math.floor(Player.maxHp * 0.05);
                Player.hp -= counter;
                logHtml += `<span style='color:gray'>ğŸŒ‘ ã€æµä½“å›é¿ã€‘ æ”»æ’ƒãŒã™ã‚ŠæŠœã‘ãŸï¼ åå‹•ã§ ${counter} ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚</span><br>`;
            }

            // 2. ãƒ´ã‚©ã‚¤ãƒ‰ã‚¢ã‚¤ - è¦–ç·šå±ˆæŠ˜
            else if (enemy.name.includes("ãƒ´ã‚©ã‚¤ãƒ‰ã‚¢ã‚¤")) {
                let reflect = Math.floor(pDmg * 0.1); 
                pDmg = Math.floor(pDmg * 0.9);        
                
                let s = Player.equipment.shield;
                if (s && s.val > 0) {
                    s.val--; 
                    logHtml += `<span style='color:#2196f3'>ğŸ›¡ï¸ ${s.name} ãŒè¦–ç·šå±ˆæŠ˜ã‚’é˜²ã„ã ï¼ (åå°„ ${reflect} ã‚’ç„¡åŠ¹åŒ–)</span><br>`;
                    reflect = 0; 
                    
                    if (s.val <= 0) {
                        Player.equipment.shield = null;
                        logHtml += `<span class='damage-text'>ğŸ’” ç›¾ãŒå¼·å…‰ã§ç •ã‘æ•£ã£ãŸï¼</span><br>`;
                        this.recalcStats();
                    }
                } else {
                    Player.hp -= reflect;
                    logHtml += `<span style='color:#00bcd4'>ğŸ‘ï¸ ã€è¦–ç·šå±ˆæŠ˜ã€‘ 10% ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒåå°„ã•ã‚ŒãŸï¼(-${reflect} HP)</span><br>`;
                }
            }

            // 3. ãƒªãƒƒãƒã‚­ãƒ³ã‚° - å‘½åŒ£ã‚·ãƒ¼ãƒ«ãƒ‰
            else if (enemy.name.includes("ãƒªãƒƒãƒã‚­ãƒ³ã‚°") && GameState.combatTurn % 3 === 0) {
                pDmg = 0;
                logHtml += `<span style='color:#9c27b0'>ğŸ’€ ã€å‘½åŒ£ã‚·ãƒ¼ãƒ«ãƒ‰ã€‘ ãƒªãƒƒãƒã‚­ãƒ³ã‚°ã¯é­‚ã®ç›¾ã«å®ˆã‚‰ã‚Œã¦ã„ã‚‹ï¼ãƒ€ãƒ¡ãƒ¼ã‚¸ç„¡åŠ¹ï¼</span><br>`;
            }

            // --- æ•µã®åæ’ƒã‚¹ã‚­ãƒ« ---
            
            // 4. ã‚¢ãƒ“ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³ - é€†é±—ã®æ€’ã‚Š
            if (enemy.name.includes("ã‚¢ãƒ“ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³") && isCrit) {
                let wrathDmg = Math.floor(enemy.atk * 1.5);
                Player.hp -= wrathDmg;
                logHtml += `<span style='color:red; font-weight:bold;'>ğŸ² ã€é€†é±—ã®æ€’ã‚Šã€‘ ä¼šå¿ƒã®ä¸€æ’ƒã«æ¿€æ€’ã—ãŸé­”ç«œãŒå³åº§ã«åæ’ƒï¼(-${wrathDmg} HP)</span><br>`;
            }

            // ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
            if (pDmg > 0) {
                // è–æ½”ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (ç¥)
                const hasPrimordial = Player.equipment.weapon && Player.equipment.weapon.id === 'w_primordial';
                if (enemy.isGod && pDmg > 111111 && !hasInspiration && !hasPrimordial) { 
                    pDmg = 111111;
                    logHtml += "<span style='color:gold'>ğŸ›¡ï¸ ã€è–æ½”ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€‘ ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯ 111111 ã«åˆ¶é™ã•ã‚ŒãŸï¼</span><br>";
                } else if (enemy.isGod && pDmg > 111111 && hasPrimordial) {
                    logHtml += "<span style='color:#00ffcc;'>âš”ï¸ ã€åŸåˆã®åŠ›ã€‘ åŸåˆã®åˆƒãŒè–æ½”ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è²«ã„ãŸï¼</span><br>";
                }

                // ãƒ©ã‚°ãƒŠãƒ­ã‚¯
                if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_ragnarok' && Math.random() < 0.05 && !enemy.isGod && !enemy.isOldOne) {
                    enemy.hp = 0;
                    logHtml += `<span style='color:red; font-weight:bold;'>â˜„ï¸ ã€ãƒ©ã‚°ãƒŠãƒ­ã‚¯ã€‘ ç™ºå‹•ï¼ å­˜åœ¨æŠ¹æ¶ˆï¼</span><br>`;
                    this.combatWin();
                    return;
                }

                enemy.hp -= pDmg;
                this.triggerAnim('event-icon', 'anim-damage');
                this.showFloatingText(pDmg, isCrit ? "red" : "white");
                logHtml += `${isCrit ? "<span class='crit-text'>ä¼šå¿ƒ " : ""}ãƒ€ãƒ¡ãƒ¼ã‚¸ ${pDmg}${isCrit ? "</span>" : ""} ã‚’ä¸ãˆãŸã€‚<br>`;
            }

            if (Player.hp <= 0) { this.checkDeath(enemy.name); return; }

            if (enemy.hp <= 0) {
                // 5. å •è½ã—ãŸé¨å£« - äº¡è€…ã®æ„å¿—
                if (enemy.name.includes("å •è½ã—ãŸé¨å£«") && !enemy.undyingTriggered) {
                    enemy.hp = 1;
                    enemy.undyingTriggered = true;
                    logHtml += `<span style='color:darkred; font-weight:bold; font-size:1.2em;'>ğŸ¤º ã€äº¡è€…ã®æ„å¿—ã€‘ é¨å£«ã¯å€’ã‚Œã‚‹ã“ã¨ã‚’æ‹’å¦ã—ãŸï¼(1ã‚¿ãƒ¼ãƒ³é£Ÿã„ã—ã°ã‚Š)</span><br>`;
                } else {
                    this.combatWin();
                    return;
                }
            }
            
            // æ­£æ°—åº¦ã‚¦ã‚£ãƒƒãƒ— (æ··ä¹±)
            if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_chaos' && Math.random() < 0.1) {
                let selfDmg = enemy.atk;
                enemy.hp -= selfDmg;
                logHtml += `<span style='color:violet'>ğŸ¦‘ æ··ä¹±ã—ãŸæ•µãŒè‡ªåˆ†ã‚’æ”»æ’ƒï¼ ${selfDmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼</span><br>`;
                if (enemy.hp <= 0) { this.combatWin(); return; }
                this.renderEvent(`âš”ï¸ æˆ¦é—˜ - ${enemy.name}`, `æ•µ HP: ${enemy.hp}`, logHtml, enemy.icon);
                this.updateUI();
                if (Player.lastInspirationTurns > 0) Player.lastInspirationTurns--;
                return; // æ•µã‚¿ãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—
            }
            
            // æ»…ä¸–ã®æ§ (æ”¯é…)
            if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_oldone' && Math.random() < 0.5) {
                GameState.enemyDominated = true;
                logHtml += "<span style='color:darkred'>ğŸ”± æ•µã‚’æ”¯é…ã—ãŸï¼</span><br>";
            }
        }

        // --- æ•µæ”»æ’ƒãƒ•ã‚§ãƒ¼ã‚º ---
        this.enemyAttackPhase(enemy, logHtml);

        if (Player.lastInspirationTurns > 0) Player.lastInspirationTurns--;

        if (Player.ghostTurns > 0) {
            Player.ghostTurns--;
            if (Player.ghostTurns <= 0) {
                Player.hp = 0; 
                this.renderEvent("ğŸ‘» éœŠä½“æ¶ˆæ»…", "åŸ·å¿µãŒå°½ããŸ...", "å¡µã¯å¡µã«ã€ç°ã¯ç°ã«ã€‚", "ğŸ’€");
                this.checkDeath("éœŠä½“æ™‚é–“åˆ‡ã‚Œ");
                return;
            }
        }
    },

    enemyAttackPhase(enemy, logHtml) {
        const ignoreGodPower = Player.lastInspirationTurns > 0;

        // ç¥ï¼šå†ç”Ÿç ´å£Š
        if (enemy.isGod && !ignoreGodPower) {
            const featherIdx = Player.inventory.material.findIndex(i => i.id === 'phoenix_feather');
            if (featherIdx !== -1 && Math.random() < 0.3) {
                Player.inventory.material.splice(featherIdx, 1);
                logHtml += "<span style='color:darkred; font-weight:bold;'>ğŸ”¥ ã€å†ç”Ÿç ´å£Šã€‘ ç¥ã®ç‚ãŒä¸æ­»é³¥ã®ç¾½æ ¹ã‚’ç„¼ãå°½ãã—ãŸï¼</span><br>";
            }
        }
        
        // ã‚·ãƒ£ãƒ‰ã‚¦ãƒ€ãƒŸãƒ¼
        const hasShadow = Player.equipment.accessories.some(a => a && a.id === 'acc_shadow');
        if (hasShadow && Math.random() < 0.1) {
            let defenseVal = Player.equipment.armor ? Player.equipment.armor.val : 0;
            let reflectDmg = Math.floor(defenseVal * 0.1);
            enemy.hp -= reflectDmg;
            logHtml += `<span style='color:#ccc'>ğŸ‘¤ ã‚·ãƒ£ãƒ‰ã‚¦ãƒ€ãƒŸãƒ¼ãŒæ”»æ’ƒã‚’ç„¡åŠ¹åŒ–ï¼ ${reflectDmg} ãƒ€ãƒ¡ãƒ¼ã‚¸åå°„ã€‚</span><br>`;
            if (enemy.hp <= 0) { this.combatWin(); return; }
        } else {
            let mDmg = enemy.atk;

            // --- æ•µæ”»æ’ƒã‚¹ã‚­ãƒ« ---

            // 1. ãƒŠã‚¤ãƒˆãƒ¡ã‚¢ãƒ›ãƒ¼ã‚¹ - ææ€–ã®çªæ’ƒ
            if (enemy.name.includes("ãƒŠã‚¤ãƒˆãƒ¡ã‚¢ãƒ›ãƒ¼ã‚¹") && GameState.combatTurn === 1) {
                mDmg *= 2;
                logHtml += `<span style='color:purple; font-weight:bold;'>ğŸ¦„ ã€ææ€–ã®çªæ’ƒã€‘ æˆ¦é¦¬ãŒç ´å£Šçš„ãªçªæ’ƒã‚’ä»•æ›ã‘ã¦ããŸï¼(ãƒ€ãƒ¡ãƒ¼ã‚¸2å€)</span><br>`;
            }

            // 2. å •è½ã—ãŸé¨å£« - èµ°é¦¬ç¯
            if (enemy.undyingTriggered) {
                mDmg = Math.floor(mDmg * 1.5);
                logHtml += `<span style='color:darkred;'>ğŸ¤º ã€èµ°é¦¬ç¯ã€‘ é¨å£«ãŒæœ€å¾Œã®é­‚ã‚’ç‡ƒã‚„ã™ï¼(æ”»æ’ƒ1.5å€)</span><br>`;
            }

            // 3. ã‚«ã‚ªã‚¹ãƒ»ãƒ†ãƒ³ã‚¿ã‚¯ãƒ« - æ€è€ƒæ±šæŸ“
            if (enemy.name.includes("ã‚«ã‚ªã‚¹ãƒ»ãƒ†ãƒ³ã‚¿ã‚¯ãƒ«") && Math.random() < 0.15) {
                Player.isConfused = true;
                logHtml += `<span style='color:violet; font-weight:bold;'>ğŸ¦‘ ã€æ€è€ƒæ±šæŸ“ã€‘ æ„è­˜ãŒæ··æ¿ã—ã¦ã„ã... (æ¬¡ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½)</span><br>`;
            }

            // 4. ãƒ–ãƒ©ãƒƒãƒ‰ä¼¯çˆµ - ç”Ÿå‘½å¸å
            if (enemy.name.includes("ãƒ–ãƒ©ãƒƒãƒ‰ä¼¯çˆµ")) {
                logHtml += `<span style='color:red;'>ğŸ§› ã€ç”Ÿå‘½å¸åã€‘ ä¼¯çˆµãŒã‚ãªãŸã®è¡€ã‚’å¸ã£ãŸ...</span><br>`;
            }

            // --- è»½æ¸› ---
            if (Player.equipment.armor && Player.equipment.armor.id === 'armor_magma') {
                mDmg = Math.floor(mDmg * 0.8);
            }
            Player.equipment.accessories.forEach(acc => {
                if (!acc) return;
                if (acc.id === 'acc_skel_1') mDmg = Math.floor(mDmg * 0.95);
                if (acc.id === 'acc_skel_2') mDmg = Math.floor(mDmg * 0.90);
                if (acc.id === 'acc_skel_3') mDmg = Math.floor(mDmg * 0.85);
            });
            if (Player.buff && Player.buff.id === 'angel_protection') mDmg = Math.floor(mDmg * 0.7);
            if (Player.sinState.greedActive) mDmg = Math.floor(mDmg * 1.2);
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_pride')) mDmg = Math.floor(mDmg * 1.5);

            // --- ç›¾ã‚¬ãƒ¼ãƒ‰ ---
            let s = Player.equipment.shield;
            let applyDamage = true;
            
            // ç¥ï¼šãƒ«ãƒ¼ãƒ«ç ´å£Š
            if (enemy.isGod && s && Math.random() < 0.2 && !ignoreGodPower) {
                Player.equipment.shield = null; 
                this.recalcStats(); 
                logHtml += `<span style='color:red; font-weight:bold;'>ğŸ”¨ ã€ãƒ«ãƒ¼ãƒ«ç ´å£Šã€‘ ç›¾ãŒä¸€æ’ƒã§ç²‰ç •ã•ã‚ŒãŸï¼(ä»Šå›ãƒ€ãƒ¡ãƒ¼ã‚¸ç„¡åŠ¹)</span><br>`;
                s = null; 
                applyDamage = false; 
            }
            // è™šç©ºã®é¡
            else if (s && s.id === 'shield_void') {
                if (s.val > 0) {
                     let consume = Math.random() < 0.3; 
                     if (consume) s.val--;
                     let reflect = Math.floor(mDmg * 0.5);
                     enemy.hp -= reflect;
                     if (!consume) {
                         logHtml += `<span class='block-text'>ğŸª è™šç©ºå±ˆæŠ˜ï¼(è€ä¹…ç¶­æŒ / åå°„ ${reflect})</span><br>`;
                     } else {
                         logHtml += `<span class='block-text'>ğŸª è™šç©ºå±ˆæŠ˜ï¼(è€ä¹…æ¶ˆè²» / åå°„ ${reflect})</span><br>`;
                         if (s.val <= 0) {
                             Player.equipment.shield = null;
                             logHtml += `<span class='damage-text'>é¡é¢ãŒç •ã‘ã€è™šç©ºã¸æ¶ˆãˆãŸ...</span><br>`;
                             this.recalcStats();
                         }
                     }
                     applyDamage = false;
                }
            }
            // é€šå¸¸ã‚¬ãƒ¼ãƒ‰
            else if (s && s.val > 0) {
                s.val--;
                logHtml += `<span class='block-text'>ğŸ›¡ï¸ ã‚¬ãƒ¼ãƒ‰!</span> (${s.val})<br>`;
                applyDamage = false;
                if (s.val <= 0) {
                    Player.equipment.shield = null;
                    logHtml += `<span class='damage-text'>ç›¾ãŒå£Šã‚ŒãŸ!</span><br>`;
                    this.recalcStats();
                }
            }

            // --- ãƒ€ãƒ¡ãƒ¼ã‚¸é©ç”¨ ---
            if (applyDamage) {
                // é€†é±—ã®ç«œè£… åæ’ƒ
                let enemyCrit = Math.random() < 0.1; 
                if (enemyCrit) {
                     mDmg = Math.floor(mDmg * 1.5);
                     logHtml += "<span class='damage-text'>æ•µã®ä¼šå¿ƒï¼</span> ";
                     if (Player.equipment.armor && Player.equipment.armor.id === 'armor_dragon' && Math.random() < 0.1 && !enemy.isGod) {
                         if (enemy.tier === 'boss' || enemy.isTrueForm) {
                             let trueDmg = Math.floor(enemy.hp * 0.1);
                             enemy.hp -= trueDmg;
                             logHtml += `<span style='color:red'>ğŸ‰ ç«œã®æ€’ã‚Šï¼åæ’ƒã§ ${trueDmg} ã®çœŸå®Ÿãƒ€ãƒ¡ãƒ¼ã‚¸ï¼</span><br>`;
                         } else {
                             enemy.hp = 0;
                             logHtml += `<span style='color:red'>ğŸ‰ ç«œã®æ€’ã‚Šï¼æ•µã‚’æ–¬æ®ºã—ãŸï¼</span><br>`;
                             this.combatWin();
                             return;
                         }
                     }
                }

                Player.hp -= mDmg;
                this.triggerAnim('game-container', 'anim-screen-shake');
                this.showFloatingText(`-${mDmg}`, "red");
                logHtml += `${enemy.name} ã®æ”»æ’ƒã§ ${mDmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚`;

                if (enemy.name.includes("ãƒ–ãƒ©ãƒƒãƒ‰ä¼¯çˆµ")) {
                    let heal = Math.floor(mDmg * 0.5);
                    enemy.hp = Math.min(enemy.maxHp, enemy.hp + heal);
                    logHtml += ` (ä¼¯çˆµã¯ ${heal} HPå›å¾©)`;
                }
            }
        }
        
        this.renderEvent(`âš”ï¸ æˆ¦é—˜ - ${enemy.name}`, 
            `æ•µ HP: ${Math.max(0, enemy.hp)}`, 
            logHtml, enemy.icon);

        if (Player.hp <= 0) {
            this.checkDeath(enemy.name);
        } else {
            this.updateUI();
        }
    },
    
    // --- è£½ä½œ (Crafting) ---
    triggerCraftingTable() {
        GameState.phase = "crafting";
        GameState.craftingCount = 0;
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ”¨ è£½ä½œå°", "æ”¾æ£„ã•ã‚ŒãŸè£½ä½œå°ã‚’è¦‹ã¤ã‘ãŸã€‚", "æ®‹ã‚Šè£½ä½œå›æ•°: 2", "âš’ï¸");
        this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
        this.renderCraftingUI();
    },

    renderCraftingUI() {
        const area = document.getElementById('crafting-area');
        area.innerHTML = "";
        area.classList.remove('hidden');

        let craftables = Object.values(CONFIG.accessories);
        if (Player.history.items.has("çœŸå®Ÿã®å¿ƒ")) {
            craftables.push(CONFIG.bible);
        }

        let html = "<h4>è£½ä½œå¯èƒ½ (ã‚¯ãƒªãƒƒã‚¯ã§åˆæˆ)</h4><div class='craft-grid'>";
        
        craftables.forEach(item => {
            const recipe = item.recipe;
            const owned = Player.inventory.material.filter(m => m.name === recipe.mat).length;
            const canCraft = owned >= recipe.count;
            const statusClass = canCraft ? 'ok' : 'no';

            html += `<div class="craft-item" onclick="Game.craftItem('${item.id}')">
                <div class="m-top">
                    <span>${item.icon} ${item.name}</span> 
                    <span style="font-size:0.8em; color:#aaa;">ãƒ¬ã‚·ãƒ”</span>
                </div>
                <div class="craft-req ${statusClass}">
                    å¿…è¦: ${recipe.mat} (${owned}/${recipe.count})
                </div>
                <div style="font-size:0.7em; color:#666; margin-top:2px;">
                    ${canCraft ? "âœ… åˆæˆå¯" : "âŒ ç´ æä¸è¶³"}
                </div>
            </div>`;
        });
        html += "</div>";
        area.innerHTML = html;
    },

    craftItem(itemId) {
        if (GameState.phase !== "crafting") return;
        if (GameState.craftingCount >= 2) {
            alert("è£½ä½œå°ã¯å£Šã‚Œã¾ã—ãŸï¼");
            this.nextEvent();
            return;
        }

        let itemTemplate = Object.values(CONFIG.accessories).find(i => i.id === itemId);
        if (itemId === 'inferno_bible') itemTemplate = CONFIG.bible;

        if (!itemTemplate) return;

        const recipe = itemTemplate.recipe;
        const owned = Player.inventory.material.filter(m => m.name === recipe.mat).length;

        if (owned < recipe.count) {
            alert("ç´ æãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
            return;
        }

        let toRemove = recipe.count;
        const newMats = [];
        for (let m of Player.inventory.material) {
            if (m.name === recipe.mat && toRemove > 0) {
                toRemove--;
            } else {
                newMats.push(m);
            }
        }
        Player.inventory.material = newMats;

        let newItem = Object.assign({}, itemTemplate);
        if(newItem.type === 'special') newItem.type = 'material'; 
        
        this.addItemToInventory(newItem);
        GameState.craftingCount++;

        this.showFloatingText("åˆæˆæˆåŠŸ!", "#4caf50");
        this.log(`åˆæˆ: ${newItem.name}`);

        if (GameState.craftingCount >= 2) {
            this.renderEvent("ğŸ”¨ è£½ä½œå°å´©å£Š", "è£½ä½œå°ã¯å´©ã‚Œå»ã£ãŸ...", "ã“ã‚Œä»¥ä¸Šä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚", "ğŸ’¥");
            document.getElementById('crafting-area').classList.add('hidden');
            this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
        } else {
            this.renderCraftingUI();
        }
        this.updateUI();
    },

    openPortableCrafting(mode = 'normal') {
        const modal = document.getElementById('portable-crafting-modal');
        modal.dataset.mode = mode;
        
        const titleEl = modal.querySelector('h3');
        if (mode === 'inferno') {
            titleEl.innerText = "ğŸ”¥ ç…‰ç„ã®ç‚‰ (æºå¸¯ç‰ˆ)";
            titleEl.style.color = "#ff3300";
        } else {
            titleEl.innerText = "ğŸ§° æºå¸¯ç”¨ä½œæ¥­å°";
            titleEl.style.color = "#e0e0e0";
        }

        modal.style.display = 'flex';
        this.renderPortableCrafting();
    },

    renderPortableCrafting() {
        const modal = document.getElementById('portable-crafting-modal');
        const mode = modal.dataset.mode || 'normal';
        const area = document.getElementById('portable-craft-content');
        area.innerHTML = "";

        let craftables = [];

        if (mode === 'inferno') {
            craftables = [...CONFIG.forgeItems];
        } else {
            craftables = Object.values(CONFIG.accessories);
            if (Player.history.items.has("çœŸå®Ÿã®å¿ƒ")) {
                craftables.push(CONFIG.bible);
            }
        }

        let html = "<div class='craft-grid'>";
        
        craftables.forEach(item => {
            const recipe = item.recipe;
            if (!recipe) return; 

            const owned = Player.inventory.material.filter(m => m.name === recipe.mat).length;
            const canCraft = owned >= recipe.count;
            const statusClass = canCraft ? 'ok' : 'no';
            const nameColor = (mode === 'inferno') ? '#ff5555' : '#fff';
            
            html += `<div class="craft-item" onclick="Game.craftPortableItem('${item.id}')">
                <div class="m-top">
                    <span style="color:${nameColor}">${item.icon} ${item.name}</span>
                </div>
                <div class="craft-req ${statusClass}">å¿…è¦: ${recipe.mat} (${owned}/${recipe.count})</div>
                <div style="font-size:0.7em; color:${canCraft ? '#4caf50' : '#666'}; margin-top:2px;">
                    ${canCraft ? "âœ… è£½ä½œã™ã‚‹" : "âŒ ç´ æä¸è¶³"}
                </div>
            </div>`;
        });
        html += "</div>";
        area.innerHTML = html;
    },

    craftPortableItem(itemId) {
        let itemTemplate = Object.values(CONFIG.accessories).find(i => i.id === itemId);
        if (itemId === 'inferno_bible') itemTemplate = CONFIG.bible;
        if (!itemTemplate) itemTemplate = CONFIG.forgeItems.find(i => i.id === itemId);
        
        if (!itemTemplate) return;

        const recipe = itemTemplate.recipe;
        const owned = Player.inventory.material.filter(m => m.name === recipe.mat).length;

        if (owned < recipe.count) {
            alert("ç´ æãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
            return;
        }

        let toRemove = recipe.count;
        const newMats = [];
        for (let m of Player.inventory.material) {
            if (m.name === recipe.mat && toRemove > 0) {
                toRemove--;
            } else {
                newMats.push(m);
            }
        }
        Player.inventory.material = newMats;

        let newItem = Object.assign({}, itemTemplate);
        if(newItem.type === 'special') newItem.type = 'material'; 
        
        this.addItemToInventory(newItem);

        this.showFloatingText("è£½ä½œæˆåŠŸ!", "#ff3300");
        this.updateUI(); 
        this.renderPortableCrafting(); 
    },

    // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼ (Helpers) ---
    checkAchievements() {
        let newUnlock = false;
        CONFIG.achievements.forEach(ach => {
            if (!Player.achievements.has(ach.id)) {
                if (ach.check(Player)) {
                    Player.achievements.add(ach.id);
                    this.showFloatingText(`ğŸ† ${ach.name}`, 'gold');
                    newUnlock = true;
                }
            }
        });
        if (newUnlock) this.checkAchievements();
    },

    checkDrops(type) {
        let needed = [];
        CONFIG.monsters.forEach(m => {
            needed.push(m.drop);
            needed.push(m.eliteDrop);
            if (type === 'prospector') needed.push(m.bossDrop);
        });
        return needed.every(item => Player.history.items.has(item));
    },

    checkAllItems() {
        const all = this.getAllItems('items').concat(this.getAllItems('accessories')).concat(this.getAllItems('inferno'));
        return all.filter(i => i.type !== 'special' && i.type !== 'revive').every(i => Player.history.items.has(i.name)); 
    },
    
    getCollectedItemsCount() {
        return Player.history.items.size; 
    },

    checkTierComplete(tiers) {
        const targets = CONFIG.achievements.filter(a => tiers.includes(a.rarity) && !a.hidden);
        return targets.every(a => Player.achievements.has(a.id));
    },

    checkAllAchievements() {
        const others = CONFIG.achievements.filter(a => a.id !== 'true_rest');
        return others.every(a => Player.achievements.has(a.id));
    },

    showAchievements() {
        const modal = document.getElementById('achieve-modal');
        const list = document.getElementById('achieve-list-content');
        const stats = document.getElementById('achieve-stats');
        list.innerHTML = "";
        modal.style.display = 'flex';

        const hasBible = Player.history.items.has("ç…‰ç„ã®è–æ›¸");

        let visibleTotal = CONFIG.achievements.filter(a => {
            if (Player.achievements.has(a.id)) return true;
            if (a.category === 'inferno' && hasBible) return true;
            if (!a.hidden) return true;
            return false;
        }).length;

        let unlockedCount = Player.achievements.size;
        
        stats.innerText = `é€²æ—: ${unlockedCount} / ${visibleTotal}`;

        CONFIG.achievements.forEach(ach => {
            const unlocked = Player.achievements.has(ach.id);
            
            let isHidden = ach.hidden && !unlocked;
            if (hasBible && ach.category === 'inferno') {
                isHidden = false;
            }

            if (isHidden) return;

            const div = document.createElement('div');
            div.className = `achieve-item ${unlocked ? 'unlocked' : ''}`;
            let colorClass = CONFIG.rarityDisplay[ach.rarity].color;
            div.innerHTML = `
                <div class="achieve-info">
                    <div class="achieve-name" style="${unlocked ? 'color:white' : ''}">${ach.name}</div>
                    <div class="achieve-cond">${ach.cond}</div>
                </div>
                <div class="achieve-badge ${colorClass}">${CONFIG.rarityDisplay[ach.rarity].label}</div>
            `;
            list.appendChild(div);
        });
    },

    selectClass(classType) {
        Player.class = classType;
        document.getElementById('class-modal').style.display = 'none';
        
        if (classType === 'knight') {
            const lance = { name: "é¨å£«ã®é•·æ§", type: "weapon", val: 12, rarity: "uncommon", price: 80, icon: "ğŸ”±" };
            this.addItemToInventory(lance, false);
            this.equip(0, 'equipment'); 
        } 
        else if (classType === 'challenger') {
            const potion = { name: "å¼·åŠ›ãªãƒãƒ¼ã‚·ãƒ§ãƒ³", type: "consumable", val: 80, rarity: "uncommon", price: 60, icon: "ğŸ·", desc: "HPã‚’80å›å¾©" };
            this.addItemToInventory(potion, false);
        }
        else if (classType === 'cultist') {
            const demonBuffs = Object.values(CONFIG.buffs).filter(b => b.type === 'demon');
            Player.buff = demonBuffs[Math.floor(Math.random() * demonBuffs.length)];
            this.updateUI();
        } 
        else if (classType === 'dragonslayer') {
            const swordBase = CONFIG.itemPool.find(i => i.name === "å± é¾å‰£");
            if (swordBase) {
                const dao = { ...swordBase, name: "å± é¾åˆ€", icon: "ğŸ”ª" };
                this.addItemToInventory(dao, false);
                this.equip(0, 'equipment');
            }
            
            const armorBase = CONFIG.itemPool.find(i => i.name === "ç«œé±—ã®é§");
            if (armorBase) {
                this.addItemToInventory({ ...armorBase }, false);
                this.equip(0, 'equipment'); 
            }
            this.updateUI();
        }
        else {
            this.updateUI();
        }

        const badgeMap = { 
            'knight': 'ğŸ›¡ï¸ é¨å£«', 'merchant': 'ğŸ’° å•†äºº', 'thief': 'ğŸ—¡ï¸ ç›—è³Š', 
            'cultist': 'ğŸ˜ˆ æ‚ªé­”ä¿¡å¾’', 'scarecrow': 'ğŸŒ¾ ã‚«ã‚«ã‚·', 'ape': 'ğŸ¦ é¡äººçŒ¿',
            'challenger': 'ğŸ§— æŒ‘æˆ¦è€…',
            'dragonslayer': 'ğŸ‰ ãƒ‰ãƒ©ã‚´ãƒ³ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼'
        };
        document.getElementById('class-badge').innerText = badgeMap[classType];
        
        GameState.phase = "event_end"; 

        this.renderEvent("æº–å‚™å®Œäº†", "å†’é™ºãŒå§‹ã¾ã‚Šã¾ã™...", "å¹¸é‹ã‚’ç¥ˆã‚‹ï¼", "âœ¨");
        this.setButtons("å†’é™ºé–‹å§‹", "nextEvent", "ãªã—", null, true);
    },

    triggerAnim(id, animClass) {
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove(animClass);
            void el.offsetWidth;
            el.classList.add(animClass);
        }
    },

    showFloatingText(text, color) {
        const display = document.getElementById('event-display');
        const div = document.createElement('div');
        div.className = 'floating-text';
        div.innerHTML = text;
        div.style.color = color;
        display.appendChild(div);
        setTimeout(() => div.remove(), 1000);
    },

    combatWin() {
        const enemy = GameState.currentEnemy;
        Player.isConfused = false;
        let isGodKill = enemy.isGod;
        let isOldOneKill = enemy.isOldOne; 

        if (enemy.isGardenBoss) {
            const sword = CONFIG.infernoItems.find(i => i.id === 'w_primordial');
            this.addItemToInventory({...sword});
            
            GameState.phase = "event_end";
            this.renderEvent("ğŸ‘» é­‚ã®è§£æ”¾", 
                "é­‚ã¯å®‰ã‚‰ã‹ãªç¬‘ã¿ã‚’æµ®ã‹ã¹ã€å…‰ã¨ãªã£ã¦æ¶ˆãˆãŸã€‚", 
                "è™šç©ºã«æœ€å¾Œã®å£°ãŒéŸ¿ãï¼š<br><span style='font-size:1.5em; color:#00ffcc; font-weight:bold;'>ã€Œã‚ã¨ã¯......é ¼ã‚“ã ãã€‚ã€</span><br><br>ç²å¾— <span class='rarity-ultra'>åŸåˆã®å‰£</span>", 
                "âœ¨");
            
            this.showFloatingText("ç²å¾— åŸåˆã®å‰£", "#00ffcc");
            this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
            return; 
        }

        if (Player.debuff && Player.debuff.id === 'sloth_curse') {
            if (isNaN(Player.sinState.slothCount)) Player.sinState.slothCount = 10;
            
            Player.sinState.slothCount--;
            if (Player.sinState.slothCount <= 0) {
                Player.debuff = null;
                const ring = CONFIG.sinItems.find(i => i.id === 'acc_sloth');
                this.addItemToInventory({...ring});
                alert("ğŸ’¤ æ€ æƒ°ã®è©¦ç·´çµ‚äº†ã€‚ã€çœ ã‚Šã®æŒ‡è¼ªã€‘ã‚’ç²å¾—ï¼");
                this.checkAchievements(); 
            }
        }

        if (Player.ghostTurns > 0) {
            Player.ghostTurns = 0;
            Player.hp = Math.floor(Player.maxHp * 0.2); 
            this.showFloatingText("é­‚ã®å¥ªå–ï¼", "#00ffcc");
        }

        if (Player.equipment.accessories.some(a => a && a.id === 'acc_phylactery')) {
            if (Player.souls < 200) {
                Player.souls++;
                this.showFloatingText("é­‚ +1", "#00ffcc");
            }
        }
        if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_minotaur') {
            if (Math.random() < 0.01) { 
                Player.permanentCritBonus = (Player.permanentCritBonus || 0) + 0.03;
                this.showFloatingText("ä¼šå¿ƒæ½œåœ¨èƒ½åŠ›ä¸Šæ˜‡!", "#ff00ff");
                alert("ğŸª“ ã€ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã®æˆ¦æ–§ã€‘é£²è¡€é€²åŒ–ï¼\n\nåŸºç¤ä¼šå¿ƒç‡ãŒæ°¸ä¹…ã« 3% ä¸Šæ˜‡ï¼");
            }
        }

        if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_void_breaker') {
            if (Math.random() < 0.10) { 
                Player.baseAtk += 100;
                this.showFloatingText("è™šç©ºè²ªé£Ÿ! æ”»+100", "#9c27b0");
            }
        }

        if (enemy.isSin && enemy.sinType === 'wrath') {
            if (Player.sinState.wrathRevive < 2 && Math.random() < 0.8) {
                Player.sinState.wrathRevive++;
                
                enemy.hp = Math.floor(enemy.maxHp * 2.0);
                enemy.maxHp = enemy.hp; 
                enemy.atk = Math.floor(enemy.atk * 2.0);
                
                this.renderEvent("ğŸ˜¡ ä¸æ­»ã®æ€’ã‚Š", "ãƒãƒ¼ã‚µãƒ¼ã‚«ãƒ¼ã¯å€’ã‚Œãªã„ï¼", "ã€Œã‚°ã‚ªã‚ªã‚ªã‚ªï¼ï¼ï¼ã€(ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€åŒ–)", "ğŸ”¥");
                this.showFloatingText("å¾©æ´»ï¼", "red");
                
                setTimeout(() => { this.updateUI(); }, 1000);
                return; 
            } 
            else {
                const knuckles = CONFIG.sinItems.find(i => i.id === 'acc_wrath');
                this.addItemToInventory({...knuckles});
                this.checkAchievements(); 
            }
        }
        
        if (enemy.isSin && enemy.sinType === 'pride') {
            const eye = CONFIG.sinItems.find(i => i.id === 'acc_pride');
            this.addItemToInventory({...eye});
            this.checkAchievements(); 
        }
        if (enemy.isSin && enemy.sinType === 'greed') {
             const icon = CONFIG.sinItems.find(i => i.id === 'acc_greed');
             this.addItemToInventory({...icon});
             this.checkAchievements(); 
        }
        if (enemy.isSin && enemy.sinType === 'envy') this.checkAchievements(); 
        if (enemy.isSin && enemy.sinType === 'gluttony') this.checkAchievements(); 
        if (enemy.isSin && enemy.sinType === 'lust') this.checkAchievements(); 

        GameState.phase = "event_end";
        
        if(Player.depth === 1000 && enemy.tier === 'boss' && !Player.inInferno) {
            Player.kill1000Boss = true;
        }

        let drops = [];
        let dropText = "";

        let gold = enemy.baseGold || 100;
        if (enemy.tier === "elite") gold *= 2;
        if (enemy.tier === "boss") gold *= 5;
        
        let goldMul = 1;
        Player.equipment.accessories.forEach(acc => {
            if(!acc) return;
            if(acc.id === 'acc_gob_1') goldMul += 0.05;
            if(acc.id === 'acc_gob_2') goldMul += 0.10;
            if(acc.id === 'acc_gob_3') goldMul += 0.20;
        });
        
        if (Player.equipment.accessories.some(a => a && a.id === 'acc_greed')) goldMul += 1.0;

        gold = Math.floor(gold * goldMul);
        Player.gold += gold;
        this.showFloatingText(`+${gold} G`, "#ffd700");
        dropText += `é‡‘è²¨ +${gold} <br>`;

        if (isGodKill) {
            const hourglass = {...CONFIG.specialItems.hourglass};
            this.addItemToInventory(hourglass);
            
            if (Player.lilithBlessing && !Player.lilithSacrificed) {
                 Player.lilithBlessing = false;
                 dropText += "<span style='color:#ff00ff;'>ğŸ’— ãƒªãƒªã‚¹ã®æ„›ï¼šå½¼å¥³ã¯ã‚ãªãŸã®å‚ã«æ®‹ã£ãŸã€‚</span><br>";
            } else if (Player.lilithSacrificed) {
                dropText += "<span style='color:#ff0000;'>ğŸ’” ã‚µã‚­ãƒ¥ãƒã‚¹ã®å‹åˆ©ï¼šå½¼å¥³ã¯å…‰ã¨ãªã£ã¦æ¶ˆãˆãŸ...</span><br>";
            }

            GameState.phase = "event_end";
            this.renderEvent("ğŸ† ç¥æ®ºã—", 
                "ç¥ã®ä»£è¡Œè€…ã‚’å€’ã—ã€ä¸–ç•Œã®ç†ã‚’æ‰“ã¡ç •ã„ãŸã€‚", 
                "ç²å¾— <span class='rarity-ultra'>è¼ªå»»ã®ç ‚æ™‚è¨ˆ</span>ã€‚<br>ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹ã‹ã€ç ‚æ™‚è¨ˆã§è¼ªå»»ã™ã‚‹ã‹é¸ã¹ã¾ã™ã€‚", 
                "â³");
            
            this.showFloatingText("ç²å¾— è¼ªå»»ã®ç ‚æ™‚è¨ˆ", "#00ffcc");
            this.checkAchievements(); 
            this.setButtons("ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹å†’é™ºã‚’ç¶™ç¶š", "nextEvent", "ãªã—", null, true);
            return; 
        }
        
        if (isOldOneKill) this.checkAchievements(); 

        if (Math.random() < 0.001) {
             const choco = {...CONFIG.specialItems.chocolate};
             this.addItemToInventory(choco);
             dropText += `ç²å¾— <span class='rarity-epic'>${choco.name}</span><br>`;
        }

        if (enemy.isTrueForm) {
            if (CONFIG.lootData["çœŸå®Ÿã®å¿ƒ"]) {
                drops.push({ ...CONFIG.lootData["çœŸå®Ÿã®å¿ƒ"], name: "çœŸå®Ÿã®å¿ƒ", type: "loot" });
            }
        } 
        else if (Player.inInferno) {
             let dropRate = 0.5;
             const dName = enemy.drop;
             
             if (dName === "æš—å½±ã®ã‚²ãƒ«" || dName === "è™šç©ºã®å¡µ") dropRate = 0.50;
             else if (dName === "æº¶å²©ã®æ ¸" || dName === "æ‚ªå¤¢ã®è§’") dropRate = 0.40;
             else if (dName === "æœ½ã¡ãŸé§" || dName === "æ··æ²Œã®ç¥çµŒ") dropRate = 0.30;
             else if (dName === "é®®è¡€ã®ã‚¨ãƒƒã‚»ãƒ³ã‚¹" || dName === "å‘½åŒ£ã®æ¬ ç‰‡") dropRate = 0.20;
             else if (dName === "é­”ç«œã®é€†é±—") dropRate = 0.10;
             else if (dName === "åçŠ¶ã—ãŒãŸãã‚‚ã®") dropRate = 1.0;

             if (Math.random() < dropRate && CONFIG.lootData[dName]) { 
                drops.push({ ...CONFIG.lootData[dName], name: dName, type: "loot" });
             }
        } else {
            let dName = "";
            if (enemy.tier === 'boss') dName = enemy.bossDrop;
            else if (enemy.tier === 'elite') dName = enemy.eliteDrop;
            else dName = enemy.drop;

            if (dName && CONFIG.lootData[dName]) {
                drops.push({ ...CONFIG.lootData[dName], name: dName, type: "loot" });
            }
        }

        if (Math.random() < 0.1) {
            drops.push(this.generateRandomItem(enemy.tier));
        }

        drops.forEach(item => {
            this.addItemToInventory(item);
            let colorClass = item.rarity ? CONFIG.rarityDisplay[item.rarity].color : "";
            if(item.rarity === 'mythic') colorClass = 'rarity-mythic';
            dropText += `ç²å¾— <span class='${colorClass}'>${item.name}</span><br>`;
        });

        let winTitle = "ğŸ† æˆ¦é—˜å‹åˆ©";
        if(enemy.isTrueForm) winTitle = "ğŸ‘‘ ç¥æ®ºã—";
        if(Player.inInferno) winTitle = "ğŸ”¥ ç…‰ç„å‹åˆ©";

        this.renderEvent(winTitle, "æ•µã‚’æ’ƒç ´ã—ãŸï¼", dropText || "ãƒ‰ãƒ­ãƒƒãƒ—ãªã—ã€‚", "ğŸ‰");
        document.getElementById('event-icon').className = "monster-icon"; 
        this.checkAchievements();
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },

   flee() {
        if (Player.ghostTurns > 0) {
            this.showFloatingText("éœŠä½“ã¯é€ƒã’ã‚‰ã‚Œãªã„...", "gray");
            this.setButtons("æ€¨å¿µæ”»æ’ƒ (2å€ãƒ€ãƒ¡)", "combatRound", "é€ƒèµ°ä¸å¯", null, true);
            return;
        }

        let fleeRate = 0.5;

        if (GameState.currentEnemy && GameState.currentEnemy.isGardenBoss) {
            fleeRate = 1.0; 
            this.showFloatingText("é™ã‹ã«ç«‹ã¡å»ã£ãŸ...", "#fff");
        }

        if (Player.buff) {
            if (Player.buff.id === 'angel_wings') fleeRate = 0.6;
            if (Player.buff.id === 'demon_wager') {
                fleeRate = 0.8;
                if (Math.random() < 0.01) {
                    Player.hp = 0;
                    this.playerDie("æ‚ªé­”ã®è³­ã‘ã«è² ã‘ãŸ");
                    return;
                }
            }
        }
        
        if (Player.debuff && Player.debuff.id === 'sloth_curse') {
             fleeRate = 0.8; 
        }

        if (Math.random() < fleeRate) {
            if (Player.debuff && Player.debuff.id === 'sloth_curse') {
                if (isNaN(Player.sinState.slothCount)) Player.sinState.slothCount = 10;
                
                Player.sinState.slothCount--;
                
                if (Player.sinState.slothCount <= 0) {
                    Player.debuff = null;
                    const ring = CONFIG.sinItems.find(i => i.id === 'acc_sloth');
                    this.addItemToInventory({...ring});
                    alert("ğŸ’¤ æ€ æƒ°ã®è©¦ç·´çµ‚äº†ã€‚ã€çœ ã‚Šã®æŒ‡è¼ªã€‘ã‚’ç²å¾—ï¼");
                    this.checkAchievements(); 
                    
                    const btnMain = document.getElementById('btn-main');
                    if (btnMain) {
                        btnMain.disabled = false;
                        btnMain.innerText = "æˆ¦é—˜";
                        btnMain.style.opacity = "1";
                        btnMain.style.cursor = "pointer";
                    }
                } else {
                    this.showFloatingText(`æ€ æƒ°ã®å‘ªã„: æ®‹ã‚Š ${Player.sinState.slothCount} æˆ¦`, "gray");
                }
            }

            GameState.phase = "event_end";
            this.renderEvent("ğŸ’¨ é€ƒèµ°æˆåŠŸ", "ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æŒ¯ã‚Šåˆ‡ã£ãŸã€‚", "", "ğŸƒ");
            document.getElementById('event-icon').className = "monster-icon";
            
            const btnMain = document.getElementById('btn-main');
            if (btnMain) { 
                btnMain.disabled = false;
                btnMain.style.opacity = "1";
                btnMain.style.cursor = "pointer";
            }
            
            this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
        } else {
            const enemy = GameState.currentEnemy;
            let mDmg = enemy.atk;
            let msg = "";
            let s = Player.equipment.shield;
            
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_sloth')) {
                mDmg = Math.floor(mDmg * 0.5);
                this.showFloatingText("çœ ã‚Šã®æŒ‡è¼ªã§è»½æ¸›", "#aaa");
            }
            
            this.triggerAnim('event-icon', 'anim-lunge');

            if (s && s.val > 0) {
                s.val--;
                this.showFloatingText("ã‚¬ãƒ¼ãƒ‰!", "#2196f3");
                msg = `é€ƒèµ°å¤±æ•—ï¼ã ãŒ<span class='block-text'>ç›¾ãŒè¿½æ’ƒã‚’é˜²ã„ã </span>ï¼`;
                if (s.val <= 0) {
                    msg += `<br><span class='damage-text'>ğŸ’” ${s.name} ãŒå£Šã‚ŒãŸï¼</span>`;
                    Player.equipment.shield = null;
                    this.recalcStats();
                }
            } else {
                Player.hp -= mDmg;
                this.triggerAnim('game-container', 'anim-screen-shake');
                this.showFloatingText(`-${mDmg}`, "red");
                msg = `é€ƒèµ°å¤±æ•—ï¼ ${mDmg} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚`;
            }
            
            if (Player.hp <= 0) {
                this.checkDeath("èƒŒå¾Œã‹ã‚‰è¥²ã‚ã‚ŒãŸ");
            } else {
                this.renderEvent(`âš”ï¸ ${enemy.name}`, `æ•µ HP: ${enemy.hp}`, msg, enemy.icon);
                this.updateUI();
            }
        }
    },

    // --- æ¨™æº–ã‚¤ãƒ™ãƒ³ãƒˆ ---
    triggerClassEvent() {
        if(Player.inInferno) { this.triggerInfernoCombat(); return; }
        GameState.phase = "event_end";
        if (Player.class === 'knight') this.handleKnightEvent();
        else if (Player.class === 'merchant') this.handleMerchantEvent();
        else if (Player.class === 'thief') this.handleThiefEvent();
        else if (Player.class === 'cultist') this.handleCultistEvent();
        else this.nextEvent();
    },
    handleKnightEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("âš”ï¸ é¨å£«ã®è²¬å‹™", "é­”ç‰©ã«å›²ã¾ã‚ŒãŸå†’é™ºè€…ã‚’ç™ºè¦‹...", "åŠ©å¤ªåˆ€ã™ã‚‹ã‹ï¼Ÿ", "ğŸ›¡ï¸");
        this.setButtons("åŠ©ã‘ã‚‹ (å‹ç‡60%)", "resolveKnightHelp", "ç„¡è¦–", "nextEvent", false);
    },
    resolveKnightHelp() {
        if (Math.random() < 0.6) {
            Player.gold += 100;
            this.showFloatingText("+100 G", "gold");
            this.renderEvent("âš”ï¸ æ•‘åŠ©æˆåŠŸ", "é­”ç‰©ã‚’æ’ƒé€€ã—ãŸï¼", "å ±é…¬ <span class='gold-text'>100 G</span> ã‚’ç²å¾—", "ğŸ‰");
        } else {
            let dmg = Math.floor(Player.hp * 0.5);
            Player.hp -= dmg;
            this.showFloatingText(`-${dmg} HP`, "red");
            this.renderEvent("âš”ï¸ æ•‘åŠ©å¤±æ•—", "é­”ç‰©ãŒå¼·ã™ããŸã€‚æ·±æ‰‹ã‚’è² ã£ãŸ...", `æå¤± <span class='damage-text'>${dmg} HP</span>`, "ğŸ©¸");
            if (Player.hp <= 0) { this.playerDie("æ•‘åŠ©æ´»å‹•ä¸­ã«æ­»äº¡"); return; }
        }
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },
    handleMerchantEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("âš–ï¸ é—‡å–å¼•", "æ€ªã—ã„é—‡å•†äººã«å‡ºä¼šã£ãŸã€‚", "66 G ã§è¬ã®å“ã‚’è²·ã†ã‹ï¼Ÿ(10%ã§è©æ¬º)", "ğŸ•µï¸");
        this.setButtons("å–å¼• (66 G)", "resolveMerchantTrade", "ç«‹ã¡å»ã‚‹", "nextEvent", false);
    },
    resolveMerchantTrade() {
        if (Player.gold < 66) { alert("é‡‘è²¨ä¸è¶³ï¼"); return; }
        Player.gold -= 66;
        this.showFloatingText("-66 G", "gold");
        if (Math.random() < 0.1) {
            this.renderEvent("ğŸ’¸ é¨™ã•ã‚ŒãŸï¼", "å•†äººã¯é‡‘ã‚’æŒã£ã¦é€ƒã’ãŸï¼", "ä½•ã‚‚å¾—ã‚‰ã‚Œãªã‹ã£ãŸã€‚", "ğŸ’¨");
        } else {
            let item;
            if (Math.random() < 0.01) {
                const legends = CONFIG.itemPool.filter(i => i.rarity === 'legendary' || i.rarity === 'epic');
                item = Object.assign({}, legends[Math.floor(Math.random() * legends.length)]);
            } else {
                item = this.generateSpecificItem(['weapon', 'armor', 'shield', 'consumable']);
            }
            this.addItemToInventory(item);
            this.renderEvent("âš–ï¸ å–å¼•æˆåŠŸ", "è¬ã®å°åŒ…ã‚’å—ã‘å–ã£ãŸ...", `ç²å¾— <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`, "ğŸ");
        }
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },
    handleThiefEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ—ï¸ é‡‘ã®å®ç®±", "é ãã«è¼ãå®ç®±ã‚’ç™ºè¦‹...", "é–‹ã‘ã¦ã¿ã‚‹ã‹ï¼Ÿ(5%ã§ç¥å™¨)", "âœ¨");
        this.setButtons("é–‹ã‘ã‚‹", "resolveThiefChest", "ç«‹ã¡å»ã‚‹", "nextEvent", false);
    },
    resolveThiefChest() {
        if (Math.random() < 0.05) {
            const artifacts = CONFIG.itemPool.filter(i => i.rarity === 'legendary' && ['è–å‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼', 'ç¥ã®è¼ã', 'ã‚¤ãƒ¼ã‚¸ã‚¹ã®ç›¾'].includes(i.name));
            if (artifacts.length > 0) {
                const template = artifacts[Math.floor(Math.random() * artifacts.length)];
                const item = Object.assign({}, template);
                this.addItemToInventory(item);
                this.renderEvent("âœ¨ ä¼èª¬é¡•ç¾", "ä¸­ã«ã¯ä¼èª¬ã®ç¥å™¨ãŒï¼", `ç²å¾— <span class='rarity-legendary'>${item.name}</span>`, "ğŸ‘‘");
            } else {
                const item = this.generateRandomItem();
                this.addItemToInventory(item);
                this.renderEvent("ğŸ“¦ ã‚¢ã‚¤ãƒ†ãƒ ç²å¾—", "", `ç²å¾— ${item.name}`, "ğŸ“¦");
            }
        } else {
            let dmg = Math.floor(Player.hp * 0.5);
            Player.hp -= dmg;
            this.showFloatingText(`-${dmg} HP`, "red");
            this.renderEvent("ğŸ’¥ ç½ ç™ºå‹•", "å¼·åŠ›ãªé­”æ³•ãŒç‚¸è£‚ã—ãŸï¼", `æå¤± <span class='damage-text'>${dmg} HP</span>`, "ğŸ’£");
            if (Player.hp <= 0) { this.checkDeath("é‡‘ã®å®ç®±ã®ç½ "); return; }
        }
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },
    handleCultistEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ² æ‚ªé­”ã®éŠæˆ¯", "æ‚ªé­”ãŒè³­ã‘ã‚’æŒã¡ã‹ã‘ã¦ããŸ...", "å‹ã¦ã°ãƒ¬ã‚¢è£…å‚™ã€è² ã‘ã‚Œã°HPãŒ1%ã«ãªã‚‹ã€‚", "ğŸ˜ˆ");
        this.setButtons("å—ã‘ã¦ç«‹ã¤", "resolveCultistGame", "æ‹’å¦", "nextEvent", false);
    },
    resolveCultistGame() {
        const pRoll = Math.floor(Math.random() * 6) + 1;
        const dRoll = Math.floor(Math.random() * 6) + 1;
        let resultHtml = `ã‚ãªãŸã¯ ${pRoll}ã€æ‚ªé­”ã¯ ${dRoll} ã‚’å‡ºã—ãŸã€‚<br>`;
        if (pRoll > dRoll) {
            let rarity = 'rare';
            let r = Math.random();
            if (r < 0.1) rarity = 'legendary';
            else if (r < 0.3) rarity = 'epic';
            let pool = CONFIG.itemPool.filter(i => i.rarity === rarity && ['weapon', 'armor', 'shield'].includes(i.type));
            if (pool.length === 0) pool = CONFIG.itemPool.filter(i => i.rarity === 'rare');
            const template = pool[Math.floor(Math.random() * pool.length)];
            const item = Object.assign({}, template);
            this.addItemToInventory(item);
            this.renderEvent("ğŸ² å‹åˆ©ï¼", resultHtml, `æ‚ªé­”ã¯ä¸æº€ã’ã« <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span> ã‚’æ¸¡ã—ãŸã€‚`, "ğŸ‰");
        } else {
            Player.hp = Math.floor(Player.maxHp * 0.01) || 1;
            this.showFloatingText("HP -> 1%", "darkred");
            this.renderEvent("ğŸ² æ•—åŒ—...", resultHtml, "æ‚ªé­”ã«ç”Ÿå‘½åŠ›ã‚’å¥ªã‚ã‚ŒãŸ...", "ğŸ’€");
        }
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },
    triggerHeal() {
        const oldHp = Player.hp;
        Player.hp = Player.maxHp; 
        const healed = Player.hp - oldHp;
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ’– ä¼‘æ¯ã®æ™‚", "å®‰å…¨ãªå ´æ‰€ã‚’è¦‹ã¤ã‘ãŸã€‚", `ä½“åŠ›ãŒ <span class='heal-text'>å…¨å›å¾©</span> ã—ãŸ (å›å¾©é‡ ${healed})ã€‚`, "ğŸ›Œ");
        if(healed > 0) this.showFloatingText(`+${healed} HP`, "#69f0ae");
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
    },
    triggerStatue() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ—¿ ç¥ˆã‚Šã®è–åƒ", "å¤ã³ãŸè–åƒãŒã‚ã‚‹...", "ç¥ˆã‚Šã‚’æ§ã’ã¾ã™ã‹ï¼Ÿ", "ğŸ™");
        this.setButtons("ç¥ˆã‚‹", "pray", "ç«‹ã¡å»ã‚‹", "nextEvent", false);
    },
    pray() {
        if (!CONFIG.buffs) return; 
        const isAngel = Math.random() < 0.5;
        const type = isAngel ? 'angel' : 'demon';
        const icon = isAngel ? "ğŸ‘¼" : "ğŸ˜ˆ";
        const options = Object.values(CONFIG.buffs).filter(b => b.type === type);
        if (options.length === 0) return;
        const selected = options[Math.floor(Math.random() * options.length)];
        Player.buff = selected;
        let title = isAngel ? "å¤©ä½¿ã®è–åƒ" : "æ‚ªé­”ã®è–åƒ";
        let style = isAngel ? "angel-text" : "demon-text";
        this.triggerAnim('event-icon', 'anim-spawn');
        let desc = `<span class='${style}'>${selected.name}</span> ã®åŠ¹æœã‚’å¾—ãŸã€‚<br><small>${selected.desc}</small>`;
        this.renderEvent(title, "ç¥ˆã‚ŠãŒå±Šã„ãŸã‚ˆã†ã ...", desc, icon);
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
        this.updateUI();
    },
    triggerMerchant() {
        GameState.phase = "merchant";
        GameState.merchantRefreshed = false;
        this.generateMerchantStock();
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ’° è¬ã®å•†äºº", "ã€Œç´ æã¯é«˜ãå£²ã‚Œã‚‹ã‚ˆã€‚ä½•ã‹å£²ã‚‰ãªã„ã‹ï¼Ÿã€", "å•†å“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’ç¢ºèªãƒ»è³¼å…¥", "ğŸ‘³");
        this.setButtons("ç«‹ã¡å»ã‚‹", "nextEvent", "ãªã—", null, true);
        this.renderMerchantShop();
    },
    generateMerchantStock() {
        GameState.merchantStock = [];
        let stockCount = (Player.class === 'merchant') ? 6 : 4;
        for(let i=0; i<stockCount; i++) {
            GameState.merchantStock.push(this.generateRandomItem());
        }
    },
    getItemDesc(item) {
        if (item.id === 'acc_phylactery') {
            return `${item.desc} (ç¾åœ¨é­‚: ${Player.souls})`;
        }

        if (item.desc) return item.desc;
        if (item.type === 'weapon') return `æ”»æ’ƒåŠ› +${item.val}`;
        if (item.type === 'armor') return `æœ€å¤§HP +${item.val}`;
        if (item.type === 'shield') return `æ”»æ’ƒã‚’ ${item.val} å›é˜²ã`;
        if (item.type === 'loot') return `æˆ¦åˆ©å“ (é«˜å€¤ã§å£²ã‚Œã‚‹)`;
        return "ä¸æ˜ãªã‚¢ã‚¤ãƒ†ãƒ ";
    },
    renderMerchantShop() {
        const area = document.getElementById('merchant-area');
        area.innerHTML = "";
        area.classList.remove('hidden');
        
        let buyHtml = "<h4>è³¼å…¥</h4>"; 

        buyHtml += "<div class='merchant-grid'>";
        GameState.merchantStock.forEach((item, idx) => {
            if (!item) return;
            const desc = this.getItemDesc(item);
            const rarityColor = CONFIG.rarityDisplay[item.rarity].color;
            const isDemon = GameState.phase === 'demon_merchant';
            const priceLabel = isDemon ? `éœ€ ${item.price} G` : `${item.price} G`;
            
            buyHtml += `<div class="merchant-item ${rarityColor}" onclick="Game.buyItem(${idx})">
                <div class="m-top">
                    <span>${item.icon || 'ğŸ“¦'} ${item.name}</span>
                    <span class="gold-text">${priceLabel}</span>
                </div>
                <div class="m-desc">${desc}</div>
            </div>`;
        });
        buyHtml += "</div>";

        if (GameState.phase === 'demon_merchant' && Player.sinState.greedActive) {
            buyHtml += `<div style="margin-top:10px; border:1px solid red; padding:5px; text-align:center;">
                <div style="color:red; font-weight:bold;">â›“ï¸ é»„é‡‘ã®æ·ã‚’å¤–ã™</div>
                <button onclick="Game.removeGreedDebuff()" style="background:darkred; color:white; width:100%; margin-top:5px;">10000 G æ”¯æ‰•ã†</button>
            </div>`;
        }

        let refreshBtnHtml = "";
        if (!GameState.merchantRefreshed) {
            refreshBtnHtml = `<button onclick="Game.refreshShop()" style="padding:5px 10px; font-size:0.8em; background:#2196f3; margin-right:5px;">ğŸ”„ æ›´æ–°</button>`;
        } else {
            refreshBtnHtml = `<span style="color:#666; font-size:0.8em; margin-right:10px;">(æ›´æ–°æ¸ˆ)</span>`;
        }

        buyHtml += `<div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
            <h4>å£²å´</h4>
            <div style="display:flex; align-items:center; gap: 5px;">
                ${refreshBtnHtml}
                <button onclick="Game.openSellMenu()" style="padding:5px 10px; font-size:0.8em; background:#ff9800; color:black; font-weight:bold;">é¸æŠå£²å´</button>
                <button onclick="Game.sellAllMaterials()" style="padding:5px 10px; font-size:0.8em; background:#d32f2f;">ä¸€æ‹¬å£²å´</button>
            </div>
        </div>
        <p style='font-size:0.8em; color:#888'>ä¸‹ã®ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å£²å´ã€‚</p>`;
        
        area.innerHTML = buyHtml;
    },
    buyItem(idx) {
        const item = GameState.merchantStock[idx];
        if (!item) return;
        if (Player.gold >= item.price) {
            Player.gold -= item.price;
            this.addItemToInventory(item);
            GameState.merchantStock[idx] = null;
            this.showFloatingText("- " + item.price + " G", "yellow");
            this.log(`è³¼å…¥: ${item.name}`);
            this.updateUI();
            this.renderMerchantShop();
        } else {
            alert("é‡‘è²¨ä¸è¶³ï¼");
        }
    },

    refreshShop() {
        if (GameState.merchantRefreshed) return;

        if (GameState.phase === 'merchant') {
            this.generateMerchantStock();
        } else if (GameState.phase === 'demon_merchant') {
            this.generateDemonStock();
        } else {
            return;
        }

        GameState.merchantRefreshed = true;
        this.showFloatingText("å•†å“æ›´æ–°", "#2196f3");
        this.renderMerchantShop();
    },
    removeGreedDebuff() {
        if (Player.gold >= 10000) {
            Player.gold -= 10000;
            Player.sinState.greedActive = false;
            
            if (Player.debuff && Player.debuff.id === 'greed_shackle') {
                Player.debuff = null;
            }
            
            this.showFloatingText("æ·ãŒå¤–ã‚ŒãŸ", "white");
            this.renderMerchantShop();
            this.updateUI();
        } else {
            alert("é‡‘è²¨ä¸è¶³ï¼");
        }
    },
    isProtectedItem(item) {
        if (item.type === 'revive') return true;
        const protectedNames = ['ãƒ‘ãƒãƒ³ã‚³', 'ãƒ•ãƒƒã‚¯', 'é­”åŠ›ã®ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ', 'ãƒ¡ãƒ¢', 'åŸç½ªã®ç‹å† ', 'è¼ªå»»ã®ç ‚æ™‚è¨ˆ', 'ç¥è–ãªå…‰å‰£', 'çœŸå®Ÿã®å¿ƒ'];
        if (protectedNames.includes(item.name)) return true;
        return false;
    },

    openSellMenu() {
        const modal = document.getElementById('sell-modal');
        const grid = document.getElementById('sell-options-grid');
        grid.innerHTML = "";
        
        const stats = { common: [], uncommon: [], rare: [], epic: [], legendary: [] };
        let hasItems = false;

        Player.inventory.material.forEach(item => {
            if (this.isProtectedItem(item)) return; 
            
            if (stats[item.rarity]) {
                stats[item.rarity].push(item);
                hasItems = true;
            }
        });

        const rarityLabels = {
            common: { label: "ä¸€èˆ¬", color: "#b0b0b0" },
            uncommon: { label: "è‰¯è³ª", color: "#4caf50" },
            rare: { label: "ãƒ¬ã‚¢", color: "#2196f3" },
            epic: { label: "ã‚¨ãƒ”ãƒƒã‚¯", color: "#9c27b0" },
            legendary: { label: "ä¼èª¬", color: "#ffd700" }
        };

        Object.keys(rarityLabels).forEach(rarity => {
            const items = stats[rarity];
            if (items.length > 0) {
                let totalPrice = 0;
                items.forEach(i => {
                    let p = i.price || 0;
                    if (Player.class === 'merchant') p = Math.floor(p * 1.2);
                    totalPrice += p;
                });

                const info = rarityLabels[rarity];
                
                const btn = document.createElement('button');
                btn.style.cssText = `width:100%; padding:10px; border:1px solid ${info.color}; background:rgba(0,0,0,0.3); color:${info.color}; display:flex; justify-content:space-between; align-items:center; cursor:pointer; margin-bottom:5px;`;
                btn.innerHTML = `
                    <span>${info.label}ç´ æ (x${items.length})</span>
                    <span style="color:gold; font-weight:bold;">+${totalPrice} G</span>
                `;
                btn.onclick = () => this.sellByRarity(rarity);
                grid.appendChild(btn);
            }
        });

        if (!hasItems) {
            grid.innerHTML = "<div style='color:#666; padding:20px;'>å£²å´å¯èƒ½ãªç´ æãŒã‚ã‚Šã¾ã›ã‚“</div>";
        }

        modal.style.display = 'flex';
    },

    sellByRarity(rarity) {
        let total = 0;
        let count = 0;
        const newMats = [];
        
        Player.inventory.material.forEach(item => {
            if (item.rarity === rarity && !this.isProtectedItem(item)) {
                let p = item.price || 0;
                if (Player.class === 'merchant') p = Math.floor(p * 1.2);
                total += p;
                count++;
            } else {
                newMats.push(item);
            }
        });

        Player.inventory.material = newMats;
        Player.gold += total;
        this.showFloatingText(`+ ${total} G`, "yellow");
        
        this.updateUI();
        this.openSellMenu();
        this.renderMerchantShop();
    },

    sellAllMaterials() {
        if (GameState.phase !== "merchant" && GameState.phase !== "demon_merchant") return;
        
        const sellable = Player.inventory.material.filter(i => 
            !this.isProtectedItem(i) && 
            i.rarity !== 'mythic' && 
            i.rarity !== 'ultra'
        );

        if (sellable.length === 0) {
            alert("å£²å´å¯èƒ½ãªç´ æãŒã‚ã‚Šã¾ã›ã‚“ (ä¿è­·/ç¥è©±ç´šä»¥ä¸Šã¯é™¤å¤–)ã€‚");
            return;
        }

        if(!confirm(`å…¨ã¦ã®ä¸€èˆ¬ç´ æã‚’å£²å´ã—ã¾ã™ã‹ï¼Ÿ\n(ä¿è­·/ç¥è©±ç´šä»¥ä¸Šã¯å«ã¾ã‚Œã¾ã›ã‚“)`)) return;

        let total = 0;
        const newMats = [];
        
        Player.inventory.material.forEach(item => {
            if (this.isProtectedItem(item) || item.rarity === 'mythic' || item.rarity === 'ultra') {
                newMats.push(item);
            } else {
                let price = item.price; 
                if (Player.class === 'merchant') price = Math.floor(price * 1.2);
                total += price;
            }
        });
        
        Player.inventory.material = newMats;
        Player.gold += total;
        this.showFloatingText("+ " + total + " G", "yellow");
        this.updateUI();
    },
    sellItem(index, category) {
        const item = Player.inventory[category][index];
        if (!item) return;

        if (this.isProtectedItem(item)) {
            alert("ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯å£²å´ã§ãã¾ã›ã‚“ï¼");
            return;
        }
        
        if (GameState.phase !== "merchant" && GameState.phase !== "demon_merchant") return; 
        
        let price = item.price || 0;
        if (['weapon', 'armor', 'shield', 'consumable'].includes(item.type)) {
            price = Math.floor(price * 0.8);
        }
        if (Player.class === 'merchant') {
            price = Math.floor(price * 1.2);
        }
        
        if(confirm(`${item.name} ã‚’ ${price} G ã§å£²å´ã—ã¾ã™ã‹ï¼Ÿ`)) {
            Player.inventory[category].splice(index, 1);
            Player.gold += price;
            this.showFloatingText("+ " + price + " G", "yellow");
            this.updateUI();
        }
    },

    triggerChest() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ“¦ å®ç®±ç™ºè¦‹", "ã”ãæ™®é€šã®æœ¨ã®å®ç®±ãŒã‚ã‚‹...", "ãŠå®ã‹ã€ãã‚Œã¨ã‚‚ç½ ã‹ã€‚\né–‹ã‘ã¦ã¿ã¾ã™ã‹ï¼Ÿ", "ğŸ“¦");
        this.setButtons("é–‹ã‘ã‚‹", "resolveChest", "ç«‹ã¡å»ã‚‹", "nextEvent", false);
    },

    resolveChest() {
        if (Math.random() < 0.005) {
            const choco = {...CONFIG.specialItems.chocolate};
            this.addItemToInventory(choco);
            this.renderEvent("ğŸ“¦ å®ç®±ç™ºè¦‹", "å®ç®±ã‚’é–‹ã‘ãŸ...", `ç”˜ã„é¦™ã‚Šã®ã™ã‚‹ <span class='rarity-epic'>${choco.name}</span> ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`, "ğŸ«");
            this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
            return;
        }
        if (Math.random() < 0.01) {
            const feather = {...CONFIG.phoenixFeather};
            this.addItemToInventory(feather);
            this.renderEvent("ğŸ“¦ å®ç®±ç™ºè¦‹", "å®ç®±ã‚’é–‹ã‘ãŸ...", "å¥‡è·¡ã ï¼ <span class='rarity-legendary'>ä¸æ­»é³¥ã®ç¾½æ ¹</span> ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼", "ğŸª¶");
            this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
            return;
        }
        
        if (Math.random() < 0.01 && CONFIG.lootData["ãƒ‘ãƒãƒ³ã‚³"]) {
            const item = { ...CONFIG.lootData["ãƒ‘ãƒãƒ³ã‚³"], name: "ãƒ‘ãƒãƒ³ã‚³", type: "material" };
            this.addItemToInventory(item);
            this.renderEvent("ğŸ“¦ å®ç®±ç™ºè¦‹", "å®ç®±ã‚’é–‹ã‘ãŸ...", `ç‰¹æ®Šãªé“å…· <span class='rarity-rare'>ãƒ‘ãƒãƒ³ã‚³</span> ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`, "ğŸªƒ");
            this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
            return;
        }

        if (Math.random() < 0.01 && CONFIG.lootData["ãƒ•ãƒƒã‚¯"]) {
            const item = { ...CONFIG.lootData["ãƒ•ãƒƒã‚¯"], name: "ãƒ•ãƒƒã‚¯", type: "material" };
            this.addItemToInventory(item);
            this.renderEvent("ğŸ“¦ å®ç®±ç™ºè¦‹", "å®ç®±ã‚’é–‹ã‘ãŸ...", `ç‰¹æ®Šãªé“å…· <span class='rarity-rare'>ãƒ•ãƒƒã‚¯</span> ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`, "ğŸª");
            this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
            return;
        }

        if (Math.random() < 0.01) {
            const tool = CONFIG.itemPool.find(i => i.name === "æºå¸¯ç”¨ä½œæ¥­å°");
            if (tool) {
                this.addItemToInventory({...tool});
                this.renderEvent("ğŸ“¦ å®ç®±ç™ºè¦‹", "å®ç®±ã‚’é–‹ã‘ãŸ...", `ä¾¿åˆ©ãªé“å…·ã ï¼<br>ç²å¾— <span class='rarity-rare'>æºå¸¯ç”¨ä½œæ¥­å°</span>ï¼`, "ğŸ§°");
                this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
                return;
            }
        }

        const roll = Math.random();
        let title = "ğŸ“¦ å®ç®±ç™ºè¦‹";
        let desc = "";
        let icon = "ğŸ“¦";
        let isThief = Player.class === 'thief';
        let safeRoll = isThief ? roll * 0.8 : roll;

        if (safeRoll < 0.30) {
            const amount = Math.floor(Math.random() * 50) + 10 + (Player.depth * 2);
            Player.gold += amount;
            desc = `<span class='gold-text'>${amount} G</span> ã‚’æ‰‹ã«å…¥ã‚ŒãŸã€‚`;
            this.showFloatingText(`+${amount} G`, "#ffd700");
        } else if (safeRoll < 0.60) {
            const item = this.generateSpecificItem(['consumable']);
            this.addItemToInventory(item);
            desc = `<span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span> ã‚’æ‰‹ã«å…¥ã‚ŒãŸã€‚`;
        } else if (safeRoll < 0.80) {
            const item = this.generateSpecificItem(['weapon', 'armor', 'shield']);
            this.addItemToInventory(item);
            desc = `<span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span> ã‚’æ‰‹ã«å…¥ã‚ŒãŸã€‚`;
        } else if (safeRoll < 0.90) {
            desc = "ä¸­ã¯ç©ºã£ã½ã ã£ãŸ...";
        } else {
            const dmg = Math.floor(Player.maxHp * 0.15);
            Player.hp = Math.max(0, Player.hp - dmg);
            desc = `ç½ ã ï¼ <span class='damage-text'>${dmg}</span> ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚`;
            this.triggerAnim('game-container', 'anim-screen-shake');
            this.showFloatingText(`-${dmg} HP`, "red");
            if(Player.hp === 0) { this.playerDie("å®ç®±ã®ç½ ã§æ­»äº¡"); return; }
        }

        this.renderEvent(title, "å®ç®±ã‚’é–‹ã‘ãŸ...", desc, icon);
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
    },

    triggerInfernoHarpy() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        
        const feather = {...CONFIG.phoenixFeather};
        this.addItemToInventory(feather);

        this.renderEvent("ğŸ¦… é€šã‚Šã™ãŒã‚Šã®ãƒãƒ¼ãƒ”ãƒ¼", 
            "é‹­ã„ç›®ã¤ãã®ãƒãƒ¼ãƒ”ãƒ¼ãŒç…‰ç„ã®ä¸Šç©ºã‚’é£›ã‚“ã§ã„ã...", 
            "æ„å¤–ãªã“ã¨ã«å½¼å¥³ã¯æ”»æ’ƒã›ãšã€å¾®ã‹ã«ç‡ƒãˆã‚‹ç¾½æ ¹ã‚’è½ã¨ã—ã¦é£›ã³å»ã£ãŸã€‚<br><br>ç²å¾— <span class='rarity-legendary'>ä¸æ­»é³¥ã®ç¾½æ ¹</span>", 
            "ğŸ¦…");
            
        this.setButtons("æ‹¾ã£ã¦é€²ã‚€", "nextEvent", "ãªã—", null, true);
    },

    triggerHarpy() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        
        if (Player.class === 'scarecrow') {
            Player.gold += 500;
            this.showFloatingText("+500 G", "#ffd700");
            this.renderEvent("ğŸ¦… ãƒãƒ¼ãƒ”ãƒ¼è¥²æ¥", "ãƒãƒ¼ãƒ”ãƒ¼ãŒè¥²ã£ã¦ããŸï¼", 
                "ã‚«ã‚«ã‚·ã§ã‚ã‚‹ã‚ãªãŸã®å§¿ã‚’è¦‹ã¦ã€ãƒãƒ¼ãƒ”ãƒ¼ã¯é€ƒã’å‡ºã—ãŸï¼<br>è½ã¨ã—ã¦ã„ã£ãŸ <span class='gold-text'>500 G</span> ã‚’æ‹¾ã£ãŸï¼", "ğŸŒ¾");
            this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
            return;
        }

        const slingIndex = Player.inventory.material.findIndex(i => i.name === 'ãƒ‘ãƒãƒ³ã‚³');
        if (slingIndex !== -1) {
            Player.inventory.material.splice(slingIndex, 1);
            Player.gold += 500;
            this.showFloatingText("+500 G", "#ffd700");
            this.renderEvent("ğŸ¦… ãƒãƒ¼ãƒ”ãƒ¼è¥²æ¥", "ãƒãƒ¼ãƒ”ãƒ¼ãŒè¥²ã£ã¦ããŸï¼", `ã‚ãªãŸã¯ <span class='rarity-rare'>ãƒ‘ãƒãƒ³ã‚³</span> ã§æ’ƒé€€ã—ãŸï¼(ãƒ‘ãƒãƒ³ã‚³ç ´æ)<br>è½ã¨ã—ã¦ã„ã£ãŸ <span class='gold-text'>500 G</span> ã‚’æ‹¾ã£ãŸï¼`, "ğŸªƒ");
            this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
            return;
        }
        
        let repelBonus = 0;
        let autoRepel = false;
        Player.equipment.accessories.forEach(acc => {
            if(!acc) return;
            if(acc.id === 'acc_orc_1') repelBonus += 0.1;
            if(acc.id === 'acc_orc_2') repelBonus += 0.3;
            if(acc.id === 'acc_orc_3') autoRepel = true;
        });

        let winChance = 0.2 + repelBonus;
        let outcome = Math.random();
        let title = "ğŸ¦… ãƒãƒ¼ãƒ”ãƒ¼è¥²æ¥";
        let desc = "";
        let icon = "ğŸ¦…";

        if (autoRepel || outcome < winChance) {
            Player.gold += 500;
            this.showFloatingText("+500 G", "#ffd700");
            let extraMsg = autoRepel ? "(è§’ç¬›ã®å¨åš‡!)" : "";
            desc = `ãƒãƒ¼ãƒ”ãƒ¼ã‚’æ’ƒé€€ã—${extraMsg}ã€<span class='gold-text'>500 G</span> ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`;
        } else {
            const type = Math.floor(Math.random() * 4);
            if (type === 0) { Player.inventory.equipment = []; desc = "ãƒãƒ¼ãƒ”ãƒ¼ã¯ãƒªãƒ¥ãƒƒã‚¯ã® <span class='damage-text'>è£…å‚™</span> ã‚’å…¨ã¦å¥ªã„å»ã£ãŸï¼"; } 
            else if (type === 1) { Player.inventory.consumable = []; desc = "ãƒãƒ¼ãƒ”ãƒ¼ã¯ãƒªãƒ¥ãƒƒã‚¯ã® <span class='damage-text'>æ¶ˆè€—å“</span> ã‚’å…¨ã¦å¥ªã„å»ã£ãŸï¼"; } 
            else if (type === 2) { 
                const keptItems = Player.inventory.material.filter(i => 
                    this.isProtectedItem(i)
                );
                const lostCount = Player.inventory.material.length - keptItems.length;
                Player.inventory.material = keptItems;
                
                if (lostCount > 0) desc = "ãƒãƒ¼ãƒ”ãƒ¼ã¯ãƒªãƒ¥ãƒƒã‚¯ã® <span class='damage-text'>ç´ æ</span> ã‚’å¥ªã„å»ã£ãŸï¼(é‡è¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’é™¤ã)";
                else desc = "ãƒãƒ¼ãƒ”ãƒ¼ã¯ãƒªãƒ¥ãƒƒã‚¯ã‚’æ¼ã£ãŸãŒã€èˆˆå‘³ã®ã‚ã‚‹ã‚‚ã®ã¯ãªã‹ã£ãŸã‚ˆã†ã ã€‚";
            } 
            else { Player.gold = 0; desc = "ãƒãƒ¼ãƒ”ãƒ¼ã¯æ‰€æŒã—ã¦ã„ã‚‹ <span class='damage-text'>é‡‘è²¨</span> ã‚’å…¨ã¦å¥ªã„å»ã£ãŸï¼"; }
        }
        this.renderEvent(title, "ãƒãƒ¼ãƒ”ãƒ¼ãŒä¸Šç©ºã‹ã‚‰è¥²ã„æ›ã‹ã£ã¦ããŸï¼", desc, icon);
        this.setButtons("æ¬¡ã¸", "nextEvent", "ãªã—", null, true);
    },
    triggerCombat(isForcedBoss, checkTrueForm) {
        GameState.phase = "combat";

        GameState.combatTurn = 0;
        GameState.enemyDominated = false;
        let baseMonster;
        let tier = "normal";
        let canFlee = true;

        if (isForcedBoss) {
            baseMonster = CONFIG.monsters[9]; 
            tier = "boss";
            canFlee = false;
        } else {
            baseMonster = this.getWeightedMonster();
            let rand = Math.random();
            if (Player.depth > 300) {
                if (rand < 0.1) tier = "normal"; else if (rand < 0.55) tier = "elite"; else tier = "boss";
            } else if (Player.depth > 100) {
                if (rand < 0.1) tier = "boss"; else if (rand < 0.6) tier = "elite"; else tier = "normal";
            } else {
                if (rand < 0.01) tier = "boss"; else if (rand < 0.11) tier = "elite"; else tier = "normal";
            }
        }

        let hpMul = 1, atkMul = 1;
        let namePrefix = "";
        
        if (Player.depth > 500) { hpMul *= 1.5; namePrefix += "æ·±æ·µã® "; }
        if (tier === "elite") { hpMul *= 2; atkMul *= 1.5; namePrefix += "ã‚¨ãƒªãƒ¼ãƒˆ "; }
        else if (tier === "boss") { hpMul *= 3; atkMul *= 2; namePrefix += "é¦–é ˜ "; }

        let enemy = {
            ...baseMonster,
            name: namePrefix + baseMonster.name,
            maxHp: Math.floor(baseMonster.hp * hpMul),
            hp: Math.floor(baseMonster.hp * hpMul),
            atk: Math.floor(baseMonster.atk * atkMul),
            tier: tier
        };

        const hasCrown = Player.inventory.material.some(i => i.name === "åŸç½ªã®ç‹å† ");
        if (hasCrown && !isForcedBoss && !enemy.isTrueForm) {
            enemy.name = "åŸåˆ " + enemy.name;
            enemy.hp *= 2;
            enemy.maxHp *= 2;
            enemy.atk *= 2;
            this.showFloatingText("ä¸–ç•ŒãŒå´©å£Šã—ã¦ã„ã...", "#ff0000");
            setTimeout(() => this.showFloatingText("æ—©ãå‡ºå£ã‚’è¦‹ã¤ã‘ã¦", "#ff0000"), 1500);
        }

        if (checkTrueForm && !Player.inInferno) {
            const hasSword = Player.equipment.weapon && Player.equipment.weapon.name === "è–å‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼";
            const hasArmor = Player.equipment.armor && Player.equipment.armor.name === "ç¥ã®è¼ã";
            if (hasSword && hasArmor) {
                enemy.name = "é­”ç‹çœŸèº«";
                enemy.maxHp = 4000;
                enemy.hp = 4000;
                enemy.atk = 200;
                enemy.isTrueForm = true;
            }
        }

        GameState.currentEnemy = enemy;
        let iconClass = "monster-icon";
        if(tier === "elite") iconClass += " monster-elite glow-blue";
        if(tier === "boss") iconClass += " monster-boss glow-red";
        if(enemy.isTrueForm) iconClass = "monster-icon monster-true-form glow-purple";

        document.getElementById('event-icon').className = iconClass;
        this.triggerAnim('event-icon', 'anim-spawn');
        
        this.renderEvent(`âš”ï¸ é­é‡ ${enemy.name}`, 
            `HP: ${enemy.hp} | æ”»æ’ƒ: ${enemy.atk}`, 
            "æˆ¦é—˜æº–å‚™ï¼", enemy.icon);
        this.setButtons("æˆ¦é—˜", "combatRound", "é€ƒã’ã‚‹", "flee", !canFlee);
        if (Player.debuff && Player.debuff.id === 'sloth_curse') {
            const btnMain = document.getElementById('btn-main');
            const btnSub = document.getElementById('btn-sub');

            btnMain.disabled = true;
            btnMain.innerText = "ğŸ’¤ æ€ æƒ° (æ”»æ’ƒä¸å¯)";
            btnMain.style.opacity = "0.6";
            btnMain.style.cursor = "not-allowed";

            btnSub.disabled = false;
            btnSub.innerText = "é€ƒã’ã‚‹";
        } else {
            document.getElementById('btn-main').disabled = false;
            document.getElementById('btn-main').style.opacity = "1";
            document.getElementById('btn-main').style.cursor = "pointer";
        }
    },

    checkDeath(reason) {
        const hasNecklace = Player.equipment.accessories.some(a => a && a.id === 'acc_dead');
        
        // 1. äº¡è€…ã®ãƒãƒƒã‚¯ãƒ¬ã‚¹ (æœ€å„ªå…ˆ)
        if (hasNecklace && Player.hp <= 0 && Player.ghostTurns === 0 && GameState.currentEnemy && GameState.phase === 'combat') {
            Player.hp = 1;
            Player.ghostTurns = 3;
            this.renderEvent("ğŸ’€ äº¡è€…ã®æ€¨å¿µ", "å€’ã‚Œã‚‹ã‚ã‘ã«ã¯ã„ã‹ãªã„...", "éœŠä½“åŒ–ï¼(3ã‚¿ãƒ¼ãƒ³ä»¥å†…ã«æ•µã‚’å€’ã›ã€æ”»æ’ƒåŠ›2å€)", "ğŸ‘»");
            this.setButtons("æ€¨å¿µæ”»æ’ƒ (2å€ãƒ€ãƒ¡)", "combatRound", "é€ƒèµ°ä¸å¯", null, true);
            this.updateUI();
            return; 
        }

        // 2. éœŠä½“ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
        if (Player.ghostTurns > 0) {
            Player.ghostTurns--;
            if (Player.ghostTurns <= 0) {
                this.showFloatingText("éœŠä½“æŒç¶šæ™‚é–“çµ‚äº†...", "gray");
            } else {
                Player.hp = 1;
                this.renderEvent("ğŸ‘» éœŠä½“ãƒ¢ãƒ¼ãƒ‰", `æ®‹ã‚Š ${Player.ghostTurns} ã‚¿ãƒ¼ãƒ³`, "æ€¨å¿µã§å½¢ã‚’ä¿ã£ã¦ã„ã‚‹...<br>æ€¥ã„ã§æ•µã‚’å€’ã›ï¼", "ğŸ’€");
                this.setButtons("æ€¨å¿µæ”»æ’ƒ (2å€ãƒ€ãƒ¡)", "combatRound", "é€ƒèµ°ä¸å¯", null, true);
                this.updateUI();
                return; 
            }
        }        
        // æ°¸ç”Ÿã®è­·ç¬¦ (å¾©æ´»)
        const hasPhylactery = Player.equipment.accessories.some(a => a && a.id === 'acc_phylactery');
        if (hasPhylactery && Player.hp <= 0 && Player.souls >= 50) {
            Player.souls -= 50;
            Player.hp = Math.floor(Player.maxHp * 0.5);
            this.showFloatingText("å‘½åŒ£å¾©æ´»", "#00ffcc");
            this.renderEvent("âš±ï¸ æ°¸ç”Ÿã®è­·ç¬¦", "å‘½åŒ£ãŒç •ã‘ã€è‚‰ä½“ã‚’å†æ§‹æˆã—ãŸã€‚", `é­‚50ã‚’æ¶ˆè²»ã—ã¦å¾©æ´»ï¼(æ®‹ã‚Šé­‚: ${Player.souls})`, "âœ¨");
            this.updateUI();
            return;
        }

        // ä¸æ­»é³¥ã®ç¾½æ ¹
        const featherIdx = Player.inventory.material.findIndex(i => i.id === 'phoenix_feather');
        if (featherIdx !== -1) {
            Player.inventory.material.splice(featherIdx, 1);
            Player.hp = Math.floor(Player.maxHp * 0.5);
            
            this.renderEvent("ğŸ”¥ èµ·æ­»å›ç”Ÿ", "ä¸æ­»é³¥ã®ç¾½æ ¹ãŒç‡ƒãˆå°½ããŸ...", "HP50%ã§å¾©æ´»ã—ãŸã€‚<br>æ…‹å‹¢ã‚’ç«‹ã¦ç›´ã›ã€‚", "ğŸ¦…");
            
            if (GameState.currentEnemy && GameState.phase === 'combat') {
                this.setButtons("æ…‹å‹¢ã‚’ç«‹ã¦ç›´ã™ (ç¶™ç¶š)", "resumeCombat", "ãªã—", null, true);
            } else {
                this.setButtons("ç”Ÿé‚„ (æ¬¡ã¸)", "nextEvent", "ãªã—", null, true);
            }
            
            this.updateUI();
            return;
        }

        // ãƒªãƒªã‚¹çŒ®èº«ã‚¤ãƒ™ãƒ³ãƒˆ
        if (GameState.currentEnemy && GameState.currentEnemy.isGod && Player.lilithBlessing && !Player.lilithSacrificed) {
            
            Player.lilithSacrificed = true;
            Player.lilithBlessing = false; 

            Player.lastInspirationTurns = 3; 
            Player.hp = Player.maxHp;        
            
            const dmgToGod = Math.floor(GameState.currentEnemy.hp * 0.5);
            GameState.currentEnemy.hp -= dmgToGod;
            
            if (Player.debuff) {
                Player.debuff = null;
                this.showFloatingText("å‘ªã„æµ„åŒ–", "#fff");
            }
            
            this.recalcStats();

            this.renderEvent("ğŸ’” èµ·æºé­”æ³•", 
                "è‡´å‘½çš„ãªä¸€æ’ƒãŒè½ã¡ã‚‹ç›´å‰ã€ãƒªãƒªã‚¹ãŒã‚ãªãŸã®å‰ã«ç«‹ã¡ã¯ã ã‹ã£ãŸã€‚", 
                `ã€Œç”Ÿãã¦...ãƒã‚«...ã€<br>å½¼å¥³ã¯ç„¡æ•°ã®å…‰ã®ç²’å­ã¨ãªã£ã¦æ¶ˆãˆå»ã£ãŸã€‚<br><br>
                <span style='color:#ff69b4'>ã€æœ€å¾Œã®é¼“èˆã€‘ã‚’ç²å¾— (3ã‚¿ãƒ¼ãƒ³ç¥ã®åŠ›ç„¡åŠ¹ã€HP+6666ã€å…¨å›å¾©)<br>
                ç¥ã®ä»£è¡Œè€…ã«å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ (HP -50%)</span>`, 
                "âœ¨");
            
            this.checkAchievements();
            
            this.setButtons("å½¼å¥³ã®åˆ†ã¾ã§æˆ¦ã† (ç¶™ç¶š)", "resumeCombat", "ãªã—", null, true);
            this.updateUI();
            return;
        }

        this.playerDie(reason);
    },

    resumeCombat() {
        const enemy = GameState.currentEnemy;
        if (!enemy) {
            this.nextEvent();
            return;
        }

        GameState.phase = "combat";
        
        let iconClass = "monster-icon";
        if (Player.inInferno) iconClass += " glow-inferno";
        if (enemy.tier === 'elite') iconClass += " monster-elite glow-blue";
        if (enemy.tier === 'boss') iconClass += " monster-boss glow-red";
        if (enemy.isTrueForm) iconClass = "monster-icon monster-true-form glow-purple";
        
        if (enemy.isGod) iconClass = "monster-icon glow-void";

        document.getElementById('event-icon').className = iconClass;

        this.renderEvent(`âš”ï¸ ${enemy.name}`, 
            `HP: ${enemy.hp} | æ”»æ’ƒ: ${enemy.atk}`, 
            "æ­¦å™¨ã‚’æ¡ã‚Šç›´ã—ã€æˆ¦é—˜å†é–‹ï¼", enemy.icon);

        const iconEl = document.getElementById('event-icon');
        iconEl.onclick = () => Game.inspectEnemy();
        iconEl.style.cursor = "help";

        const escapableBosses = ['ãƒ–ãƒ©ãƒƒãƒ‰ä¼¯çˆµ', 'ãƒªãƒƒãƒã‚­ãƒ³ã‚°', 'ã‚¢ãƒ“ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³'];
        const isEscapable = escapableBosses.some(name => enemy.name.includes(name));

        const canFlee = !enemy.isSin && 
                        !enemy.isOldOne && 
                        !enemy.isGod && 
                        (enemy.tier !== 'boss' || isEscapable) || 
                        enemy.isGardenBoss;

        this.setButtons("æˆ¦é—˜", "combatRound", "é€ƒã’ã‚‹", "flee", !canFlee);

        if (Player.debuff && Player.debuff.id === 'sloth_curse') {
            const btnMain = document.getElementById('btn-main');
            const btnSub = document.getElementById('btn-sub');
            btnMain.disabled = true;
            btnMain.innerText = "ğŸ’¤ æ€ æƒ° (æ”»æ’ƒä¸å¯)";
            btnMain.style.opacity = "0.6";
            btnMain.style.cursor = "not-allowed";
            btnSub.disabled = !canFlee; 
            btnSub.innerText = "é€ƒã’ã‚‹";
        }

        this.updateUI();
    },
    playerDie(reason) { 
        GameState.phase = "dead";
        Player.hp = 0;
        this.updateUI();
        localStorage.removeItem('fantasy_adventure_save_v2');
        let cause = reason ? reason : "æ­»å› ä¸æ˜";
        this.renderEvent("â˜ ï¸ ã‚ãªãŸã¯æ­»ã‚“ã ", `æ­»å› ï¼š${cause}<br>å†’é™ºçµ‚äº†ã€‚æœ€çµ‚åˆ°é”æ·±åº¦: ${Player.depth}`, "ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦å†é–‹ã—ã¦ãã ã•ã„", "ğŸª¦");
        this.setButtons("å†æŒ‘æˆ¦", "restart", "ãªã—", null, true);
    },
    restart() { location.reload(); },

    getWeightedMonster() {
        let activeMonsters = [];
        if (Player.depth < 50) {
            let weakWeight = 99 / 4; 
            let strongWeight = 1 / 6; 
            CONFIG.monsters.forEach((m, idx) => {
                let tempM = {...m};
                tempM.weight = (idx < 4) ? weakWeight : strongWeight;
                activeMonsters.push(tempM);
            });
        } else {
            activeMonsters = CONFIG.monsters;
        }
        let totalWeight = 0;
        for (let m of activeMonsters) totalWeight += m.weight;
        let randomVal = Math.random() * totalWeight;
        for (let m of activeMonsters) {
            if (randomVal < m.weight) return m;
            randomVal -= m.weight;
        }
        return activeMonsters[0];
    },
    generateRandomItem(tierModifier = "normal") {
        const r = Math.random();
        let rarityKey = "common";
        let table = CONFIG.rarityProb;
        let acc = 0;
        for (let key in table) {
            acc += table[key];
            if (r <= acc) { rarityKey = key; break; }
        }
        if (tierModifier === "boss" && (rarityKey === "common" || rarityKey === "uncommon")) rarityKey = "rare";
        const pool = CONFIG.itemPool.filter(i => i.rarity === rarityKey);
        if (pool.length === 0) return this.generateRandomItem("normal");
        const template = pool[Math.floor(Math.random() * pool.length)];
        return Object.assign({}, template);
    },
    generateSpecificItem(allowedTypes) {
        const r = Math.random();
        let rarityKey = "common";
        let table = CONFIG.rarityProb;
        let acc = 0;
        for (let key in table) {
            acc += table[key];
            if (r <= acc) { rarityKey = key; break; }
        }
        let pool = CONFIG.itemPool.filter(i => i.rarity === rarityKey && allowedTypes.includes(i.type));
        if (pool.length === 0) pool = CONFIG.itemPool.filter(i => allowedTypes.includes(i.type));
        const template = pool[Math.floor(Math.random() * pool.length)];
        return Object.assign({}, template);
    },
    addItemToInventory(item, render = true) {
        if (!Player.history.items.has(item.name)) {
            Player.history.items.add(item.name);
        }
        
        if (['weapon', 'armor', 'shield'].includes(item.type)) {
            Player.inventory.equipment.push(item);
        } else if (item.type === 'consumable') {
            Player.inventory.consumable.push(item);
        } else if (item.type === 'accessory') {
            Player.inventory.accessory.push(item);
        } else {
            Player.inventory.material.push(item);
        }
        if (render) this.updateUI();
    },
   handleItemClick(index, category) {
        if (GameState.phase === "merchant" || GameState.phase === "demon_merchant") {
            this.sellItem(index, category);
            return;
        }

        const item = Player.inventory[category][index];
        const type = item.type;

        if (GameState.phase === "combat") {
            const isPrideFight = GameState.currentEnemy && GameState.currentEnemy.sinType === 'pride';
            
            if (isPrideFight) {
                if (['weapon', 'armor', 'shield'].includes(type)) {
                    alert("å‚²æ…¢ã®æ±ºé—˜ä¸­ã€ä¸»è¦è£…å‚™ã¯å¤‰æ›´ã§ãã¾ã›ã‚“ï¼");
                    return;
                }
            } 
        }

        if (GameState.phase === "sin_event") {
            if (GameState.currentSinType === 'pride') {
                if (['weapon', 'armor', 'shield'].includes(type)) {
                    alert("å‚²æ…¢ã®é–€ã®å‰ã§ã¯ã€è£…å‚™ã‚’éš ã™(å¤‰æ›´ã™ã‚‹)ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼");
                    return;
                }
            }
        }

        if (['weapon', 'armor', 'shield'].includes(type)) {
            if(confirm(`${item.name} (${this.getItemDesc(item)}) ã‚’è£…å‚™ã—ã¾ã™ã‹ï¼Ÿ`)) this.equip(index, category);
        } else if (type === 'accessory') {
             this.promptEquipAccessory(index);
        } else if (type === 'consumable') {
            if(confirm(`${item.name} (${item.desc}) ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ`)) this.useItem(index, category);
        } else {
             alert(`${item.icon} ${item.name}: ${item.desc || "ç´ æ/æˆ¦åˆ©å“"}`);
        }
    },
    equip(index, category) {
        const item = Player.inventory[category][index];
        
        if (Player.class === 'scarecrow') {
            if (item.name === "é¨å£«ã®ç›¾" || item.name === "ã‚¿ãƒ¯ãƒ¼ã‚·ãƒ¼ãƒ«ãƒ‰") {
                alert("ã‚«ã‚«ã‚·ã®è…•ã¯ç´°ã™ãã¦ã€ãã‚“ãªé‡ã„ç›¾ã¯æŒã¦ã¾ã›ã‚“ï¼\n(ã‚«ã‚«ã‚·ã¯é¨å£«ã®ç›¾ã¨ã‚¿ãƒ¯ãƒ¼ã‚·ãƒ¼ãƒ«ãƒ‰ã‚’è£…å‚™ä¸å¯)");
                return; 
            }
        }

        const type = item.type;
        if (!['weapon', 'armor', 'shield'].includes(type)) return;
        if (Player.equipment[type]) this.addItemToInventory(Player.equipment[type], false);
        Player.equipment[type] = item;
        Player.inventory[category].splice(index, 1);
        this.recalcStats();
        this.updateUI();    
        this.log(`è£…å‚™: ${item.name}`);
    },
    promptEquipAccessory(index) {
        const item = Player.inventory.accessory[index];
        let desc = this.getItemDesc(item);
        
        let slot = prompt(`ã€${item.name}ã€‘\n${desc}\n\nã©ã®ã‚¹ãƒ­ãƒƒãƒˆã«è£…å‚™ã—ã¾ã™ã‹ï¼Ÿ (1, 2, 3 ã‚’å…¥åŠ›)`, "1");
        
        if (slot === "1" || slot === "2" || slot === "3") {
            let slotIdx = parseInt(slot) - 1;
            if (Player.equipment.accessories[slotIdx]) {
                this.addItemToInventory(Player.equipment.accessories[slotIdx], false);
            }
            Player.equipment.accessories[slotIdx] = item;
            Player.inventory.accessory.splice(index, 1);
            this.recalcStats();
            this.updateUI();
        }
    },
   unequip(type) {
        if (GameState.phase === "sin_event" && GameState.currentSinType === 'pride') {
            alert("å‚²æ…¢ã®é–€ã®å‰ã§ã¯ã€è£…å‚™ã‚’å¤–ã›ã¾ã›ã‚“ï¼");
            return;
        }

        if (GameState.phase === "combat") {
            const isPrideFight = GameState.currentEnemy && GameState.currentEnemy.sinType === 'pride';
            if (isPrideFight && type !== 'accessory') { 
                alert("é¡åƒã¨ã®æ±ºé—˜ä¸­ã€æ­¦å™¨ã‚’æ¨ã¦ãŸã‚Šé˜²å…·ã‚’ç€ãŸã‚Šã¯ã§ãã¾ã›ã‚“ï¼");
                return;
            }
        }

        if (!Player.equipment[type]) return;
        const item = Player.equipment[type];
        this.addItemToInventory(item, false); 
        Player.equipment[type] = null;
        this.recalcStats();
        this.updateUI();
    },

    unequipAccessory(slotIdx) {
        if (!Player.equipment.accessories[slotIdx]) return;
        const item = Player.equipment.accessories[slotIdx];
        this.addItemToInventory(item, false);
        Player.equipment.accessories[slotIdx] = null;
        this.recalcStats();
        this.updateUI();
    },
    useItem(index, category) {
        if (Player.hp <= 0) return;
        const item = Player.inventory[category][index];

        if (item.name === "è¼ªå»»ã®ç ‚æ™‚è¨ˆ") {
            this.openRebirthMenu(); 
            return;
        }
        if (item.name === "æºå¸¯ç”¨ä½œæ¥­å°") {
            if(confirm("æºå¸¯ç”¨ä½œæ¥­å°ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ(ä½¿ç”¨å¾Œæ¶ˆæ»…)")) {
                Player.inventory[category].splice(index, 1);
                this.updateUI();
                this.openPortableCrafting();
                this.showFloatingText("ä½œæ¥­å°å±•é–‹", "#eee");
            }
            return;
        }
        if (item.name === "ç…‰ç„ç‚‰ã®å·»ç‰©") {
            if(confirm("å·»ç‰©ã‚’æ¶ˆè²»ã—ã¦ç…‰ç„ã®ç‚‰ã‚’å¬å–šã—ã¾ã™ã‹ï¼Ÿ")) {
                Player.inventory[category].splice(index, 1); 
                this.updateUI();
                this.openPortableCrafting('inferno'); 
                this.showFloatingText("ç…‰ç„ã®ç‚‰ é¡•ç¾", "#ff3300");
            }
            return;
        }
        // è¡€ã®å¥‘ç´„åˆ¶é™
        if (Player.equipment.accessories.some(a => a && a.id === 'acc_blood')) {
             if (item.name.includes("ãƒãƒ¼ã‚·ãƒ§ãƒ³") || item.name.includes("ã‚¨ãƒªã‚¯ã‚µãƒ¼") || item.name.includes("è¡€")) {
                 alert("ã€è¡€ã®å¥‘ç´„æ›¸ã€‘å›å¾©ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨ç¦æ­¢ï¼å¸è¡€ã§ç”Ÿãå»¶ã³ã‚ã€‚");
                 return;
             }
        }

        if (item.name.includes("ãƒãƒ¼ã‚·ãƒ§ãƒ³") || item.name.includes("ã‚¨ãƒªã‚¯ã‚µãƒ¼") || item.name.includes("ãƒãƒ¼ãƒ”ãƒ¼ã®è¡€")) {
            let heal = item.val;
            Player.hp = Math.min(Player.maxHp, Player.hp + heal);
            Player.inventory[category].splice(index, 1);
            this.showFloatingText(`+${heal} HP`, "#69f0ae");
            this.updateUI();
        }
        else if (item.name.includes("æµ„åŒ–ã®è¡€")) {
            Player.hp = Player.maxHp;
            Player.inventory[category].splice(index, 1);
            this.showFloatingText("HP MAX", "#69f0ae");
            this.updateUI();
        }
    },

    openRebirthMenu() {
        let allAccessories = [];
        Player.inventory.accessory.forEach(acc => allAccessories.push(acc));
        Player.equipment.accessories.forEach(acc => {
            if (acc) allAccessories.push(acc);
        });

        if (allAccessories.length === 0) {
            if(confirm("ç¶™æ‰¿ã§ãã‚‹ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ(å…¨ã¦å¤±ã‚ã‚Œã¾ã™)")) {
                this.executeRebirth(null);
            }
            return;
        }

        const modal = document.getElementById('rebirth-modal');
        const list = document.getElementById('rebirth-list');
        list.innerHTML = "";

        allAccessories.sort((a, b) => {
            const valA = CONFIG.rarityDisplay[a.rarity]?.val || 0;
            const valB = CONFIG.rarityDisplay[b.rarity]?.val || 0;
            return valB - valA;
        });

        allAccessories.forEach(item => {
            const div = document.createElement('div');
            let colorClass = CONFIG.rarityDisplay[item.rarity]?.color || 'rarity-common';
            
            div.className = `merchant-item ${colorClass}`;
            if(item.rarity === 'mythic') div.className += ' rarity-mythic';
            if(item.rarity === 'ultra') div.className += ' rarity-ultra';
            
            div.style.cssText = "cursor:pointer; display:flex; flex-direction:column; align-items:center; text-align:center; padding:10px; font-size:0.8em;";
            div.innerHTML = `
                <div style="font-size:2em; margin-bottom:5px;">${item.icon}</div>
                <div>${item.name}</div>
            `;
            
            div.onclick = () => {
                if(confirm(`ã€${item.name}ã€‘ã‚’ç¶™æ‰¿ã—ã¦æ–°ã—ã„è¼ªå»»ã‚’å§‹ã‚ã¾ã™ã‹ï¼Ÿ\n(ä»–ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯å…¨ã¦å¤±ã‚ã‚Œã¾ã™)`)) {
                    this.executeRebirth(item);
                }
            };
            list.appendChild(div);
        });

        modal.style.display = 'flex';
    },

    executeRebirth(inheritedItem) {
        document.getElementById('rebirth-modal').style.display = 'none';

        Player.hp = 100;
        Player.maxHp = 100;
        Player.baseMaxHp = 100;
        Player.baseAtk = 5;
        Player.gold = 100;
        Player.depth = 0;
        Player.class = null;
        
        Player.permanentCritBonus = 0;
        Player.lilithBlessing = false;
        Player.lilithSacrificed = false;
        Player.lastInspirationTurns = 0;
        Player.fairyEnhanceCount = 0;
        Player.elderEnhanceCount = 0;
        Player.permanentHpBonus = 0;
        Player.inInferno = false;
        Player.kill1000Boss = false;
        Player.souls = 0;
        Player.ghostTurns = 0;
        Player.bloodContractAtk = 0;
        Player.chaosRoll = 1;
        
        Player.sinState = { slothCount: 0, wrathRevive: 0, lustActive: false, greedActive: false };
        Player.buff = null;
        Player.debuff = null;
        Player.succubusStage = 0;

        Player.inventory = { 
            equipment: [], 
            consumable: [
                { name: "å›å¾©ãƒãƒ¼ã‚·ãƒ§ãƒ³", type: "consumable", val: 30, rarity: "common", price: 25, icon: "ğŸ§ª", desc: "HPã‚’30å›å¾©" }
            ], 
            material: [],
            accessory: [] 
        };
        Player.equipment = { weapon: null, armor: null, shield: null, accessories: [null, null, null] };

        if (inheritedItem) {
            const savedItem = JSON.parse(JSON.stringify(inheritedItem));
            this.addItemToInventory(savedItem, false);
        }
        
        Player.history.items.add("è¼ªå»»å¾Œã®è¨˜æ†¶"); 
        this.checkAchievements();

        GameState.phase = "select_class";
        GameState.forgeUsed = false;
        GameState.merchantRefreshed = false;
        GameState.combatTurn = 0;
        GameState.enemyDominated = false;
        GameState.currentEnemy = null;
        GameState.craftingCount = 0;
        GameState.merchantStock = [];

        document.body.classList.remove('inferno-mode');
        document.body.style.boxShadow = "";
        document.getElementById('merchant-area').classList.add('hidden');
        document.getElementById('crafting-area').classList.add('hidden');
        document.getElementById('class-badge').innerText = "";
        
        this.updateUI();
        this.saveGame();
        
        document.getElementById('class-modal').style.display = 'flex';
        this.renderEvent("â³ è¼ªå»»é–‹å§‹", "æ›–æ˜§ãªè¨˜æ†¶ã¨å…±ã«èµ·ç‚¹ã¸æˆ»ã£ãŸ...", inheritedItem ? `æ‰‹ã«ã¯ <span class="${CONFIG.rarityDisplay[inheritedItem.rarity].color}">${inheritedItem.name}</span> ãŒæ¡ã‚‰ã‚Œã¦ã„ã‚‹ã€‚` : "ä»Šå›ã¯ä½•ã‚‚æŒã£ã¦ã„ãªã„ã€‚", "âœ¨");

        this.setButtons("ã‚¯ãƒ©ã‚¹é¸æŠã¸", "showClassModal", "ãªã—", null, true);
        
        const floaters = document.querySelectorAll('.floating-text');
        floaters.forEach(el => el.remove());
        
        alert("â³ è¼ªå»»é–‹å§‹ï¼\n\nå…¨ã¦ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    },

getEnemySkillDesc(name) {
        if (name.includes("ã‚·ãƒ£ãƒ‰ã‚¦ã‚¹ãƒ©ã‚¤ãƒ ")) return "ã€æµä½“å›é¿ã€‘\nè¢«å¼¾æ™‚ 15% ã®ç¢ºç‡ã§å®Œå…¨å›é¿ã—ã€æ”»æ’ƒè€…ã«å°‘é‡ã®åæ’ƒãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚";
        if (name.includes("ãƒ´ã‚©ã‚¤ãƒ‰ã‚¢ã‚¤")) return "ã€è¦–ç·šå±ˆæŠ˜ã€‘\nè¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ã® 10% ã‚’æ”»æ’ƒè€…ã«åå°„ã™ã‚‹ã€‚";
        if (name.includes("ãƒã‚°ãƒã‚´ãƒ¼ãƒ¬ãƒ ")) return "ã€éç†±ã‚ªãƒ¼ãƒ©ã€‘\næ¯ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã€åŒæ–¹ã«æœ€å¤§HPã® 5% ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚";
        if (name.includes("ãƒŠã‚¤ãƒˆãƒ¡ã‚¢ãƒ›ãƒ¼ã‚¹")) return "ã€ææ€–ã®çªæ’ƒã€‘\næˆ¦é—˜ã®ç¬¬ 1 ã‚¿ãƒ¼ãƒ³ã€æ”»æ’ƒåŠ›ãŒ 100% ä¸Šæ˜‡ã™ã‚‹ã€‚";
        if (name.includes("å •è½ã—ãŸé¨å£«")) return "ã€äº¡è€…ã®æ„å¿—ã€‘\nè‡´æ­»ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã¦ã‚‚1åº¦ã ã‘è€ãˆã€æ”»æ’ƒåŠ›ãŒå¤§å¹…ã«ä¸Šæ˜‡ã™ã‚‹ã€‚";
        if (name.includes("ã‚«ã‚ªã‚¹ãƒ»ãƒ†ãƒ³ã‚¿ã‚¯ãƒ«")) return "ã€æ€è€ƒæ±šæŸ“ã€‘\næ”»æ’ƒæ™‚ 15% ã®ç¢ºç‡ã§ã€Œæ··ä¹±ã€ã‚’ä¸ãˆã€æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã«ã™ã‚‹ã€‚";
        if (name.includes("ãƒ–ãƒ©ãƒƒãƒ‰ä¼¯çˆµ")) return "ã€ç”Ÿå‘½å¸åã€‘\nä¸ãˆãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã® 50% åˆ†ã€è‡ªèº«ã®HPã‚’å›å¾©ã™ã‚‹ã€‚";
        if (name.includes("ãƒªãƒƒãƒã‚­ãƒ³ã‚°")) return "ã€å‘½åŒ£ã‚·ãƒ¼ãƒ«ãƒ‰ã€‘\n3ã‚¿ãƒ¼ãƒ³ã”ã¨ã«ç„¡æ•µã‚·ãƒ¼ãƒ«ãƒ‰ã‚’å±•é–‹ã—ã€ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã€‚";
        if (name.includes("ã‚¢ãƒ“ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³")) return "ã€é€†é±—ã®æ€’ã‚Šã€‘\nã€Œä¼šå¿ƒã€æ”»æ’ƒã‚’å—ã‘ã‚‹ã¨æ¿€æ€’ã—ã€å³åº§ã«åæ’ƒã‚’è¡Œã†ã€‚";
        if (name.includes("æ—§æ”¯é…è€…")) return "ã€åçŠ¶ã—ãŒãŸãå›ãã€‘\nã‚¿ãƒ¼ãƒ³çµŒéã¨ã¨ã‚‚ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è“„ç©ã™ã‚‹çœŸå®Ÿãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ï¼ˆç²¾ç¥å´©å£Šï¼‰ã€‚";
        
        if (name.includes("ç¥ã®ä»£è¡Œè€…")) return "ã€ç¥ã®æ¨©èƒ½ã€‘\n1. å¨åœ§ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¼šå¿ƒã‚’å°å° (é¼“èˆãŒãªã„å ´åˆ)\n2. è–æ½”ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šè¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ä¸Šé™ 111,111\n3. å¯©åˆ¤ã®çœ¼ï¼š3ã‚¿ãƒ¼ãƒ³ã”ã¨ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®HPã‚’å¼·åˆ¶çš„ã« 1 ã«ã™ã‚‹\n4. ãƒ«ãƒ¼ãƒ«ç ´å£Šï¼šç¢ºç‡ã§ç›¾ã‚’ç ´å£Šã€ã¾ãŸã¯å¾©æ´»ã®ç¾½æ ¹ã‚’ç„¼å´ã™ã‚‹";
        if (name.includes("å‚²æ…¢ã®é¡åƒ")) return "ã€é¡åƒè¤‡è£½ã€‘\nã‚ãªãŸã¨ä¼¼ãŸèƒ½åŠ›ã‚’æŒã¤ã€‚é˜²å‚™ã‚’æ¨ã¦ãªã‘ã‚Œã°å‹ã¦ãªã„ã€‚";
        
        return "ç‰¹æ®Šèƒ½åŠ›ãªã— (ã¾ãŸã¯ä¸æ˜)";
    },

    inspectEnemy() {
        const enemy = GameState.currentEnemy;
        if (!enemy || GameState.phase !== 'combat') return;

        let desc = `ã€${enemy.name}ã€‘\n`;
        desc += `----------------\n`;
        desc += `â¤ï¸ HP: ${Math.max(0, enemy.hp)} / ${enemy.maxHp}\n`;
        desc += `âš”ï¸ æ”»æ’ƒ: ${enemy.atk}\n`;
        desc += `----------------\n`;
        desc += `[ç‰¹æ®Šèƒ½åŠ›]\n${this.getEnemySkillDesc(enemy.name)}`;

        alert(desc);
    },

    log(msg) { console.log(msg); },
    renderEvent(title, subtitle, content, icon) {
        document.getElementById('event-title').innerText = title;
        document.getElementById('event-desc').innerHTML = `<p>${subtitle}</p><p>${content}</p>`;
        
        const iconEl = document.getElementById('event-icon');
        if(icon) iconEl.innerText = icon;
        
        iconEl.onclick = null;
        iconEl.style.cursor = "default";

        if (GameState.phase === 'combat' && GameState.currentEnemy) {
            iconEl.onclick = () => Game.inspectEnemy();
            iconEl.style.cursor = "help";
        }

        if(GameState.phase !== 'merchant' && GameState.phase !== 'demon_merchant') document.getElementById('merchant-area').classList.add('hidden');
        if(GameState.phase !== 'crafting') document.getElementById('crafting-area').classList.add('hidden');
    },
    setButtons(mainText, mainAction, subText, subAction, disableSub) {
        const b1 = document.getElementById('btn-main');
        const b2 = document.getElementById('btn-sub');
        b1.innerText = mainText;
        if (Game[mainAction]) b1.onclick = () => Game[mainAction](); else b1.onclick = null; 
        b2.innerText = subText;
        if (subAction && Game[subAction]) b2.onclick = () => Game[subAction](); else b2.onclick = null;
        b2.disabled = disableSub;
    },
    updateUI() {
        this.updateStatsUI();
        
        const w = Player.equipment.weapon;
        const a = Player.equipment.armor;
        const s = Player.equipment.shield;
        
        const wEl = document.getElementById('slot-weapon');
        wEl.innerHTML = w ? `<span class="${CONFIG.rarityDisplay[w.rarity].color}">${w.icon} ${w.name} (+${w.val})</span>` : "æ­¦å™¨ãªã—";
        wEl.className = `equip-slot ${w ? CONFIG.rarityDisplay[w.rarity].color : ''}`;

        const aEl = document.getElementById('slot-armor');
        aEl.innerHTML = a ? `<span class="${CONFIG.rarityDisplay[a.rarity].color}">${a.icon} ${a.name} (+${a.val})</span>` : "é˜²å…·ãªã—";
        aEl.className = `equip-slot ${a ? CONFIG.rarityDisplay[a.rarity].color : ''}`;
        
        const sEl = document.getElementById('slot-shield');
        sEl.innerHTML = s ? `<span class="${CONFIG.rarityDisplay[s.rarity].color}">${s.icon} ${s.name} (${s.val})</span>` : "ç›¾ãªã—";
        sEl.className = `equip-slot ${s ? CONFIG.rarityDisplay[s.rarity].color : ''}`;

        for(let i=0; i<3; i++) {
            const acc = Player.equipment.accessories[i];
            const el = document.getElementById(`slot-acc${i+1}`);
            el.innerHTML = acc ? `<span class="${CONFIG.rarityDisplay[acc.rarity].color}">${acc.icon} ${acc.name}</span>` : `è£…é£¾å“ ${i+1}`;
            el.className = `equip-slot ${acc ? CONFIG.rarityDisplay[acc.rarity].color : ''}`;
        }

        this.renderInvList('inv-equip', Player.inventory.equipment, 'equipment');
        this.renderInvList('inv-acc', Player.inventory.accessory, 'accessory');
        this.renderInvList('inv-consum', Player.inventory.consumable, 'consumable');
        this.renderInvList('inv-mat', Player.inventory.material, 'material');

        if (!GameState.isLoading && Player.hp > 0 && Player.class) {
            this.saveGame();
        }
    },
    updateStatsUI() {
        document.getElementById('hp-val').innerText = Player.hp;
        document.getElementById('max-hp-val').innerText = Player.maxHp;
        document.getElementById('atk-val').innerText = this.getAtk();
        document.getElementById('crit-val').innerText = this.getCritRate();
        document.getElementById('gold-val').innerText = Player.gold;
        document.getElementById('depth-val').innerText = Player.depth;
        
        const buffEl = document.getElementById('buff-display');
        let statusHtml = "çŠ¶æ…‹: ";
        let hasStatus = false;

        if (Player.buff) {
            const style = Player.buff.type === 'angel' ? 'angel-text' : 'demon-text';
            statusHtml += `<span class="${style}" title="${Player.buff.desc}">[${Player.buff.name}]</span> `;
            hasStatus = true;
        }

        if (Player.debuff) {
            let tooltip = Player.debuff.desc;
            let displayName = Player.debuff.name;
            if (Player.debuff.id === 'sloth_curse') {
                let count = Player.sinState.slothCount;
                tooltip = `å…¨èº«è„±åŠ›ã€æ”»æ’ƒä¸å¯ã€é€ƒèµ°ã®ã¿ (æ®‹ã‚Š ${count} æˆ¦)`;
                displayName = `ğŸ’¤ æ€ æƒ° (${count})`; 
            }
            statusHtml += `<span class="damage-text" title="${tooltip}">[${displayName}]</span> `;
            hasStatus = true;
        }

        if (Player.lilithBlessing || Player.lilithSacrificed) {
            let title = Player.lilithSacrificed 
                ? "ãƒªãƒªã‚¹ã®é­‚ã¯ã‚ãªãŸã¨å…±ã«... (æœ€å¤§HP+10000)" 
                : "ãƒªãƒªã‚¹ãŒå…±ã«æˆ¦ã£ã¦ã„ã‚‹ï¼(æœ€å¤§HP+10000)";
            
            statusHtml += `<span style="color:#ff69b4; font-weight:bold;" title="${title}">[ğŸ’— ãƒªãƒªã‚¹ã®ç¥ç¦]</span> `;
            hasStatus = true;
        }

        if (Player.lastInspirationTurns > 0) {
            statusHtml += `<span style="color:#ff00ff; font-weight:bold; text-shadow:0 0 5px #fff;" title="ç¥ã®æ¨©èƒ½ã‚’ç„¡è¦–ï¼(æ®‹ã‚Š ${Player.lastInspirationTurns} ã‚¿ãƒ¼ãƒ³)">[âœ¨ æœ€å¾Œã®é¼“èˆ(${Player.lastInspirationTurns})]</span> `;
            hasStatus = true;
        }

        const hasPhylactery = Player.equipment.accessories.some(a => a && a.id === 'acc_phylactery');
        if (hasPhylactery) {
            const soulColor = Player.souls >= 50 ? '#00ffcc' : '#888';
            statusHtml += `<span style="color:${soulColor}; font-weight:bold;" title="æ’ƒç ´ã§é­‚ã‚’è“„ç©ã€50ã§å¾©æ´»å¯èƒ½">[âš±ï¸ é­‚: ${Player.souls}]</span> `;
            hasStatus = true;
        }

        if (!hasStatus) statusHtml += "ãªã—";
        
        buffEl.innerHTML = statusHtml;
        
        buffEl.onclick = () => {
            let msg = "";
            if (Player.buff) msg += `ã€${Player.buff.name}ã€‘\n${Player.buff.desc}\n\n`;
            if (Player.debuff) msg += `ã€${Player.debuff.name}ã€‘\n${Player.debuff.desc}\n\n`;
            
            if (Player.lilithBlessing || Player.lilithSacrificed) {
                msg += `ã€ğŸ’— ãƒªãƒªã‚¹ã®ç¥ç¦ã€‘\n${Player.lilithSacrificed ? "å½¼å¥³ã¯æ¶ˆãˆã¦ã—ã¾ã£ãŸãŒã€ãã®å®ˆã‚‹åŠ›ã¯ä»Šã‚‚ã‚ãªãŸã®ä¸­ã«æµã‚Œã¦ã„ã‚‹ã€‚" : "ãƒªãƒªã‚¹ã¯ã‚ãªãŸã¨å…±ã«ã„ã‚‹ã€‚"}\nç”Ÿå‘½åŠ›ãŒå¤§å¹…ã«ä¸Šæ˜‡ (+10000)ã€‚\n\n`;
            }
            
            if (Player.lastInspirationTurns > 0) msg += `ã€âœ¨ æœ€å¾Œã®é¼“èˆã€‘\nãƒªãƒªã‚¹æœ€æœŸã®é­”æ³•ã€‚ç¥ã®ä»£è¡Œè€…ã®å…¨ã¦ã®ç‰¹æ®Šèƒ½åŠ›ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã€‚æŒç¶š ${Player.lastInspirationTurns} ã‚¿ãƒ¼ãƒ³ã€‚`;
            
            if (msg) alert(msg);
        };
    },

    renderInvList(id, items, category) {
        const list = document.getElementById(id);
        list.innerHTML = "";
        items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = `item ${CONFIG.rarityDisplay[item.rarity].color}`;
            if (item.rarity === 'epic') div.classList.add('rare-epic');
            if (item.rarity === 'legendary') div.classList.add('rare-legendary');
            if (item.rarity === 'mythic') div.classList.add('rarity-mythic');
            if (item.rarity === 'ultra') div.classList.add('rarity-ultra');
            div.innerHTML = `${item.icon || 'ğŸ“¦'} ${item.name}`;
            div.onclick = () => this.handleItemClick(idx, category);
            list.appendChild(div);
        });
    }, 

    openInventoryModal(category) {
        const modal = document.getElementById('inventory-modal');
        const title = document.getElementById('inv-modal-title');
        const content = document.getElementById('inv-modal-content');
        
        const catName = {
            'equipment': 'ğŸ“¦ è£…å‚™',
            'accessory': 'ğŸ’ è£…é£¾',
            'consumable': 'ğŸ§ª æ¶ˆè€—å“',
            'material': 'ğŸ§© ç´ æ'
        }[category];

        title.innerText = `${catName} ä¸€è¦§ (ãƒ¬ã‚¢åº¦é †)`;
        content.innerHTML = "";

        let items = Player.inventory[category].map((item, index) => ({
            ...item,
            originalIndex: index 
        }));

        items.sort((a, b) => {
            const valA = CONFIG.rarityDisplay[a.rarity]?.val || 0;
            const valB = CONFIG.rarityDisplay[b.rarity]?.val || 0;
            return valB - valA;
        });

        if (items.length === 0) {
            content.innerHTML = "<div style='grid-column:1/-1; text-align:center; color:#666; margin-top:50px;'>ç©ºã£ã½ã§ã™</div>";
        } else {
            items.forEach(item => {
                const div = document.createElement('div');
                let colorClass = CONFIG.rarityDisplay[item.rarity]?.color || 'rarity-common';
                
                div.className = `merchant-item ${colorClass}`;
                if(item.rarity === 'mythic') div.className += ' rarity-mythic';
                if(item.rarity === 'ultra') div.className += ' rarity-ultra';
                
                div.style.cssText = "cursor:pointer; display:flex; flex-direction:column; align-items:center; text-align:center; height:100%; justify-content:center; padding:15px;";
                
                let subText = "";
                if(category === 'material') {
                    let p = item.price || 0;
                    if(GameState.phase === 'merchant' || GameState.phase === 'demon_merchant') {
                        if(Player.class === 'merchant') p = Math.floor(p * 1.2);
                        subText = `<span class="gold-text">${p} G</span>`;
                    }
                } else {
                    subText = `<span style="font-size:0.8em; color:#aaa;">${this.getItemDesc(item)}</span>`;
                }

                div.innerHTML = `
                    <div style="font-size:2em; margin-bottom:5px;">${item.icon || 'ğŸ“¦'}</div>
                    <div style="font-weight:bold; margin-bottom:5px; word-break:break-all;">${item.name}</div>
                    ${subText}
                `;
                
                div.onclick = () => {
                    this.handleItemClick(item.originalIndex, category);
                    setTimeout(() => this.openInventoryModal(category), 100); 
                };
                
                content.appendChild(div);
            });
        }

        modal.style.display = 'flex';
    },
   
};

Game.init();
</script>
</body>
</html>
